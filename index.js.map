{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/anchor/utils/messageGenerator.ts","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/anchor/utils/textParser.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/anchor/utils/variableReader.ts","src://tavern_helper_template/src/anchor/components/SplashScreen.ts","src://tavern_helper_template/src/anchor/components/NewGameSetup.ts","src://tavern_helper_template/src/anchor/components/Dashboard.ts","src://tavern_helper_template/src/anchor/utils/variableUpdater.ts","src://tavern_helper_template/src/anchor/utils/pageManager.ts","src://tavern_helper_template/src/anchor/utils/gameInitializer.ts","src://tavern_helper_template/src/anchor/dashboardLogic.ts","src://tavern_helper_template/src/anchor/app.ts","src://tavern_helper_template/src/anchor/index.ts"],"sourcesContent":["/**\n * æ¶ˆæ¯ç”ŸæˆæœåŠ¡\n * å¤„ç†å®Œæ•´çš„æ¶ˆæ¯ç”Ÿæˆæµç¨‹ï¼šæ„å»ºæç¤ºè¯ -> åˆ›å»º user æ¶ˆæ¯ -> è°ƒç”¨ LLM -> è§£æç»“æœ -> åˆ›å»º assistant æ¶ˆæ¯\n */\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function createChatMessages(\n  messages: Array<{ role: 'user' | 'assistant' | 'system'; message: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function generate(config: { user_input?: string; should_stream?: boolean }): Promise<string>;\n\n// æ£€æŸ¥ generate å‡½æ•°æ˜¯å¦åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨\nfunction checkGenerateAvailable(): boolean {\n  if (typeof generate === 'undefined') {\n    // å°è¯•ä» window å¯¹è±¡è·å–\n    if (typeof window !== 'undefined' && (window as any).generate) {\n      return true;\n    }\n    return false;\n  }\n  return true;\n}\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const iframe_events: {\n  STREAM_TOKEN_RECEIVED_FULLY: 'js_stream_token_received_fully';\n  GENERATION_ENDED: 'js_generation_ended';\n};\n\n// MVU å˜é‡æ¡†æ¶å£°æ˜\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  parseMessage?: (message: string, old_data: any) => Promise<any | undefined>;\n};\n\nimport _ from 'lodash';\nimport {\n  extractAllOptions,\n  extractLastMaintext,\n  extractLastOption,\n  extractLastSum,\n  extractLastUpdateVariable,\n  removeThinkingTags,\n  removeThinkingTagsFromStream,\n  validateMessage,\n} from './textParser';\n\n/**\n * è·å–åŸºç¡€ MVU æ•°æ®ï¼ˆç”¨äºä¼ é€’åˆ°æ–°æ¥¼å±‚ï¼‰\n */\nasync function getBaseMvuData(): Promise<any> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    await waitGlobalInitialized('Mvu');\n\n    // åˆå¹¶ init(0) / latest message / chatï¼ˆchat ä¼˜å…ˆï¼‰ï¼Œä½œä¸ºæ–°æ¥¼å±‚çš„ base\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    try {\n      chatData = Mvu.getMvuData({ type: 'chat' });\n    } catch {\n      // ignore\n    }\n\n    const base = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    console.log('ğŸ“Š ä» MVU(merged) è·å–åŸºç¡€æ•°æ®');\n\n    // è¿”å›åŸºç¡€æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•è§£æ\n    return (\n      base ?? {\n        stat_data: {},\n        display_data: {},\n        delta_data: {},\n      }\n    );\n  } catch (error) {\n    console.warn('âš ï¸ è·å– MVU æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºå¯¹è±¡:', error);\n    // å¦‚æœ MVU ä¸å¯ç”¨ï¼Œè¿”å›ä¸€ä¸ªåŸºæœ¬çš„ MVU æ•°æ®ç»“æ„\n    return {\n      stat_data: {},\n      display_data: {},\n      delta_data: {},\n    };\n  }\n}\n\n/**\n * æ¶ˆæ¯ç”Ÿæˆå›è°ƒæ¥å£\n */\nexport interface MessageGeneratorCallbacks {\n  onShowGenerating?: () => void; // æ˜¾ç¤ºç”Ÿæˆæç¤º\n  onHideGenerating?: () => void; // éšè—ç”Ÿæˆæç¤º\n  onError?: (error: string) => void; // é”™è¯¯å›è°ƒ\n  onStreamingUpdate?: (text: string) => void; // æµå¼æ›´æ–° maintext çš„å›è°ƒ\n  onRefreshStoryIfOpen?: (userMessage: string) => void; // å¦‚æœç•Œé¢å·²æ‰“å¼€åˆ™åˆ·æ–°æ˜¾ç¤ºï¼ˆuseræ¶ˆæ¯åˆ›å»ºåï¼Œä¼ å…¥ç”¨æˆ·æ¶ˆæ¯å†…å®¹ï¼‰\n  onRefreshStory?: (options?: string[]) => void; // åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºçš„å›è°ƒï¼ˆassistantæ¶ˆæ¯åˆ›å»ºåï¼Œä¼ å…¥é€‰é¡¹æ•°ç»„ï¼‰\n  onCreatedMessages?: (ids: { userMessageId: number; assistantMessageId: number }) => void; // user+assistant åˆ›å»ºå®Œæˆåå›ä¼ çœŸå®æ¥¼å±‚ id\n}\n\n/**\n * é‡æ–°ç”Ÿæˆ assistant æ¶ˆæ¯ï¼ˆä¸åˆ›å»º user æ¥¼å±‚ï¼‰\n * å…¸å‹ç”¨é€”ï¼šåˆ é™¤å½“å‰è½®çš„ assistant æ¥¼å±‚åï¼ŒåŸºäºåŒä¸€ä¸ª user æ¥¼å±‚é‡æ–°ç”Ÿæˆ AI å›å¤ã€‚\n */\nexport async function regenerateAssistantMessage(\n  userMessageId: number,\n  callbacks: MessageGeneratorCallbacks = {},\n): Promise<boolean> {\n  try {\n    if (callbacks.onShowGenerating) callbacks.onShowGenerating();\n\n    // æ³¨å†Œæµå¼äº‹ä»¶ç›‘å¬å™¨\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          callbacks.onStreamingUpdate?.('');\n          return;\n        }\n        callbacks.onStreamingUpdate?.(cleanedText);\n      };\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('âœ… [regen] å·²æ³¨å†Œæµå¼è¾“å‡ºç›‘å¬å™¨');\n    } else {\n      console.log('â„¹ï¸ [regen] æµå¼äº‹ä»¶ä¸å¯ç”¨ï¼Œé€€åŒ–ä¸ºéæµå¼æ¨¡å¼');\n    }\n\n    // æ£€æŸ¥ generate å¯ç”¨\n    if (!checkGenerateAvailable()) {\n      throw new Error('generate å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿é…’é¦†åŠ©æ‰‹å·²æ­£ç¡®åŠ è½½');\n    }\n\n    // generateï¼ˆä¸ä¼  user_inputï¼šæ²¿ç”¨å½“å‰ä¸Šä¸‹æ–‡/æç¤ºè¯ï¼‰\n    const generatePromise = generate({ should_stream: true });\n    const timeoutPromise = new Promise<string>((_, reject) => {\n      setTimeout(() => reject(new Error('generate è°ƒç”¨è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰')), 5 * 60 * 1000);\n    });\n    const result = await Promise.race([generatePromise, timeoutPromise]);\n\n    const cleanedResult = removeThinkingTags(result);\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('ç”Ÿæˆçš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      return false;\n    }\n\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('æ— æ³•æå– maintext æˆ– option');\n      return false;\n    }\n\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) finalMessage += `\\n\\n<sum>${sum}</sum>`;\n    if (updateVariable) finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n\n    // base ä¼˜å…ˆä½¿ç”¨ userMessage.dataï¼ˆå› ä¸º regenerate ä¸ä¼šæ–°å»º user æ¥¼å±‚ï¼‰\n    let base: any = null;\n    try {\n      const userMsg = getChatMessages(userMessageId)?.[0];\n      if (userMsg?.data) base = userMsg.data;\n    } catch {\n      // ignore\n    }\n    if (!base) {\n      try {\n        base =\n          getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n          Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        base = { stat_data: {}, display_data: {}, delta_data: {} };\n      }\n    }\n\n    if (!base || typeof base !== 'object') base = { stat_data: {}, display_data: {}, delta_data: {} };\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // MVU è§£æ\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) finalData = parsed;\n      } catch (e) {\n        console.warn('âš ï¸ [regen] MVU è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®:', e);\n      }\n    }\n\n    const extractedOptions = extractAllOptions(finalMessage);\n\n    // åªä¿å­˜ maintext\n    const maintextContent = extractLastMaintext(finalMessage);\n    const messageToSave = maintextContent || finalMessage;\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave,\n          data: {\n            ...finalData,\n            __options: extractedOptions,\n          },\n        },\n      ],\n      { refresh: 'none' },\n    );\n\n    const assistantMessageId = getLastMessageId();\n    console.log('âœ… [regen] assistant æ¶ˆæ¯å·²åˆ›å»ºï¼ŒID:', assistantMessageId);\n\n    // å›ä¼  idï¼ˆuserMessageId ä¸å˜ï¼‰\n    callbacks.onCreatedMessages?.({ userMessageId, assistantMessageId });\n\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n\n    setTimeout(() => {\n      callbacks.onRefreshStory?.(extractedOptions);\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('âŒ [regen] é‡æ–°ç”Ÿæˆ assistant å¤±è´¥:', error);\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n    callbacks.onError?.(error instanceof Error ? error.message : 'é‡æ–°ç”Ÿæˆå¤±è´¥');\n    return false;\n  }\n}\n\n/**\n * ç”Ÿæˆæ¶ˆæ¯\n * @param userInput ç”¨æˆ·è¾“å…¥ï¼ˆé€‰é¡¹æ–‡æœ¬æˆ–è‡ªå®šä¹‰æ¶ˆæ¯ï¼‰\n * @param callbacks å›è°ƒå‡½æ•°\n */\nexport async function generateMessage(userInput: string, callbacks: MessageGeneratorCallbacks = {}): Promise<boolean> {\n  let userMessageId: number | null = null;\n\n  try {\n    // 1. ç¦ç”¨ç›¸å…³UIï¼ˆå¦‚æœéœ€è¦ï¼‰\n    // è¿™é‡Œå¯ä»¥æ·»åŠ ç¦ç”¨é€‰é¡¹æŒ‰é’®ç­‰é€»è¾‘\n\n    // 2. æ˜¾ç¤º\"æ­£åœ¨ç”Ÿæˆ\"æç¤º\n    if (callbacks.onShowGenerating) {\n      callbacks.onShowGenerating();\n    }\n\n    // 3. è·å–åŸºç¡€ MVU æ•°æ®\n    const mvu_data = await getBaseMvuData();\n\n    // 4. åˆ›å»º user æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤2] å¼€å§‹åˆ›å»º user æ¶ˆæ¯...');\n    console.log('ğŸ“ [æ­¥éª¤2] ç”¨æˆ·è¾“å…¥:', userInput);\n    console.log('ğŸ“ [æ­¥éª¤2] MVU æ•°æ®:', mvu_data ? 'å·²è·å–' : 'æœªè·å–');\n\n    try {\n      await createChatMessages(\n        [\n          {\n            role: 'user',\n            message: userInput, // âš ï¸ åªå­˜å‚¨ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œä¸å­˜å‚¨å®Œæ•´æç¤ºè¯\n            data: mvu_data, // ä¼ é€’ MVU æ•°æ®ï¼Œç¡®ä¿å˜é‡æ­£ç¡®ä¼ é€’åˆ°æ–°æ¥¼å±‚\n          },\n        ],\n        {\n          refresh: 'none', // ä¸æ›´æ–°æ˜¾ç¤ºï¼Œç”±æ¸¸æˆç•Œé¢è‡ªå·±è¯»å–\n        },\n      );\n      console.log('âœ… [æ­¥éª¤2] user æ¶ˆæ¯å·²åˆ›å»º');\n\n      // 9. è·å–åˆšåˆ›å»ºçš„ user æ¶ˆæ¯ ID\n      userMessageId = getLastMessageId();\n      console.log('âœ… [æ­¥éª¤2] user æ¶ˆæ¯å·²åˆ›å»ºï¼ŒID:', userMessageId);\n\n      // 10. åˆ·æ–°æ˜¾ç¤ºåˆšå‘é€çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆå‚è€ƒmhjgå®ç°ï¼‰\n      // ä½¿ç”¨è½®è¯¢æ–¹å¼ç¡®ä¿æ¶ˆæ¯å·²åˆ›å»º\n      const checkAndRefresh = async (retries = 5) => {\n        const checkMessageId = getLastMessageId();\n        if (checkMessageId === userMessageId) {\n          // éªŒè¯æ¶ˆæ¯æ˜¯å¦å­˜åœ¨\n          const messages = getChatMessages(checkMessageId);\n          if (messages && messages.length > 0 && messages[0].role === 'user') {\n            if (callbacks.onRefreshStoryIfOpen) {\n              callbacks.onRefreshStoryIfOpen(messages[0].message);\n              console.log('âœ… [æ­¥éª¤2] å·²åˆ·æ–°æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ŒID:', userMessageId);\n            }\n            return;\n          }\n        }\n\n        // å¦‚æœæ¶ˆæ¯è¿˜æœªåˆ›å»ºï¼Œé‡è¯•\n        if (retries > 0) {\n          setTimeout(() => checkAndRefresh(retries - 1), 50);\n        } else {\n          // å³ä½¿éªŒè¯å¤±è´¥ï¼Œä¹Ÿå°è¯•åˆ·æ–°ï¼ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼‰\n          if (callbacks.onRefreshStoryIfOpen) {\n            callbacks.onRefreshStoryIfOpen(userInput);\n            console.log('âš ï¸ [æ­¥éª¤2] éªŒè¯æ¶ˆæ¯å¤±è´¥ï¼Œä½†ä»å°è¯•åˆ·æ–°æ˜¾ç¤º');\n          }\n        }\n      };\n\n      setTimeout(() => checkAndRefresh(), 50);\n    } catch (createError) {\n      console.error('âŒ [æ­¥éª¤2] createChatMessages è°ƒç”¨å¤±è´¥:', createError);\n      throw new Error(\n        `åˆ›å»º user æ¶ˆæ¯å¤±è´¥: ${createError instanceof Error ? createError.message : String(createError)}`,\n      );\n    }\n\n    // 5. æ³¨å†Œæµå¼äº‹ä»¶ç›‘å¬å™¨ï¼ˆåœ¨è°ƒç”¨ generate ä¹‹å‰ï¼‰\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        // å®æ—¶å‰”é™¤ <thinking> æ ‡ç­¾ï¼ˆåŒ…æ‹¬æœªé—­åˆçš„ï¼‰\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n\n        // å¦‚æœæ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼ˆè¯´æ˜æ­£åœ¨ thinking æ ‡ç­¾å†…ï¼‰ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          if (callbacks.onStreamingUpdate) {\n            callbacks.onStreamingUpdate('');\n          }\n          return;\n        }\n\n        // ä¼ é€’å®Œæ•´çš„ cleanedTextï¼ˆåŒ…å«æ‰€æœ‰æ ‡ç­¾ï¼‰ï¼Œç”¨äºæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸ\n        if (callbacks.onStreamingUpdate) {\n          callbacks.onStreamingUpdate(cleanedText);\n        }\n      };\n\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('âœ… [æ­¥éª¤3] å·²æ³¨å†Œæµå¼è¾“å‡ºç›‘å¬å™¨');\n    } else {\n      console.log('â„¹ï¸ [æ­¥éª¤3] æµå¼äº‹ä»¶ä¸å¯ç”¨ï¼Œé€€åŒ–ä¸ºéæµå¼æ¨¡å¼');\n    }\n\n    // 6. ä½¿ç”¨ generate ç”Ÿæˆ LLM å›å¤ï¼ˆæ”¯æŒæµå¼ç”Ÿæˆï¼‰\n    console.log('ğŸš€ [æ­¥éª¤3] å¼€å§‹è°ƒç”¨ generate ç”Ÿæˆå›å¤...');\n    console.log('ğŸ“ [æ­¥éª¤3] ç”¨æˆ·è¾“å…¥:', userInput);\n\n    // æ£€æŸ¥ generate å‡½æ•°æ˜¯å¦å¯ç”¨\n    if (!checkGenerateAvailable()) {\n      console.error('âŒ [æ­¥éª¤3] generate å‡½æ•°æœªå®šä¹‰');\n      console.error('âŒ [æ­¥éª¤3] è¯·æ£€æŸ¥ï¼š');\n      console.error('   1. é…’é¦†åŠ©æ‰‹æ˜¯å¦å·²æ­£ç¡®å®‰è£…');\n      console.error('   2. æ˜¯å¦åœ¨ iframe ç¯å¢ƒä¸­è¿è¡Œ');\n      console.error('   3. å…¨å±€ generate å‡½æ•°æ˜¯å¦å¯ç”¨');\n      throw new Error('generate å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿é…’é¦†åŠ©æ‰‹å·²æ­£ç¡®åŠ è½½');\n    }\n\n    let result: string;\n    try {\n      console.log('ğŸš€ [æ­¥éª¤3] è°ƒç”¨ generateï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰...');\n      console.log('ğŸš€ [æ­¥éª¤3] generate å‡½æ•°ç±»å‹:', typeof generate);\n\n      // ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰\n      const generatePromise = generate({\n        // user_input: userInput, // ä¸ä½¿ç”¨ç”¨æˆ·è¾“å…¥\n        should_stream: true, // å¯ç”¨æµå¼ç”Ÿæˆ\n      });\n\n      // è®¾ç½®è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(\n          () => {\n            reject(new Error('generate è°ƒç”¨è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰'));\n          },\n          5 * 60 * 1000,\n        );\n      });\n\n      result = await Promise.race([generatePromise, timeoutPromise]);\n\n      console.log('ğŸ“¨ [æ­¥éª¤3] generate è¿”å›ç»“æœï¼Œé•¿åº¦:', result?.length || 0);\n      if (!result || result.length === 0) {\n        console.warn('âš ï¸ [æ­¥éª¤3] generate è¿”å›ç©ºç»“æœ');\n      } else {\n        console.log('ğŸ“¨ [æ­¥éª¤3] generate è¿”å›ç»“æœé¢„è§ˆ:', result.substring(0, 200) + '...');\n      }\n    } catch (generateError) {\n      console.error('âŒ [æ­¥éª¤3] generate è°ƒç”¨å¤±è´¥:', generateError);\n      console.error('âŒ [æ­¥éª¤3] é”™è¯¯è¯¦æƒ…:', {\n        error: generateError,\n        errorType: typeof generateError,\n        errorMessage: generateError instanceof Error ? generateError.message : String(generateError),\n        errorStack: generateError instanceof Error ? generateError.stack : undefined,\n      });\n\n      // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯\n      if (generateError instanceof Error && generateError.message.includes('è¶…æ—¶')) {\n        throw new Error('generate è°ƒç”¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– LLM æœåŠ¡çŠ¶æ€');\n      }\n\n      throw new Error(\n        `generate è°ƒç”¨å¤±è´¥: ${generateError instanceof Error ? generateError.message : String(generateError)}`,\n      );\n    }\n\n    // 7. ç§»é™¤ <thinking> æ ‡ç­¾\n    const cleanedResult = removeThinkingTags(result);\n\n    // 8. éªŒè¯è¿”å›ç»“æœæ˜¯å¦ç¬¦åˆè§„èŒƒ\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      console.error('âŒ [æ­¥éª¤4] generate è¿”å›çš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      // åˆ é™¤ user æ¶ˆæ¯\n      if (userMessageId !== null) {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('ğŸ—‘ï¸ å·²åˆ é™¤ä¸åˆè§„çš„ user æ¶ˆæ¯');\n      }\n      // éšè—ç”Ÿæˆæç¤ºæ¡†\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('ç”Ÿæˆçš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      }\n      return false;\n    }\n\n    // 12. æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <maintext>ã€<option>ã€<sum> å’Œ <UpdateVariable>\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      console.error('âŒ [æ­¥éª¤5] æ— æ³•æå– maintext æˆ– option');\n      // åˆ é™¤ user æ¶ˆæ¯\n      if (userMessageId !== null) {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('ğŸ—‘ï¸ å·²åˆ é™¤ä¸åˆè§„çš„ user æ¶ˆæ¯');\n      }\n      // éšè—ç”Ÿæˆæç¤ºæ¡†\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('æ— æ³•æå– maintext æˆ– option');\n      }\n      return false;\n    }\n\n    // 13. é‡æ–°ç»„åˆæ¶ˆæ¯ï¼ˆåŒ…å«æœ€åä¸€æ¬¡çš„ maintextã€optionã€sumï¼ˆå¦‚æœæœ‰ï¼‰å’Œ UpdateVariableï¼ˆå¦‚æœæœ‰ï¼‰ï¼‰\n    // ç”¨äº MVU è§£æï¼ˆéœ€è¦å®Œæ•´æ¶ˆæ¯ï¼‰\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) {\n      finalMessage += `\\n\\n<sum>${sum}</sum>`;\n      console.log('ğŸ“ [æ­¥éª¤5] æå–åˆ° <sum> æ ‡ç­¾');\n    }\n    if (updateVariable) {\n      finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n      console.log('ğŸ“ [æ­¥éª¤5] æå–åˆ° <UpdateVariable> æ ‡ç­¾');\n    }\n\n    // 14. è·å–åŸºç¡€ MVU æ•°æ®ï¼ˆä¼˜å…ˆä»åˆšåˆ›å»ºçš„ user æ¶ˆæ¯è¯»å–ï¼‰\n    console.log('ğŸ“Š [æ­¥éª¤6] å¼€å§‹è·å–åŸºç¡€ MVU æ•°æ®...');\n    let base: any;\n    if (userMessageId !== null) {\n      const userMessage = getChatMessages(userMessageId)?.[0];\n      if (userMessage?.data) {\n        base = userMessage.data;\n        console.log('âœ… [æ­¥éª¤6] ä»åˆšåˆ›å»ºçš„ user æ¶ˆæ¯è¯»å–åŸºç¡€æ•°æ®');\n      }\n    }\n\n    // å¦‚æœ user æ¶ˆæ¯æ²¡æœ‰ dataï¼Œåˆ™ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–\n    if (!base) {\n      console.log('ğŸ“Š [æ­¥éª¤6] å°è¯•ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–...');\n      base =\n        getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n        Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      console.log('âœ… [æ­¥éª¤6] ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–åŸºç¡€æ•°æ®');\n    }\n\n    // ç¡®ä¿ base æ•°æ®ç»“æ„å®Œæ•´\n    if (!base || typeof base !== 'object') {\n      console.log('âš ï¸ [æ­¥éª¤6] base æ•°æ®æ— æ•ˆï¼Œä½¿ç”¨ç©ºå¯¹è±¡');\n      base = { stat_data: {}, display_data: {}, delta_data: {} };\n    }\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // 15. è§£ææ¶ˆæ¯ä¸­çš„ MVU å‘½ä»¤ï¼ˆå¦‚æœ MVU.parseMessage å¯ç”¨ï¼‰\n    console.log('ğŸ” [æ­¥éª¤7] å¼€å§‹è§£ææ¶ˆæ¯ä¸­çš„ MVU å‘½ä»¤...');\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) {\n          finalData = parsed;\n          console.log('âœ… [æ­¥éª¤7] MVU è§£ææˆåŠŸ');\n        } else {\n          console.log('â„¹ï¸ [æ­¥éª¤7] MVU è§£æè¿”å› undefinedï¼Œä½¿ç”¨åŸºç¡€æ•°æ®');\n        }\n      } catch (error) {\n        console.warn('âš ï¸ [æ­¥éª¤7] MVU è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®:', error);\n      }\n    } else {\n      console.log('â„¹ï¸ [æ­¥éª¤7] MVU.parseMessage ä¸å¯ç”¨ï¼Œè·³è¿‡è§£æ');\n    }\n\n    // 16. æå–é€‰é¡¹ï¼ˆåœ¨ createChatMessages ä¹‹å‰ï¼Œä» finalMessage ä¸­æå–ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤8] å¼€å§‹æå–é€‰é¡¹...');\n    const extractedOptions = extractAllOptions(finalMessage);\n    console.log('ğŸ“ [æ­¥éª¤8] å·²æå–é€‰é¡¹:', extractedOptions.length, 'ä¸ª');\n\n    // 17. åˆ›å»º assistant æ¶ˆæ¯ï¼ˆåªä¿å­˜ <maintext> æ ‡ç­¾é‡Œçš„å†…å®¹ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤9] å¼€å§‹åˆ›å»º assistant æ¶ˆæ¯...');\n    // ä» finalMessage ä¸­æå– maintext å†…å®¹ï¼ˆåªä¿ç•™ maintext æ ‡ç­¾é‡Œçš„å†…å®¹ï¼‰\n    const maintextContent = extractLastMaintext(finalMessage);\n    const messageToSave = maintextContent || finalMessage;\n    if (!maintextContent) {\n      console.warn('âš ï¸ [æ­¥éª¤9] æ— æ³•ä» finalMessage ä¸­æå– maintextï¼Œä½¿ç”¨å®Œæ•´çš„ finalMessage');\n    } else {\n      console.log('ğŸ“ [æ­¥éª¤9] å·²æå– maintext å†…å®¹ï¼Œåªä¿å­˜ maintext éƒ¨åˆ†');\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave, // åªä¿å­˜ maintext å†…å®¹\n          data: {\n            ...finalData, // ä¼ å…¥è§£æåçš„æ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰å˜é‡æ›´æ–°ï¼‰\n            __options: extractedOptions, // âœ… å­˜åœ¨ data é‡Œ\n          },\n        },\n      ],\n      {\n        refresh: 'none', // æ›´æ–°æ˜¾ç¤ºï¼Œç”±æ¸¸æˆç•Œé¢è‡ªå·±è¯»å–\n      },\n    );\n    console.log('âœ… [æ­¥éª¤9] assistant æ¶ˆæ¯å·²åˆ›å»ºï¼Œé…’é¦†ç•Œé¢å†å²å·²åˆ·æ–°');\n\n    // 18. è·å–æ–°åˆ›å»ºçš„æ¶ˆæ¯ ID\n    const assistantMessageId = getLastMessageId();\n    console.log('ğŸ†” [æ­¥éª¤10] è·å–æ–°åˆ›å»ºçš„æ¶ˆæ¯ ID:', assistantMessageId);\n\n    // 18.1 å›ä¼ çœŸå® message_idï¼ˆä¾¿äºä¸Šå±‚åšâ€œé‡æ–°ç”Ÿæˆ/åˆ é™¤æœ¬è½®â€ç­‰æ“ä½œï¼‰\n    if (callbacks.onCreatedMessages && userMessageId !== null) {\n      try {\n        callbacks.onCreatedMessages({ userMessageId, assistantMessageId });\n      } catch (e) {\n        console.warn('âš ï¸ onCreatedMessages å›è°ƒæ‰§è¡Œå¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e);\n      }\n    }\n\n    // 19. éšè—ç”Ÿæˆæç¤ºæ¡†\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 20. åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºï¼ˆå»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿æ¶ˆæ¯å·²ç»å®Œå…¨åˆ›å»ºå¹¶å†™å…¥å†å²ï¼‰\n    // åŒæ—¶ä¼ é€’æå–çš„é€‰é¡¹ï¼Œå‰ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä»æ¶ˆæ¯ä¸­æå–\n    setTimeout(() => {\n      if (callbacks.onRefreshStory) {\n        callbacks.onRefreshStory(extractedOptions);\n        console.log('âœ… [æ­¥éª¤11] å·²åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºï¼ˆå·²ä¼ é€’é€‰é¡¹ï¼‰');\n      }\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('âŒ ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:', error);\n\n    // å¦‚æœåˆ›å»ºäº† user æ¶ˆæ¯ï¼Œåˆ é™¤å®ƒ\n    if (userMessageId !== null) {\n      try {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('ğŸ—‘ï¸ å·²åˆ é™¤å¤±è´¥çš„ user æ¶ˆæ¯');\n      } catch (deleteError) {\n        console.error('âŒ åˆ é™¤ user æ¶ˆæ¯å¤±è´¥:', deleteError);\n      }\n    }\n\n    // éšè—ç”Ÿæˆæç¤ºæ¡†\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯\n    if (callbacks.onError) {\n      callbacks.onError(error instanceof Error ? error.message : 'ç”Ÿæˆæ¶ˆæ¯å¤±è´¥');\n    }\n\n    return false;\n  }\n}\n","module.exports = _;","/**\n * æ–‡æœ¬è§£æå·¥å…·\n * ç”¨äºä» LLM è¿”å›çš„æ–‡æœ¬ä¸­æå–æ ¼å¼åŒ–çš„æ ‡ç­¾å†…å®¹\n */\n\n/**\n * ç§»é™¤ <thinking> æ ‡ç­¾åŠå…¶å†…éƒ¨æ‰€æœ‰å†…å®¹ï¼ˆç”¨äºæœ€ç»ˆç»“æœï¼‰\n */\nexport function removeThinkingTags(text: string): string {\n  if (!text) return '';\n\n  // åŒ¹é… <thinking>...</thinking> æ ‡ç­¾ï¼ˆåŒ…æ‹¬ç®€å•åµŒå¥—æƒ…å†µï¼‰\n  let result = text;\n  let lastResult = '';\n\n  // å¾ªç¯å¤„ç†ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šçš„ <thinking> æ ‡ç­¾\n  while (result !== lastResult) {\n    lastResult = result;\n    result = result.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n  }\n\n  return result;\n}\n\n/**\n * ä»æµå¼æ–‡æœ¬ä¸­ç§»é™¤ <thinking> å†…å®¹\n * - å…ˆç§»é™¤æ‰€æœ‰å®Œæ•´çš„ <thinking>...</thinking>\n * - å¦‚æœè¿˜æœ‰æœªé—­åˆçš„ <thinking>ï¼Œåˆ™éšè—ä»æœ€åä¸€ä¸ª <thinking> å¼€å§‹çš„æ‰€æœ‰å†…å®¹\n */\nexport function removeThinkingTagsFromStream(text: string): string {\n  if (!text) return '';\n\n  // å…ˆç§»é™¤æ‰€æœ‰å®Œæ•´çš„ <thinking>...</thinking> æ ‡ç­¾å¯¹\n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n\n  // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªé—­åˆçš„ <thinking> æ ‡ç­¾\n  const lastThinkingStart = cleaned.lastIndexOf('<thinking>');\n\n  // å¦‚æœæ‰¾åˆ°äº†æœªé—­åˆçš„ <thinking>ï¼Œéšè—ä»å®ƒå¼€å§‹çš„æ‰€æœ‰å†…å®¹\n  if (lastThinkingStart !== -1) {\n    cleaned = cleaned.substring(0, lastThinkingStart).trim();\n  }\n\n  return cleaned;\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <maintext> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastMaintext(text: string): string {\n  const matches = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <continue_choice> æ ‡ç­¾å†…å®¹\n */\nexport function extractContinueChoice(text: string): string {\n  const matches = text.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <result> æ ‡ç­¾å†…å®¹\n */\nexport function extractResult(text: string): string {\n  const matches = text.match(/<result>([\\s\\S]*?)<\\/result>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<result>([\\s\\S]*?)<\\/result>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <decision_node> æ ‡ç­¾å†…å®¹\n */\nexport function extractNextChoice(text: string): string {\n  const matches = text.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <option> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastOption(text: string): string {\n  const matches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<option>([\\s\\S]*?)<\\/option>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æ‰€æœ‰ <suboption> æ ‡ç­¾å†…å®¹ï¼ˆæ–°æ ¼å¼ï¼‰\n * @returns æ‰€æœ‰ suboption æ–‡æœ¬çš„æ•°ç»„\n */\nexport function extractAllOptions(text: string): string[] {\n  if (!text) return [];\n\n  // é¦–å…ˆå°è¯•æå– <suboption> æ ‡ç­¾ï¼ˆæ–°æ ¼å¼ï¼‰\n  const suboptionMatches = text.match(/<suboption>([\\s\\S]*?)<\\/suboption>/gi);\n  if (suboptionMatches && suboptionMatches.length > 0) {\n    const options: string[] = [];\n    suboptionMatches.forEach(match => {\n      const contentMatch = match.match(/<suboption>([\\s\\S]*?)<\\/suboption>/i);\n      if (contentMatch && contentMatch[1]) {\n        const content = contentMatch[1].trim();\n        if (content) {\n          options.push(content);\n        }\n      }\n    });\n    if (options.length > 0) {\n      return options;\n    }\n  }\n\n  // å¦‚æœæ²¡æœ‰æ‰¾åˆ° <suboption>ï¼Œå›é€€åˆ°æ—§çš„ <option> æ ¼å¼ï¼ˆå…¼å®¹æ€§ï¼‰\n  const optionMatches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!optionMatches || optionMatches.length === 0) {\n    return [];\n  }\n\n  // æå–æ¯ä¸ª option çš„å†…å®¹ï¼ˆæ—§æ ¼å¼ï¼‰\n  const options: string[] = [];\n  optionMatches.forEach(match => {\n    const contentMatch = match.match(/<option>([\\s\\S]*?)<\\/option>/i);\n    if (contentMatch && contentMatch[1]) {\n      const content = contentMatch[1].trim();\n      if (content) {\n        // å°è¯•æŒ‰è¡Œåˆ†å‰²ï¼Œæ¯è¡Œä½œä¸ºä¸€ä¸ªé€‰é¡¹ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰\n        const lines = content.split('\\n').map(line => line.trim()).filter(line => line);\n        if (lines.length > 1) {\n          // å¤šè¡Œï¼Œæ¯è¡Œä½œä¸ºä¸€ä¸ªé€‰é¡¹\n          options.push(...lines);\n        } else {\n          // å•è¡Œï¼Œç›´æ¥æ·»åŠ \n          options.push(content);\n        }\n      }\n    }\n  });\n\n  return options;\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <sum> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastSum(text: string): string {\n  const matches = text.match(/<sum>([\\s\\S]*?)<\\/sum>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <UpdateVariable> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastUpdateVariable(text: string): string {\n  const matches = text.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/i);\n  if (!contentMatch) {\n    return '';\n  }\n\n  const content = contentMatch[1].trim();\n\n  // ç›´æ¥è¿”å›åŸå§‹å†…å®¹ï¼Œä¸è¿›è¡Œä»»ä½•è½¬æ¢\n  // MVU ç³»ç»Ÿå¯èƒ½ç›´æ¥æ”¯æŒ JSONPatch æ ¼å¼ï¼Œè½¬æ¢åè€Œä¼šå¯¼è‡´é—®é¢˜\n  console.log('ğŸ“ æå–åˆ° <UpdateVariable> åŸå§‹å†…å®¹ï¼Œç›´æ¥ä¿ç•™ï¼Œä¸è¿›è¡Œè½¬æ¢');\n  return content;\n}\n\n/**\n * éªŒè¯æ¶ˆæ¯æ˜¯å¦ç¬¦åˆè§„èŒƒï¼ˆè‡³å°‘åŒ…å« maintext å’Œ optionï¼‰\n */\nexport function validateMessage(messageContent: string): boolean {\n  if (!messageContent || typeof messageContent !== 'string') {\n    return false;\n  }\n\n  // ç§»é™¤ thinking æ ‡ç­¾åå†éªŒè¯\n  const cleaned = removeThinkingTags(messageContent);\n  const maintext = extractLastMaintext(cleaned);\n  const option = extractLastOption(cleaned);\n\n  if (!maintext || !option) {\n    console.warn('âš ï¸ æ¶ˆæ¯ç¼ºå°‘ <maintext> æˆ– <option> æ ‡ç­¾');\n    return false;\n  }\n\n  return true;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { GameData, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\ndeclare function getLastMessageId(): number;\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ä» MVU å˜é‡ç³»ç»Ÿè¯»å–æ¸¸æˆæ•°æ®\n */\nexport async function readGameData(): Promise<any> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    if (typeof waitGlobalInitialized !== 'undefined') {\n      await waitGlobalInitialized('Mvu');\n    }\n\n    // ä» MVU ç³»ç»Ÿè¯»å– stat_data\n    if (typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n      // åˆå¹¶å¤šä¸ªæ¥æºï¼šinit(0) -> latest message -> chatï¼ˆchat ä¼˜å…ˆè¦†ç›–ï¼‰ï¼Œç”¨äºè¡¥é½ç¼ºå¤±å­—æ®µ\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      try {\n        chatData = Mvu.getMvuData({ type: 'chat' });\n      } catch {\n        // ignore\n      }\n\n      const merged = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      return _.get(merged, 'stat_data') || {};\n    }\n\n    // é™çº§ï¼šä»é…’é¦†å˜é‡ç³»ç»Ÿè¯»å–\n    const variables = getVariables({ type: 'message' });\n    const gameData = variables.game_data || variables.stat_data || {};\n    return gameData;\n  } catch (error) {\n    console.warn('è¯»å–æ¸¸æˆæ•°æ®å¤±è´¥:', error);\n    return {};\n  }\n}\n\n/**\n * æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£\n * é€šè¿‡æ£€æŸ¥ assistant æ¶ˆæ¯æ•°é‡æ¥åˆ¤æ–­ï¼š\n * - assistant æ¶ˆæ¯åªæœ‰ 1 æ¡ï¼šæ–°å¼€çš„æ¡£ï¼ˆå¼€åœºç™½ï¼‰ï¼Œè¿”å› falseï¼Œæ˜¾ç¤ºå¼€å§‹ç•Œé¢\n * - assistant æ¶ˆæ¯ > 1 æ¡ï¼šç»§ç»­æ¸¸æˆï¼Œè¿”å› trueï¼Œç›´æ¥è¿›å…¥æ¸¸æˆç•Œé¢\n */\nexport function hasSaveData(): boolean {\n  try {\n    // æ£€æŸ¥ assistant æ¶ˆæ¯æ•°é‡\n    const lastMessageId = getLastMessageId();\n    if (lastMessageId < 0) {\n      return false; // æ²¡æœ‰æ¶ˆæ¯ï¼Œè‚¯å®šæ²¡æœ‰å­˜æ¡£\n    }\n\n    // è·å–æ‰€æœ‰ assistant æ¶ˆæ¯\n    const messages = getChatMessages(`0-${lastMessageId}`, { role: 'assistant' });\n\n    // åªæœ‰ 1 æ¡ assistant æ¶ˆæ¯ï¼šæ–°å¼€çš„æ¡£ï¼ˆå¼€åœºç™½ï¼‰ï¼Œåº”è¯¥æ˜¾ç¤ºå¼€å§‹ç•Œé¢\n    // å¤šäº 1 æ¡ assistant æ¶ˆæ¯ï¼šç»§ç»­æ¸¸æˆ\n    return messages && messages.length > 1;\n  } catch (error) {\n    console.warn('æ£€æŸ¥å­˜æ¡£çŠ¶æ€å¤±è´¥:', error);\n    return false;\n  }\n}\n\n/**\n * è¯»å–æ¸¸æˆé…ç½®\n */\nexport function readGameConfig(): Partial<GameConfig> {\n  try {\n    const variables = getVariables({ type: 'message' });\n    const config = variables.game_config || {};\n    return config as Partial<GameConfig>;\n  } catch (error) {\n    console.warn('è¯»å–æ¸¸æˆé…ç½®å¤±è´¥:', error);\n    return {};\n  }\n}\n","import { ComponentCallbacks } from '../types/types';\nimport { hasSaveData } from '../utils/variableReader';\n\n/**\n * æ ‡é¢˜é¡µé¢ç»„ä»¶\n */\nexport class SplashScreen {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen splash-screen';\n    div.id = 'splash-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    this.updateContinueButton();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      this.updateContinueButton();\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬å™¨\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  private updateContinueButton(): void {\n    if (!this.element) return;\n\n    const continueButton = this.element.querySelector('#continue-button') as HTMLElement;\n    if (continueButton) {\n      if (hasSaveData()) {\n        continueButton.style.display = 'flex';\n      } else {\n        continueButton.style.display = 'none';\n      }\n    }\n  }\n\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    const newGameButton = this.element.querySelector('#new-game-button');\n    if (newGameButton) {\n      newGameButton.addEventListener('click', () => {\n        this.callbacks.onNewGame?.();\n      });\n    }\n\n    const continueButton = this.element.querySelector('#continue-button');\n    if (continueButton) {\n      continueButton.addEventListener('click', () => {\n        this.callbacks.onContinue?.();\n      });\n    }\n\n    const fullscreenButton = this.element.querySelector('#fullscreen-button');\n    if (fullscreenButton) {\n      fullscreenButton.addEventListener('click', () => {\n        this.requestFullscreen();\n      });\n    }\n\n    // Enteré”®æ”¯æŒï¼šå…¨å±\n    this.keyDownHandler = (e: KeyboardEvent) => {\n      if (e.key === 'Enter' && this.element?.classList.contains('active')) {\n        e.preventDefault();\n        this.requestFullscreen();\n      }\n    };\n    document.addEventListener('keydown', this.keyDownHandler);\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"splash-screen-content\">\n        <div class=\"splash-header\">\n          <div class=\"splash-logo\">\n            <i class=\"fas fa-anchor\"></i>\n          </div>\n          <h1 class=\"splash-title\">é”š</h1>\n          <p class=\"splash-subtitle\">ANCHOR</p>\n        </div>\n        <div class=\"splash-actions\">\n          <button type=\"button\" class=\"splash-button primary\" id=\"new-game-button\">\n            <i class=\"fas fa-play\"></i>\n            <span>å¼€å§‹æ–°æ¸¸æˆ</span>\n          </button>\n          <button type=\"button\" class=\"splash-button secondary\" id=\"continue-button\" style=\"display: none;\">\n            <i class=\"fas fa-redo\"></i>\n            <span>ç»§ç»­æ¸¸æˆ</span>\n          </button>\n          <button type=\"button\" class=\"splash-button icon-only\" id=\"fullscreen-button\" title=\"åˆ‡æ¢å…¨å± (Enter)\">\n            <i class=\"fas fa-expand\"></i>\n          </button>\n        </div>\n        <div class=\"splash-footer\">\n          <p class=\"splash-copyright\">Â© 2024 é”š</p>\n          <p class=\"splash-author\">åŸºäºé…’é¦†åŠ©æ‰‹å¼€å‘</p>\n          <p class=\"splash-hint\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-tertiary);\">æŒ‰ Enter é”®å…¨å±</p>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const toastr: any;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * å¼€å±€è®¾ç½®é¡µé¢ç»„ä»¶\n */\nexport class NewGameSetup {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen setup-screen';\n    div.id = 'setup-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    // å®æ—¶æ›´æ–° MVU å˜é‡ï¼ˆå½“ç”¨æˆ·è¾“å…¥æ—¶ï¼‰\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    if (reserveInput) {\n      reserveInput.addEventListener('input', async () => {\n        const config = this.getConfig();\n        if (config.reserve !== undefined) {\n          await this.updateMvuVariable(config.reserve);\n        }\n      });\n    }\n\n    const confirmButton = this.element.querySelector('#setup-confirm-button');\n    if (confirmButton) {\n      confirmButton.addEventListener('click', () => {\n        const reserveInput = this.element?.querySelector('#energy-reserve') as HTMLInputElement;\n        const inputValue = reserveInput?.value?.trim() || '';\n\n        // éªŒè¯è¾“å…¥\n        if (!inputValue) {\n          toastr.error('è¯·è¾“å…¥ç³»ç»Ÿå‰©ä½™èƒ½æº', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        // æ£€æŸ¥æ˜¯å¦ä¸ºæ•´æ•°ï¼ˆä¸å…è®¸å°æ•°ç‚¹ï¼‰\n        if (inputValue.includes('.')) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»æ˜¯æ•´æ•°', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        const reserve = parseInt(inputValue, 10);\n        if (isNaN(reserve)) {\n          toastr.error('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        if (!Number.isInteger(reserve)) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»æ˜¯æ•´æ•°', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        if (reserve < 0 || reserve > 100000) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»åœ¨ 0-100000 ä¹‹é—´', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        const config: GameConfig = { reserve };\n        this.callbacks.onConfirm?.(config);\n      });\n    }\n\n    const cancelButton = this.element.querySelector('#setup-cancel-button');\n    if (cancelButton) {\n      cancelButton.addEventListener('click', () => {\n        this.callbacks.onCancel?.();\n      });\n    }\n  }\n\n  private async updateMvuVariable(value: number): Promise<void> {\n    try {\n      // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n      if (typeof waitGlobalInitialized !== 'undefined') {\n        await waitGlobalInitialized('Mvu');\n      }\n\n      if (typeof Mvu === 'undefined' || !Mvu.getMvuData || !Mvu.replaceMvuData) {\n        console.warn('âš ï¸ MVU ä¸å¯ç”¨ï¼Œè·³è¿‡å®æ—¶æ›´æ–°');\n        return;\n      }\n\n      // è·å–å½“å‰çš„ MVU æ•°æ®\n      // åˆå¹¶ init(0) / latest message / chatï¼ˆchat ä¼˜å…ˆï¼‰ï¼Œé¿å…åªå†™ reserve å¯¼è‡´ system_state ç»“æ„æ®‹ç¼º\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      chatData = Mvu.getMvuData({ type: 'chat' });\n\n      const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      const currentStatData = currentMvuData?.stat_data || {};\n\n      // æ„å»ºæ›´æ–°åçš„ stat_data\n      const updatedStatData = { ...currentStatData };\n\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // ç¡®ä¿ reserve åœ¨ 0-100000 èŒƒå›´å†…\n      updatedStatData.system_state.antimatter.reserve = Math.max(0, Math.min(100000, value));\n\n      // å°†æ›´æ–°åçš„æ•°æ®å†™å› MVU\n      const updatedMvuData = {\n        ...currentMvuData,\n        stat_data: updatedStatData,\n      };\n\n      await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n      console.info(`âœ… å®æ—¶æ›´æ–° MVU å˜é‡ reserve: ${value}`);\n    } catch (error) {\n      console.warn(`âš ï¸ å®æ—¶æ›´æ–° MVU å˜é‡ reserve å¤±è´¥:`, error);\n    }\n  }\n\n  private getConfig(): GameConfig {\n    if (!this.element) {\n      return {};\n    }\n\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    return {\n      reserve: reserveInput?.value ? parseInt(reserveInput.value, 10) : undefined,\n    };\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"setup-screen-content\">\n        <div class=\"setup-header\">\n          <h1 class=\"setup-title\">æ–°æ¸¸æˆè®¾ç½®</h1>\n          <p class=\"setup-subtitle\">é…ç½®æ‚¨çš„æ¸¸æˆ</p>\n        </div>\n        <div class=\"setup-form\">\n          <div class=\"setup-form-group\">\n            <label class=\"setup-label\" for=\"energy-reserve\">ç³»ç»Ÿå‰©ä½™èƒ½æº</label>\n            <input\n              type=\"number\"\n              id=\"energy-reserve\"\n              class=\"setup-input\"\n              min=\"0\"\n              max=\"100000\"\n              step=\"1\"\n              placeholder=\"è¾“å…¥ç³»ç»Ÿå‰©ä½™èƒ½æº\"\n              required\n            />\n            <small style=\"color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;\">\n              èŒƒå›´ï¼š0 - 100000ï¼ˆæ•´æ•°ï¼‰\n            </small>\n          </div>\n        </div>\n        <div class=\"setup-actions\">\n          <button type=\"button\" class=\"setup-button secondary\" id=\"setup-cancel-button\">\n            <i class=\"fas fa-times\"></i>\n            <span>å–æ¶ˆ</span>\n          </button>\n          <button type=\"button\" class=\"setup-button primary\" id=\"setup-confirm-button\">\n            <i class=\"fas fa-check\"></i>\n            <span>ç¡®è®¤</span>\n          </button>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { waitUntil } from 'async-wait-until';\nimport _ from 'lodash';\nimport { ComponentCallbacks, GameData } from '../types/types';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): { stop: () => void };\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  CHAT_CHANGED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  events: {\n    VARIABLE_UPDATE_ENDED: 'mag_variable_update_ended';\n  };\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ä¸»æ¸¸æˆç•Œé¢ç»„ä»¶ï¼ˆDashboardï¼‰\n */\nexport class Dashboard {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n  private gameData: Partial<GameData> = {};\n  private loadedMessageIds: Set<number> = new Set(); // è®°å½•å·²åŠ è½½çš„æ¶ˆæ¯IDï¼Œé¿å…é‡å¤æ˜¾ç¤º\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n  private mvuUpdateListener: { stop: () => void } | null = null;\n  private statusRetryCount = 0;\n  private statusRetryTimer: number | null = null;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    try {\n      const div = document.createElement('div');\n      div.className = 'screen main-screen';\n      div.id = 'main-screen';\n      div.innerHTML = this.getHTML();\n      this.element = div;\n\n      // ç»‘å®šäº‹ä»¶ï¼ˆåœ¨è®¾ç½® innerHTML ä¹‹åï¼‰\n      this.bindEvents();\n\n      // åˆ›å»ºåç«‹å³æ¸²æŸ“é»˜è®¤æ•°æ®\n      this.refreshData();\n\n      console.log('âœ… Dashboard å…ƒç´ å·²åˆ›å»º');\n      return div;\n    } catch (error) {\n      console.error('âŒ åˆ›å»º Dashboard å…ƒç´ å¤±è´¥:', error);\n      // åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ div ä½œä¸ºé™çº§æ–¹æ¡ˆ\n      const fallbackDiv = document.createElement('div');\n      fallbackDiv.className = 'screen main-screen';\n      fallbackDiv.id = 'main-screen';\n      fallbackDiv.innerHTML = '<div style=\"padding: 2rem; color: var(--text-primary);\">é”šåŠ è½½ä¸­...</div>';\n      this.element = fallbackDiv;\n      return fallbackDiv;\n    }\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      // æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®\n      try {\n        this.refreshData();\n        console.log('âœ… Dashboard æ•°æ®å·²åˆ·æ–°');\n      } catch (error) {\n        console.error('âŒ Dashboard åˆ·æ–°æ•°æ®å¤±è´¥:', error);\n        // å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ˜¾ç¤º\n      }\n    } else {\n      console.error('âŒ Dashboard element ä¸º nullï¼Œæ— æ³•æ˜¾ç¤º');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬å™¨\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n\n    if (this.mvuUpdateListener) {\n      this.mvuUpdateListener.stop();\n      this.mvuUpdateListener = null;\n    }\n\n    if (this.statusRetryTimer !== null) {\n      window.clearTimeout(this.statusRetryTimer);\n      this.statusRetryTimer = null;\n    }\n  }\n\n  public updateGameData(data: Partial<GameData>): void {\n    this.gameData = { ...this.gameData, ...data };\n    this.refreshData();\n  }\n\n  private refreshData(): void {\n    if (!this.element) {\n      console.warn('âš ï¸ Dashboard element ä¸º nullï¼Œæ— æ³•åˆ·æ–°æ•°æ®');\n      return;\n    }\n\n    try {\n      // æ›´æ–°çŠ¶æ€å¡ç‰‡ï¼ˆå¼‚æ­¥ï¼Œä» MVU å˜é‡è¯»å–ï¼‰\n      this.updateStatusCards().catch(error => {\n        console.warn('âš ï¸ æ›´æ–°çŠ¶æ€å¡ç‰‡å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n      });\n\n      // æ›´æ–°ä»»åŠ¡åˆ—è¡¨\n      this.updateTasksList();\n\n      // æ›´æ–°æ—¥è®°åˆ—è¡¨\n      this.updateDiaryList();\n\n      // æ›´æ–°èŠå¤©æ¶ˆæ¯ï¼ˆç°åœ¨ç”± dashboardLogic.ts ç®¡ç†ï¼Œè¿™é‡Œä¸å†æ›´æ–°ï¼‰\n      // this.updateChatMessages();\n\n      // è¯»å–å¹¶æ˜¾ç¤º maintextï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…åœ¨åˆå§‹åŒ–æ—¶å‡ºé”™ï¼‰\n      setTimeout(() => {\n        try {\n          this.loadMaintextFromChat();\n        } catch (error) {\n          console.warn('âš ï¸ åŠ è½½ maintext å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n        }\n      }, 100);\n\n      console.info('âœ… æ¸¸æˆæ•°æ®å·²åˆ·æ–°');\n    } catch (error) {\n      console.error('âŒ åˆ·æ–°æ•°æ®æ—¶å‡ºé”™:', error);\n      // å³ä½¿å‡ºé”™ä¹Ÿç»§ç»­ï¼Œé¿å…å®Œå…¨æ— æ³•æ˜¾ç¤º\n    }\n  }\n\n  private async updateStatusCards(): Promise<void> {\n    if (!this.element) return;\n\n    const statusGrid = this.element.querySelector('#status-grid');\n    if (!statusGrid) return;\n\n    try {\n      // ä» MVU å˜é‡ç³»ç»Ÿè¯»å– system_state æ•°æ®\n      // å…³é”®ï¼šé¿å…â€œåˆšè¿›å…¥ç•Œé¢æ—¶ MVU è¿˜æœªæŠŠ stat_data æ³¨å…¥ -> è¯»ä¸åˆ° -> è½åˆ°é»˜è®¤å€¼ä¸”ä¸å†åˆ·æ–°â€\n      await waitGlobalInitialized('Mvu');\n      await waitUntil(() => _.has(getVariables({ type: 'message' }), 'stat_data'), {\n        timeout: 3000,\n        intervalBetweenAttempts: 100,\n      }).catch(() => {\n        // timeout ä¸ç®—è‡´å‘½ï¼šä¸‹é¢ä¼šå±•ç¤ºâ€œåŠ è½½ä¸­â€¦â€ï¼Œå¹¶è‡ªåŠ¨é‡è¯•\n      });\n\n      // ä¼˜å…ˆä» chat å˜é‡è¡¨è¯»å–ï¼ˆä½œä¸ºâ€œå½“å‰çŠ¶æ€â€æ¥æºï¼‰\n      const chatData = Mvu.getMvuData({ type: 'chat' });\n      const chatSystemState = _.get(chatData, 'stat_data.system_state');\n\n      // å…œåº•æ¥æºï¼šlatest message + 0 å±‚ï¼ˆinitvarï¼‰ï¼Œç”¨äºè¡¥é½ç¼ºå¤±å­—æ®µ\n      let latestSystemState: any = null;\n      let initSystemState: any = null;\n      try {\n        const latest = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n        latestSystemState = _.get(latest, 'stat_data.system_state');\n      } catch (e) {\n        console.warn('âš ï¸ è¯»å– latest message çš„ system_state å¤±è´¥:', e);\n      }\n      try {\n        const initMsg = Mvu.getMvuData({ type: 'message', message_id: 0 });\n        initSystemState = _.get(initMsg, 'stat_data.system_state');\n      } catch (e) {\n        // message 0 å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥\n      }\n\n      // åˆå¹¶ï¼šinit -> latest -> chatï¼ˆchat ä¼˜å…ˆè¦†ç›–ï¼‰\n      const systemState: any = _.merge({}, initSystemState || {}, latestSystemState || {}, chatSystemState || {});\n\n      const hasSystemStateData =\n        systemState &&\n        (systemState.cycle !== undefined ||\n          systemState.system_pressure !== undefined ||\n          systemState.instability !== undefined ||\n          !!systemState.population ||\n          !!systemState.antimatter);\n\n      // ä»ç„¶æ²¡æœ‰ï¼šä¸è¦ç”¨å‡é»˜è®¤å€¼è¦†ç›–ï¼›æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€å¹¶é‡è¯•\n      if (!hasSystemStateData) {\n        statusGrid.innerHTML = '<div class=\"status-empty\">ç³»ç»ŸçŠ¶æ€åŠ è½½ä¸­â€¦</div>';\n\n        if (this.statusRetryCount < 10) {\n          this.statusRetryCount += 1;\n          if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n          this.statusRetryTimer = window.setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 250);\n        }\n        return;\n      }\n\n      // è¯»åˆ°äº†å°±æ¸…ç†é‡è¯•çŠ¶æ€\n      this.statusRetryCount = 0;\n      if (this.statusRetryTimer !== null) {\n        window.clearTimeout(this.statusRetryTimer);\n        this.statusRetryTimer = null;\n      }\n\n      // æ ¹æ® initvar ä¸­çš„å˜é‡ç»“æ„æ¸²æŸ“çŠ¶æ€å¡ç‰‡\n      const cards: string[] = [];\n\n      // Cycle (æ—¶é—´è®¡æ•°å•ä½)\n      if (systemState.cycle !== undefined) {\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-clock status-card-icon\"></i>\n              <span class=\"status-card-title\">æ—¶é—´å‘¨æœŸ</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${systemState.cycle}</span>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Antimatter (åç‰©è´¨)\n      if (systemState.antimatter) {\n        const reserve = systemState.antimatter.reserve ?? 0;\n        const leakRisk = systemState.antimatter.leak_risk ?? 0;\n        const reservePercent = Math.round((reserve / 100000) * 100);\n        const riskLevel = leakRisk < 0.3 ? 'low' : leakRisk < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-atom status-card-icon\"></i>\n              <span class=\"status-card-title\">åç‰©è´¨å‚¨å¤‡</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${reserve.toLocaleString()}</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill\" style=\"width: ${reservePercent}%\"></div>\n                </div>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  æ³„æ¼é£é™©: <span class=\"risk-${riskLevel}\">${(leakRisk * 100).toFixed(1)}%</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Population (äººå£)\n      if (systemState.population) {\n        const pop = systemState.population;\n        const active = pop.active ?? 0;\n        const standby = pop.standby ?? 0;\n        const archived = pop.archived ?? 0;\n        const total = active + standby + archived;\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-users status-card-icon\"></i>\n              <span class=\"status-card-title\">äººå£ç»Ÿè®¡</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${total}</span>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  å¯ç”¨: ${active} | å¾…æœº: ${standby} | å½’æ¡£: ${archived}\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // System Pressure (ç³»ç»Ÿå‹åŠ›)\n      if (systemState.system_pressure !== undefined) {\n        const pressure = systemState.system_pressure ?? 0;\n        const pressurePercent = Math.round(pressure * 100);\n        const pressureLevel = pressure < 0.5 ? 'low' : pressure < 0.8 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-tachometer-alt status-card-icon\"></i>\n              <span class=\"status-card-title\">ç³»ç»Ÿå‹åŠ›</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${pressurePercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${pressureLevel}\" style=\"width: ${pressurePercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Instability (ç³»ç»Ÿä¸ç¨³å®šæ€§)\n      if (systemState.instability !== undefined) {\n        const instability = systemState.instability ?? 0;\n        const instabilityPercent = Math.round(instability * 100);\n        const instabilityLevel = instability < 0.3 ? 'low' : instability < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-exclamation-triangle status-card-icon\"></i>\n              <span class=\"status-card-title\">ç³»ç»Ÿä¸ç¨³å®šæ€§</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${instabilityPercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${instabilityLevel}\" style=\"width: ${instabilityPercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      if (cards.length > 0) {\n        statusGrid.innerHTML = cards.join('');\n      } else {\n        statusGrid.innerHTML = '<div class=\"status-empty\">æš‚æ— ç³»ç»ŸçŠ¶æ€æ•°æ®</div>';\n      }\n    } catch (error) {\n      console.error('âŒ æ›´æ–°çŠ¶æ€å¡ç‰‡å¤±è´¥:', error);\n      statusGrid.innerHTML = '<div class=\"status-empty\">åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥</div>';\n    }\n  }\n\n  private updateTasksList(): void {\n    if (!this.element) return;\n\n    const tasksList = this.element.querySelector('#tasks-list');\n    if (!tasksList) return;\n\n    // å¦‚æœgameData.taskså­˜åœ¨ä¸”æ˜¯æ•°ç»„ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤ä»»åŠ¡\n    const tasks =\n      this.gameData.tasks && Array.isArray(this.gameData.tasks) && this.gameData.tasks.length > 0\n        ? this.gameData.tasks\n        : this.getDefaultTasks();\n\n    tasksList.innerHTML = tasks\n      .map(\n        task => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas ${this.getTaskIcon(task.status)}\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(task.title)}</span>\n            <span class=\"entry-status ${task.status}\">${this.getStatusText(task.status)}</span>\n          </div>\n          <div class=\"entry-meta\">\n            <span class=\"entry-time\">${task.time}</span>\n            <span class=\"entry-priority priority-${task.priority}\">${this.getPriorityText(task.priority)}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(task.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateDiaryList(): void {\n    if (!this.element) return;\n\n    const diaryList = this.element.querySelector('#diary-list');\n    if (!diaryList) return;\n\n    // å¦‚æœgameData.diaryå­˜åœ¨ä¸”æ˜¯æ•°ç»„ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ—¥è®°\n    const diary =\n      this.gameData.diary && Array.isArray(this.gameData.diary) && this.gameData.diary.length > 0\n        ? this.gameData.diary\n        : this.getDefaultDiary();\n\n    diaryList.innerHTML = diary\n      .map(\n        entry => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas fa-book-open\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(entry.title)}</span>\n            <span class=\"entry-date\">${entry.date}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(entry.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateChatMessages(): void {\n    // æ³¨æ„ï¼šé€šè®¯æ¨¡å—çš„æ¶ˆæ¯ç°åœ¨ç”± dashboardLogic.ts ä¸­çš„ initChatInterface ç®¡ç†\n    // è¿™é‡Œä¸å†æ›´æ–°ï¼Œé¿å…å†²çª\n    // é€šè®¯æ¨¡å—ä¼šä» getChatMessages è¯»å–å†å²æ¶ˆæ¯\n  }\n\n  private getDefaultTasks() {\n    return [\n      {\n        id: '1',\n        title: 'ç»´æŠ¤èƒ½æºç³»ç»Ÿ',\n        status: 'completed' as const,\n        priority: 'high' as const,\n        time: '01-15 14:30',\n        description: 'æ£€æŸ¥å¹¶ç»´æŠ¤ç©ºé—´ç«™èƒ½æºç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡æ­£å¸¸è¿è¡Œ',\n      },\n      {\n        id: '2',\n        title: 'ç‰©èµ„è¡¥ç»™ä»»åŠ¡',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 10:00',\n        description: 'æ¥æ”¶å¹¶åˆ†é…æ–°ä¸€æ‰¹ç‰©èµ„è¡¥ç»™ï¼Œæ›´æ–°åº“å­˜è®°å½•',\n      },\n      {\n        id: '3',\n        title: 'ç´§æ€¥ç»´ä¿®ä»»åŠ¡',\n        status: 'pending' as const,\n        priority: 'urgent' as const,\n        time: '01-15 16:00',\n        description: 'æ£€æµ‹åˆ°ç”Ÿå‘½ç»´æŒç³»ç»Ÿå¼‚å¸¸ï¼Œéœ€è¦ç«‹å³è¿›è¡Œç»´ä¿®æ£€æŸ¥',\n      },\n      {\n        id: '4',\n        title: 'å®éªŒæ•°æ®åˆ†æ',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 09:00',\n        description: 'åˆ†ææœ€æ–°å®éªŒæ•°æ®ï¼Œç”ŸæˆæŠ¥å‘Šå¹¶ä¸Šä¼ è‡³ç³»ç»Ÿ',\n      },\n      {\n        id: '5',\n        title: 'é€šä¿¡ç³»ç»Ÿæ ¡å‡†',\n        status: 'pending' as const,\n        priority: 'low' as const,\n        time: '01-16 08:00',\n        description: 'å®šæœŸæ ¡å‡†é€šä¿¡ç³»ç»Ÿï¼Œç¡®ä¿ä¸åœ°çƒæ€»éƒ¨çš„ç¨³å®šè¿æ¥',\n      },\n      {\n        id: '6',\n        title: 'é˜²æŠ¤ç³»ç»Ÿæ£€æŸ¥',\n        status: 'pending' as const,\n        priority: 'high' as const,\n        time: '01-16 10:00',\n        description: 'æ£€æŸ¥ç©ºé—´ç«™é˜²æŠ¤ç³»ç»Ÿï¼ŒåŒ…æ‹¬è¾å°„é˜²æŠ¤å’Œå¾®é™¨çŸ³é˜²æŠ¤',\n      },\n      {\n        id: '7',\n        title: 'ç³»ç»Ÿå¤‡ä»½',\n        status: 'completed' as const,\n        priority: 'medium' as const,\n        time: '01-15 03:00',\n        description: 'å®Œæˆæ¯æ—¥ç³»ç»Ÿæ•°æ®å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨',\n      },\n      {\n        id: '8',\n        title: 'äººå‘˜è½®æ¢',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 12:00',\n        description: 'æ‰§è¡Œäººå‘˜è½®æ¢è®¡åˆ’ï¼Œç¡®ä¿å„å²—ä½æ­£å¸¸è¿è½¬',\n      },\n    ];\n  }\n\n  private getDefaultDiary() {\n    return [\n      {\n        id: '1',\n        title: 'æ—¥å¸¸è®°å½•',\n        date: '01-15',\n        description: 'ç©ºé—´ç«™è¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰ç³»ç»ŸæŒ‡æ ‡åœ¨å®‰å…¨èŒƒå›´å†…ã€‚å®Œæˆèƒ½æºç³»ç»Ÿä¾‹è¡Œæ£€æŸ¥ï¼Œæœªå‘ç°å¼‚å¸¸ã€‚',\n      },\n      {\n        id: '2',\n        title: 'ç‰©èµ„è¡¥ç»™',\n        date: '01-14',\n        description: 'æ¥æ”¶æ–°ä¸€æ‰¹ç‰©èµ„è¡¥ç»™ï¼ŒåŒ…æ‹¬é£Ÿç‰©ã€åŒ»ç–—ç”¨å“å’Œå·¥ç¨‹ææ–™ã€‚å·²æŒ‰æ ‡å‡†æµç¨‹æ¸…ç‚¹å’Œåˆ†é…ã€‚',\n      },\n      {\n        id: '3',\n        title: 'ç³»ç»Ÿç»´æŠ¤',\n        date: '01-13',\n        description: 'è¿›è¡Œæœˆåº¦ç³»ç»Ÿç»´æŠ¤ï¼Œæ›´æ–°éƒ¨åˆ†è€åŒ–è®¾å¤‡ã€‚ç»´æŠ¤è¿‡ç¨‹æœªå‘ç°é‡å¤§é—®é¢˜ï¼Œè¿è¡Œç¨³å®šã€‚',\n      },\n      {\n        id: '4',\n        title: 'å®éªŒæŠ¥å‘Š',\n        date: '01-12',\n        description: 'å®Œæˆç¬¬47æ¬¡é›¶é‡åŠ›å®éªŒï¼Œæ•°æ®é‡‡é›†æ­£å¸¸ã€‚åˆæ­¥åˆ†ææ˜¾ç¤ºå®éªŒç»“æœç¬¦åˆé¢„æœŸã€‚',\n      },\n      {\n        id: '5',\n        title: 'é€šä¿¡æ—¥å¿—',\n        date: '01-11',\n        description: 'ä¸åœ°çƒæ€»éƒ¨å»ºç«‹ç¨³å®šè¿æ¥ï¼Œå»¶è¿Ÿ12msã€‚æ¥æ”¶æœ€æ–°æŒ‡ä»¤ï¼Œå‡†å¤‡æ‰§è¡Œä¸‹ä¸€é˜¶æ®µä»»åŠ¡ã€‚',\n      },\n      {\n        id: '6',\n        title: 'å®‰å…¨æ£€æŸ¥',\n        date: '01-10',\n        description: 'å®Œæˆæ¯å‘¨å®‰å…¨æ£€æŸ¥ï¼Œæ‰€æœ‰é˜²æŠ¤ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚è¾å°„æ°´å¹³åœ¨å®‰å…¨èŒƒå›´å†…ã€‚',\n      },\n      {\n        id: '7',\n        title: 'äººå‘˜æ—¥å¿—',\n        date: '01-09',\n        description: 'æ‰§è¡Œäººå‘˜å¥åº·æ£€æŸ¥ï¼Œæ‰€æœ‰æˆå‘˜èº«ä½“çŠ¶å†µè‰¯å¥½ã€‚å®Œæˆå¿ƒç†è¯„ä¼°ï¼ŒçŠ¶æ€æ­£å¸¸ã€‚',\n      },\n      {\n        id: '8',\n        title: 'ç³»ç»Ÿæ›´æ–°',\n        date: '01-08',\n        description: 'å®‰è£…ç³»ç»Ÿè¡¥ä¸v2.3.1ï¼Œä¿®å¤å·²çŸ¥æ¼æ´ã€‚é‡å¯åç³»ç»Ÿè¿è¡Œç¨³å®šï¼Œæ€§èƒ½æå‡5%ã€‚',\n      },\n    ];\n  }\n\n  private getDefaultMessages() {\n    return [\n      { id: '1', role: 'user' as const, content: 'ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ç©ºé—´ç«™çš„å½“å‰çŠ¶æ€ã€‚', time: '14:32' },\n      {\n        id: '2',\n        role: 'assistant' as const,\n        content:\n          'æ‚¨å¥½ï¼ç©ºé—´ç«™å½“å‰è¿è¡ŒçŠ¶æ€è‰¯å¥½ã€‚èƒ½æºç³»ç»Ÿï¼š87%ï¼Œç”Ÿå‘½ç»´æŒç³»ç»Ÿï¼š92%ï¼Œç³»ç»Ÿå®Œæ•´æ€§ï¼š78%ã€‚æ‰€æœ‰å…³é”®æŒ‡æ ‡å‡åœ¨å®‰å…¨èŒƒå›´å†…ã€‚éœ€è¦æˆ‘è¯¦ç»†è¯´æ˜æŸä¸ªç³»ç»Ÿçš„çŠ¶æ€å—ï¼Ÿ',\n        time: '14:32',\n      },\n      { id: '3', role: 'user' as const, content: 'èƒ½æºç³»ç»Ÿçš„è¯¦ç»†æƒ…å†µå¦‚ä½•ï¼Ÿ', time: '14:33' },\n      {\n        id: '4',\n        role: 'assistant' as const,\n        content:\n          'èƒ½æºç³»ç»Ÿå½“å‰è¿è¡Œåœ¨87%çš„å®¹é‡æ°´å¹³ã€‚ä¸»è¦èƒ½æºæ¥æºåŒ…æ‹¬å¤ªé˜³èƒ½ç”µæ± æ¿å’Œå¤‡ç”¨æ ¸èƒ½å‘ç”µæœºã€‚æœ€è¿‘ä¸€æ¬¡æ£€æŸ¥æ˜¾ç¤ºæ‰€æœ‰ç»„ä»¶è¿è¡Œæ­£å¸¸ï¼Œé¢„è®¡å¯ä»¥ç»´æŒå½“å‰è´Ÿè½½è‡³å°‘30å¤©ã€‚å»ºè®®åœ¨ä¸‹å‘¨è¿›è¡Œä¾‹è¡Œç»´æŠ¤æ£€æŸ¥ã€‚',\n        time: '14:33',\n      },\n    ];\n  }\n\n  private getTaskIcon(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'fa-check-circle';\n      case 'in-progress':\n        return 'fa-clock';\n      case 'pending':\n        return 'fa-exclamation-circle';\n      default:\n        return 'fa-circle';\n    }\n  }\n\n  private getStatusText(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'å®Œæˆ';\n      case 'in-progress':\n        return 'è¿›è¡Œä¸­';\n      case 'pending':\n        return 'å¾…å¤„ç†';\n      default:\n        return status;\n    }\n  }\n\n  private getPriorityText(priority: string): string {\n    switch (priority) {\n      case 'urgent':\n        return 'ç´§æ€¥';\n      case 'high':\n        return 'é«˜';\n      case 'medium':\n        return 'ä¸­';\n      case 'low':\n        return 'ä½';\n      default:\n        return priority;\n    }\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * è§£æ maintext çš„å·¥å…·å‡½æ•°ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰\n   */\n  private parseMaintext(messageContent: string): string {\n    const maintextMatch = messageContent.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n    if (!maintextMatch) {\n      return '';\n    }\n    return maintextMatch[1].trim();\n  }\n\n  /**\n   * ä»æœ€æ–°æ¥¼å±‚è¯»å– maintext å¹¶æ˜¾ç¤ºåœ¨ä¸‰ä¸ªæ–‡æœ¬æ¡†ä¸­\n   * ä¼˜å…ˆä½¿ç”¨ç»“æ„åŒ–æ ‡ç­¾ï¼ˆcontinue_choice, result, decision_nodeï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°æ—§æ ¼å¼\n   */\n  public loadMaintextFromChat(): void {\n    if (!this.element) return;\n\n    try {\n      // æ£€æŸ¥ getChatMessages æ˜¯å¦å¯ç”¨\n      if (typeof getChatMessages === 'undefined') {\n        console.warn('âš ï¸ getChatMessages ä¸å¯ç”¨');\n        return;\n      }\n\n      // 1. å…ˆå°è¯•è·å–æœ€æ–°çš„ assistant æ¶ˆæ¯\n      let messages: Array<{ message: string; message_id: number; role: string }> = [];\n      try {\n        messages = getChatMessages(-1, { role: 'assistant' });\n      } catch (error) {\n        console.warn('âš ï¸ è·å– assistant æ¶ˆæ¯å¤±è´¥:', error);\n      }\n\n      let lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n\n      // 2. å¦‚æœæ²¡æœ‰ assistant æ¶ˆæ¯ï¼Œè·å–æœ€æ–°æ¶ˆæ¯ï¼ˆä¸é™åˆ¶ roleï¼‰\n      if (!lastMessage) {\n        try {\n          messages = getChatMessages(-1);\n          lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n        } catch (error) {\n          console.warn('âš ï¸ è·å–æœ€æ–°æ¶ˆæ¯å¤±è´¥:', error);\n        }\n      }\n\n      if (!lastMessage) {\n        return;\n      }\n\n      // 3. æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™æ¡æ¶ˆæ¯ï¼ˆé¿å…é‡å¤ï¼‰\n      if (this.loadedMessageIds.has(lastMessage.message_id)) {\n        return;\n      }\n\n      // 4. è§£ææ¶ˆæ¯å†…å®¹\n      const messageContent = lastMessage.message || '';\n\n      // åŠ¨æ€å¯¼å…¥ textParser\n      import('../utils/textParser')\n        .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n          const el = this.element;\n          if (!el) return;\n\n          // 5. å°è¯•æå–ç»“æ„åŒ–æ ‡ç­¾\n          const continueChoice = extractContinueChoice(messageContent);\n          const result = extractResult(messageContent);\n          const nextChoice = extractNextChoice(messageContent);\n\n          // 6. è·å–ä¸‰ä¸ªæ–‡æœ¬æ¡†å…ƒç´ \n          const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n          const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n          if (continueChoice || result || nextChoice) {\n            // ä½¿ç”¨ç»“æ„åŒ–æ ‡ç­¾\n            if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n            if (resultArea) resultArea.textContent = result || '';\n            if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n          } else {\n            // å›é€€åˆ°æ—§æ ¼å¼ï¼šå°† maintext å†…å®¹æ˜¾ç¤ºåœ¨ next_choice åŒºåŸŸ\n            const maintext = this.parseMaintext(messageContent);\n            if (nextChoiceArea && maintext) {\n              nextChoiceArea.textContent = maintext;\n            }\n            // æ¸…ç©ºå…¶ä»–ä¸¤ä¸ªåŒºåŸŸ\n            if (continueChoiceArea) continueChoiceArea.textContent = '';\n            if (resultArea) resultArea.textContent = '';\n          }\n\n          // æ ‡è®°å·²åŠ è½½\n          this.loadedMessageIds.add(lastMessage.message_id);\n          console.info(`âœ… å·²åŠ è½½ maintext (message_id: ${lastMessage.message_id})`);\n        })\n        .catch(error => {\n          console.error('âŒ å¯¼å…¥ textParser å¤±è´¥:', error);\n          const el = this.element;\n          if (!el) return;\n          // é™çº§å¤„ç†ï¼šä½¿ç”¨æ—§æ ¼å¼\n          const maintext = this.parseMaintext(messageContent);\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n          if (nextChoiceArea && maintext) {\n            nextChoiceArea.textContent = maintext;\n          }\n        });\n    } catch (error) {\n      console.error('âŒ åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ç›‘å¬æ¶ˆæ¯å˜åŒ–äº‹ä»¶ï¼Œè‡ªåŠ¨æ›´æ–°æ˜¾ç¤º\n   */\n  private setupMessageListener(): void {\n    try {\n      if (typeof eventOn === 'undefined' || typeof tavern_events === 'undefined') {\n        console.warn('âš ï¸ äº‹ä»¶ç›‘å¬ API ä¸å¯ç”¨');\n        return;\n      }\n\n      const handleMessageReceived = () => {\n        // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ¶ˆæ¯å·²å†™å…¥\n        setTimeout(() => {\n          try {\n            this.loadMaintextFromChat();\n            // å…œåº•ï¼šæ¶ˆæ¯å˜åŒ–æ—¶ä¹Ÿåˆ·æ–°çŠ¶æ€æ ï¼ˆé˜²æ­¢ MVU äº‹ä»¶åœ¨æŸäº›é“¾è·¯ä¸è§¦å‘ï¼‰\n            this.updateStatusCards().catch(() => {});\n          } catch (error) {\n            console.error('âŒ å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);\n          }\n        }, 150);\n      };\n\n      // ç›‘å¬ MESSAGE_RECEIVED å’Œ CHAT_CHANGED äº‹ä»¶\n      if (tavern_events.MESSAGE_RECEIVED) {\n        eventOn(tavern_events.MESSAGE_RECEIVED, handleMessageReceived);\n      }\n      if (tavern_events.CHAT_CHANGED) {\n        eventOn(tavern_events.CHAT_CHANGED, handleMessageReceived);\n      }\n      if (tavern_events.MESSAGE_UPDATED) {\n        eventOn(tavern_events.MESSAGE_UPDATED, handleMessageReceived);\n      }\n\n      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ refresh-maintextï¼ˆç”¨äºåœ¨å¯¹è¯å®Œæˆåæ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼‰\n      if (this.element) {\n        this.element.addEventListener('refresh-maintext', () => {\n          setTimeout(() => {\n            this.loadMaintextFromChat();\n          }, 100);\n        });\n        this.element.addEventListener('refresh-status', () => {\n          setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 50);\n        });\n      }\n\n      console.info('âœ… å·²è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');\n    } catch (error) {\n      console.error('âŒ è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨å¤±è´¥:', error);\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) {\n      console.warn('âš ï¸ Dashboard element ä¸º nullï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');\n      return;\n    }\n\n    try {\n      // å…¨å±æŒ‰é’®\n      const fullscreenButton = this.element.querySelector('#dashboard-fullscreen-button');\n      if (fullscreenButton) {\n        fullscreenButton.addEventListener('click', () => {\n          this.toggleFullscreen();\n        });\n      } else {\n        console.warn('âš ï¸ æœªæ‰¾åˆ°å…¨å±æŒ‰é’®å…ƒç´ ');\n      }\n\n      // Enter é”®å…¨å±æ”¯æŒ\n      this.setupEnterKeyFullscreen();\n\n      // å¯¼èˆªåˆ‡æ¢äº‹ä»¶å°†åœ¨ app.ts ä¸­å¤„ç†\n\n      // è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆéœ€è¦æ£€æŸ¥ API æ˜¯å¦å¯ç”¨ï¼Œå»¶è¿Ÿæ‰§è¡Œé¿å…åˆå§‹åŒ–æ—¶å‡ºé”™ï¼‰\n      setTimeout(() => {\n        try {\n          if (typeof eventOn !== 'undefined' && typeof tavern_events !== 'undefined') {\n            this.setupMessageListener();\n          } else {\n            console.warn('âš ï¸ äº‹ä»¶ç›‘å¬ API ä¸å¯ç”¨ï¼Œè·³è¿‡æ¶ˆæ¯ç›‘å¬å™¨è®¾ç½®');\n          }\n        } catch (error) {\n          console.warn('âš ï¸ è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n        }\n      }, 200);\n\n      // ç›‘å¬ MVU å˜é‡æ›´æ–°ç»“æŸ -> åˆ·æ–°çŠ¶æ€å¡ç‰‡\n      setTimeout(async () => {\n        try {\n          await waitGlobalInitialized('Mvu');\n          if (this.mvuUpdateListener) return;\n          if (typeof Mvu === 'undefined' || !Mvu.events?.VARIABLE_UPDATE_ENDED) return;\n\n          this.mvuUpdateListener = eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, () => {\n            if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n            this.statusRetryTimer = window.setTimeout(() => {\n              this.updateStatusCards().catch(() => {});\n            }, 50);\n          });\n        } catch (e) {\n          console.warn('âš ï¸ MVU äº‹ä»¶ç›‘å¬å®‰è£…å¤±è´¥:', e);\n        }\n      }, 250);\n    } catch (error) {\n      console.error('âŒ bindEvents å¤±è´¥:', error);\n      // å³ä½¿ç»‘å®šå¤±è´¥ï¼Œä¹Ÿç»§ç»­ï¼Œé¿å…å®Œå…¨æ— æ³•ä½¿ç”¨\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->\n      <header class=\"main-header\">\n        <div class=\"header-content\">\n          <div class=\"logo-section\">\n            <i class=\"fas fa-anchor logo-icon\"></i>\n            <h1 class=\"logo-text\">é”š</h1>\n          </div>\n          <!-- æ¨¡å—åˆ‡æ¢å¯¼èˆª -->\n          <nav class=\"top-nav-menu\">\n            <button type=\"button\" class=\"nav-item active\" data-module=\"status\" id=\"nav-status\" title=\"èˆ°ä½“çŠ¶æ€ (1)\">\n              <span class=\"nav-shortcut\">1</span>\n              <i class=\"fas fa-chart-line nav-icon\"></i>\n              <span class=\"nav-text\">èˆ°ä½“çŠ¶æ€</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"tasks\" id=\"nav-tasks\" title=\"ä»»åŠ¡æ¨¡å— (2)\">\n              <span class=\"nav-shortcut\">2</span>\n              <i class=\"fas fa-tasks nav-icon\"></i>\n              <span class=\"nav-text\">ä»»åŠ¡æ¨¡å—</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"diary\" id=\"nav-diary\" title=\"æ—¥è®°æ¨¡å— (3)\">\n              <span class=\"nav-shortcut\">3</span>\n              <i class=\"fas fa-book nav-icon\"></i>\n              <span class=\"nav-text\">æ—¥è®°æ¨¡å—</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"communication\" id=\"nav-communication\" title=\"é€šè®¯æ¨¡å— (4)\">\n              <span class=\"nav-shortcut\">4</span>\n              <i class=\"fas fa-comments nav-icon\"></i>\n              <span class=\"nav-text\">é€šè®¯æ¨¡å—</span>\n            </button>\n          </nav>\n          <div class=\"header-actions\">\n            <button type=\"button\" class=\"fullscreen-button\" id=\"dashboard-fullscreen-button\" title=\"å…¨å± (Enter)\">\n              <i class=\"fas fa-expand\"></i>\n            </button>\n            <div class=\"header-status\">\n              <div class=\"status-indicator online\">\n                <span class=\"status-dot\"></span>\n                <span class=\"status-text\">ç³»ç»Ÿåœ¨çº¿</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <!-- ä¸»å†…å®¹åŒºåŸŸ -->\n      <main class=\"main-content\">\n        <!-- å†…å®¹é¢æ¿ -->\n        <section class=\"content-panel\">\n          <!-- ç©ºé—´ç«™çŠ¶æ€æ¨¡å—ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->\n          <div class=\"module-container active\" id=\"module-status\">\n            <div class=\"module-body\">\n              <!-- ä¸»æ–‡æœ¬æ¡†åŒºåŸŸ -->\n              <div class=\"maintext-container\">\n                <div class=\"maintext-header\">\n                  <h3 class=\"maintext-title\">\n                    <i class=\"fas fa-scroll\"></i>\n                    å½“å‰å‰§æƒ…\n                  </h3>\n                </div>\n                <div class=\"maintext-areas\">\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">é€‰æ‹©å»¶ç»­</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-continue-choice\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">åæœæ€»ç»“</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-result\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">æ–°å‰§æƒ…</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-next-choice\"></div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"status-grid\" id=\"status-grid\"></div>\n            </div>\n          </div>\n\n          <!-- ä»»åŠ¡æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-tasks\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"tasks-list\"></div>\n            </div>\n          </div>\n\n          <!-- æ—¥è®°æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-diary\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"diary-list\"></div>\n            </div>\n          </div>\n\n          <!-- é€šè®¯æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-communication\">\n            <div class=\"module-body communication-body\">\n              <div class=\"chat-messages\" id=\"chat-messages\"></div>\n              <div class=\"chat-input-container\">\n                <div class=\"chat-input-wrapper\">\n                  <button type=\"button\" id=\"chat-show-options-btn\" class=\"chat-show-options-btn\" title=\"æ˜¾ç¤ºé€‰é¡¹\">\n                    <i class=\"fas fa-list\"></i>\n                  </button>\n                  <button\n                    type=\"button\"\n                    id=\"chat-regenerate-btn\"\n                    class=\"chat-regenerate-btn\"\n                    title=\"é‡æ–°ç”Ÿæˆå½“å‰è½®ï¼ˆä¼šåˆ é™¤æœ¬è½® user/assistant æ¶ˆæ¯ï¼‰\"\n                  >\n                    <i class=\"fas fa-rotate-right\"></i>\n                  </button>\n                  <textarea id=\"chat-input\" class=\"chat-input\" placeholder=\"è¾“å…¥æ¶ˆæ¯...\" rows=\"1\"></textarea>\n                  <button type=\"button\" id=\"chat-send-btn\" class=\"chat-send-btn\">\n                    <i class=\"fas fa-paper-plane\"></i>\n                  </button>\n                </div>\n              </div>\n              <!-- Option é€‰é¡¹æµ®å±‚å®¹å™¨ -->\n              <div class=\"chat-options-overlay\" id=\"chat-options-overlay\">\n                <div class=\"chat-options-container\" id=\"chat-options-container\">\n                  <div class=\"chat-options-header\">\n                    <span class=\"chat-options-title\">å¯ç”¨é€‰é¡¹</span>\n                    <button type=\"button\" class=\"chat-options-close\" id=\"chat-options-close\" title=\"å…³é—­\">\n                      <i class=\"fas fa-times\"></i>\n                    </button>\n                  </div>\n                </div>\n                <div class=\"chat-options-list\" id=\"chat-options-list\"></div>\n              </div>\n            </div>\n          </div>\n        </section>\n      </main>\n\n      <!-- æ¨¡æ€æ¡†å®¹å™¨ -->\n      <div class=\"modal-overlay\" id=\"modal-overlay\">\n        <div class=\"modal-container\" id=\"modal-container\">\n          <div class=\"modal-header\">\n            <h3 class=\"modal-title\" id=\"modal-title\">æ ‡é¢˜</h3>\n            <button class=\"modal-close\" id=\"modal-close\">\n              <i class=\"fas fa-times\"></i>\n            </button>\n          </div>\n          <div class=\"modal-body\" id=\"modal-body\"></div>\n        </div>\n      </div>\n\n    `;\n  }\n\n  private setupEnterKeyFullscreen(): void {\n    try {\n      // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n      if (this.keyDownHandler) {\n        document.removeEventListener('keydown', this.keyDownHandler);\n        this.keyDownHandler = null;\n      }\n\n      // åˆ›å»ºæ–°çš„äº‹ä»¶ç›‘å¬å™¨\n      this.keyDownHandler = (e: KeyboardEvent) => {\n        try {\n          // åªåœ¨ Dashboard æ˜¾ç¤ºæ—¶å“åº”\n          if (!this.element?.classList.contains('active')) {\n            return;\n          }\n\n          // å¦‚æœè¾“å…¥æ¡†èšç„¦ï¼Œä¸å¤„ç† Enter é”®å’Œ Esc é”®\n          const activeElement = document.activeElement;\n          if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {\n            return;\n          }\n\n          // Enter é”®è§¦å‘å…¨å±\n          if (e.key === 'Enter') {\n            e.preventDefault();\n            this.toggleFullscreen();\n          }\n        } catch (error) {\n          console.error('âŒ é”®ç›˜äº‹ä»¶å¤„ç†å¤±è´¥:', error);\n        }\n      };\n\n      document.addEventListener('keydown', this.keyDownHandler);\n      console.log('âœ… Enter é”®å…¨å±æ”¯æŒå·²è®¾ç½®');\n    } catch (error) {\n      console.error('âŒ è®¾ç½®é”®ç›˜äº‹ä»¶æ”¯æŒå¤±è´¥:', error);\n    }\n  }\n\n  private requestFullscreen(): void {\n    try {\n      const element = document.documentElement;\n      if (element.requestFullscreen) {\n        element.requestFullscreen().catch(err => {\n          console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n        });\n      } else if ((element as any).webkitRequestFullscreen) {\n        (element as any).webkitRequestFullscreen();\n      } else if ((element as any).mozRequestFullScreen) {\n        (element as any).mozRequestFullScreen();\n      } else if ((element as any).msRequestFullscreen) {\n        (element as any).msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ è¯·æ±‚å…¨å±å¤±è´¥:', error);\n    }\n  }\n\n  private exitFullscreen(): void {\n    try {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ é€€å‡ºå…¨å±å¤±è´¥:', error);\n    }\n  }\n\n  private toggleFullscreen(): void {\n    try {\n      if (!document.fullscreenElement) {\n        this.requestFullscreen();\n      } else {\n        this.exitFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ åˆ‡æ¢å…¨å±å¤±è´¥:', error);\n    }\n  }\n}\n","import _ from 'lodash';\nimport { GameConfig, GameData } from '../types/types';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (\n    mvu_data: any,\n    options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' },\n  ) => Promise<void>;\n};\n\n/**\n * æ›´æ–° MVU å˜é‡ï¼ˆå°†è¡¨å•è¾“å…¥çš„å€¼å†™å…¥ MVU å˜é‡ç³»ç»Ÿï¼‰\n */\nexport async function updateMvuVariables(config: GameConfig): Promise<void> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    await waitGlobalInitialized('Mvu');\n\n    // è·å–å½“å‰çš„ MVU æ•°æ®\n    // ä¼˜å…ˆæ›´æ–° chat å˜é‡è¡¨ï¼Œä½œä¸ºâ€œå½“å‰çŠ¶æ€â€æ¥æºã€‚\n    // åŒæ—¶åˆå¹¶ init(0) / latest message ä»¥è¡¥é½ç¼ºå¤±å­—æ®µï¼Œé¿å…åªå†™ reserve å¯¼è‡´ system_state ç»“æ„æ®‹ç¼ºã€‚\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    chatData = Mvu.getMvuData({ type: 'chat' });\n\n    const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    const currentStatData = currentMvuData?.stat_data || {};\n\n    // æ„å»ºæ›´æ–°åçš„ stat_data\n    const updatedStatData = _.cloneDeep(currentStatData);\n\n    // æ›´æ–° system_state.antimatter.reserveï¼ˆç³»ç»Ÿå‰©ä½™èƒ½æºï¼‰\n    if (config.reserve !== undefined) {\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // ç¡®ä¿ reserve åœ¨ 0-100000 èŒƒå›´å†…\n      const clampedReserve = _.clamp(config.reserve, 0, 100000);\n      updatedStatData.system_state.antimatter.reserve = clampedReserve;\n      console.info(`âœ… æ›´æ–° system_state.antimatter.reserve: ${clampedReserve}`);\n    }\n\n    // å°†æ›´æ–°åçš„æ•°æ®å†™å› MVU\n    const updatedMvuData = {\n      ...currentMvuData,\n      stat_data: updatedStatData,\n    };\n\n    await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n    console.info('âœ… MVU å˜é‡å·²æ›´æ–°');\n  } catch (error) {\n    console.error('âŒ æ›´æ–° MVU å˜é‡å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°æ¸¸æˆæ•°æ®åˆ°é…’é¦†å˜é‡ç³»ç»Ÿ\n */\nexport async function updateGameData(data: Partial<GameData>): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_data: {\n        ...(currentData.game_data || {}),\n        ...data,\n      },\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('æ¸¸æˆæ•°æ®å·²æ›´æ–°');\n  } catch (error) {\n    console.error('æ›´æ–°æ¸¸æˆæ•°æ®å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°æ¸¸æˆé…ç½®\n */\nexport async function updateGameConfig(config: GameConfig): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_config: config,\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('æ¸¸æˆé…ç½®å·²æ›´æ–°');\n  } catch (error) {\n    console.error('æ›´æ–°æ¸¸æˆé…ç½®å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * åˆå§‹åŒ–æ¸¸æˆæ•°æ®\n */\nexport async function initializeGameData(config: GameConfig): Promise<GameData> {\n  // å…ˆæ›´æ–° MVU å˜é‡ï¼ˆå°†è¡¨å•è¾“å…¥çš„å€¼å†™å…¥ MVUï¼‰\n  await updateMvuVariables(config);\n\n  // åˆ›å»ºåŸºæœ¬çš„æ¸¸æˆæ•°æ®ç»“æ„ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰\n  const gameData: GameData = {\n    station_name: 'ç©ºé—´ç«™ Alpha', // ä¸å†ä»è¡¨å•è¯»å–\n    difficulty: 'normal', // ä¸å†ä»è¡¨å•è¯»å–\n    resources: {\n      energy: 100,\n      supplies: 100,\n      crew: 10,\n    },\n    status: {\n      energy: 87,\n      life_support: 92,\n      system: 78,\n      personnel: 'æ­£å¸¸',\n      communication: 95,\n      laboratory: 83,\n      storage: 64,\n      computing: 71,\n    },\n    tasks: [],\n    diary: [],\n    messages: [],\n  };\n\n  await updateGameData(gameData);\n  await updateGameConfig(config);\n\n  return gameData;\n}\n","import { PageState } from '../types/types';\nimport { SplashScreen } from '../components/SplashScreen';\nimport { NewGameSetup } from '../components/NewGameSetup';\nimport { Dashboard } from '../components/Dashboard';\nimport { ComponentCallbacks } from '../types/types';\nimport { initializeNewGame, continueGame } from './gameInitializer';\nimport { hasSaveData } from './variableReader';\n\n/**\n * é¡µé¢æµç¨‹ç®¡ç†å™¨\n */\nexport class PageManager {\n  private currentPage: PageState = 'splash';\n  private splashScreen: SplashScreen;\n  private setupScreen: NewGameSetup;\n  private dashboard: Dashboard;\n  private appContainer: HTMLElement;\n\n  constructor(appContainer: HTMLElement) {\n    this.appContainer = appContainer;\n\n    const callbacks: ComponentCallbacks = {\n      onStart: () => this.goToSplash(),\n      onNewGame: () => this.goToSetup(),\n      onContinue: () => this.goToGame(),\n      onConfirm: (config) => this.handleConfirm(config),\n      onCancel: () => this.goToSplash(),\n      onFullscreenToggle: () => this.toggleFullscreen(),\n    };\n\n    this.splashScreen = new SplashScreen(callbacks);\n    this.setupScreen = new NewGameSetup(callbacks);\n    this.dashboard = new Dashboard(callbacks);\n  }\n\n  public initialize(): void {\n    // åˆ›å»ºæ‰€æœ‰ç»„ä»¶\n    this.appContainer.appendChild(this.splashScreen.createElement());\n    this.appContainer.appendChild(this.setupScreen.createElement());\n    this.appContainer.appendChild(this.dashboard.createElement());\n\n    // æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿›å…¥æ¸¸æˆï¼Œå¦åˆ™æ˜¾ç¤ºå¼€å§‹å±å¹•\n    const hasSave = hasSaveData();\n    if (hasSave) {\n      // æœ‰å­˜æ¡£ï¼Œç›´æ¥è¿›å…¥æ¸¸æˆ\n      this.goToGame();\n    } else {\n      // æ²¡æœ‰å­˜æ¡£ï¼Œæ˜¾ç¤ºå¼€å§‹å±å¹•\n      this.showPage('splash');\n    }\n  }\n\n  private showPage(page: PageState): void {\n    console.log(`ğŸ”„ å¼€å§‹åˆ‡æ¢é¡µé¢: ${page}`);\n\n    // éšè—æ‰€æœ‰é¡µé¢\n    try {\n      this.splashScreen.hide();\n      this.setupScreen.hide();\n      this.dashboard.hide();\n    } catch (error) {\n      console.warn('âš ï¸ éšè—é¡µé¢æ—¶å‡ºé”™:', error);\n    }\n\n    // æ˜¾ç¤ºç›®æ ‡é¡µé¢\n    try {\n      switch (page) {\n        case 'splash':\n          this.splashScreen.show();\n          // è¿›å…¥æ ‡é¢˜é¡µé¢æ—¶è¯·æ±‚å…¨å±\n          this.requestFullscreen();\n          break;\n        case 'setup':\n          this.setupScreen.show();\n          break;\n        case 'game':\n          this.dashboard.show();\n          // ç¡®ä¿ Dashboard å·²æ­£ç¡®æ˜¾ç¤º\n          setTimeout(() => {\n            const dashboardElement = document.getElementById('main-screen');\n            if (dashboardElement && dashboardElement.classList.contains('active')) {\n              console.log('âœ… Dashboard å·²æ­£ç¡®æ˜¾ç¤º');\n            } else {\n              console.error('âŒ Dashboard æ˜¾ç¤ºå¼‚å¸¸ï¼Œelement:', dashboardElement);\n            }\n          }, 100);\n          break;\n      }\n    } catch (error) {\n      console.error(`âŒ æ˜¾ç¤ºé¡µé¢ ${page} å¤±è´¥:`, error);\n      throw error;\n    }\n\n    this.currentPage = page;\n    console.info(`âœ… æˆåŠŸåˆ‡æ¢åˆ°é¡µé¢: ${page}`);\n  }\n\n  private goToSplash(): void {\n    this.showPage('splash');\n  }\n\n  private goToSetup(): void {\n    this.showPage('setup');\n  }\n\n  private async goToGame(): Promise<void> {\n    try {\n      console.log('ğŸ”„ å¼€å§‹åŠ è½½æ¸¸æˆ...');\n      const gameData = await continueGame();\n      console.log('âœ… æ¸¸æˆæ•°æ®åŠ è½½å®Œæˆ:', gameData);\n\n      // æ›´æ–°æ¸¸æˆæ•°æ®\n      this.dashboard.updateGameData(gameData);\n\n      // æ˜¾ç¤ºæ¸¸æˆé¡µé¢\n      this.showPage('game');\n\n      console.log('âœ… å·²åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢');\n    } catch (error) {\n      console.error('âŒ åŠ è½½æ¸¸æˆå¤±è´¥:', error);\n      console.error('âŒ é”™è¯¯è¯¦æƒ…:', {\n        error: error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorStack: error instanceof Error ? error.stack : undefined,\n      });\n\n      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºæ¸¸æˆé¡µé¢ï¼ˆä½¿ç”¨ç©ºæ•°æ®ï¼‰\n      try {\n        this.dashboard.updateGameData({});\n        this.showPage('game');\n        console.warn('âš ï¸ ä½¿ç”¨ç©ºæ•°æ®ç»§ç»­æ˜¾ç¤ºæ¸¸æˆé¡µé¢');\n      } catch (fallbackError) {\n        console.error('âŒ æ˜¾ç¤ºæ¸¸æˆé¡µé¢ä¹Ÿå¤±è´¥:', fallbackError);\n        toastr.error('åŠ è½½æ¸¸æˆå¤±è´¥', 'é”™è¯¯');\n      }\n    }\n  }\n\n  private async handleConfirm(config: any): Promise<void> {\n    try {\n      // initializeNewGame å†…éƒ¨å·²ç»ä¼šè°ƒç”¨ createOpeningStoryMessage\n      const gameData = await initializeNewGame(config);\n      this.dashboard.updateGameData(gameData);\n      this.showPage('game');\n      toastr.success('æ¸¸æˆå·²åˆå§‹åŒ–', 'æˆåŠŸ');\n    } catch (error) {\n      console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', error);\n      toastr.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥', 'é”™è¯¯');\n    }\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private toggleFullscreen(): void {\n    if (!document.fullscreenElement) {\n      this.requestFullscreen();\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    }\n  }\n\n  public getDashboard(): Dashboard {\n    return this.dashboard;\n  }\n}\n","import { GameConfig, GameData } from '../types/types';\nimport { initializeGameData } from './variableUpdater';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\n\n/**\n * åˆå§‹åŒ–æ–°æ¸¸æˆ\n * ä¸å†åˆ›å»ºå¼€åœºç™½ï¼Œå¼€åœºç™½ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼ˆç¬¬ä¸€æ¡assistantæ¶ˆæ¯ï¼‰\n */\nexport async function initializeNewGame(config: GameConfig): Promise<GameData> {\n  console.info('åˆå§‹åŒ–æ–°æ¸¸æˆ...', config);\n\n  const gameData = await initializeGameData(config);\n\n  console.info('æ–°æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼ˆå¼€åœºç™½ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼‰');\n  return gameData;\n}\n\n/**\n * ç»§ç»­æ¸¸æˆ\n */\nexport async function continueGame(): Promise<Partial<GameData>> {\n  console.info('ç»§ç»­æ¸¸æˆ...');\n\n  const variables = getVariables({ type: 'message' });\n  const gameData = variables.game_data || variables.stat_data || {};\n\n  console.info('æ¸¸æˆæ•°æ®å·²åŠ è½½');\n  return gameData as Partial<GameData>;\n}\n","// é”š - Dashboard é€»è¾‘\n// åŒ…å«å¯¼èˆªã€æ¨¡æ€æ¡†ã€åŠ¨ç”»ã€çŠ¶æ€å¡ç‰‡äº¤äº’ã€èŠå¤©ç•Œé¢ç­‰åŠŸèƒ½\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare const errorCatched: (fn: () => void) => () => void;\n\n// ========== å¯¼èˆªåŠŸèƒ½ ==========\nexport function initNavigation() {\n  const navItems = document.querySelectorAll('.nav-item');\n  const modules = document.querySelectorAll('.module-container');\n\n  // åˆ‡æ¢æ¨¡å—çš„å‡½æ•°\n  function switchModule(moduleId: string) {\n    if (!moduleId) return;\n\n    // ç§»é™¤æ‰€æœ‰ active ç±»\n    navItems.forEach(nav => nav.classList.remove('active'));\n    modules.forEach(module => module.classList.remove('active'));\n\n    // æ·»åŠ  active ç±»\n    const targetNavItem = document.querySelector(`.nav-item[data-module=\"${moduleId}\"]`);\n    const targetModule = document.getElementById(`module-${moduleId}`);\n\n    if (targetNavItem) {\n      targetNavItem.classList.add('active');\n    }\n    if (targetModule) {\n      targetModule.classList.add('active');\n    }\n  }\n\n  // ç‚¹å‡»åˆ‡æ¢\n  navItems.forEach(item => {\n    item.addEventListener('click', () => {\n      const moduleId = item.getAttribute('data-module');\n      if (moduleId) {\n        switchModule(moduleId);\n      }\n    });\n  });\n\n  // é”®ç›˜å¿«æ·é”®åˆ‡æ¢ï¼ˆ1, 2, 3, 4ï¼‰\n  const moduleMap: Record<string, string> = {\n    '1': 'status',\n    '2': 'tasks',\n    '3': 'diary',\n    '4': 'communication',\n  };\n\n  document.addEventListener('keydown', e => {\n    // åªåœ¨ä¸»æ¸¸æˆç•Œé¢æ¿€æ´»æ—¶å“åº”ï¼Œä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­\n    const mainScreen = document.getElementById('main-screen');\n    if (!mainScreen || !mainScreen.classList.contains('active')) {\n      return;\n    }\n\n    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–å…¶ä»–å¯è¾“å…¥å…ƒç´ ä¸Šï¼Œä¸å“åº”\n    const activeElement = document.activeElement;\n    if (\n      activeElement &&\n      (activeElement.tagName === 'INPUT' ||\n        activeElement.tagName === 'TEXTAREA' ||\n        (activeElement instanceof HTMLElement && activeElement.isContentEditable))\n    ) {\n      return;\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹æ•°å­—é”® 1-4\n    if (e.key >= '1' && e.key <= '4') {\n      const moduleId = moduleMap[e.key];\n      if (moduleId) {\n        e.preventDefault();\n        switchModule(moduleId);\n        console.log(`âŒ¨ï¸ å¿«æ·é”®åˆ‡æ¢æ¨¡å—: ${moduleId} (${e.key})`);\n      }\n    }\n  });\n}\n\n// ========== æ¨¡æ€æ¡†åŠŸèƒ½ ==========\nexport function initModals() {\n  const modalOverlay = document.getElementById('modal-overlay');\n  const modalClose = document.getElementById('modal-close');\n\n  if (!modalOverlay || !modalClose) return;\n\n  modalClose.addEventListener('click', () => {\n    modalOverlay.classList.remove('active');\n  });\n\n  modalOverlay.addEventListener('click', e => {\n    if (e.target === modalOverlay) {\n      modalOverlay.classList.remove('active');\n    }\n  });\n}\n\n// ========== åŠ¨ç”»åŠŸèƒ½ ==========\nexport function initAnimations() {\n  // åŸºç¡€åŠ¨ç”»å·²é€šè¿‡ CSS å®ç°\n  // è¿™é‡Œå¯ä»¥æ·»åŠ  JS åŠ¨ç”»é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰\n}\n\n// ========== çŠ¶æ€å¡ç‰‡äº¤äº’ ==========\nexport function initStatusCardInteractions() {\n  const statusCards = document.querySelectorAll('.status-card');\n  statusCards.forEach(card => {\n    card.addEventListener('click', () => {\n      // çŠ¶æ€å¡ç‰‡ç‚¹å‡»äº¤äº’ï¼ˆå¦‚æœéœ€è¦ï¼‰\n      console.log('çŠ¶æ€å¡ç‰‡è¢«ç‚¹å‡»');\n    });\n  });\n}\n\n// ========== èŠå¤©ç•Œé¢åŠŸèƒ½ ==========\n\n/**\n * ä¸€è½®å¯¹è¯çš„æ•°æ®ç»“æ„\n */\ninterface ConversationRound {\n  assistantMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  userMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  pending?: boolean; // æ ‡è®°ä¸ºå¾…å¤„ç†çš„è½®æ¬¡ï¼ˆç”¨æˆ·å·²å‘é€ï¼ŒAIæœªå›å¤ï¼‰\n  pendingUserMessage?: string; // å¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯å†…å®¹\n}\n\n/**\n * åˆå§‹åŒ–å¯¹è¯ç•Œé¢ï¼ˆæ”¯æŒå·¦å³æ»‘åŠ¨å’Œæµå¼æ¸²æŸ“ï¼‰\n */\nexport function initChatInterface() {\n  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;\n  const chatSendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;\n  const chatRegenerateBtn = document.getElementById('chat-regenerate-btn') as HTMLButtonElement;\n  const chatMessages = document.getElementById('chat-messages') as HTMLElement;\n\n  if (!chatInput || !chatSendBtn || !chatMessages) {\n    return;\n  }\n\n  // å¯¹è¯è½®æ¬¡æ•°ç»„\n  let rounds: ConversationRound[] = [];\n  let currentRoundIndex = -1; // å½“å‰æ˜¾ç¤ºçš„è½®æ¬¡ç´¢å¼•\n\n  // æ­£åœ¨ç”Ÿæˆ/è½¬æ­£çš„è½®æ¬¡ç´¢å¼•ï¼ˆä¸ currentRoundIndex è§£è€¦ï¼šç”¨æˆ·å¯èƒ½åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æµè§ˆå†å²è½®æ¬¡ï¼‰\n  let activePendingRoundIndex: number | null = null;\n\n  function findLastPendingRoundIndex(): number | null {\n    for (let i = rounds.length - 1; i >= 0; i--) {\n      const r = rounds[i];\n      if (r && r.pending) return i;\n    }\n    return null;\n  }\n\n  function getPendingRoundIndexSafe(): number | null {\n    if (\n      activePendingRoundIndex !== null &&\n      activePendingRoundIndex >= 0 &&\n      activePendingRoundIndex < rounds.length &&\n      rounds[activePendingRoundIndex]?.pending\n    ) {\n      return activePendingRoundIndex;\n    }\n    return findLastPendingRoundIndex();\n  }\n\n  // å½“å‰æµå¼è¾“å‡ºå…ƒç´ ï¼ˆç”¨äºå®æ—¶æ¸²æŸ“ï¼‰\n  let streamingElement: HTMLElement | null = null;\n\n  // ä¿å­˜æœ€åä¸€æ¬¡æµå¼æ–‡æœ¬ï¼ˆrawï¼ŒåŒ…å«æ ‡ç­¾ï¼‰\n  let lastStreamedRawMessage: string = '';\n\n  // æ˜¯å¦æ­£åœ¨ç”Ÿæˆæ¶ˆæ¯\n  let isGenerating = false;\n\n  // æ˜¯å¦æ­£åœ¨å‘é€æ¶ˆæ¯ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰\n  let isSending = false;\n\n  // ä¿å­˜æœ€æ–°æå–çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼Œé¿å…ä»æ¶ˆæ¯ä¸­æå–ï¼‰\n  let latestOptions: string[] = [];\n\n  // è®°å½•æœ€è¿‘ä¸€æ¬¡ç”Ÿæˆåˆ›å»ºçš„çœŸå® message_idï¼ˆç”¨äºæŠŠ rounds çš„ä¸´æ—¶ id è¦†ç›–ä¸ºçœŸå® idï¼‰\n  let lastCreatedIds: { userMessageId: number; assistantMessageId: number } | null = null;\n\n  // ç¡®ä¿ generateMessage å·²åŠ è½½\n  let generateMessagePromise: Promise<any> | null = null;\n\n  // ç¡®ä¿ regenerateAssistantMessage å·²åŠ è½½\n  let regenerateAssistantMessagePromise: Promise<any> | null = null;\n\n  function ensureRegenerateAssistantLoaded(): Promise<any> {\n    if (!regenerateAssistantMessagePromise) {\n      regenerateAssistantMessagePromise = import('./utils/messageGenerator').then(\n        module => module.regenerateAssistantMessage,\n      );\n    }\n    return regenerateAssistantMessagePromise;\n  }\n\n  // é¢„åŠ è½½æ¶ˆæ¯ç”ŸæˆæœåŠ¡\n  function ensureMessageGeneratorLoaded(): Promise<any> {\n    if (!generateMessagePromise) {\n      generateMessagePromise = import('./utils/messageGenerator').then(module => module.generateMessage);\n    }\n    return generateMessagePromise;\n  }\n\n  // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦\n  function adjustInputHeight() {\n    chatInput.style.height = 'auto';\n    const maxHeight = 80;\n    const newHeight = Math.min(chatInput.scrollHeight, maxHeight);\n    chatInput.style.height = `${newHeight}px`;\n  }\n\n  chatInput.addEventListener('input', adjustInputHeight);\n\n  // HTMLè½¬ä¹‰\n  function escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // å°†æ¶ˆæ¯åˆ†ç»„ä¸ºè½®æ¬¡\n  // è§„åˆ™ï¼ˆä¿®æ­£ç‰ˆï¼Œç¬¦åˆçœŸå®æ—¶é—´çº¿ï¼‰ï¼š\n  // 1. ç¬¬ä¸€æ¡ assistant æ¶ˆæ¯ï¼ˆå¼€åœºç™½ï¼‰ä½œä¸ºå­¤ç«‹æ¶ˆæ¯ï¼Œåªæœ‰ assistantMessageï¼Œæ²¡æœ‰ userMessage\n  // 2. æ¯ä¸€æ¡ user æ¶ˆæ¯éƒ½ä¼šå¼€å¯ä¸€è½®\n  // 3. ç´§éšå…¶åçš„ assistant æ¶ˆæ¯è¡¥å…¨è¯¥è½®\n  function groupMessagesIntoRounds(\n    allMessages: Array<{\n      message: string;\n      message_id: number;\n      role: string;\n    }>,\n  ): ConversationRound[] {\n    const rounds: ConversationRound[] = [];\n\n    // å½“å‰æ­£åœ¨ç­‰å¾… assistant è¡¥å…¨çš„è½®æ¬¡\n    let pendingRound: ConversationRound | null = null;\n\n    // æŒ‰æ¶ˆæ¯çœŸå®å‡ºç°é¡ºåºéå†ï¼ˆæ—¶é—´çº¿ï¼‰\n    allMessages.forEach(msg => {\n      // å¤„ç† user æ¶ˆæ¯ï¼šæ°¸è¿œå¼€å¯æ–°ä¸€è½®\n      if (msg.role === 'user') {\n        const round: ConversationRound = {\n          userMessage: {\n            message_id: msg.message_id,\n            message: msg.message,\n          },\n          assistantMessage: null,\n        };\n\n        rounds.push(round);\n        pendingRound = round;\n        return;\n      }\n\n      // å¤„ç† assistant æ¶ˆæ¯\n      if (msg.role === 'assistant') {\n        // å¦‚æœå­˜åœ¨ç­‰å¾…è¡¥å…¨çš„è½®æ¬¡ï¼Œåˆ™è¡¥å…¨å®ƒ\n        if (pendingRound && !pendingRound.assistantMessage) {\n          pendingRound.assistantMessage = {\n            message_id: msg.message_id,\n            message: msg.message,\n          };\n          pendingRound = null;\n        } else {\n          // å¦åˆ™è§†ä¸ºå¼€åœºç™½ / å­¤ç«‹ assistant æ¶ˆæ¯\n          rounds.push({\n            userMessage: null,\n            assistantMessage: {\n              message_id: msg.message_id,\n              message: msg.message,\n            },\n          });\n        }\n      }\n    });\n\n    return rounds;\n  }\n\n  // æ˜¾ç¤ºæŒ‡å®šè½®æ¬¡çš„å¯¹è¯\n  async function displayRound(roundIndex: number) {\n    // å¦‚æœæ­£åœ¨ç”Ÿæˆï¼Œä¸æ¸…é™¤æµå¼å…ƒç´ \n    if (!isGenerating) {\n      chatMessages.innerHTML = '';\n      streamingElement = null;\n    } else {\n      // æ­£åœ¨ç”Ÿæˆæ—¶ï¼Œåªæ¸…é™¤éæµå¼çš„æ¶ˆæ¯ï¼ˆä¿ç•™æµå¼å…ƒç´ ï¼‰\n      const existingMessages = Array.from(chatMessages.children).filter(child => child !== streamingElement);\n      existingMessages.forEach(msg => msg.remove());\n    }\n\n    // å¦‚æœç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œæ˜¾ç¤ºç©ºè½®æ¬¡ï¼ˆç”¨äºæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ç­‰å¾…AIå›å¤ï¼‰\n    if (roundIndex < 0 || roundIndex >= rounds.length) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const round = rounds[roundIndex];\n\n    // å…ˆæ˜¾ç¤º user æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰- ç¡®ä¿åœ¨ä¸Šæ–¹\n    if (round.userMessage) {\n      renderUserMessage(round.userMessage.message);\n    } else if (round.pendingUserMessage) {\n      // æ˜¾ç¤ºå¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯\n      renderUserMessage(round.pendingUserMessage);\n    }\n\n    // å†æ˜¾ç¤º assistant æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰- ç¡®ä¿åœ¨ä¸‹æ–¹\n    if (round.assistantMessage) {\n      await renderAssistantMessage(round.assistantMessage.message, round.assistantMessage.message);\n    } else if (round.pending && isGenerating) {\n      // å¦‚æœæ˜¯å¾…å¤„ç†çš„è½®æ¬¡ä¸”æ­£åœ¨ç”Ÿæˆï¼Œç¡®ä¿æµå¼å…ƒç´ åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸‹æ–¹\n      if (!streamingElement) {\n        showGenerating();\n      }\n      // å¦‚æœæµå¼å…ƒç´ å·²å­˜åœ¨ä½†ä¸åœ¨æ­£ç¡®ä½ç½®ï¼Œç§»åŠ¨åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸‹æ–¹\n      if (streamingElement && streamingElement.parentNode === chatMessages) {\n        // ç¡®ä¿æµå¼å…ƒç´ åœ¨æœ€åï¼ˆç”¨æˆ·æ¶ˆæ¯ä¹‹åï¼‰\n        chatMessages.appendChild(streamingElement);\n      }\n    } else if (!round.assistantMessage) {\n      // å¦‚æœæ²¡æœ‰assistantæ¶ˆæ¯ä¸”ä¸åœ¨ç”Ÿæˆï¼Œæ˜¾ç¤ºç­‰å¾…é€‰æ‹©\n      if (!isGenerating) {\n        showWaitingMessage();\n      }\n    }\n\n    updateRegenerateButtonState();\n  }\n\n  function updateRegenerateButtonState() {\n    if (!chatRegenerateBtn) return;\n\n    if (isGenerating || isSending) {\n      chatRegenerateBtn.disabled = true;\n      return;\n    }\n\n    const round = rounds[currentRoundIndex];\n    const enabled =\n      !!round &&\n      !!round.userMessage &&\n      typeof round.userMessage.message === 'string' &&\n      round.userMessage.message.trim().length > 0 &&\n      !!round.assistantMessage &&\n      typeof round.assistantMessage.message_id === 'number' &&\n      Number.isFinite(round.assistantMessage.message_id) &&\n      !round.pending;\n\n    chatRegenerateBtn.disabled = !enabled;\n  }\n\n  // æ¸²æŸ“ assistant æ¶ˆæ¯ï¼ˆåªè§£æå­˜åœ¨çš„æ ‡ç­¾ï¼‰\n  async function renderAssistantMessage(content: string, rawMessage: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-assistant';\n\n    try {\n      const { extractContinueChoice, extractResult, extractNextChoice } = await import('./utils/textParser');\n\n      // ä» rawMessage ä¸­æå– maintextï¼Œç„¶åä» maintext ä¸­æå–ä¸‰æ æ ‡ç­¾\n      const { extractLastMaintext } = await import('./utils/textParser');\n      const maintext = extractLastMaintext(rawMessage);\n\n      // å¦‚æœ maintext å­˜åœ¨ï¼Œä» maintext ä¸­æå–ï¼›å¦åˆ™ä»æ•´ä¸ªæ¶ˆæ¯ä¸­æå–\n      const searchText = maintext || rawMessage;\n\n      const continueChoice = extractContinueChoice(searchText);\n      const result = extractResult(searchText);\n      const nextChoice = extractNextChoice(searchText);\n\n      // æ„å»ºä¸‰æ å†…å®¹ï¼Œåªæ˜¾ç¤ºå­˜åœ¨çš„æ ‡ç­¾\n      const columns: Array<{ header: string; content: string; key: string }> = [];\n\n      if (continueChoice) {\n        columns.push({ header: 'é€‰æ‹©å»¶ç»­', content: continueChoice, key: 'continue' });\n      }\n      if (result) {\n        columns.push({ header: 'åæœæ€»ç»“', content: result, key: 'result' });\n      }\n      if (nextChoice) {\n        columns.push({ header: 'æ–°å‰§æƒ…', content: nextChoice, key: 'next' });\n      }\n\n      if (columns.length > 0) {\n        // æ˜¾ç¤ºä¸‰æ ï¼ˆå¯èƒ½åªæœ‰1-3æ ï¼‰\n        const columnsHtml = columns\n          .map(\n            col => `\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">${escapeHtml(col.header)}</div>\n            <div class=\"message-column-content\">${escapeHtml(col.content)}</div>\n          </div>\n        `,\n          )\n          .join('');\n\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\">\n              ${columnsHtml}\n            </div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      } else {\n        // æ²¡æœ‰ç»“æ„åŒ–æ ‡ç­¾ï¼Œæ˜¾ç¤ºå•æ \n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content\">${escapeHtml(content)}</div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      }\n    } catch (error) {\n      console.error('âŒ è§£æç»“æ„åŒ–æ ‡ç­¾å¤±è´¥ï¼Œä½¿ç”¨å•æ æ˜¾ç¤º:', error);\n      messageItem.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content\">${escapeHtml(content)}</div>\n          <div class=\"message-time\"></div>\n        </div>\n      `;\n    }\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // æ¸²æŸ“ user æ¶ˆæ¯\n  function renderUserMessage(content: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-user';\n\n    // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºå•æ \n    messageItem.innerHTML = `\n      <div class=\"message-bubble\">\n        <div class=\"message-content\">${escapeHtml(content)}</div>\n        <div class=\"message-time\"></div>\n      </div>\n    `;\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // åŠ è½½å¯¹è¯å†å²å¹¶åˆ†ç»„\n  async function loadChatHistory() {\n    try {\n      const lastMessageId = getLastMessageId();\n\n      const allMessages = lastMessageId >= 0 ? getChatMessages(`0-${lastMessageId}`) : [];\n      const newRounds = groupMessagesIntoRounds(allMessages);\n\n      rounds = newRounds;\n\n      // æ˜¾ç¤ºæœ€åä¸€è½®\n      if (rounds.length > 0) {\n        currentRoundIndex = rounds.length - 1;\n        if (!isGenerating) {\n          await displayRound(currentRoundIndex);\n        }\n      }\n\n      console.log('âœ… å·²åŠ è½½èŠå¤©å†å²ï¼Œå…±', rounds.length, 'è½®å¯¹è¯ï¼Œå½“å‰æ˜¾ç¤ºç¬¬', currentRoundIndex + 1, 'è½®');\n    } catch (error) {\n      console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);\n    }\n  }\n\n  // åˆ·æ–°æ˜¾ç¤ºï¼ˆå½“æ¨¡å—è¢«æ¿€æ´»æ—¶è°ƒç”¨ï¼‰\n  async function refreshDisplay() {\n    await loadChatHistory();\n  }\n\n  // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼ˆå·¦ç®­å¤´å’Œå³ç®­å¤´ï¼‰\n  function setupKeyboardNavigation() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const keyHandler = (e: KeyboardEvent) => {\n      // åªåœ¨é€šè®¯æ¨¡å—æ¿€æ´»ä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶å“åº”\n      if (!communicationModule.classList.contains('active')) return;\n      if (document.activeElement === chatInput) return;\n\n      if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        goToPreviousRound();\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        goToNextRound();\n      } else if (e.key === 'o' || e.key === 'O') {\n        // O é”®æ‰“å¼€é€‰é¡¹ç•Œé¢\n        e.preventDefault();\n        const showOptionsBtn = document.getElementById('chat-show-options-btn') as HTMLButtonElement;\n        if (showOptionsBtn) {\n          showOptionsBtn.click();\n        }\n      }\n    };\n\n    document.addEventListener('keydown', keyHandler);\n  }\n\n  // å‘é€æ¶ˆæ¯\n  async function sendMessage() {\n    // é˜²æ­¢é‡å¤å‘é€\n    if (isSending) {\n      console.warn('âš ï¸ æ­£åœ¨å‘é€æ¶ˆæ¯ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');\n      return;\n    }\n\n    const message = chatInput.value.trim();\n    if (!message) {\n      return;\n    }\n\n    // è®¾ç½®å‘é€æ ‡å¿—\n    isSending = true;\n\n    chatInput.value = '';\n    adjustInputHeight();\n\n    // ç¦ç”¨å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n\n    // è®¾ç½®ç”Ÿæˆæ ‡å¿—ï¼ˆåœ¨åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ä¹‹å‰ï¼‰\n    isGenerating = true;\n    updateRegenerateButtonState();\n\n    // æ³¨æ„ï¼šä¸åœ¨ sendMessage ä¸­ç›´æ¥æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯\n    // ç”¨æˆ·æ¶ˆæ¯ä¼šåœ¨ generateMessage åˆ›å»ºåï¼Œé€šè¿‡ loadChatHistory é‡æ–°åŠ è½½æ—¶æ˜¾ç¤º\n\n    try {\n      const generateMessage = await ensureMessageGeneratorLoaded();\n      console.log('ğŸš€ å¼€å§‹ç”Ÿæˆæ¶ˆæ¯ï¼Œç”¨æˆ·è¾“å…¥:', message);\n\n      const success = await generateMessage(message, {\n        onShowGenerating: () => {\n          // æ˜¾ç¤ºç”Ÿæˆæç¤ºï¼ˆå¦‚æœè¿˜æ²¡æœ‰æµå¼å…ƒç´ ï¼‰\n          if (!streamingElement) {\n            showGenerating();\n          }\n        },\n        onHideGenerating: () => {\n          // ç”Ÿæˆç»“æŸæ—¶ä¸è¦æŠŠæµå¼ DOM åˆ æ‰ï¼Œå¦åˆ™ç”¨æˆ·ä¼šçœ‹åˆ°â€œå…ˆæ¶ˆå¤±å†å‡ºç°â€çš„é—ªå±ã€‚\n          // æœ€ç»ˆçš„â€œè½¬æ­£â€ä¸ºæ­£å¼æ¶ˆæ¯åœ¨ onRefreshStory -> finalizeStreamingAsAssistant ä¸­å®Œæˆã€‚\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('âŒ ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:', error);\n          hideGenerating();\n          isGenerating = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          isSending = false;\n        },\n        onStreamingUpdate: (text: string) => {\n          // ä¼ é€’å®Œæ•´çš„æ–‡æœ¬ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰ï¼Œç”¨äºæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸ\n          updateStreamingMessage(text);\n        },\n        onRefreshStoryIfOpen: (userMessage: string) => {\n          // user æ¶ˆæ¯åˆ›å»ºåï¼Œç«‹å³åˆ›å»ºä¸€ä¸ªpendingè½®æ¬¡å¹¶æ˜¾ç¤º\n          console.log('ğŸ“ user æ¶ˆæ¯å·²åˆ›å»ºï¼Œç«‹å³æ˜¾ç¤º:', userMessage);\n\n          // è®¾ç½®ç”Ÿæˆæ ‡å¿—\n          isGenerating = true;\n\n          // åˆ›å»ºä¸€ä¸ªpendingè½®æ¬¡\n          const pendingRound: ConversationRound = {\n            assistantMessage: null,\n            userMessage: null,\n            pending: true,\n            pendingUserMessage: userMessage,\n          };\n\n          // å°†pendingè½®æ¬¡æ·»åŠ åˆ°roundsæ•°ç»„\n          rounds.push(pendingRound);\n          currentRoundIndex = rounds.length - 1;\n          activePendingRoundIndex = currentRoundIndex;\n\n          // ç«‹å³æ˜¾ç¤ºè¿™ä¸ªè½®æ¬¡\n          displayRound(currentRoundIndex);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          // assistant æ¶ˆæ¯åˆ›å»ºåï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯\n          console.log('ğŸ“ assistant æ¶ˆæ¯å·²åˆ›å»ºï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯');\n\n          if (options && options.length > 0) {\n            latestOptions = options;\n          } else {\n            latestOptions = [];\n          }\n\n          // âœ… æ ¸å¿ƒï¼šç›´æ¥ finalizeï¼Œä¸é‡è½½å†å²\n          // å°†æœ€åçš„æµå¼ raw æ–‡æœ¬ä¼ å…¥ finalizeï¼ˆå¦‚æœä¸ºç©ºä¹Ÿä¼  ''ï¼Œä»¥ä¿è¯ finalize èƒ½å¤„ç†ï¼‰\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // ç”¨çœŸå® message_id è¦†ç›–ä¸´æ—¶ idï¼ˆç¡®ä¿åç»­å¯ç²¾å‡†åˆ é™¤/é‡æ–°ç”Ÿæˆï¼‰\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.userMessage) r.userMessage.message_id = lastCreatedIds.userMessageId;\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          // ğŸ”• ä¸è¦å†è°ƒç”¨ loadChatHistory()\n\n          // å…¶ä»–æ¨¡å—æ›´æ–°å¯ä»¥ä¿ç•™\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          lastCreatedIds = ids;\n        },\n      });\n\n      if (success) {\n        console.log('âœ… æ¶ˆæ¯ç”ŸæˆæˆåŠŸ');\n        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œå¯ç”¨æŒ‰é’®ï¼ŒæŒ‰é’®åº”è¯¥åœ¨ onRefreshStory ä¸­å¯ç”¨\n        // å› ä¸ºæ­¤æ—¶ AI å¯èƒ½è¿˜åœ¨æµå¼è¾“å‡º\n      }\n    } catch (error) {\n      console.error('âŒ å‘é€æ¶ˆæ¯å¼‚å¸¸:', error);\n      hideGenerating();\n      isGenerating = false;\n      // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç«‹å³å¯ç”¨æŒ‰é’®å’Œè¾“å…¥æ¡†\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      isSending = false;\n      updateRegenerateButtonState();\n    }\n    // æ³¨æ„ï¼šç§»é™¤äº† finally å—ï¼Œå› ä¸ºæŒ‰é’®åº”è¯¥åœ¨ onRefreshStory ä¸­å¯ç”¨\n    // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ AI å®Œå…¨ç”Ÿæˆå®Œæˆåæ‰å¯ç”¨æŒ‰é’®\n  }\n\n  // é‡æ–°ç”Ÿæˆå½“å‰è½®ï¼šåªåˆ é™¤ assistant æ¶ˆæ¯ï¼Œç„¶åè§¦å‘ generate å†åˆ›å»ºæ–°çš„ assistant æ¶ˆæ¯\n  async function regenerateCurrentRound() {\n    if (!chatRegenerateBtn) return;\n    if (isGenerating || isSending) return;\n\n    const round = rounds[currentRoundIndex];\n    if (!round?.userMessage || !round.assistantMessage) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const userMessageId = round.userMessage.message_id;\n    const assistantMessageId = round.assistantMessage.message_id;\n\n    if (typeof userMessageId !== 'number' || !Number.isFinite(userMessageId)) return;\n    if (typeof assistantMessageId !== 'number' || !Number.isFinite(assistantMessageId)) return;\n\n    // UI é”å®š\n    isSending = true;\n    isGenerating = true;\n    lastStreamedRawMessage = '';\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n    chatRegenerateBtn.disabled = true;\n\n    // å½“å‰è½®è¿›å…¥ pendingï¼šä¿ç•™ userMessageï¼Œä»…æ¸…ç©º assistantMessage\n    round.assistantMessage = null;\n    round.pending = true;\n    activePendingRoundIndex = currentRoundIndex;\n    await displayRound(currentRoundIndex);\n\n    try {\n      await deleteChatMessages([assistantMessageId], { refresh: 'none' });\n      console.log('ğŸ—‘ï¸ å·²åˆ é™¤å½“å‰è½® assistant æ¶ˆæ¯ï¼Œå‡†å¤‡é‡æ–°ç”Ÿæˆ:', assistantMessageId);\n\n      const regenerateAssistantMessage = await ensureRegenerateAssistantLoaded();\n\n      await regenerateAssistantMessage(userMessageId, {\n        onShowGenerating: () => {\n          if (!streamingElement) showGenerating();\n        },\n        onHideGenerating: () => {\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('âŒ é‡æ–°ç”Ÿæˆå¤±è´¥:', error);\n          hideGenerating();\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          round.pending = false;\n          updateRegenerateButtonState();\n          // å…œåº•ï¼šé‡æ–°åŠ è½½å†å²ï¼ˆç¡®ä¿ä¸é…’é¦†çœŸå®å†å²ä¸€è‡´ï¼‰\n          loadChatHistory();\n        },\n        onStreamingUpdate: (text: string) => {\n          updateStreamingMessage(text);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          console.log('ğŸ“ assistant æ¶ˆæ¯å·²é‡æ–°ç”Ÿæˆï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯');\n\n          latestOptions = options && options.length > 0 ? options : [];\n\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // é‡æ–°ç”Ÿæˆåªä¼šåˆ›å»ºæ–°çš„ assistant æ¶ˆæ¯ï¼Œå›è°ƒé‡Œä¼šç»™å‡ºæ–°çš„ assistantMessageId\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          // æ¸…é™¤ pending\n          round.pending = false;\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          // regenerate åªåˆ›å»º assistantï¼Œä½†æˆ‘ä»¬ä¿æŒåŒä¸€ä¸ª userMessageId\n          lastCreatedIds = ids;\n        },\n      });\n    } catch (e) {\n      console.error('âŒ é‡æ–°ç”Ÿæˆå¼‚å¸¸:', e);\n      hideGenerating();\n      round.pending = false;\n      isGenerating = false;\n      isSending = false;\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      updateRegenerateButtonState();\n      loadChatHistory();\n    }\n  }\n\n  // æ˜¾ç¤ºç”Ÿæˆæç¤º\n  function showGenerating() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant message-streaming';\n      streamingElement.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content message-content-three-columns\"></div>\n        </div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // æ˜¾ç¤ºç­‰å¾…é€‰æ‹©æç¤ºï¼ˆå½“è½®æ¬¡æ²¡æœ‰assistantæ¶ˆæ¯ä¸”ä¸åœ¨ç”Ÿæˆæ—¶ï¼‰\n  function showWaitingMessage() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant';\n      streamingElement.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content message-content-three-columns\">\n            <div class=\"message-column\">\n              <div class=\"message-column-header\">æ–°å‰§æƒ…</div>\n              <div class=\"message-column-content\">ç­‰å¾…é€‰æ‹©ã€‚</div>\n            </div>\n          </div>\n          <div class=\"message-time\"></div>\n        </div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // éšè—ç”Ÿæˆæç¤º\n  function hideGenerating() {\n    if (streamingElement) {\n      streamingElement.remove();\n      streamingElement = null;\n    }\n  }\n\n  // æäº¤æµå¼ä¸ºæ­£å¼æ¶ˆæ¯ï¼ˆé¿å…å…¨é‡é‡æ¸²æŸ“ï¼‰\n  async function finalizeStreamingAsAssistant(finalText: string) {\n    // å³ä½¿ streamingElement ä¸å­˜åœ¨ï¼Œä¹Ÿåº”è¯¥æŠŠ rounds è¡¥å…¨ï¼ˆé˜²æ­¢ raceï¼‰\n    // å…ˆæŠŠæµå¼ DOM æ›´æ–°ä¸ºæœ€ç»ˆå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n    if (streamingElement) {\n      try {\n        // å¦‚æœæœ‰ä¸‰æ å®¹å™¨ï¼Œå°±ç”¨ç°æœ‰è§£æå‡½æ•°æŠŠ finalText å¡«è¿›å»\n        let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) {\n          // å¦‚æœæ²¡æœ‰ä¸‰æ å®¹å™¨ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªå®¹å™¨ä»¥ä¾¿ updateColumnsFromStream ä½¿ç”¨\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content message-content-three-columns\"></div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n          columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        }\n\n        // ä½¿ç”¨å·²æœ‰çš„è§£æé€»è¾‘æŠŠ finalText æ¸²æŸ“åˆ°æ ç›®é‡Œï¼ˆä¿è¯æœ€ç»ˆè§†å›¾å®Œæ•´ï¼‰\n        await updateColumnsFromStream(finalText, columnsContainer);\n      } catch (err) {\n        // è§£æå¤±è´¥æ—¶å›é€€ä¸ºå•æ æ–‡æœ¬\n        console.error('âŒ finalize æ›´æ–°æµå¼ DOM å¤±è´¥ï¼Œå›é€€ä¸ºå•æ :', err);\n        if (streamingElement) {\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content\">${escapeHtml(finalText)}</div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n        }\n      }\n\n      // ç§»é™¤æµå¼æ ·å¼ï¼ˆå˜ä¸ºæ­£å¼æ¶ˆæ¯ï¼‰\n      streamingElement.classList.remove('message-streaming');\n      const timeEl = streamingElement.querySelector('.message-time');\n      if (timeEl) timeEl.textContent = '';\n    }\n\n    // å…³é”®ï¼šç«‹å³æŠŠ rounds è¡¥å…¨ä¸ºæ­£å¼æ¶ˆæ¯ï¼Œä½¿ç”¨ finalTextï¼ˆä¸ä¾èµ–åç«¯ï¼‰\n    // æ³¨æ„ï¼šç”¨æˆ·å¯èƒ½åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æµè§ˆå†å²è½®æ¬¡ï¼Œå› æ­¤ä¸èƒ½ä¾èµ– currentRoundIndex\n    const pendingIdx = getPendingRoundIndexSafe();\n    if (typeof pendingIdx === 'number' && pendingIdx >= 0 && pendingIdx < rounds.length) {\n      const targetRound = rounds[pendingIdx];\n      if (targetRound && targetRound.pending) {\n        // å¦‚æœ pendingï¼Œåˆ™ç›´æ¥ç”¨ finalText å¡«å…… assistantMessage\n        targetRound.assistantMessage = {\n          // ä¸´æ—¶ idï¼Œåé¢å¯ä»¥å¼‚æ­¥ç”¨çœŸå® id è¦†ç›–\n          message_id: Date.now(),\n          message: finalText || (streamingElement ? streamingElement.textContent || '' : ''),\n        };\n\n        // å¦‚æœæœ‰ pendingUserMessage -> å°†å…¶è½¬ä¸º userMessageï¼ˆä¸´æ—¶ idï¼‰\n        if (targetRound.pendingUserMessage) {\n          targetRound.userMessage = {\n            message_id: Date.now() - 1,\n            message: targetRound.pendingUserMessage,\n          };\n        }\n\n        targetRound.pending = false;\n        delete targetRound.pendingUserMessage;\n      }\n    } else {\n      console.warn('âš ï¸ finalize: æœªæ‰¾åˆ° pending è½®æ¬¡ï¼Œå¯èƒ½æ˜¯çŠ¶æ€ç«äº‰æˆ–å·²è¢«åˆ·æ–°é‡å»º');\n    }\n\n    // âœ… ä¸è¦åœ¨ç”Ÿæˆç»“æŸåå† displayRound() å…¨é‡é‡å»º DOM\n    // è¿™ä¼šå¯¼è‡´ chatMessages æ¸…ç©º/é‡å»ºï¼Œè‚‰çœ¼è¡¨ç°ä¸ºâ€œåˆ·æ–°é—ªä¸€ä¸‹â€ï¼Œå¹¶ä¸”å®¹æ˜“å¼•å…¥ä½ç½®/æ»šåŠ¨ç­‰æ–°é—®é¢˜ã€‚\n    // è¿™é‡Œä»…æŠŠæµå¼å…ƒç´ â€œè½¬æ­£â€ä¸ºæœ€ç»ˆæ¶ˆæ¯ï¼Œå¹¶æ›´æ–° rounds æ•°æ®å³å¯ã€‚\n    streamingElement = null;\n    activePendingRoundIndex = null;\n  }\n\n  // æ›´æ–°æµå¼æ¶ˆæ¯ï¼ˆå®æ—¶æ¸²æŸ“ï¼Œæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸï¼‰\n  async function updateStreamingMessage(text: string) {\n    // ä¿å­˜æœ€æ–°æµå¼æ–‡æœ¬ï¼Œä¾› finalize ä½¿ç”¨ï¼ˆé¿å…ä¾èµ–åç«¯ç«‹å³æŒä¹…åŒ–ï¼‰\n    lastStreamedRawMessage = text;\n\n    if (!streamingElement) {\n      // å¦‚æœè¿˜æ²¡æœ‰æµå¼å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª\n      showGenerating();\n    }\n\n    if (!streamingElement) return;\n\n    try {\n      // è·å–æˆ–åˆ›å»ºæ ç›®å®¹å™¨\n      let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n      if (!columnsContainer) {\n        streamingElement.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\"></div>\n            <div class=\"message-time\">ç”Ÿæˆä¸­</div>\n          </div>\n        `;\n        columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) return;\n      }\n\n      await updateColumnsFromStream(text, columnsContainer);\n    } catch (error) {\n      console.error('âŒ æ›´æ–°æµå¼æ¶ˆæ¯å¤±è´¥:', error);\n    }\n  }\n\n  // ä»æµå¼æ–‡æœ¬æ›´æ–°æ ç›®ï¼ˆæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸï¼ŒåŠ¨æ€åˆ›å»ºæ ç›®ï¼‰\n  async function updateColumnsFromStream(text: string, container: HTMLElement) {\n    // å®šä¹‰æ ç›®é…ç½®\n    const columnConfigs = [\n      { tag: 'continue_choice', header: 'é€‰æ‹©å»¶ç»­', key: 'continue' },\n      { tag: 'result', header: 'åæœæ€»ç»“', key: 'result' },\n      { tag: 'decision_node', header: 'æ–°å‰§æƒ…', key: 'next' },\n    ];\n\n    // æ£€æµ‹æ¯ä¸ªæ ‡ç­¾çš„å¼€å§‹å’Œç»“æŸï¼Œæå–å†…å®¹\n    for (const config of columnConfigs) {\n      const startTag = `<${config.tag}>`;\n      const endTag = `</${config.tag}>`;\n\n      // è·å–æˆ–åˆ›å»ºæ ç›®å…ƒç´ ï¼ˆå…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼‰\n      let columnElement = container.querySelector(`[data-column-key=\"${config.key}\"]`) as HTMLElement;\n\n      // æ£€æŸ¥è¯¥æ ç›®æ˜¯å¦å·²ç»é—­åˆï¼ˆå¦‚æœå·²å­˜åœ¨ä¸”å·²é—­åˆï¼Œä¸å†æ›´æ–°ï¼‰\n      if (columnElement) {\n        const isClosed = columnElement.hasAttribute('data-closed');\n        if (isClosed) {\n          // æ ç›®å·²é—­åˆï¼Œä¸å†æ›´æ–°\n          continue;\n        }\n      }\n\n      // æ£€æµ‹æ˜¯å¦å·²ç»å¼€å§‹ï¼ˆæœ‰å¼€å§‹æ ‡ç­¾ï¼‰\n      const startIndex = text.indexOf(startTag);\n      if (startIndex === -1) {\n        // è¿˜æ²¡æœ‰å¼€å§‹æ ‡ç­¾ï¼Œè·³è¿‡è¿™ä¸ªæ ç›®\n        continue;\n      }\n\n      // æå–å¼€å§‹æ ‡ç­¾ä¹‹åçš„å†…å®¹\n      const contentStart = startIndex + startTag.length;\n      const endIndex = text.indexOf(endTag, contentStart);\n\n      let content = '';\n\n      if (endIndex !== -1) {\n        // æœ‰ç»“æŸæ ‡ç­¾ï¼Œæå–å®Œæ•´å†…å®¹ï¼Œå¹¶æ ‡è®°ä¸ºå·²é—­åˆ\n        content = text.substring(contentStart, endIndex);\n\n        // å¦‚æœæ ç›®å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.textContent = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n\n        // æ ‡è®°ä¸ºå·²é—­åˆï¼Œä¹‹åä¸å†æ›´æ–°\n        columnElement.setAttribute('data-closed', 'true');\n      } else {\n        // è¿˜æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼Œæå–åˆ°ç›®å‰ä¸ºæ­¢çš„å†…å®¹\n        content = text.substring(contentStart);\n\n        // å¦‚æœæ ç›®å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.textContent = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n      }\n\n      // æ›´æ–°æ ç›®å†…å®¹ï¼ˆåªæ›´æ–°æ–‡æœ¬å†…å®¹ï¼Œä¸æ›¿æ¢æ•´ä¸ª HTMLï¼Œä¿æŒæ»šåŠ¨ä½ç½®ï¼‰\n      const contentElement = columnElement.querySelector('.message-column-content') as HTMLElement;\n      if (contentElement) {\n        // ä¿å­˜æ»šåŠ¨çŠ¶æ€\n        const oldScrollTop = contentElement.scrollTop;\n        const oldScrollHeight = contentElement.scrollHeight;\n        const wasAtBottom = oldScrollTop + contentElement.clientHeight >= oldScrollHeight - 10;\n\n        // æ›´æ–°å†…å®¹\n        contentElement.textContent = content;\n\n        // æ¢å¤æ»šåŠ¨ä½ç½®\n        if (wasAtBottom) {\n          // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨\n          contentElement.scrollTop = contentElement.scrollHeight;\n        } else {\n          // å¦åˆ™ä¿æŒç›¸å¯¹ä½ç½®ï¼ˆå°½é‡ä¿æŒåŸæœ‰ä½ç½®ï¼‰\n          const newScrollHeight = contentElement.scrollHeight;\n          if (newScrollHeight > oldScrollHeight) {\n            // å†…å®¹å¢åŠ äº†ï¼Œä¿æŒç›¸å¯¹ä½ç½®\n            contentElement.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);\n          } else {\n            // å†…å®¹å‡å°‘äº†æˆ–ä¸å˜ï¼Œä¿æŒåŸä½ç½®\n            contentElement.scrollTop = oldScrollTop;\n          }\n        }\n      }\n    }\n  }\n\n  // ä¸Šä¸€è½®\n  function goToPreviousRound() {\n    if (currentRoundIndex > 0) {\n      currentRoundIndex--;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ä¸‹ä¸€è½®\n  function goToNextRound() {\n    if (currentRoundIndex < rounds.length - 1) {\n      currentRoundIndex++;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ========== Option é€‰é¡¹åŠŸèƒ½ ==========\n  const optionsOverlay = document.getElementById('chat-options-overlay');\n  const optionsContainer = document.getElementById('chat-options-container');\n  const optionsList = document.getElementById('chat-options-list');\n  const showOptionsBtn = document.getElementById('chat-show-options-btn');\n  const closeOptionsBtn = document.getElementById('chat-options-close');\n\n  // ä»æœ€æ–°æ¶ˆæ¯æå–é€‰é¡¹æ•°æ®\n  async function getOptionsFromLatestMessage(): Promise<string[]> {\n    try {\n      // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼‰\n      if (latestOptions.length > 0) {\n        console.log('âœ… ä½¿ç”¨ä¿å­˜çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼‰');\n        return latestOptions;\n      }\n\n      // æ¬¡ä¼˜å…ˆï¼šä» assistant æ¶ˆæ¯çš„ data ä¸­è¯»å–ï¼ˆæŒä¹…åŒ–é€‰é¡¹ï¼‰\n      const messages = getChatMessages(-1, { role: 'assistant' });\n      const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n      if (!lastMessage) {\n        return [];\n      }\n\n      if (lastMessage.data?.__options && lastMessage.data.__options.length > 0) {\n        console.log('âœ… ä» assistant.data è¯»å–é€‰é¡¹ï¼ˆæŒä¹…åŒ–ï¼‰');\n        return lastMessage.data.__options;\n      }\n\n      // é™çº§ï¼šä»æ¶ˆæ¯ä¸­æå–ï¼ˆå¦‚æœä»¥ä¸Šæ–¹æ¡ˆå‡ä¸å¯ç”¨ï¼‰\n      const { extractAllOptions } = await import('./utils/textParser');\n      const messageContent = lastMessage.message || '';\n      const options = extractAllOptions(messageContent);\n      if (options.length > 0) {\n        console.log('âœ… ä»æ¶ˆæ¯ä¸­æå–é€‰é¡¹ï¼ˆé™çº§æ–¹æ¡ˆï¼‰');\n      }\n      return options;\n    } catch (error) {\n      console.error('âŒ è·å–é€‰é¡¹å¤±è´¥:', error);\n      return [];\n    }\n  }\n\n  // æ˜¾ç¤ºé€‰é¡¹æµ®å±‚\n  async function showOptionsOverlay() {\n    if (!optionsOverlay || !optionsContainer || !optionsList) {\n      return;\n    }\n\n    const options = await getOptionsFromLatestMessage();\n\n    if (options.length === 0) {\n      // å¦‚æœoptionä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º\n      showNoOptionsMessage();\n      return;\n    }\n\n    // æ¸…ç©ºä¹‹å‰çš„é€‰é¡¹\n    optionsList.innerHTML = '';\n\n    // é‡ç½®çŠ¶æ€\n    optionsList.classList.remove('collapse');\n\n    // è®¾ç½®é€‰é¡¹åˆ—è¡¨ä¸ºå…¨å±å®šä½å®¹å™¨\n    optionsList.style.position = 'absolute';\n    optionsList.style.top = '0';\n    optionsList.style.left = '0';\n    optionsList.style.right = '0';\n    optionsList.style.bottom = '0';\n    optionsList.style.width = '100%';\n    optionsList.style.height = '100%';\n    // éœ€è¦è®© list èƒ½ hoverï¼ˆç”¨äº hover èšç„¦/æ¨¡ç³Šæ•ˆæœçš„ CSS å›é€€æ–¹æ¡ˆï¼‰ï¼›\n    // åŒæ—¶é€šè¿‡ click handler æ”¯æŒâ€œç‚¹ç©ºç™½å¤„å…³é—­â€ï¼Œé¿å… list åƒæ‰ overlay çš„ç‚¹å‡»ã€‚\n    optionsList.style.pointerEvents = 'auto';\n\n    // è·å– overlay çš„å°ºå¯¸ï¼Œç”¨äºè®¡ç®—éšæœºä½ç½®\n    if (!optionsOverlay) return;\n\n    // å­˜å‚¨å·²ä½¿ç”¨çš„ä½ç½®ï¼Œé¿å…é‡å \n    const usedPositions: Array<{ x: number; y: number }> = [];\n    const minDistance = 150; // æœ€å°é—´è·ï¼ˆåƒç´ ï¼‰\n\n    // ç”Ÿæˆéšæœºä½ç½®ï¼Œç¡®ä¿ä¸é‡å ä¸”ä¸é è¾¹ç¼˜\n    function generateRandomPosition(): { x: number; y: number } {\n      const maxAttempts = 50;\n      let attempts = 0;\n      const margin = 0.15; // è¾¹ç¼˜è¾¹è·ï¼ˆ15%ï¼‰\n\n      while (attempts < maxAttempts) {\n        // éšæœºä½ç½®ï¼Œä½†ç•™å‡ºè¾¹ç¼˜ç©ºé—´\n        const x = margin + Math.random() * (1 - 2 * margin);\n        const y = margin + Math.random() * (1 - 2 * margin);\n\n        // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰ä½ç½®å¤ªè¿‘\n        const tooClose = usedPositions.some(pos => {\n          const overlayWidth = optionsOverlay!.clientWidth;\n          const overlayHeight = optionsOverlay!.clientHeight;\n          const dx = (x - pos.x) * overlayWidth;\n          const dy = (y - pos.y) * overlayHeight;\n          const distance = Math.sqrt(dx * dx + dy * dy);\n          return distance < minDistance;\n        });\n\n        if (!tooClose) {\n          usedPositions.push({ x, y });\n          return { x, y };\n        }\n\n        attempts++;\n      }\n\n      // å¦‚æœæ— æ³•æ‰¾åˆ°ä¸é‡å çš„ä½ç½®ï¼Œä½¿ç”¨éšæœºä½ç½®ï¼ˆä½†ä»æœ‰è¾¹è·ï¼‰\n      const x = margin + Math.random() * (1 - 2 * margin);\n      const y = margin + Math.random() * (1 - 2 * margin);\n      usedPositions.push({ x, y });\n      return { x, y };\n    }\n\n    // æ¸²æŸ“æ¯ä¸ªé€‰é¡¹ä¸ºåœ†å½¢æ°”æ³¡ï¼Œéšæœºä½ç½®\n    options.forEach((optionText, index) => {\n      // å¯ä»¥åŒæ—¶æµ®ç°å¤šä¸ªé€‰é¡¹ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰\n      const delay = index * 80; // å‡å°‘å»¶è¿Ÿï¼Œè®©é€‰é¡¹æ›´å¿«æµ®ç°\n\n      setTimeout(() => {\n        // STEP 1: åˆ›å»ºå®¹å™¨ + æ°”æ³¡ç»“æ„\n        const chatOption = document.createElement('div');\n        chatOption.className = 'chat-option';\n\n        const optionButton = document.createElement('button');\n        optionButton.type = 'button';\n        optionButton.className = 'chat-option-button';\n\n        const optionTextSpan = document.createElement('span');\n        optionTextSpan.className = 'chat-option-text';\n        optionTextSpan.textContent = optionText;\n        optionButton.title = optionText;\n\n        optionButton.appendChild(optionTextSpan);\n        chatOption.appendChild(optionButton);\n\n        // ç”Ÿæˆéšæœºä½ç½®\n        const position = generateRandomPosition();\n        const rotate = (Math.random() - 0.5) * 30; // -15 åˆ° 15 åº¦éšæœºæ—‹è½¬\n\n        chatOption.style.setProperty('--rot', `${rotate}deg`);\n        chatOption.style.left = `${position.x * 100}%`;\n        chatOption.style.top = `${position.y * 100}%`;\n        chatOption.style.position = 'absolute';\n        chatOption.style.pointerEvents = 'auto'; // æ°”æ³¡æœ¬èº«å¯ç‚¹å‡»\n\n        // æ€ç»´æƒé‡ï¼ˆè¶Šé å‰è¶Š\"æ¸…æ™°\"ï¼‰\n        const weight = options.length - index;\n        // é™ä½åŸºç¡€ä¸é€æ˜åº¦å·®å¼‚ï¼Œç¡®ä¿åœ¨æ¨¡ç³Šæ—¶ä¾ç„¶å¯è§\n        optionButton.style.opacity = `${0.85 + weight * 0.03}`;\n        // ç§»é™¤åˆå§‹æ¨¡ç³Šï¼Œç¡®ä¿æ‰€æœ‰é€‰é¡¹åŸºç¡€æ¸…æ™°åº¦\n        optionButton.style.filter = 'none';\n\n        // ç‚¹å‡»ï¼šæ€ç»´åç¼©\n        optionButton.addEventListener('click', () => {\n          optionButton.classList.add('selected');\n          chatOption.classList.add('selected-parent');\n          optionsList.classList.add('collapse');\n\n          setTimeout(() => {\n            chatInput.value = optionText;\n            adjustInputHeight();\n            sendMessage();\n            hideOptionsOverlay();\n          }, 220);\n        });\n\n        optionsList.appendChild(chatOption);\n\n        // è§¦å‘\"å¿µå¤´æˆå½¢\"åŠ¨ç”»\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            chatOption.classList.add('show');\n          });\n        });\n      }, delay);\n    });\n\n    optionsOverlay.classList.add('active');\n    console.log(`âœ… å·²æ˜¾ç¤º ${options.length} ä¸ªé€‰é¡¹`);\n  }\n\n  // æ˜¾ç¤ºæ— é€‰é¡¹æç¤º\n  function showNoOptionsMessage() {\n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'chat-no-options-message';\n    messageDiv.innerHTML = `\n      <div class=\"chat-no-options-content\">\n        <div class=\"chat-no-options-text\">åšå†³å®šå§ qwq</div>\n        <button type=\"button\" class=\"chat-no-options-close\" title=\"å…³é—­\">Ã—</button>\n      </div>\n    `;\n\n    const closeBtn = messageDiv.querySelector('.chat-no-options-close');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        hideOptionsOverlay();\n      });\n    }\n\n    // æ·»åŠ åˆ°é€‰é¡¹åˆ—è¡¨å®¹å™¨ä¸­\n    if (optionsList) {\n      optionsList.innerHTML = '';\n      // é‡ç½®æ ·å¼ï¼Œç¡®ä¿æ— é€‰é¡¹æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤º\n      optionsList.style.position = 'absolute';\n      optionsList.style.top = '50%';\n      optionsList.style.left = '50%';\n      optionsList.style.transform = 'translate(-50%, -50%)';\n      optionsList.style.width = 'auto';\n      optionsList.style.height = 'auto';\n      optionsList.style.pointerEvents = 'auto';\n      optionsList.classList.remove('collapse');\n      optionsList.appendChild(messageDiv);\n    }\n\n    // æ˜¾ç¤ºæµ®å±‚\n    if (optionsOverlay) {\n      optionsOverlay.classList.add('active');\n    }\n  }\n\n  // éšè—é€‰é¡¹æµ®å±‚\n  function hideOptionsOverlay() {\n    if (optionsOverlay) {\n      optionsOverlay.classList.remove('active');\n    }\n    // é‡ç½® collapse çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æ—¶èƒ½æ­£å¸¸æ˜¾ç¤º\n    if (optionsList) {\n      optionsList.classList.remove('collapse');\n    }\n  }\n\n  // ç»‘å®šé€‰é¡¹ç›¸å…³äº‹ä»¶\n  if (showOptionsBtn) {\n    showOptionsBtn.addEventListener('click', showOptionsOverlay);\n  }\n\n  if (closeOptionsBtn) {\n    closeOptionsBtn.addEventListener('click', hideOptionsOverlay);\n  }\n\n  if (optionsOverlay) {\n    optionsOverlay.addEventListener('click', e => {\n      // å…è®¸ç‚¹å‡»ç©ºç™½å¤„å…³é—­ï¼š\n      // - target æ˜¯ overlayï¼ˆçœŸæ­£èƒŒæ™¯ï¼‰\n      // - æˆ– target æ˜¯ list æœ¬èº«ï¼ˆlist è¦†ç›–å…¨å±æ—¶ï¼‰\n      if (e.target === optionsOverlay || e.target === optionsList) {\n        hideOptionsOverlay();\n      }\n    });\n  }\n\n  // ç»‘å®šå‘é€æŒ‰é’®äº‹ä»¶\n  chatSendBtn.addEventListener('click', sendMessage);\n\n  // ç»‘å®šé‡æ–°ç”ŸæˆæŒ‰é’®äº‹ä»¶\n  if (chatRegenerateBtn) {\n    chatRegenerateBtn.addEventListener('click', regenerateCurrentRound);\n  }\n\n  // ç»‘å®š Enter é”®å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰\n  chatInput.addEventListener('keydown', e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n\n  // è®¾ç½®é”®ç›˜å¯¼èˆª\n  setupKeyboardNavigation();\n\n  // è®¾ç½®æ¨¡å—åˆ‡æ¢ç›‘å¬\n  function setupModuleSwitchListener() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const observer = new MutationObserver(() => {\n      if (communicationModule.classList.contains('active')) {\n        console.log('ğŸ“¡ é€šè®¯æ¨¡å—å·²æ¿€æ´»ï¼Œåˆ·æ–°æ˜¾ç¤º');\n        refreshDisplay();\n      }\n    });\n\n    observer.observe(communicationModule, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // åˆå§‹åŒ–æ—¶åŠ è½½å†å²æ¶ˆæ¯\n  loadChatHistory();\n\n  // è®¾ç½®æ¨¡å—åˆ‡æ¢ç›‘å¬\n  setupModuleSwitchListener();\n}\n","// é”š - ä¸»é€»è¾‘\nimport { PageManager } from './utils/pageManager';\nimport { initNavigation, initModals, initAnimations, initStatusCardInteractions, initChatInterface } from './dashboardLogic';\n\nlet pageManager: PageManager | null = null;\n\n/**\n * åˆå§‹åŒ–åº”ç”¨\n */\nfunction initApp() {\n  const appContainer = document.getElementById('app');\n  if (!appContainer) {\n    console.error('æœªæ‰¾åˆ° #app å®¹å™¨');\n    return;\n  }\n\n  // åˆå§‹åŒ–é¡µé¢ç®¡ç†å™¨\n  pageManager = new PageManager(appContainer);\n  pageManager.initialize();\n\n  // ç›‘å¬é¡µé¢åˆ‡æ¢ï¼Œå½“è¿›å…¥æ¸¸æˆé¡µé¢æ—¶åˆå§‹åŒ–åŠŸèƒ½\n  const mainScreen = document.getElementById('main-screen');\n  if (mainScreen) {\n    const observer = new MutationObserver(() => {\n      if (mainScreen.classList.contains('active')) {\n        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“\n        setTimeout(() => {\n          initDashboardFeatures();\n        }, 100);\n      }\n    });\n\n    observer.observe(mainScreen, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // ç›‘å¬é…’é¦†æ¶ˆæ¯æ›´æ–°äº‹ä»¶\n  eventOn(tavern_events.MESSAGE_UPDATED, () => {\n    if (pageManager) {\n      const dashboard = pageManager.getDashboard();\n      // åˆ·æ–°æ¸¸æˆæ•°æ®\n      // è¿™é‡Œå¯ä»¥ä»å˜é‡ç³»ç»Ÿè¯»å–æœ€æ–°æ•°æ®å¹¶æ›´æ–°\n      console.info('æ¶ˆæ¯å·²æ›´æ–°ï¼Œåˆ·æ–°æ¸¸æˆæ•°æ®');\n    }\n  });\n}\n\n/**\n * åˆå§‹åŒ–ä¸»æ¸¸æˆç•Œé¢åŠŸèƒ½\n */\nfunction initDashboardFeatures() {\n  // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡\n  if (document.querySelector('.nav-item[data-module=\"status\"]')?.hasAttribute('data-initialized')) {\n    return;\n  }\n\n  initNavigation();\n  initModals();\n  initAnimations();\n  initStatusCardInteractions();\n  initChatInterface();\n\n  // æ ‡è®°å·²åˆå§‹åŒ–\n  document.querySelectorAll('.nav-item').forEach(item => {\n    item.setAttribute('data-initialized', 'true');\n  });\n\n  console.info('ä¸»æ¸¸æˆç•Œé¢åŠŸèƒ½å·²åˆå§‹åŒ–');\n}\n\n// ä½¿ç”¨ jQuery åœ¨åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–ï¼ˆç¬¦åˆé¡¹ç›®è§„èŒƒï¼‰\n$(() => {\n  errorCatched(initApp)();\n});\n\n// åœ¨ç•Œé¢å¸è½½æ—¶æ‰§è¡Œæ¸…ç†\n$(window).on('pagehide', () => {\n  console.info('é”šç•Œé¢å·²å¸è½½');\n  if (pageManager) {\n    // å¯ä»¥åœ¨è¿™é‡Œæ¸…ç†èµ„æº\n  }\n});\n","// å¯¼å…¥æ ·å¼\nimport './styles.css';\n\n// åˆå§‹åŒ–å‡½æ•°\nfunction init() {\n  // æ·»åŠ  FontAwesome CSS\n  if (!document.querySelector('link[href*=\"font-awesome\"]')) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';\n    document.head.appendChild(link);\n  }\n\n  // æ·»åŠ  meta æ ‡ç­¾\n  if (!document.querySelector('meta[charset]')) {\n    const charset = document.createElement('meta');\n    charset.setAttribute('charset', 'UTF-8');\n    document.head.appendChild(charset);\n  }\n\n  if (!document.querySelector('meta[name=\"viewport\"]')) {\n    const viewport = document.createElement('meta');\n    viewport.setAttribute('name', 'viewport');\n    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');\n    document.head.appendChild(viewport);\n  }\n\n  // è®¾ç½®æ ‡é¢˜\n  document.title = 'é”š';\n\n  // æ·»åŠ æè¿°\n  if (!document.querySelector('meta[name=\"description\"]')) {\n    const description = document.createElement('meta');\n    description.setAttribute('name', 'description');\n    description.setAttribute('content', 'é”š - èˆ°ä½“ç”Ÿå­˜ç»è¥æ¸¸æˆ - ç®¡ç†ä»»åŠ¡ã€è®°å½•æ—¥å¿—ã€å¤„ç†é€šè®¯ã€ç›‘æ§èˆ°ä½“çŠ¶æ€');\n    document.head.appendChild(description);\n  }\n}\n\n// ä½¿ç”¨ jQuery åœ¨åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–ï¼ˆç¬¦åˆé¡¹ç›®è§„èŒƒï¼‰\n$(() => {\n  init();\n  console.info('é”šç•Œé¢å·²åŠ è½½');\n});\n\n// åœ¨ç•Œé¢å¸è½½æ—¶æ‰§è¡Œæ¸…ç†\n$(window).on('pagehide', () => {\n  console.info('é”šç•Œé¢å·²å¸è½½');\n});\n\n// å¯¼å…¥åº”ç”¨é€»è¾‘\nimport './app';\n"],"names":["checkGenerateAvailable","generate","window","async","regenerateAssistantMessage","userMessageId","callbacks","onShowGenerating","streamingHandler","eventOn","iframe_events","STREAM_TOKEN_RECEIVED_FULLY","fullText","cleanedText","trim","length","onStreamingUpdate","console","log","Error","generatePromise","should_stream","timeoutPromise","Promise","_","reject","setTimeout","result","race","cleanedResult","onHideGenerating","onError","maintext","extractLastMaintext","option","sum","updateVariable","finalMessage","base","userMsg","getChatMessages","data","role","Mvu","getMvuData","type","message_id","stat_data","display_data","delta_data","finalData","parseMessage","parsed","e","warn","extractedOptions","extractAllOptions","messageToSave","createChatMessages","message","__options","refresh","assistantMessageId","getLastMessageId","onCreatedMessages","onRefreshStory","error","generateMessage","userInput","mvu_data","waitGlobalInitialized","initData","latestData","chatData","getBaseMvuData","checkAndRefresh","retries","checkMessageId","messages","onRefreshStoryIfOpen","createError","String","substring","generateError","errorType","errorMessage","errorStack","stack","undefined","includes","deleteChatMessages","userMessage","maintextContent","deleteError","module","exports","removeThinkingTags","text","lastResult","replace","removeThinkingTagsFromStream","cleaned","lastThinkingStart","lastIndexOf","matches","match","contentMatch","extractContinueChoice","extractResult","extractNextChoice","extractLastOption","suboptionMatches","options","forEach","content","push","optionMatches","lines","split","map","line","filter","extractLastSum","extractLastUpdateVariable","validateMessage","messageContent","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","hasSaveData","lastMessageId","SplashScreen","element","constructor","this","createElement","div","document","className","id","innerHTML","getHTML","bindEvents","updateContinueButton","show","classList","add","hide","remove","destroy","$","off","keyDownHandler","removeEventListener","continueButton","querySelector","style","display","newGameButton","addEventListener","onNewGame","onContinue","fullscreenButton","requestFullscreen","contains","preventDefault","documentElement","catch","err","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","NewGameSetup","reserveInput","config","getConfig","reserve","updateMvuVariable","confirmButton","inputValue","value","toastr","parseInt","isNaN","Number","isInteger","onConfirm","cancelButton","onCancel","replaceMvuData","currentMvuData","updatedStatData","system_state","antimatter","Math","max","min","updatedMvuData","info","Dashboard","gameData","loadedMessageIds","Set","mvuUpdateListener","statusRetryCount","statusRetryTimer","refreshData","fallbackDiv","stop","clearTimeout","updateGameData","updateStatusCards","updateTasksList","updateDiaryList","loadMaintextFromChat","statusGrid","getVariables","timeout","intervalBetweenAttempts","chatSystemState","latestSystemState","initSystemState","latest","initMsg","systemState","cycle","system_pressure","instability","population","cards","leakRisk","leak_risk","reservePercent","round","riskLevel","toLocaleString","toFixed","pop","active","standby","archived","total","pressure","pressurePercent","pressureLevel","instabilityPercent","instabilityLevel","join","tasksList","tasks","Array","isArray","getDefaultTasks","task","getTaskIcon","status","escapeHtml","title","getStatusText","time","priority","getPriorityText","description","diaryList","diary","getDefaultDiary","entry","date","updateChatMessages","getDefaultMessages","textContent","parseMaintext","maintextMatch","lastMessage","has","then","el","continueChoice","nextChoice","continueChoiceArea","resultArea","nextChoiceArea","setupMessageListener","tavern_events","handleMessageReceived","MESSAGE_RECEIVED","CHAT_CHANGED","MESSAGE_UPDATED","toggleFullscreen","setupEnterKeyFullscreen","events","VARIABLE_UPDATE_ENDED","activeElement","tagName","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","fullscreenElement","initializeGameData","currentStatData","clampedReserve","updateMvuVariables","station_name","difficulty","resources","energy","supplies","crew","life_support","system","personnel","communication","laboratory","storage","computing","currentData","updatedData","game_data","replaceVariables","game_config","updateGameConfig","PageManager","currentPage","splashScreen","setupScreen","dashboard","appContainer","onStart","goToSplash","goToSetup","goToGame","handleConfirm","onFullscreenToggle","initialize","appendChild","showPage","page","dashboardElement","getElementById","variables","continueGame","fallbackError","initializeNewGame","success","getDashboard","initChatInterface","chatInput","chatSendBtn","chatRegenerateBtn","chatMessages","rounds","currentRoundIndex","activePendingRoundIndex","getPendingRoundIndexSafe","pending","i","r","findLastPendingRoundIndex","streamingElement","lastStreamedRawMessage","isGenerating","isSending","latestOptions","lastCreatedIds","generateMessagePromise","regenerateAssistantMessagePromise","adjustInputHeight","height","newHeight","scrollHeight","displayRound","roundIndex","from","children","child","msg","updateRegenerateButtonState","renderUserMessage","pendingUserMessage","assistantMessage","rawMessage","messageItem","searchText","columns","header","columnsHtml","col","renderAssistantMessage","showGenerating","parentNode","disabled","enabled","isFinite","loadChatHistory","newRounds","allMessages","pendingRound","groupMessagesIntoRounds","sendMessage","timeEl","hideGenerating","updateStreamingMessage","finalizeStreamingAsAssistant","idx","dispatchEvent","CustomEvent","debug","ids","finalText","columnsContainer","updateColumnsFromStream","pendingIdx","targetRound","Date","now","container","columnConfigs","tag","startTag","endTag","columnElement","hasAttribute","startIndex","indexOf","contentStart","endIndex","setAttribute","headerElement","contentElement","oldScrollTop","scrollTop","oldScrollHeight","wasAtBottom","clientHeight","newScrollHeight","optionsOverlay","optionsContainer","optionsList","showOptionsBtn","closeOptionsBtn","hideOptionsOverlay","getOptionsFromLatestMessage","messageDiv","closeBtn","position","top","left","transform","width","pointerEvents","showNoOptionsMessage","right","bottom","usedPositions","optionText","index","chatOption","optionButton","optionTextSpan","attempts","margin","x","random","y","some","pos","overlayWidth","clientWidth","overlayHeight","dx","dy","sqrt","generateRandomPosition","rotate","setProperty","weight","opacity","requestAnimationFrame","target","shiftKey","communicationModule","click","setupKeyboardNavigation","MutationObserver","refreshDisplay","observe","attributes","attributeFilter","setupModuleSwitchListener","pageManager","initApp","mainScreen","navItems","querySelectorAll","modules","switchModule","nav","targetNavItem","targetModule","item","getAttribute","moduleMap","HTMLElement","isContentEditable","initNavigation","modalOverlay","modalClose","initModals","card","initDashboardFeatures","errorCatched","on","link","rel","href","head","charset","viewport","init"],"ignoreList":[],"sourceRoot":""}