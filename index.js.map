{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/anchor/utils/textParser.ts","src://tavern_helper_template/src/anchor/utils/messageGenerator.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/src/anchor/utils/variableReader.ts","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/anchor/components/SplashScreen.ts","src://tavern_helper_template/src/anchor/components/NewGameSetup.ts","src://tavern_helper_template/src/anchor/components/Dashboard.ts","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/anchor/utils/variableUpdater.ts","src://tavern_helper_template/src/anchor/utils/pageManager.ts","src://tavern_helper_template/src/anchor/utils/gameInitializer.ts","src://tavern_helper_template/src/anchor/dashboardLogic.ts","src://tavern_helper_template/src/anchor/app.ts","src://tavern_helper_template/src/anchor/index.ts"],"sourcesContent":["/**\n * ÊñáÊú¨Ëß£ÊûêÂ∑•ÂÖ∑\n * Áî®‰∫é‰ªé LLM ËøîÂõûÁöÑÊñáÊú¨‰∏≠ÊèêÂèñÊ†ºÂºèÂåñÁöÑÊ†áÁ≠æÂÜÖÂÆπ\n */\n\n/**\n * ÁßªÈô§ <thinking> Ê†áÁ≠æÂèäÂÖ∂ÂÜÖÈÉ®ÊâÄÊúâÂÜÖÂÆπÔºàÁî®‰∫éÊúÄÁªàÁªìÊûúÔºâ\n */\nexport function removeThinkingTags(text: string): string {\n  if (!text) return '';\n\n  // ÂåπÈÖç <thinking>...</thinking> Ê†áÁ≠æÔºàÂåÖÊã¨ÁÆÄÂçïÂµåÂ•óÊÉÖÂÜµÔºâ\n  let result = text;\n  let lastResult = '';\n\n  // Âæ™ÁéØÂ§ÑÁêÜÔºåÁõ¥Âà∞Ê≤°ÊúâÊõ¥Â§öÁöÑ <thinking> Ê†áÁ≠æ\n  while (result !== lastResult) {\n    lastResult = result;\n    result = result.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n  }\n\n  return result;\n}\n\n/**\n * ‰ªéÊµÅÂºèÊñáÊú¨‰∏≠ÁßªÈô§ <thinking> ÂÜÖÂÆπ\n * - ÂÖàÁßªÈô§ÊâÄÊúâÂÆåÊï¥ÁöÑ <thinking>...</thinking>\n * - Â¶ÇÊûúËøòÊúâÊú™Èó≠ÂêàÁöÑ <thinking>ÔºåÂàôÈöêËóè‰ªéÊúÄÂêé‰∏Ä‰∏™ <thinking> ÂºÄÂßãÁöÑÊâÄÊúâÂÜÖÂÆπ\n */\nexport function removeThinkingTagsFromStream(text: string): string {\n  if (!text) return '';\n\n  // ÂÖàÁßªÈô§ÊâÄÊúâÂÆåÊï¥ÁöÑ <thinking>...</thinking> Ê†áÁ≠æÂØπ\n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n\n  // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊú™Èó≠ÂêàÁöÑ <thinking> Ê†áÁ≠æ\n  const lastThinkingStart = cleaned.lastIndexOf('<thinking>');\n\n  // Â¶ÇÊûúÊâæÂà∞‰∫ÜÊú™Èó≠ÂêàÁöÑ <thinking>ÔºåÈöêËóè‰ªéÂÆÉÂºÄÂßãÁöÑÊâÄÊúâÂÜÖÂÆπ\n  if (lastThinkingStart !== -1) {\n    cleaned = cleaned.substring(0, lastThinkingStart).trim();\n  }\n\n  return cleaned;\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <maintext> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractLastMaintext(text: string): string {\n  const matches = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™ÂåπÈÖç\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <continue_choice> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractContinueChoice(text: string): string {\n  const matches = text.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <result> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractResult(text: string): string {\n  const matches = text.match(/<result>([\\s\\S]*?)<\\/result>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<result>([\\s\\S]*?)<\\/result>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <decision_node> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractNextChoice(text: string): string {\n  const matches = text.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <option> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractLastOption(text: string): string {\n  const matches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™ÂåπÈÖç\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<option>([\\s\\S]*?)<\\/option>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊâÄÊúâ <suboption> Ê†áÁ≠æÂÜÖÂÆπÔºàÊñ∞Ê†ºÂºèÔºâ\n * @returns ÊâÄÊúâ suboption ÊñáÊú¨ÁöÑÊï∞ÁªÑ\n */\nexport function extractAllOptions(text: string): string[] {\n  if (!text) return [];\n\n  // È¶ñÂÖàÂ∞ùËØïÊèêÂèñ <suboption> Ê†áÁ≠æÔºàÊñ∞Ê†ºÂºèÔºâ\n  const suboptionMatches = text.match(/<suboption>([\\s\\S]*?)<\\/suboption>/gi);\n  if (suboptionMatches && suboptionMatches.length > 0) {\n    const options: string[] = [];\n    suboptionMatches.forEach(match => {\n      const contentMatch = match.match(/<suboption>([\\s\\S]*?)<\\/suboption>/i);\n      if (contentMatch && contentMatch[1]) {\n        const content = contentMatch[1].trim();\n        if (content) {\n          options.push(content);\n        }\n      }\n    });\n    if (options.length > 0) {\n      return options;\n    }\n  }\n\n  // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ <suboption>ÔºåÂõûÈÄÄÂà∞ÊóßÁöÑ <option> Ê†ºÂºèÔºàÂÖºÂÆπÊÄßÔºâ\n  const optionMatches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!optionMatches || optionMatches.length === 0) {\n    return [];\n  }\n\n  // ÊèêÂèñÊØè‰∏™ option ÁöÑÂÜÖÂÆπÔºàÊóßÊ†ºÂºèÔºâ\n  const options: string[] = [];\n  optionMatches.forEach(match => {\n    const contentMatch = match.match(/<option>([\\s\\S]*?)<\\/option>/i);\n    if (contentMatch && contentMatch[1]) {\n      const content = contentMatch[1].trim();\n      if (content) {\n        // Â∞ùËØïÊåâË°åÂàÜÂâ≤ÔºåÊØèË°å‰Ωú‰∏∫‰∏Ä‰∏™ÈÄâÈ°πÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ\n        const lines = content.split('\\n').map(line => line.trim()).filter(line => line);\n        if (lines.length > 1) {\n          // Â§öË°åÔºåÊØèË°å‰Ωú‰∏∫‰∏Ä‰∏™ÈÄâÈ°π\n          options.push(...lines);\n        } else {\n          // ÂçïË°åÔºåÁõ¥Êé•Ê∑ªÂä†\n          options.push(content);\n        }\n      }\n    }\n  });\n\n  return options;\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <sum> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractLastSum(text: string): string {\n  const matches = text.match(/<sum>([\\s\\S]*?)<\\/sum>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™ÂåπÈÖç\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <UpdateVariable> Ê†áÁ≠æÂÜÖÂÆπ\n */\nexport function extractLastUpdateVariable(text: string): string {\n  const matches = text.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™ÂåπÈÖç\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/i);\n  if (!contentMatch) {\n    return '';\n  }\n\n  const content = contentMatch[1].trim();\n\n  // Áõ¥Êé•ËøîÂõûÂéüÂßãÂÜÖÂÆπÔºå‰∏çËøõË°å‰ªª‰ΩïËΩ¨Êç¢\n  // MVU Á≥ªÁªüÂèØËÉΩÁõ¥Êé•ÊîØÊåÅ JSONPatch Ê†ºÂºèÔºåËΩ¨Êç¢ÂèçËÄå‰ºöÂØºËá¥ÈóÆÈ¢ò\n  console.log('üìù ÊèêÂèñÂà∞ <UpdateVariable> ÂéüÂßãÂÜÖÂÆπÔºåÁõ¥Êé•‰øùÁïôÔºå‰∏çËøõË°åËΩ¨Êç¢');\n  return content;\n}\n\n/**\n * È™åËØÅÊ∂àÊÅØÊòØÂê¶Á¨¶ÂêàËßÑËåÉÔºàËá≥Â∞ëÂåÖÂê´ maintext Âíå optionÔºâ\n */\nexport function validateMessage(messageContent: string): boolean {\n  if (!messageContent || typeof messageContent !== 'string') {\n    return false;\n  }\n\n  // ÁßªÈô§ thinking Ê†áÁ≠æÂêéÂÜçÈ™åËØÅ\n  const cleaned = removeThinkingTags(messageContent);\n  const maintext = extractLastMaintext(cleaned);\n  const option = extractLastOption(cleaned);\n\n  if (!maintext || !option) {\n    console.warn('‚ö†Ô∏è Ê∂àÊÅØÁº∫Â∞ë <maintext> Êàñ <option> Ê†áÁ≠æ');\n    return false;\n  }\n\n  return true;\n}\n","/**\n * Ê∂àÊÅØÁîüÊàêÊúçÂä°\n * Â§ÑÁêÜÂÆåÊï¥ÁöÑÊ∂àÊÅØÁîüÊàêÊµÅÁ®ãÔºöÊûÑÂª∫ÊèêÁ§∫ËØç -> ÂàõÂª∫ user Ê∂àÊÅØ -> Ë∞ÉÁî® LLM -> Ëß£ÊûêÁªìÊûú -> ÂàõÂª∫ assistant Ê∂àÊÅØ\n */\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function createChatMessages(\n  messages: Array<{ role: 'user' | 'assistant' | 'system'; message: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function generate(config: { user_input?: string; should_stream?: boolean }): Promise<string>;\n\n// Ê£ÄÊü• generate ÂáΩÊï∞ÊòØÂê¶Âú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÂèØÁî®\nfunction checkGenerateAvailable(): boolean {\n  if (typeof generate === 'undefined') {\n    // Â∞ùËØï‰ªé window ÂØπË±°Ëé∑Âèñ\n    if (typeof window !== 'undefined' && (window as any).generate) {\n      return true;\n    }\n    return false;\n  }\n  return true;\n}\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const iframe_events: {\n  STREAM_TOKEN_RECEIVED_FULLY: 'js_stream_token_received_fully';\n  GENERATION_ENDED: 'js_generation_ended';\n};\n\n// MVU ÂèòÈáèÊ°ÜÊû∂Â£∞Êòé\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  parseMessage?: (message: string, old_data: any) => Promise<any | undefined>;\n};\n\nimport {\n  extractAllOptions,\n  extractLastMaintext,\n  extractLastOption,\n  extractLastSum,\n  extractLastUpdateVariable,\n  removeThinkingTags,\n  removeThinkingTagsFromStream,\n  validateMessage,\n} from './textParser';\n\n/**\n * Ëé∑ÂèñÂü∫Á°Ä MVU Êï∞ÊçÆÔºàÁî®‰∫é‰º†ÈÄíÂà∞Êñ∞Ê•ºÂ±ÇÔºâ\n */\nasync function getBaseMvuData(): Promise<any> {\n  try {\n    // Á°Æ‰øù MVU Â∑≤ÂàùÂßãÂåñ\n    await waitGlobalInitialized('Mvu');\n\n    // ‰ºòÂÖà‰ªé MVU Á≥ªÁªüËØªÂèñÊúÄÊñ∞Ê•ºÂ±ÇÁöÑÂèòÈáèÊï∞ÊçÆ\n    const base = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    console.log('üìä ‰ªé MVU Ëé∑ÂèñÂü∫Á°ÄÊï∞ÊçÆ');\n\n    // ËøîÂõûÂü∫Á°ÄÊï∞ÊçÆÔºå‰∏çËøõË°å‰ªª‰ΩïËß£Êûê\n    return (\n      base ?? {\n        stat_data: {},\n        display_data: {},\n        delta_data: {},\n      }\n    );\n  } catch (error) {\n    console.warn('‚ö†Ô∏è Ëé∑Âèñ MVU Êï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®Á©∫ÂØπË±°:', error);\n    // Â¶ÇÊûú MVU ‰∏çÂèØÁî®ÔºåËøîÂõû‰∏Ä‰∏™Âü∫Êú¨ÁöÑ MVU Êï∞ÊçÆÁªìÊûÑ\n    return {\n      stat_data: {},\n      display_data: {},\n      delta_data: {},\n    };\n  }\n}\n\n/**\n * Ê∂àÊÅØÁîüÊàêÂõûË∞ÉÊé•Âè£\n */\nexport interface MessageGeneratorCallbacks {\n  onShowGenerating?: () => void; // ÊòæÁ§∫ÁîüÊàêÊèêÁ§∫\n  onHideGenerating?: () => void; // ÈöêËóèÁîüÊàêÊèêÁ§∫\n  onError?: (error: string) => void; // ÈîôËØØÂõûË∞É\n  onStreamingUpdate?: (text: string) => void; // ÊµÅÂºèÊõ¥Êñ∞ maintext ÁöÑÂõûË∞É\n  onRefreshStoryIfOpen?: (userMessage: string) => void; // Â¶ÇÊûúÁïåÈù¢Â∑≤ÊâìÂºÄÂàôÂà∑Êñ∞ÊòæÁ§∫ÔºàuserÊ∂àÊÅØÂàõÂª∫ÂêéÔºå‰º†ÂÖ•Áî®Êà∑Ê∂àÊÅØÂÜÖÂÆπÔºâ\n  onRefreshStory?: (options?: string[]) => void; // Âà∑Êñ∞Ê∏∏ÊàèÊòæÁ§∫ÁöÑÂõûË∞ÉÔºàassistantÊ∂àÊÅØÂàõÂª∫ÂêéÔºå‰º†ÂÖ•ÈÄâÈ°πÊï∞ÁªÑÔºâ\n}\n\n/**\n * ÁîüÊàêÊ∂àÊÅØ\n * @param userInput Áî®Êà∑ËæìÂÖ•ÔºàÈÄâÈ°πÊñáÊú¨ÊàñËá™ÂÆö‰πâÊ∂àÊÅØÔºâ\n * @param callbacks ÂõûË∞ÉÂáΩÊï∞\n */\nexport async function generateMessage(userInput: string, callbacks: MessageGeneratorCallbacks = {}): Promise<boolean> {\n  let userMessageId: number | null = null;\n\n  try {\n    // 1. Á¶ÅÁî®Áõ∏ÂÖ≥UIÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ\n    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Á¶ÅÁî®ÈÄâÈ°πÊåâÈíÆÁ≠âÈÄªËæë\n\n    // 2. ÊòæÁ§∫\"Ê≠£Âú®ÁîüÊàê\"ÊèêÁ§∫\n    if (callbacks.onShowGenerating) {\n      callbacks.onShowGenerating();\n    }\n\n    // 3. Ëé∑ÂèñÂü∫Á°Ä MVU Êï∞ÊçÆ\n    const mvu_data = await getBaseMvuData();\n\n    // 4. ÂàõÂª∫ user Ê∂àÊÅØÔºåÁõ¥Êé•‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÔºàÊèêÁ§∫ËØçÂ∑≤Âú®ÈÖíÈ¶ÜÁïåÈù¢Â∞ÅË£ÖÔºâ\n    console.log('üìù [Ê≠•È™§2] ÂºÄÂßãÂàõÂª∫ user Ê∂àÊÅØ...');\n    console.log('üìù [Ê≠•È™§2] Áî®Êà∑ËæìÂÖ•:', userInput);\n    console.log('üìù [Ê≠•È™§2] MVU Êï∞ÊçÆ:', mvu_data ? 'Â∑≤Ëé∑Âèñ' : 'Êú™Ëé∑Âèñ');\n\n    try {\n      await createChatMessages(\n        [\n          {\n            role: 'user',\n            message: userInput, // ‚ö†Ô∏è Âè™Â≠òÂÇ®Áî®Êà∑ÁöÑÂéüÂßãËæìÂÖ•Ôºå‰∏çÂ≠òÂÇ®ÂÆåÊï¥ÊèêÁ§∫ËØç\n            data: mvu_data, // ‰º†ÈÄí MVU Êï∞ÊçÆÔºåÁ°Æ‰øùÂèòÈáèÊ≠£Á°Æ‰º†ÈÄíÂà∞Êñ∞Ê•ºÂ±Ç\n          },\n        ],\n        {\n          refresh: 'none', // ‰∏çÊõ¥Êñ∞ÊòæÁ§∫ÔºåÁî±Ê∏∏ÊàèÁïåÈù¢Ëá™Â∑±ËØªÂèñ\n        },\n      );\n      console.log('‚úÖ [Ê≠•È™§2] user Ê∂àÊÅØÂ∑≤ÂàõÂª∫');\n\n      // 9. Ëé∑ÂèñÂàöÂàõÂª∫ÁöÑ user Ê∂àÊÅØ ID\n      userMessageId = getLastMessageId();\n      console.log('‚úÖ [Ê≠•È™§2] user Ê∂àÊÅØÂ∑≤ÂàõÂª∫ÔºåID:', userMessageId);\n\n      // 10. Âà∑Êñ∞ÊòæÁ§∫ÂàöÂèëÈÄÅÁöÑÁî®Êà∑Ê∂àÊÅØÔºàÂèÇËÄÉmhjgÂÆûÁé∞Ôºâ\n      // ‰ΩøÁî®ËΩÆËØ¢ÊñπÂºèÁ°Æ‰øùÊ∂àÊÅØÂ∑≤ÂàõÂª∫\n      const checkAndRefresh = async (retries = 5) => {\n        const checkMessageId = getLastMessageId();\n        if (checkMessageId === userMessageId) {\n          // È™åËØÅÊ∂àÊÅØÊòØÂê¶Â≠òÂú®\n          const messages = getChatMessages(checkMessageId);\n          if (messages && messages.length > 0 && messages[0].role === 'user') {\n            if (callbacks.onRefreshStoryIfOpen) {\n              callbacks.onRefreshStoryIfOpen(messages[0].message);\n              console.log('‚úÖ [Ê≠•È™§2] Â∑≤Âà∑Êñ∞ÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÔºåID:', userMessageId);\n            }\n            return;\n          }\n        }\n\n        // Â¶ÇÊûúÊ∂àÊÅØËøòÊú™ÂàõÂª∫ÔºåÈáçËØï\n        if (retries > 0) {\n          setTimeout(() => checkAndRefresh(retries - 1), 50);\n        } else {\n          // Âç≥‰ΩøÈ™åËØÅÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÂà∑Êñ∞Ôºà‰ΩøÁî®Áî®Êà∑ËæìÂÖ•Ôºâ\n          if (callbacks.onRefreshStoryIfOpen) {\n            callbacks.onRefreshStoryIfOpen(userInput);\n            console.log('‚ö†Ô∏è [Ê≠•È™§2] È™åËØÅÊ∂àÊÅØÂ§±Ë¥•Ôºå‰ΩÜ‰ªçÂ∞ùËØïÂà∑Êñ∞ÊòæÁ§∫');\n          }\n        }\n      };\n\n      setTimeout(() => checkAndRefresh(), 50);\n    } catch (createError) {\n      console.error('‚ùå [Ê≠•È™§2] createChatMessages Ë∞ÉÁî®Â§±Ë¥•:', createError);\n      throw new Error(\n        `ÂàõÂª∫ user Ê∂àÊÅØÂ§±Ë¥•: ${createError instanceof Error ? createError.message : String(createError)}`,\n      );\n    }\n\n    // 5. Ê≥®ÂÜåÊµÅÂºè‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂú®Ë∞ÉÁî® generate ‰πãÂâçÔºâ\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        // ÂÆûÊó∂ÂâîÈô§ <thinking> Ê†áÁ≠æÔºàÂåÖÊã¨Êú™Èó≠ÂêàÁöÑÔºâ\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n\n        // Â¶ÇÊûúÊ∏ÖÁêÜÂêéÊñáÊú¨‰∏∫Á©∫ÔºàËØ¥ÊòéÊ≠£Âú® thinking Ê†áÁ≠æÂÜÖÔºâÔºå‰∏çÊòæÁ§∫‰ªª‰ΩïÂÜÖÂÆπ\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          if (callbacks.onStreamingUpdate) {\n            callbacks.onStreamingUpdate('');\n          }\n          return;\n        }\n\n        // ‰º†ÈÄíÂÆåÊï¥ÁöÑ cleanedTextÔºàÂåÖÂê´ÊâÄÊúâÊ†áÁ≠æÔºâÔºåÁî®‰∫éÊ£ÄÊµãÊ†áÁ≠æÂºÄÂßã/ÁªìÊùü\n        if (callbacks.onStreamingUpdate) {\n          callbacks.onStreamingUpdate(cleanedText);\n        }\n      };\n\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('‚úÖ [Ê≠•È™§3] Â∑≤Ê≥®ÂÜåÊµÅÂºèËæìÂá∫ÁõëÂê¨Âô®');\n    } else {\n      console.log('‚ÑπÔ∏è [Ê≠•È™§3] ÊµÅÂºè‰∫ã‰ª∂‰∏çÂèØÁî®ÔºåÈÄÄÂåñ‰∏∫ÈùûÊµÅÂºèÊ®°Âºè');\n    }\n\n    // 6. ‰ΩøÁî® generate ÁîüÊàê LLM ÂõûÂ§çÔºàÊîØÊåÅÊµÅÂºèÁîüÊàêÔºâ\n    console.log('üöÄ [Ê≠•È™§3] ÂºÄÂßãË∞ÉÁî® generate ÁîüÊàêÂõûÂ§ç...');\n    console.log('üìù [Ê≠•È™§3] Áî®Êà∑ËæìÂÖ•:', userInput);\n\n    // Ê£ÄÊü• generate ÂáΩÊï∞ÊòØÂê¶ÂèØÁî®\n    if (!checkGenerateAvailable()) {\n      console.error('‚ùå [Ê≠•È™§3] generate ÂáΩÊï∞Êú™ÂÆö‰πâ');\n      console.error('‚ùå [Ê≠•È™§3] ËØ∑Ê£ÄÊü•Ôºö');\n      console.error('   1. ÈÖíÈ¶ÜÂä©ÊâãÊòØÂê¶Â∑≤Ê≠£Á°ÆÂÆâË£Ö');\n      console.error('   2. ÊòØÂê¶Âú® iframe ÁéØÂ¢É‰∏≠ËøêË°å');\n      console.error('   3. ÂÖ®Â±Ä generate ÂáΩÊï∞ÊòØÂê¶ÂèØÁî®');\n      throw new Error('generate ÂáΩÊï∞‰∏çÂèØÁî®ÔºåËØ∑Á°Æ‰øùÈÖíÈ¶ÜÂä©ÊâãÂ∑≤Ê≠£Á°ÆÂä†ËΩΩ');\n    }\n\n    let result: string;\n    try {\n      console.log('üöÄ [Ê≠•È™§3] Ë∞ÉÁî® generateÔºåÁõ¥Êé•‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÔºàÊèêÁ§∫ËØçÂ∑≤Âú®ÈÖíÈ¶ÜÁïåÈù¢Â∞ÅË£ÖÔºâ...');\n      console.log('üöÄ [Ê≠•È™§3] generate ÂáΩÊï∞Á±ªÂûã:', typeof generate);\n\n      // Áõ¥Êé•‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÔºàÊèêÁ§∫ËØçÂ∑≤Âú®ÈÖíÈ¶ÜÁïåÈù¢Â∞ÅË£ÖÔºâ\n      const generatePromise = generate({\n        // user_input: userInput, // ‰∏ç‰ΩøÁî®Áî®Êà∑ËæìÂÖ•\n        should_stream: true, // ÂêØÁî®ÊµÅÂºèÁîüÊàê\n      });\n\n      // ËÆæÁΩÆË∂ÖÊó∂Ôºà5ÂàÜÈíüÔºâ\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(\n          () => {\n            reject(new Error('generate Ë∞ÉÁî®Ë∂ÖÊó∂Ôºà5ÂàÜÈíüÔºâ'));\n          },\n          5 * 60 * 1000,\n        );\n      });\n\n      result = await Promise.race([generatePromise, timeoutPromise]);\n\n      console.log('üì® [Ê≠•È™§3] generate ËøîÂõûÁªìÊûúÔºåÈïøÂ∫¶:', result?.length || 0);\n      if (!result || result.length === 0) {\n        console.warn('‚ö†Ô∏è [Ê≠•È™§3] generate ËøîÂõûÁ©∫ÁªìÊûú');\n      } else {\n        console.log('üì® [Ê≠•È™§3] generate ËøîÂõûÁªìÊûúÈ¢ÑËßà:', result.substring(0, 200) + '...');\n      }\n    } catch (generateError) {\n      console.error('‚ùå [Ê≠•È™§3] generate Ë∞ÉÁî®Â§±Ë¥•:', generateError);\n      console.error('‚ùå [Ê≠•È™§3] ÈîôËØØËØ¶ÊÉÖ:', {\n        error: generateError,\n        errorType: typeof generateError,\n        errorMessage: generateError instanceof Error ? generateError.message : String(generateError),\n        errorStack: generateError instanceof Error ? generateError.stack : undefined,\n      });\n\n      // Ê£ÄÊü•ÊòØÂê¶ÊòØË∂ÖÊó∂ÈîôËØØ\n      if (generateError instanceof Error && generateError.message.includes('Ë∂ÖÊó∂')) {\n        throw new Error('generate Ë∞ÉÁî®Ë∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Êàñ LLM ÊúçÂä°Áä∂ÊÄÅ');\n      }\n\n      throw new Error(\n        `generate Ë∞ÉÁî®Â§±Ë¥•: ${generateError instanceof Error ? generateError.message : String(generateError)}`,\n      );\n    }\n\n    // 7. ÁßªÈô§ <thinking> Ê†áÁ≠æ\n    const cleanedResult = removeThinkingTags(result);\n\n    // 8. È™åËØÅËøîÂõûÁªìÊûúÊòØÂê¶Á¨¶ÂêàËßÑËåÉ\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      console.error('‚ùå [Ê≠•È™§4] generate ËøîÂõûÁöÑÊ∂àÊÅØ‰∏çÁ¨¶ÂêàËßÑËåÉ');\n      // Âà†Èô§ user Ê∂àÊÅØ\n      if (userMessageId !== null) {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('üóëÔ∏è Â∑≤Âà†Èô§‰∏çÂêàËßÑÁöÑ user Ê∂àÊÅØ');\n      }\n      // ÈöêËóèÁîüÊàêÊèêÁ§∫Ê°Ü\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('ÁîüÊàêÁöÑÊ∂àÊÅØ‰∏çÁ¨¶ÂêàËßÑËåÉ');\n      }\n      return false;\n    }\n\n    // 12. ÊèêÂèñÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ <maintext>„ÄÅ<option>„ÄÅ<sum> Âíå <UpdateVariable>\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      console.error('‚ùå [Ê≠•È™§5] Êó†Ê≥ïÊèêÂèñ maintext Êàñ option');\n      // Âà†Èô§ user Ê∂àÊÅØ\n      if (userMessageId !== null) {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('üóëÔ∏è Â∑≤Âà†Èô§‰∏çÂêàËßÑÁöÑ user Ê∂àÊÅØ');\n      }\n      // ÈöêËóèÁîüÊàêÊèêÁ§∫Ê°Ü\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('Êó†Ê≥ïÊèêÂèñ maintext Êàñ option');\n      }\n      return false;\n    }\n\n    // 13. ÈáçÊñ∞ÁªÑÂêàÊ∂àÊÅØÔºàÂåÖÂê´ÊúÄÂêé‰∏ÄÊ¨°ÁöÑ maintext„ÄÅoption„ÄÅsumÔºàÂ¶ÇÊûúÊúâÔºâÂíå UpdateVariableÔºàÂ¶ÇÊûúÊúâÔºâÔºâ\n    // Áî®‰∫é MVU Ëß£ÊûêÔºàÈúÄË¶ÅÂÆåÊï¥Ê∂àÊÅØÔºâ\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) {\n      finalMessage += `\\n\\n<sum>${sum}</sum>`;\n      console.log('üìù [Ê≠•È™§5] ÊèêÂèñÂà∞ <sum> Ê†áÁ≠æ');\n    }\n    if (updateVariable) {\n      finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n      console.log('üìù [Ê≠•È™§5] ÊèêÂèñÂà∞ <UpdateVariable> Ê†áÁ≠æ');\n    }\n\n    // 14. Ëé∑ÂèñÂü∫Á°Ä MVU Êï∞ÊçÆÔºà‰ºòÂÖà‰ªéÂàöÂàõÂª∫ÁöÑ user Ê∂àÊÅØËØªÂèñÔºâ\n    console.log('üìä [Ê≠•È™§6] ÂºÄÂßãËé∑ÂèñÂü∫Á°Ä MVU Êï∞ÊçÆ...');\n    let base: any;\n    if (userMessageId !== null) {\n      const userMessage = getChatMessages(userMessageId)?.[0];\n      if (userMessage?.data) {\n        base = userMessage.data;\n        console.log('‚úÖ [Ê≠•È™§6] ‰ªéÂàöÂàõÂª∫ÁöÑ user Ê∂àÊÅØËØªÂèñÂü∫Á°ÄÊï∞ÊçÆ');\n      }\n    }\n\n    // Â¶ÇÊûú user Ê∂àÊÅØÊ≤°Êúâ dataÔºåÂàô‰ªéÊúÄÊñ∞ÁöÑ assistant Ê∂àÊÅØÊàñ MVU ËØªÂèñ\n    if (!base) {\n      console.log('üìä [Ê≠•È™§6] Â∞ùËØï‰ªéÊúÄÊñ∞ÁöÑ assistant Ê∂àÊÅØÊàñ MVU ËØªÂèñ...');\n      base =\n        getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n        Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      console.log('‚úÖ [Ê≠•È™§6] ‰ªéÊúÄÊñ∞ÁöÑ assistant Ê∂àÊÅØÊàñ MVU ËØªÂèñÂü∫Á°ÄÊï∞ÊçÆ');\n    }\n\n    // Á°Æ‰øù base Êï∞ÊçÆÁªìÊûÑÂÆåÊï¥\n    if (!base || typeof base !== 'object') {\n      console.log('‚ö†Ô∏è [Ê≠•È™§6] base Êï∞ÊçÆÊó†ÊïàÔºå‰ΩøÁî®Á©∫ÂØπË±°');\n      base = { stat_data: {}, display_data: {}, delta_data: {} };\n    }\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // 15. Ëß£ÊûêÊ∂àÊÅØ‰∏≠ÁöÑ MVU ÂëΩ‰ª§ÔºàÂ¶ÇÊûú MVU.parseMessage ÂèØÁî®Ôºâ\n    console.log('üîç [Ê≠•È™§7] ÂºÄÂßãËß£ÊûêÊ∂àÊÅØ‰∏≠ÁöÑ MVU ÂëΩ‰ª§...');\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) {\n          finalData = parsed;\n          console.log('‚úÖ [Ê≠•È™§7] MVU Ëß£ÊûêÊàêÂäü');\n        } else {\n          console.log('‚ÑπÔ∏è [Ê≠•È™§7] MVU Ëß£ÊûêËøîÂõû undefinedÔºå‰ΩøÁî®Âü∫Á°ÄÊï∞ÊçÆ');\n        }\n      } catch (error) {\n        console.warn('‚ö†Ô∏è [Ê≠•È™§7] MVU Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®Âü∫Á°ÄÊï∞ÊçÆ:', error);\n      }\n    } else {\n      console.log('‚ÑπÔ∏è [Ê≠•È™§7] MVU.parseMessage ‰∏çÂèØÁî®ÔºåË∑≥ËøáËß£Êûê');\n    }\n\n    // 16. ÊèêÂèñÈÄâÈ°πÔºàÂú® createChatMessages ‰πãÂâçÔºå‰ªé finalMessage ‰∏≠ÊèêÂèñÔºâ\n    console.log('üìù [Ê≠•È™§8] ÂºÄÂßãÊèêÂèñÈÄâÈ°π...');\n    const extractedOptions = extractAllOptions(finalMessage);\n    console.log('üìù [Ê≠•È™§8] Â∑≤ÊèêÂèñÈÄâÈ°π:', extractedOptions.length, '‰∏™');\n\n    // 17. ÂàõÂª∫ assistant Ê∂àÊÅØÔºàÂè™‰øùÂ≠ò <maintext> Ê†áÁ≠æÈáåÁöÑÂÜÖÂÆπÔºâ\n    console.log('üìù [Ê≠•È™§9] ÂºÄÂßãÂàõÂª∫ assistant Ê∂àÊÅØ...');\n    // ‰ªé finalMessage ‰∏≠ÊèêÂèñ maintext ÂÜÖÂÆπÔºàÂè™‰øùÁïô maintext Ê†áÁ≠æÈáåÁöÑÂÜÖÂÆπÔºâ\n    const maintextContent = extractLastMaintext(finalMessage);\n    const messageToSave = maintextContent || finalMessage;\n    if (!maintextContent) {\n      console.warn('‚ö†Ô∏è [Ê≠•È™§9] Êó†Ê≥ï‰ªé finalMessage ‰∏≠ÊèêÂèñ maintextÔºå‰ΩøÁî®ÂÆåÊï¥ÁöÑ finalMessage');\n    } else {\n      console.log('üìù [Ê≠•È™§9] Â∑≤ÊèêÂèñ maintext ÂÜÖÂÆπÔºåÂè™‰øùÂ≠ò maintext ÈÉ®ÂàÜ');\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave, // Âè™‰øùÂ≠ò maintext ÂÜÖÂÆπ\n          data: {\n            ...finalData, // ‰º†ÂÖ•Ëß£ÊûêÂêéÁöÑÊï∞ÊçÆÔºàÂåÖÂê´ÊâÄÊúâÂèòÈáèÊõ¥Êñ∞Ôºâ\n            __options: extractedOptions, // ‚úÖ Â≠òÂú® data Èáå\n          },\n        },\n      ],\n      {\n        refresh: 'affected', // Êõ¥Êñ∞ÊòæÁ§∫ÔºåÁî±Ê∏∏ÊàèÁïåÈù¢Ëá™Â∑±ËØªÂèñ\n      },\n    );\n    console.log('‚úÖ [Ê≠•È™§9] assistant Ê∂àÊÅØÂ∑≤ÂàõÂª∫ÔºåÈÖíÈ¶ÜÁïåÈù¢ÂéÜÂè≤Â∑≤Âà∑Êñ∞');\n\n    // 18. Ëé∑ÂèñÊñ∞ÂàõÂª∫ÁöÑÊ∂àÊÅØ ID\n    const assistantMessageId = getLastMessageId();\n    console.log('üÜî [Ê≠•È™§10] Ëé∑ÂèñÊñ∞ÂàõÂª∫ÁöÑÊ∂àÊÅØ ID:', assistantMessageId);\n\n    // 19. ÈöêËóèÁîüÊàêÊèêÁ§∫Ê°Ü\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 20. Âà∑Êñ∞Ê∏∏ÊàèÊòæÁ§∫ÔºàÂª∂Ëøü‰∏Ä‰∏ãÔºåÁ°Æ‰øùÊ∂àÊÅØÂ∑≤ÁªèÂÆåÂÖ®ÂàõÂª∫Âπ∂ÂÜôÂÖ•ÂéÜÂè≤Ôºâ\n    // ÂêåÊó∂‰º†ÈÄíÊèêÂèñÁöÑÈÄâÈ°πÔºåÂâçÁ´ØÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®ÔºåÊó†ÈúÄ‰ªéÊ∂àÊÅØ‰∏≠ÊèêÂèñ\n    setTimeout(() => {\n      if (callbacks.onRefreshStory) {\n        callbacks.onRefreshStory(extractedOptions);\n        console.log('‚úÖ [Ê≠•È™§11] Â∑≤Âà∑Êñ∞Ê∏∏ÊàèÊòæÁ§∫ÔºàÂ∑≤‰º†ÈÄíÈÄâÈ°πÔºâ');\n      }\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('‚ùå ÁîüÊàêÊ∂àÊÅØÂ§±Ë¥•:', error);\n\n    // Â¶ÇÊûúÂàõÂª∫‰∫Ü user Ê∂àÊÅØÔºåÂà†Èô§ÂÆÉ\n    if (userMessageId !== null) {\n      try {\n        await deleteChatMessages([userMessageId], { refresh: 'none' });\n        console.log('üóëÔ∏è Â∑≤Âà†Èô§Â§±Ë¥•ÁöÑ user Ê∂àÊÅØ');\n      } catch (deleteError) {\n        console.error('‚ùå Âà†Èô§ user Ê∂àÊÅØÂ§±Ë¥•:', deleteError);\n      }\n    }\n\n    // ÈöêËóèÁîüÊàêÊèêÁ§∫Ê°Ü\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ\n    if (callbacks.onError) {\n      callbacks.onError(error instanceof Error ? error.message : 'ÁîüÊàêÊ∂àÊÅØÂ§±Ë¥•');\n    }\n\n    return false;\n  }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { GameData, GameConfig } from '../types/types';\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\ndeclare function getLastMessageId(): number;\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ‰ªé MVU ÂèòÈáèÁ≥ªÁªüËØªÂèñÊ∏∏ÊàèÊï∞ÊçÆ\n */\nexport async function readGameData(): Promise<any> {\n  try {\n    // Á°Æ‰øù MVU Â∑≤ÂàùÂßãÂåñ\n    if (typeof waitGlobalInitialized !== 'undefined') {\n      await waitGlobalInitialized('Mvu');\n    }\n\n    // ‰ªé MVU Á≥ªÁªüËØªÂèñ stat_data\n    if (typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n      const mvuData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      const statData = mvuData?.stat_data || {};\n      return statData;\n    }\n\n    // ÈôçÁ∫ßÔºö‰ªéÈÖíÈ¶ÜÂèòÈáèÁ≥ªÁªüËØªÂèñ\n    const variables = getVariables({ type: 'message' });\n    const gameData = variables.game_data || variables.stat_data || {};\n    return gameData;\n  } catch (error) {\n    console.warn('ËØªÂèñÊ∏∏ÊàèÊï∞ÊçÆÂ§±Ë¥•:', error);\n    return {};\n  }\n}\n\n/**\n * Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠òÊ°£\n * ÈÄöËøáÊ£ÄÊü• assistant Ê∂àÊÅØÊï∞ÈáèÊù•Âà§Êñ≠Ôºö\n * - assistant Ê∂àÊÅØÂè™Êúâ 1 Êù°ÔºöÊñ∞ÂºÄÁöÑÊ°£ÔºàÂºÄÂú∫ÁôΩÔºâÔºåËøîÂõû falseÔºåÊòæÁ§∫ÂºÄÂßãÁïåÈù¢\n * - assistant Ê∂àÊÅØ > 1 Êù°ÔºöÁªßÁª≠Ê∏∏ÊàèÔºåËøîÂõû trueÔºåÁõ¥Êé•ËøõÂÖ•Ê∏∏ÊàèÁïåÈù¢\n */\nexport function hasSaveData(): boolean {\n  try {\n    // Ê£ÄÊü• assistant Ê∂àÊÅØÊï∞Èáè\n    const lastMessageId = getLastMessageId();\n    if (lastMessageId < 0) {\n      return false; // Ê≤°ÊúâÊ∂àÊÅØÔºåËÇØÂÆöÊ≤°ÊúâÂ≠òÊ°£\n    }\n\n    // Ëé∑ÂèñÊâÄÊúâ assistant Ê∂àÊÅØ\n    const messages = getChatMessages(`0-${lastMessageId}`, { role: 'assistant' });\n\n    // Âè™Êúâ 1 Êù° assistant Ê∂àÊÅØÔºöÊñ∞ÂºÄÁöÑÊ°£ÔºàÂºÄÂú∫ÁôΩÔºâÔºåÂ∫îËØ•ÊòæÁ§∫ÂºÄÂßãÁïåÈù¢\n    // Â§ö‰∫é 1 Êù° assistant Ê∂àÊÅØÔºöÁªßÁª≠Ê∏∏Êàè\n    return messages && messages.length > 1;\n  } catch (error) {\n    console.warn('Ê£ÄÊü•Â≠òÊ°£Áä∂ÊÄÅÂ§±Ë¥•:', error);\n    return false;\n  }\n}\n\n/**\n * ËØªÂèñÊ∏∏ÊàèÈÖçÁΩÆ\n */\nexport function readGameConfig(): Partial<GameConfig> {\n  try {\n    const variables = getVariables({ type: 'message' });\n    const config = variables.game_config || {};\n    return config as Partial<GameConfig>;\n  } catch (error) {\n    console.warn('ËØªÂèñÊ∏∏ÊàèÈÖçÁΩÆÂ§±Ë¥•:', error);\n    return {};\n  }\n}\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { ComponentCallbacks } from '../types/types';\nimport { hasSaveData } from '../utils/variableReader';\n\n/**\n * Ê†áÈ¢òÈ°µÈù¢ÁªÑ‰ª∂\n */\nexport class SplashScreen {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen splash-screen';\n    div.id = 'splash-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    this.updateContinueButton();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      this.updateContinueButton();\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ÁßªÈô§ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  private updateContinueButton(): void {\n    if (!this.element) return;\n\n    const continueButton = this.element.querySelector('#continue-button') as HTMLElement;\n    if (continueButton) {\n      if (hasSaveData()) {\n        continueButton.style.display = 'flex';\n      } else {\n        continueButton.style.display = 'none';\n      }\n    }\n  }\n\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    const newGameButton = this.element.querySelector('#new-game-button');\n    if (newGameButton) {\n      newGameButton.addEventListener('click', () => {\n        this.callbacks.onNewGame?.();\n      });\n    }\n\n    const continueButton = this.element.querySelector('#continue-button');\n    if (continueButton) {\n      continueButton.addEventListener('click', () => {\n        this.callbacks.onContinue?.();\n      });\n    }\n\n    const fullscreenButton = this.element.querySelector('#fullscreen-button');\n    if (fullscreenButton) {\n      fullscreenButton.addEventListener('click', () => {\n        this.requestFullscreen();\n      });\n    }\n\n    // EnterÈîÆÊîØÊåÅÔºöÂÖ®Â±è\n    this.keyDownHandler = (e: KeyboardEvent) => {\n      if (e.key === 'Enter' && this.element?.classList.contains('active')) {\n        e.preventDefault();\n        this.requestFullscreen();\n      }\n    };\n    document.addEventListener('keydown', this.keyDownHandler);\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('ÂÖ®Â±èËØ∑Ê±ÇÂ§±Ë¥•:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"splash-screen-content\">\n        <div class=\"splash-header\">\n          <div class=\"splash-logo\">\n            <i class=\"fas fa-anchor\"></i>\n          </div>\n          <h1 class=\"splash-title\">Èîö</h1>\n          <p class=\"splash-subtitle\">ANCHOR</p>\n        </div>\n        <div class=\"splash-actions\">\n          <button type=\"button\" class=\"splash-button primary\" id=\"new-game-button\">\n            <i class=\"fas fa-play\"></i>\n            <span>ÂºÄÂßãÊñ∞Ê∏∏Êàè</span>\n          </button>\n          <button type=\"button\" class=\"splash-button secondary\" id=\"continue-button\" style=\"display: none;\">\n            <i class=\"fas fa-redo\"></i>\n            <span>ÁªßÁª≠Ê∏∏Êàè</span>\n          </button>\n          <button type=\"button\" class=\"splash-button icon-only\" id=\"fullscreen-button\" title=\"ÂàáÊç¢ÂÖ®Â±è (Enter)\">\n            <i class=\"fas fa-expand\"></i>\n          </button>\n        </div>\n        <div class=\"splash-footer\">\n          <p class=\"splash-copyright\">¬© 2024 Èîö</p>\n          <p class=\"splash-author\">Âü∫‰∫éÈÖíÈ¶ÜÂä©ÊâãÂºÄÂèë</p>\n          <p class=\"splash-hint\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-tertiary);\">Êåâ Enter ÈîÆÂÖ®Â±è</p>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const toastr: any;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * ÂºÄÂ±ÄËÆæÁΩÆÈ°µÈù¢ÁªÑ‰ª∂\n */\nexport class NewGameSetup {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen setup-screen';\n    div.id = 'setup-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    // ÂÆûÊó∂Êõ¥Êñ∞ MVU ÂèòÈáèÔºàÂΩìÁî®Êà∑ËæìÂÖ•Êó∂Ôºâ\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    if (reserveInput) {\n      reserveInput.addEventListener('input', async () => {\n        const config = this.getConfig();\n        if (config.reserve !== undefined) {\n          await this.updateMvuVariable(config.reserve);\n        }\n      });\n    }\n\n    const confirmButton = this.element.querySelector('#setup-confirm-button');\n    if (confirmButton) {\n      confirmButton.addEventListener('click', () => {\n        const reserveInput = this.element?.querySelector('#energy-reserve') as HTMLInputElement;\n        const inputValue = reserveInput?.value?.trim() || '';\n\n        // È™åËØÅËæìÂÖ•\n        if (!inputValue) {\n          toastr.error('ËØ∑ËæìÂÖ•Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫ê', 'È™åËØÅÂ§±Ë¥•');\n          return;\n        }\n\n        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êï¥Êï∞Ôºà‰∏çÂÖÅËÆ∏Â∞èÊï∞ÁÇπÔºâ\n        if (inputValue.includes('.')) {\n          toastr.error('Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫êÂøÖÈ°ªÊòØÊï¥Êï∞', 'È™åËØÅÂ§±Ë¥•');\n          return;\n        }\n\n        const reserve = parseInt(inputValue, 10);\n        if (isNaN(reserve)) {\n          toastr.error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠ó', 'È™åËØÅÂ§±Ë¥•');\n          return;\n        }\n\n        if (!Number.isInteger(reserve)) {\n          toastr.error('Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫êÂøÖÈ°ªÊòØÊï¥Êï∞', 'È™åËØÅÂ§±Ë¥•');\n          return;\n        }\n\n        if (reserve < 0 || reserve > 100000) {\n          toastr.error('Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫êÂøÖÈ°ªÂú® 0-100000 ‰πãÈó¥', 'È™åËØÅÂ§±Ë¥•');\n          return;\n        }\n\n        const config: GameConfig = { reserve };\n        this.callbacks.onConfirm?.(config);\n      });\n    }\n\n    const cancelButton = this.element.querySelector('#setup-cancel-button');\n    if (cancelButton) {\n      cancelButton.addEventListener('click', () => {\n        this.callbacks.onCancel?.();\n      });\n    }\n  }\n\n  private async updateMvuVariable(value: number): Promise<void> {\n    try {\n      // Á°Æ‰øù MVU Â∑≤ÂàùÂßãÂåñ\n      if (typeof waitGlobalInitialized !== 'undefined') {\n        await waitGlobalInitialized('Mvu');\n      }\n\n      if (typeof Mvu === 'undefined' || !Mvu.getMvuData || !Mvu.replaceMvuData) {\n        console.warn('‚ö†Ô∏è MVU ‰∏çÂèØÁî®ÔºåË∑≥ËøáÂÆûÊó∂Êõ¥Êñ∞');\n        return;\n      }\n\n      // Ëé∑ÂèñÂΩìÂâçÁöÑ MVU Êï∞ÊçÆ\n      const currentMvuData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      const currentStatData = currentMvuData?.stat_data || {};\n\n      // ÊûÑÂª∫Êõ¥Êñ∞ÂêéÁöÑ stat_data\n      const updatedStatData = { ...currentStatData };\n\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // Á°Æ‰øù reserve Âú® 0-100000 ËåÉÂõ¥ÂÜÖ\n      updatedStatData.system_state.antimatter.reserve = Math.max(0, Math.min(100000, value));\n\n      // Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆÂÜôÂõû MVU\n      const updatedMvuData = {\n        ...currentMvuData,\n        stat_data: updatedStatData,\n      };\n\n      await Mvu.replaceMvuData(updatedMvuData, { type: 'message', message_id: 'latest' });\n      console.info(`‚úÖ ÂÆûÊó∂Êõ¥Êñ∞ MVU ÂèòÈáè reserve: ${value}`);\n    } catch (error) {\n      console.warn(`‚ö†Ô∏è ÂÆûÊó∂Êõ¥Êñ∞ MVU ÂèòÈáè reserve Â§±Ë¥•:`, error);\n    }\n  }\n\n  private getConfig(): GameConfig {\n    if (!this.element) {\n      return {};\n    }\n\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    return {\n      reserve: reserveInput?.value ? parseInt(reserveInput.value, 10) : undefined,\n    };\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"setup-screen-content\">\n        <div class=\"setup-header\">\n          <h1 class=\"setup-title\">Êñ∞Ê∏∏ÊàèËÆæÁΩÆ</h1>\n          <p class=\"setup-subtitle\">ÈÖçÁΩÆÊÇ®ÁöÑÊ∏∏Êàè</p>\n        </div>\n        <div class=\"setup-form\">\n          <div class=\"setup-form-group\">\n            <label class=\"setup-label\" for=\"energy-reserve\">Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫ê</label>\n            <input\n              type=\"number\"\n              id=\"energy-reserve\"\n              class=\"setup-input\"\n              min=\"0\"\n              max=\"100000\"\n              step=\"1\"\n              placeholder=\"ËæìÂÖ•Á≥ªÁªüÂâ©‰ΩôËÉΩÊ∫ê\"\n              required\n            />\n            <small style=\"color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;\">\n              ËåÉÂõ¥Ôºö0 - 100000ÔºàÊï¥Êï∞Ôºâ\n            </small>\n          </div>\n        </div>\n        <div class=\"setup-actions\">\n          <button type=\"button\" class=\"setup-button secondary\" id=\"setup-cancel-button\">\n            <i class=\"fas fa-times\"></i>\n            <span>ÂèñÊ∂à</span>\n          </button>\n          <button type=\"button\" class=\"setup-button primary\" id=\"setup-confirm-button\">\n            <i class=\"fas fa-check\"></i>\n            <span>Á°ÆËÆ§</span>\n          </button>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameData } from '../types/types';\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  CHAT_CHANGED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ‰∏ªÊ∏∏ÊàèÁïåÈù¢ÁªÑ‰ª∂ÔºàDashboardÔºâ\n */\nexport class Dashboard {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n  private gameData: Partial<GameData> = {};\n  private loadedMessageIds: Set<number> = new Set(); // ËÆ∞ÂΩïÂ∑≤Âä†ËΩΩÁöÑÊ∂àÊÅØIDÔºåÈÅøÂÖçÈáçÂ§çÊòæÁ§∫\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    try {\n      const div = document.createElement('div');\n      div.className = 'screen main-screen';\n      div.id = 'main-screen';\n      div.innerHTML = this.getHTML();\n      this.element = div;\n\n      // ÁªëÂÆö‰∫ã‰ª∂ÔºàÂú®ËÆæÁΩÆ innerHTML ‰πãÂêéÔºâ\n      this.bindEvents();\n\n      // ÂàõÂª∫ÂêéÁ´ãÂç≥Ê∏≤ÊüìÈªòËÆ§Êï∞ÊçÆ\n      this.refreshData();\n\n      console.log('‚úÖ Dashboard ÂÖÉÁ¥†Â∑≤ÂàõÂª∫');\n      return div;\n    } catch (error) {\n      console.error('‚ùå ÂàõÂª∫ Dashboard ÂÖÉÁ¥†Â§±Ë¥•:', error);\n      // ÂàõÂª∫‰∏Ä‰∏™Âü∫Êú¨ÁöÑ div ‰Ωú‰∏∫ÈôçÁ∫ßÊñπÊ°à\n      const fallbackDiv = document.createElement('div');\n      fallbackDiv.className = 'screen main-screen';\n      fallbackDiv.id = 'main-screen';\n      fallbackDiv.innerHTML = '<div style=\"padding: 2rem; color: var(--text-primary);\">ÈîöÂä†ËΩΩ‰∏≠...</div>';\n      this.element = fallbackDiv;\n      return fallbackDiv;\n    }\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      // ÊòæÁ§∫Êó∂Âà∑Êñ∞Êï∞ÊçÆ\n      try {\n        this.refreshData();\n        console.log('‚úÖ Dashboard Êï∞ÊçÆÂ∑≤Âà∑Êñ∞');\n      } catch (error) {\n        console.error('‚ùå Dashboard Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', error);\n        // Âç≥‰ΩøÂà∑Êñ∞Â§±Ë¥•Ôºå‰πüÁªßÁª≠ÊòæÁ§∫\n      }\n    } else {\n      console.error('‚ùå Dashboard element ‰∏∫ nullÔºåÊó†Ê≥ïÊòæÁ§∫');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ÁßªÈô§ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  public updateGameData(data: Partial<GameData>): void {\n    this.gameData = { ...this.gameData, ...data };\n    this.refreshData();\n  }\n\n  private refreshData(): void {\n    if (!this.element) {\n      console.warn('‚ö†Ô∏è Dashboard element ‰∏∫ nullÔºåÊó†Ê≥ïÂà∑Êñ∞Êï∞ÊçÆ');\n      return;\n    }\n\n    try {\n      // Êõ¥Êñ∞Áä∂ÊÄÅÂç°ÁâáÔºàÂºÇÊ≠•Ôºå‰ªé MVU ÂèòÈáèËØªÂèñÔºâ\n      this.updateStatusCards().catch(error => {\n        console.warn('‚ö†Ô∏è Êõ¥Êñ∞Áä∂ÊÄÅÂç°ÁâáÂ§±Ë¥•ÔºàÈùûÂÖ≥ÈîÆÈîôËØØÔºâ:', error);\n      });\n\n      // Êõ¥Êñ∞‰ªªÂä°ÂàóË°®\n      this.updateTasksList();\n\n      // Êõ¥Êñ∞Êó•ËÆ∞ÂàóË°®\n      this.updateDiaryList();\n\n      // Êõ¥Êñ∞ËÅäÂ§©Ê∂àÊÅØÔºàÁé∞Âú®Áî± dashboardLogic.ts ÁÆ°ÁêÜÔºåËøôÈáå‰∏çÂÜçÊõ¥Êñ∞Ôºâ\n      // this.updateChatMessages();\n\n      // ËØªÂèñÂπ∂ÊòæÁ§∫ maintextÔºàÂª∂ËøüÊâßË°åÔºåÈÅøÂÖçÂú®ÂàùÂßãÂåñÊó∂Âá∫ÈîôÔºâ\n      setTimeout(() => {\n        try {\n          this.loadMaintextFromChat();\n        } catch (error) {\n          console.warn('‚ö†Ô∏è Âä†ËΩΩ maintext Â§±Ë¥•ÔºàÈùûÂÖ≥ÈîÆÈîôËØØÔºâ:', error);\n        }\n      }, 100);\n\n      console.info('‚úÖ Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤Âà∑Êñ∞');\n    } catch (error) {\n      console.error('‚ùå Âà∑Êñ∞Êï∞ÊçÆÊó∂Âá∫Èîô:', error);\n      // Âç≥‰ΩøÂá∫Èîô‰πüÁªßÁª≠ÔºåÈÅøÂÖçÂÆåÂÖ®Êó†Ê≥ïÊòæÁ§∫\n    }\n  }\n\n  private async updateStatusCards(): Promise<void> {\n    if (!this.element) return;\n\n    const statusGrid = this.element.querySelector('#status-grid');\n    if (!statusGrid) return;\n\n    try {\n      // ‰ªé MVU ÂèòÈáèÁ≥ªÁªüËØªÂèñ system_state Êï∞ÊçÆ\n      let systemState: any = null;\n\n      if (typeof waitGlobalInitialized !== 'undefined' && typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n        try {\n          await waitGlobalInitialized('Mvu');\n\n          // Â∞ùËØïÂ§öÁßçÊñπÂºèËØªÂèñÊï∞ÊçÆ\n          // 1. ÂÖàÂ∞ùËØï‰ªéÊúÄÊñ∞ assistant Ê∂àÊÅØËØªÂèñ\n          try {\n            const assistantMessages = getChatMessages(-1, { role: 'assistant' });\n            if (assistantMessages && assistantMessages.length > 0) {\n              const latestAssistant = assistantMessages[assistantMessages.length - 1];\n              const mvuData = Mvu.getMvuData({ type: 'message', message_id: latestAssistant.message_id });\n              if (mvuData?.stat_data?.system_state) {\n                systemState = mvuData.stat_data.system_state;\n                console.log('‚úÖ ‰ªéÊúÄÊñ∞ assistant Ê∂àÊÅØËØªÂèñ system_state');\n              }\n            }\n          } catch (error) {\n            console.warn('‚ö†Ô∏è ‰ªéÊúÄÊñ∞ assistant Ê∂àÊÅØËØªÂèñÂ§±Ë¥•:', error);\n          }\n\n          // 2. Â¶ÇÊûúËøòÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªé 'latest' ËØªÂèñ\n          if (!systemState) {\n            try {\n              const mvuData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n              if (mvuData?.stat_data?.system_state) {\n                systemState = mvuData.stat_data.system_state;\n                console.log('‚úÖ ‰ªé latest Ê∂àÊÅØËØªÂèñ system_state');\n              }\n            } catch (error) {\n              console.warn('‚ö†Ô∏è ‰ªé latest Ê∂àÊÅØËØªÂèñÂ§±Ë¥•:', error);\n            }\n          }\n\n          // 3. Â¶ÇÊûúËøòÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªé 0 Â±ÇËØªÂèñÔºàinitvar ÂàùÂßãÂåñÊï∞ÊçÆÔºâ\n          if (!systemState) {\n            try {\n              const mvuData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n              if (mvuData?.stat_data?.system_state) {\n                systemState = mvuData.stat_data.system_state;\n                console.log('‚úÖ ‰ªé 0 Â±ÇÊ∂àÊÅØËØªÂèñ system_stateÔºàinitvar Êï∞ÊçÆÔºâ');\n              }\n            } catch (error) {\n              console.warn('‚ö†Ô∏è ‰ªé 0 Â±ÇÊ∂àÊÅØËØªÂèñÂ§±Ë¥•:', error);\n            }\n          }\n        } catch (error) {\n          console.warn('‚ö†Ô∏è MVU ÂàùÂßãÂåñÊàñËØªÂèñÂ§±Ë¥•:', error);\n        }\n      }\n\n      // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊï∞ÊçÆÔºå‰ΩøÁî® initvar ‰∏≠ÁöÑÈªòËÆ§ÂÄº\n      if (!systemState) {\n        console.warn('‚ö†Ô∏è Êó†Ê≥ï‰ªé MVU ËØªÂèñ system_stateÔºå‰ΩøÁî® initvar ÈªòËÆ§ÂÄº');\n        systemState = {\n          cycle: 12,\n          antimatter: {\n            reserve: 100000,\n            leak_risk: 0.18,\n          },\n          population: {\n            active: 41,\n            standby: 19,\n            archived: 0,\n          },\n          system_pressure: 0.63,\n          instability: 0.41,\n        };\n      }\n\n      // Ê†πÊçÆ initvar ‰∏≠ÁöÑÂèòÈáèÁªìÊûÑÊ∏≤ÊüìÁä∂ÊÄÅÂç°Áâá\n      const cards: string[] = [];\n\n      // Cycle (Êó∂Èó¥ËÆ°Êï∞Âçï‰Ωç)\n      if (systemState.cycle !== undefined) {\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-clock status-card-icon\"></i>\n              <span class=\"status-card-title\">Êó∂Èó¥Âë®Êúü</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${systemState.cycle}</span>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Antimatter (ÂèçÁâ©Ë¥®)\n      if (systemState.antimatter) {\n        const reserve = systemState.antimatter.reserve ?? 0;\n        const leakRisk = systemState.antimatter.leak_risk ?? 0;\n        const reservePercent = Math.round((reserve / 100000) * 100);\n        const riskLevel = leakRisk < 0.3 ? 'low' : leakRisk < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-atom status-card-icon\"></i>\n              <span class=\"status-card-title\">ÂèçÁâ©Ë¥®ÂÇ®Â§á</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${reserve.toLocaleString()}</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill\" style=\"width: ${reservePercent}%\"></div>\n                </div>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  Ê≥ÑÊºèÈ£éÈô©: <span class=\"risk-${riskLevel}\">${(leakRisk * 100).toFixed(1)}%</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Population (‰∫∫Âè£)\n      if (systemState.population) {\n        const pop = systemState.population;\n        const active = pop.active ?? 0;\n        const standby = pop.standby ?? 0;\n        const archived = pop.archived ?? 0;\n        const total = active + standby + archived;\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-users status-card-icon\"></i>\n              <span class=\"status-card-title\">‰∫∫Âè£ÁªüËÆ°</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${total}</span>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  ÂêØÁî®: ${active} | ÂæÖÊú∫: ${standby} | ÂΩíÊ°£: ${archived}\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // System Pressure (Á≥ªÁªüÂéãÂäõ)\n      if (systemState.system_pressure !== undefined) {\n        const pressure = systemState.system_pressure ?? 0;\n        const pressurePercent = Math.round(pressure * 100);\n        const pressureLevel = pressure < 0.5 ? 'low' : pressure < 0.8 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-tachometer-alt status-card-icon\"></i>\n              <span class=\"status-card-title\">Á≥ªÁªüÂéãÂäõ</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${pressurePercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${pressureLevel}\" style=\"width: ${pressurePercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Instability (Á≥ªÁªü‰∏çÁ®≥ÂÆöÊÄß)\n      if (systemState.instability !== undefined) {\n        const instability = systemState.instability ?? 0;\n        const instabilityPercent = Math.round(instability * 100);\n        const instabilityLevel = instability < 0.3 ? 'low' : instability < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-exclamation-triangle status-card-icon\"></i>\n              <span class=\"status-card-title\">Á≥ªÁªü‰∏çÁ®≥ÂÆöÊÄß</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${instabilityPercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${instabilityLevel}\" style=\"width: ${instabilityPercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      if (cards.length > 0) {\n        statusGrid.innerHTML = cards.join('');\n      } else {\n        statusGrid.innerHTML = '<div class=\"status-empty\">ÊöÇÊó†Á≥ªÁªüÁä∂ÊÄÅÊï∞ÊçÆ</div>';\n      }\n    } catch (error) {\n      console.error('‚ùå Êõ¥Êñ∞Áä∂ÊÄÅÂç°ÁâáÂ§±Ë¥•:', error);\n      statusGrid.innerHTML = '<div class=\"status-empty\">Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•</div>';\n    }\n  }\n\n  private updateTasksList(): void {\n    if (!this.element) return;\n\n    const tasksList = this.element.querySelector('#tasks-list');\n    if (!tasksList) return;\n\n    // Â¶ÇÊûúgameData.tasksÂ≠òÂú®‰∏îÊòØÊï∞ÁªÑÔºå‰ΩøÁî®ÂÆÉÔºõÂê¶Âàô‰ΩøÁî®ÈªòËÆ§‰ªªÂä°\n    const tasks = (this.gameData.tasks && Array.isArray(this.gameData.tasks) && this.gameData.tasks.length > 0)\n      ? this.gameData.tasks\n      : this.getDefaultTasks();\n\n    tasksList.innerHTML = tasks.map(task => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas ${this.getTaskIcon(task.status)}\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(task.title)}</span>\n            <span class=\"entry-status ${task.status}\">${this.getStatusText(task.status)}</span>\n          </div>\n          <div class=\"entry-meta\">\n            <span class=\"entry-time\">${task.time}</span>\n            <span class=\"entry-priority priority-${task.priority}\">${this.getPriorityText(task.priority)}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(task.description)}</div>\n        </div>\n      </div>\n    `).join('');\n  }\n\n  private updateDiaryList(): void {\n    if (!this.element) return;\n\n    const diaryList = this.element.querySelector('#diary-list');\n    if (!diaryList) return;\n\n    // Â¶ÇÊûúgameData.diaryÂ≠òÂú®‰∏îÊòØÊï∞ÁªÑÔºå‰ΩøÁî®ÂÆÉÔºõÂê¶Âàô‰ΩøÁî®ÈªòËÆ§Êó•ËÆ∞\n    const diary = (this.gameData.diary && Array.isArray(this.gameData.diary) && this.gameData.diary.length > 0)\n      ? this.gameData.diary\n      : this.getDefaultDiary();\n\n    diaryList.innerHTML = diary.map(entry => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas fa-book-open\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(entry.title)}</span>\n            <span class=\"entry-date\">${entry.date}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(entry.description)}</div>\n        </div>\n      </div>\n    `).join('');\n  }\n\n  private updateChatMessages(): void {\n    // Ê≥®ÊÑèÔºöÈÄöËÆØÊ®°ÂùóÁöÑÊ∂àÊÅØÁé∞Âú®Áî± dashboardLogic.ts ‰∏≠ÁöÑ initChatInterface ÁÆ°ÁêÜ\n    // ËøôÈáå‰∏çÂÜçÊõ¥Êñ∞ÔºåÈÅøÂÖçÂÜ≤Á™Å\n    // ÈÄöËÆØÊ®°Âùó‰ºö‰ªé getChatMessages ËØªÂèñÂéÜÂè≤Ê∂àÊÅØ\n  }\n\n  private getDefaultTasks() {\n    return [\n      { id: '1', title: 'Áª¥Êä§ËÉΩÊ∫êÁ≥ªÁªü', status: 'completed' as const, priority: 'high' as const, time: '01-15 14:30', description: 'Ê£ÄÊü•Âπ∂Áª¥Êä§Á©∫Èó¥Á´ôËÉΩÊ∫êÁ≥ªÁªüÔºåÁ°Æ‰øùÊâÄÊúâËÆæÂ§áÊ≠£Â∏∏ËøêË°å' },\n      { id: '2', title: 'Áâ©ËµÑË°•Áªô‰ªªÂä°', status: 'in-progress' as const, priority: 'medium' as const, time: '01-15 10:00', description: 'Êé•Êî∂Âπ∂ÂàÜÈÖçÊñ∞‰∏ÄÊâπÁâ©ËµÑË°•ÁªôÔºåÊõ¥Êñ∞Â∫ìÂ≠òËÆ∞ÂΩï' },\n      { id: '3', title: 'Á¥ßÊÄ•Áª¥‰øÆ‰ªªÂä°', status: 'pending' as const, priority: 'urgent' as const, time: '01-15 16:00', description: 'Ê£ÄÊµãÂà∞ÁîüÂëΩÁª¥ÊåÅÁ≥ªÁªüÂºÇÂ∏∏ÔºåÈúÄË¶ÅÁ´ãÂç≥ËøõË°åÁª¥‰øÆÊ£ÄÊü•' },\n      { id: '4', title: 'ÂÆûÈ™åÊï∞ÊçÆÂàÜÊûê', status: 'in-progress' as const, priority: 'medium' as const, time: '01-15 09:00', description: 'ÂàÜÊûêÊúÄÊñ∞ÂÆûÈ™åÊï∞ÊçÆÔºåÁîüÊàêÊä•ÂëäÂπ∂‰∏ä‰º†Ëá≥Á≥ªÁªü' },\n      { id: '5', title: 'ÈÄö‰ø°Á≥ªÁªüÊ†°ÂáÜ', status: 'pending' as const, priority: 'low' as const, time: '01-16 08:00', description: 'ÂÆöÊúüÊ†°ÂáÜÈÄö‰ø°Á≥ªÁªüÔºåÁ°Æ‰øù‰∏éÂú∞ÁêÉÊÄªÈÉ®ÁöÑÁ®≥ÂÆöËøûÊé•' },\n      { id: '6', title: 'Èò≤Êä§Á≥ªÁªüÊ£ÄÊü•', status: 'pending' as const, priority: 'high' as const, time: '01-16 10:00', description: 'Ê£ÄÊü•Á©∫Èó¥Á´ôÈò≤Êä§Á≥ªÁªüÔºåÂåÖÊã¨ËæêÂ∞ÑÈò≤Êä§ÂíåÂæÆÈô®Áü≥Èò≤Êä§' },\n      { id: '7', title: 'Á≥ªÁªüÂ§á‰ªΩ', status: 'completed' as const, priority: 'medium' as const, time: '01-15 03:00', description: 'ÂÆåÊàêÊØèÊó•Á≥ªÁªüÊï∞ÊçÆÂ§á‰ªΩÔºåÁ°Æ‰øùÊï∞ÊçÆÂÆâÂÖ®' },\n      { id: '8', title: '‰∫∫ÂëòËΩÆÊç¢', status: 'in-progress' as const, priority: 'medium' as const, time: '01-15 12:00', description: 'ÊâßË°å‰∫∫ÂëòËΩÆÊç¢ËÆ°ÂàíÔºåÁ°Æ‰øùÂêÑÂ≤ó‰ΩçÊ≠£Â∏∏ËøêËΩ¨' },\n    ];\n  }\n\n  private getDefaultDiary() {\n    return [\n      { id: '1', title: 'Êó•Â∏∏ËÆ∞ÂΩï', date: '01-15', description: 'Á©∫Èó¥Á´ôËøêË°åÊ≠£Â∏∏ÔºåÊâÄÊúâÁ≥ªÁªüÊåáÊ†áÂú®ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖ„ÄÇÂÆåÊàêËÉΩÊ∫êÁ≥ªÁªü‰æãË°åÊ£ÄÊü•ÔºåÊú™ÂèëÁé∞ÂºÇÂ∏∏„ÄÇ' },\n      { id: '2', title: 'Áâ©ËµÑË°•Áªô', date: '01-14', description: 'Êé•Êî∂Êñ∞‰∏ÄÊâπÁâ©ËµÑË°•ÁªôÔºåÂåÖÊã¨È£üÁâ©„ÄÅÂåªÁñóÁî®ÂìÅÂíåÂ∑•Á®ãÊùêÊñô„ÄÇÂ∑≤ÊåâÊ†áÂáÜÊµÅÁ®ãÊ∏ÖÁÇπÂíåÂàÜÈÖç„ÄÇ' },\n      { id: '3', title: 'Á≥ªÁªüÁª¥Êä§', date: '01-13', description: 'ËøõË°åÊúàÂ∫¶Á≥ªÁªüÁª¥Êä§ÔºåÊõ¥Êñ∞ÈÉ®ÂàÜËÄÅÂåñËÆæÂ§á„ÄÇÁª¥Êä§ËøáÁ®ãÊú™ÂèëÁé∞ÈáçÂ§ßÈóÆÈ¢òÔºåËøêË°åÁ®≥ÂÆö„ÄÇ' },\n      { id: '4', title: 'ÂÆûÈ™åÊä•Âëä', date: '01-12', description: 'ÂÆåÊàêÁ¨¨47Ê¨°Èõ∂ÈáçÂäõÂÆûÈ™åÔºåÊï∞ÊçÆÈááÈõÜÊ≠£Â∏∏„ÄÇÂàùÊ≠•ÂàÜÊûêÊòæÁ§∫ÂÆûÈ™åÁªìÊûúÁ¨¶ÂêàÈ¢ÑÊúü„ÄÇ' },\n      { id: '5', title: 'ÈÄö‰ø°Êó•Âøó', date: '01-11', description: '‰∏éÂú∞ÁêÉÊÄªÈÉ®Âª∫Á´ãÁ®≥ÂÆöËøûÊé•ÔºåÂª∂Ëøü12ms„ÄÇÊé•Êî∂ÊúÄÊñ∞Êåá‰ª§ÔºåÂáÜÂ§áÊâßË°å‰∏ã‰∏ÄÈò∂ÊÆµ‰ªªÂä°„ÄÇ' },\n      { id: '6', title: 'ÂÆâÂÖ®Ê£ÄÊü•', date: '01-10', description: 'ÂÆåÊàêÊØèÂë®ÂÆâÂÖ®Ê£ÄÊü•ÔºåÊâÄÊúâÈò≤Êä§Á≥ªÁªüËøêË°åÊ≠£Â∏∏„ÄÇËæêÂ∞ÑÊ∞¥Âπ≥Âú®ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖ„ÄÇ' },\n      { id: '7', title: '‰∫∫ÂëòÊó•Âøó', date: '01-09', description: 'ÊâßË°å‰∫∫ÂëòÂÅ•Â∫∑Ê£ÄÊü•ÔºåÊâÄÊúâÊàêÂëòË∫´‰ΩìÁä∂ÂÜµËâØÂ•Ω„ÄÇÂÆåÊàêÂøÉÁêÜËØÑ‰º∞ÔºåÁä∂ÊÄÅÊ≠£Â∏∏„ÄÇ' },\n      { id: '8', title: 'Á≥ªÁªüÊõ¥Êñ∞', date: '01-08', description: 'ÂÆâË£ÖÁ≥ªÁªüË°•‰∏Åv2.3.1Ôºå‰øÆÂ§çÂ∑≤Áü•ÊºèÊ¥û„ÄÇÈáçÂêØÂêéÁ≥ªÁªüËøêË°åÁ®≥ÂÆöÔºåÊÄßËÉΩÊèêÂçá5%„ÄÇ' },\n    ];\n  }\n\n  private getDefaultMessages() {\n    return [\n      { id: '1', role: 'user' as const, content: '‰Ω†Â•ΩÔºåÊàëÊÉ≥‰∫ÜËß£‰∏Ä‰∏ãÁ©∫Èó¥Á´ôÁöÑÂΩìÂâçÁä∂ÊÄÅ„ÄÇ', time: '14:32' },\n      { id: '2', role: 'assistant' as const, content: 'ÊÇ®Â•ΩÔºÅÁ©∫Èó¥Á´ôÂΩìÂâçËøêË°åÁä∂ÊÄÅËâØÂ•Ω„ÄÇËÉΩÊ∫êÁ≥ªÁªüÔºö87%ÔºåÁîüÂëΩÁª¥ÊåÅÁ≥ªÁªüÔºö92%ÔºåÁ≥ªÁªüÂÆåÊï¥ÊÄßÔºö78%„ÄÇÊâÄÊúâÂÖ≥ÈîÆÊåáÊ†áÂùáÂú®ÂÆâÂÖ®ËåÉÂõ¥ÂÜÖ„ÄÇÈúÄË¶ÅÊàëËØ¶ÁªÜËØ¥ÊòéÊüê‰∏™Á≥ªÁªüÁöÑÁä∂ÊÄÅÂêóÔºü', time: '14:32' },\n      { id: '3', role: 'user' as const, content: 'ËÉΩÊ∫êÁ≥ªÁªüÁöÑËØ¶ÁªÜÊÉÖÂÜµÂ¶Ç‰ΩïÔºü', time: '14:33' },\n      { id: '4', role: 'assistant' as const, content: 'ËÉΩÊ∫êÁ≥ªÁªüÂΩìÂâçËøêË°åÂú®87%ÁöÑÂÆπÈáèÊ∞¥Âπ≥„ÄÇ‰∏ªË¶ÅËÉΩÊ∫êÊù•Ê∫êÂåÖÊã¨Â§™Èò≥ËÉΩÁîµÊ±†ÊùøÂíåÂ§áÁî®Ê†∏ËÉΩÂèëÁîµÊú∫„ÄÇÊúÄËøë‰∏ÄÊ¨°Ê£ÄÊü•ÊòæÁ§∫ÊâÄÊúâÁªÑ‰ª∂ËøêË°åÊ≠£Â∏∏ÔºåÈ¢ÑËÆ°ÂèØ‰ª•Áª¥ÊåÅÂΩìÂâçË¥üËΩΩËá≥Â∞ë30Â§©„ÄÇÂª∫ËÆÆÂú®‰∏ãÂë®ËøõË°å‰æãË°åÁª¥Êä§Ê£ÄÊü•„ÄÇ', time: '14:33' },\n    ];\n  }\n\n  private getTaskIcon(status: string): string {\n    switch (status) {\n      case 'completed': return 'fa-check-circle';\n      case 'in-progress': return 'fa-clock';\n      case 'pending': return 'fa-exclamation-circle';\n      default: return 'fa-circle';\n    }\n  }\n\n  private getStatusText(status: string): string {\n    switch (status) {\n      case 'completed': return 'ÂÆåÊàê';\n      case 'in-progress': return 'ËøõË°å‰∏≠';\n      case 'pending': return 'ÂæÖÂ§ÑÁêÜ';\n      default: return status;\n    }\n  }\n\n  private getPriorityText(priority: string): string {\n    switch (priority) {\n      case 'urgent': return 'Á¥ßÊÄ•';\n      case 'high': return 'È´ò';\n      case 'medium': return '‰∏≠';\n      case 'low': return '‰Ωé';\n      default: return priority;\n    }\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Ëß£Êûê maintext ÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞ÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ\n   */\n  private parseMaintext(messageContent: string): string {\n    const maintextMatch = messageContent.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n    if (!maintextMatch) {\n      return '';\n    }\n    return maintextMatch[1].trim();\n  }\n\n  /**\n   * ‰ªéÊúÄÊñ∞Ê•ºÂ±ÇËØªÂèñ maintext Âπ∂ÊòæÁ§∫Âú®‰∏â‰∏™ÊñáÊú¨Ê°Ü‰∏≠\n   * ‰ºòÂÖà‰ΩøÁî®ÁªìÊûÑÂåñÊ†áÁ≠æÔºàcontinue_choice, result, decision_nodeÔºâÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÂõûÈÄÄÂà∞ÊóßÊ†ºÂºè\n   */\n  public loadMaintextFromChat(): void {\n    if (!this.element) return;\n\n    try {\n      // Ê£ÄÊü• getChatMessages ÊòØÂê¶ÂèØÁî®\n      if (typeof getChatMessages === 'undefined') {\n        console.warn('‚ö†Ô∏è getChatMessages ‰∏çÂèØÁî®');\n        return;\n      }\n\n      // 1. ÂÖàÂ∞ùËØïËé∑ÂèñÊúÄÊñ∞ÁöÑ assistant Ê∂àÊÅØ\n      let messages: Array<{ message: string; message_id: number; role: string }> = [];\n      try {\n        messages = getChatMessages(-1, { role: 'assistant' });\n      } catch (error) {\n        console.warn('‚ö†Ô∏è Ëé∑Âèñ assistant Ê∂àÊÅØÂ§±Ë¥•:', error);\n      }\n\n      let lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n\n      // 2. Â¶ÇÊûúÊ≤°Êúâ assistant Ê∂àÊÅØÔºåËé∑ÂèñÊúÄÊñ∞Ê∂àÊÅØÔºà‰∏çÈôêÂà∂ roleÔºâ\n      if (!lastMessage) {\n        try {\n          messages = getChatMessages(-1);\n          lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n        } catch (error) {\n          console.warn('‚ö†Ô∏è Ëé∑ÂèñÊúÄÊñ∞Ê∂àÊÅØÂ§±Ë¥•:', error);\n        }\n      }\n\n      if (!lastMessage) {\n        return;\n      }\n\n      // 3. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂä†ËΩΩËøáËøôÊù°Ê∂àÊÅØÔºàÈÅøÂÖçÈáçÂ§çÔºâ\n      if (this.loadedMessageIds.has(lastMessage.message_id)) {\n        return;\n      }\n\n      // 4. Ëß£ÊûêÊ∂àÊÅØÂÜÖÂÆπ\n      const messageContent = lastMessage.message || '';\n\n      // Âä®ÊÄÅÂØºÂÖ• textParser\n      import('../utils/textParser').then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n        // 5. Â∞ùËØïÊèêÂèñÁªìÊûÑÂåñÊ†áÁ≠æ\n        const continueChoice = extractContinueChoice(messageContent);\n        const result = extractResult(messageContent);\n        const nextChoice = extractNextChoice(messageContent);\n\n        // 6. Ëé∑Âèñ‰∏â‰∏™ÊñáÊú¨Ê°ÜÂÖÉÁ¥†\n        const continueChoiceArea = this.element.querySelector('#maintext-continue-choice') as HTMLElement;\n        const resultArea = this.element.querySelector('#maintext-result') as HTMLElement;\n        const nextChoiceArea = this.element.querySelector('#maintext-next-choice') as HTMLElement;\n\n        if (continueChoice || result || nextChoice) {\n          // ‰ΩøÁî®ÁªìÊûÑÂåñÊ†áÁ≠æ\n          if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n          if (resultArea) resultArea.textContent = result || '';\n          if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n        } else {\n          // ÂõûÈÄÄÂà∞ÊóßÊ†ºÂºèÔºöÂ∞Ü maintext ÂÜÖÂÆπÊòæÁ§∫Âú® next_choice Âå∫Âüü\n          const maintext = this.parseMaintext(messageContent);\n          if (nextChoiceArea && maintext) {\n            nextChoiceArea.textContent = maintext;\n          }\n          // Ê∏ÖÁ©∫ÂÖ∂‰ªñ‰∏§‰∏™Âå∫Âüü\n          if (continueChoiceArea) continueChoiceArea.textContent = '';\n          if (resultArea) resultArea.textContent = '';\n        }\n\n        // Ê†áËÆ∞Â∑≤Âä†ËΩΩ\n        this.loadedMessageIds.add(lastMessage.message_id);\n        console.info(`‚úÖ Â∑≤Âä†ËΩΩ maintext (message_id: ${lastMessage.message_id})`);\n      }).catch(error => {\n        console.error('‚ùå ÂØºÂÖ• textParser Â§±Ë¥•:', error);\n        // ÈôçÁ∫ßÂ§ÑÁêÜÔºö‰ΩøÁî®ÊóßÊ†ºÂºè\n        const maintext = this.parseMaintext(messageContent);\n        const nextChoiceArea = this.element.querySelector('#maintext-next-choice') as HTMLElement;\n        if (nextChoiceArea && maintext) {\n          nextChoiceArea.textContent = maintext;\n        }\n      });\n    } catch (error) {\n      console.error('‚ùå Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);\n    }\n  }\n\n  /**\n   * ÁõëÂê¨Ê∂àÊÅØÂèòÂåñ‰∫ã‰ª∂ÔºåËá™Âä®Êõ¥Êñ∞ÊòæÁ§∫\n   */\n  private setupMessageListener(): void {\n    try {\n      if (typeof eventOn === 'undefined' || typeof tavern_events === 'undefined') {\n        console.warn('‚ö†Ô∏è ‰∫ã‰ª∂ÁõëÂê¨ API ‰∏çÂèØÁî®');\n        return;\n      }\n\n      const handleMessageReceived = () => {\n        // Âª∂Ëøü‰∏ÄÁÇπÁ°Æ‰øùÊ∂àÊÅØÂ∑≤ÂÜôÂÖ•\n        setTimeout(() => {\n          try {\n            this.loadMaintextFromChat();\n          } catch (error) {\n            console.error('‚ùå Â§ÑÁêÜÊ∂àÊÅØÊé•Êî∂‰∫ã‰ª∂Â§±Ë¥•:', error);\n          }\n        }, 100);\n      };\n\n      // ÁõëÂê¨ MESSAGE_RECEIVED Âíå CHAT_CHANGED ‰∫ã‰ª∂\n      if (tavern_events.MESSAGE_RECEIVED) {\n        eventOn(tavern_events.MESSAGE_RECEIVED, handleMessageReceived);\n      }\n      if (tavern_events.CHAT_CHANGED) {\n        eventOn(tavern_events.CHAT_CHANGED, handleMessageReceived);\n      }\n\n      // ÁõëÂê¨Ëá™ÂÆö‰πâ‰∫ã‰ª∂ refresh-maintextÔºàÁî®‰∫éÂú®ÂØπËØùÂÆåÊàêÂêéÊâãÂä®Ëß¶ÂèëÊõ¥Êñ∞Ôºâ\n      if (this.element) {\n        this.element.addEventListener('refresh-maintext', () => {\n          setTimeout(() => {\n            this.loadMaintextFromChat();\n          }, 100);\n        });\n      }\n\n      console.info('‚úÖ Â∑≤ËÆæÁΩÆÊ∂àÊÅØÁõëÂê¨Âô®');\n    } catch (error) {\n      console.error('‚ùå ËÆæÁΩÆÊ∂àÊÅØÁõëÂê¨Âô®Â§±Ë¥•:', error);\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) {\n      console.warn('‚ö†Ô∏è Dashboard element ‰∏∫ nullÔºåÊó†Ê≥ïÁªëÂÆö‰∫ã‰ª∂');\n      return;\n    }\n\n    try {\n      // ÂÖ®Â±èÊåâÈíÆ\n      const fullscreenButton = this.element.querySelector('#dashboard-fullscreen-button');\n      if (fullscreenButton) {\n        fullscreenButton.addEventListener('click', () => {\n          this.toggleFullscreen();\n        });\n      } else {\n        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÂÖ®Â±èÊåâÈíÆÂÖÉÁ¥†');\n      }\n\n      // Enter ÈîÆÂÖ®Â±èÊîØÊåÅ\n      this.setupEnterKeyFullscreen();\n\n      // ÂØºËà™ÂàáÊç¢‰∫ã‰ª∂Â∞ÜÂú® app.ts ‰∏≠Â§ÑÁêÜ\n\n      // ËÆæÁΩÆÊ∂àÊÅØÁõëÂê¨Âô®ÔºàÈúÄË¶ÅÊ£ÄÊü• API ÊòØÂê¶ÂèØÁî®ÔºåÂª∂ËøüÊâßË°åÈÅøÂÖçÂàùÂßãÂåñÊó∂Âá∫ÈîôÔºâ\n      setTimeout(() => {\n        try {\n          if (typeof eventOn !== 'undefined' && typeof tavern_events !== 'undefined') {\n            this.setupMessageListener();\n          } else {\n            console.warn('‚ö†Ô∏è ‰∫ã‰ª∂ÁõëÂê¨ API ‰∏çÂèØÁî®ÔºåË∑≥ËøáÊ∂àÊÅØÁõëÂê¨Âô®ËÆæÁΩÆ');\n          }\n        } catch (error) {\n          console.warn('‚ö†Ô∏è ËÆæÁΩÆÊ∂àÊÅØÁõëÂê¨Âô®Â§±Ë¥•ÔºàÈùûÂÖ≥ÈîÆÈîôËØØÔºâ:', error);\n        }\n      }, 200);\n    } catch (error) {\n      console.error('‚ùå bindEvents Â§±Ë¥•:', error);\n      // Âç≥‰ΩøÁªëÂÆöÂ§±Ë¥•Ôºå‰πüÁªßÁª≠ÔºåÈÅøÂÖçÂÆåÂÖ®Êó†Ê≥ï‰ΩøÁî®\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->\n      <header class=\"main-header\">\n        <div class=\"header-content\">\n          <div class=\"logo-section\">\n            <i class=\"fas fa-anchor logo-icon\"></i>\n            <h1 class=\"logo-text\">Èîö</h1>\n          </div>\n          <!-- Ê®°ÂùóÂàáÊç¢ÂØºËà™ -->\n          <nav class=\"top-nav-menu\">\n            <button type=\"button\" class=\"nav-item active\" data-module=\"status\" id=\"nav-status\" title=\"Ëà∞‰ΩìÁä∂ÊÄÅ (1)\">\n              <span class=\"nav-shortcut\">1</span>\n              <i class=\"fas fa-chart-line nav-icon\"></i>\n              <span class=\"nav-text\">Ëà∞‰ΩìÁä∂ÊÄÅ</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"tasks\" id=\"nav-tasks\" title=\"‰ªªÂä°Ê®°Âùó (2)\">\n              <span class=\"nav-shortcut\">2</span>\n              <i class=\"fas fa-tasks nav-icon\"></i>\n              <span class=\"nav-text\">‰ªªÂä°Ê®°Âùó</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"diary\" id=\"nav-diary\" title=\"Êó•ËÆ∞Ê®°Âùó (3)\">\n              <span class=\"nav-shortcut\">3</span>\n              <i class=\"fas fa-book nav-icon\"></i>\n              <span class=\"nav-text\">Êó•ËÆ∞Ê®°Âùó</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"communication\" id=\"nav-communication\" title=\"ÈÄöËÆØÊ®°Âùó (4)\">\n              <span class=\"nav-shortcut\">4</span>\n              <i class=\"fas fa-comments nav-icon\"></i>\n              <span class=\"nav-text\">ÈÄöËÆØÊ®°Âùó</span>\n            </button>\n          </nav>\n          <div class=\"header-actions\">\n            <button type=\"button\" class=\"fullscreen-button\" id=\"dashboard-fullscreen-button\" title=\"ÂÖ®Â±è (Enter)\">\n              <i class=\"fas fa-expand\"></i>\n            </button>\n            <div class=\"header-status\">\n              <div class=\"status-indicator online\">\n                <span class=\"status-dot\"></span>\n                <span class=\"status-text\">Á≥ªÁªüÂú®Á∫ø</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->\n      <main class=\"main-content\">\n        <!-- ÂÜÖÂÆπÈù¢Êùø -->\n        <section class=\"content-panel\">\n          <!-- Á©∫Èó¥Á´ôÁä∂ÊÄÅÊ®°ÂùóÔºàÈªòËÆ§ÊòæÁ§∫Ôºâ -->\n          <div class=\"module-container active\" id=\"module-status\">\n            <div class=\"module-body\">\n              <!-- ‰∏ªÊñáÊú¨Ê°ÜÂå∫Âüü -->\n              <div class=\"maintext-container\">\n                <div class=\"maintext-header\">\n                  <h3 class=\"maintext-title\">\n                    <i class=\"fas fa-scroll\"></i>\n                    ÂΩìÂâçÂâßÊÉÖ\n                  </h3>\n                </div>\n                <div class=\"maintext-areas\">\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">ÈÄâÊã©Âª∂Áª≠</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-continue-choice\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">ÂêéÊûúÊÄªÁªì</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-result\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\">Êñ∞ÂâßÊÉÖ</span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-next-choice\"></div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"status-grid\" id=\"status-grid\"></div>\n            </div>\n          </div>\n\n          <!-- ‰ªªÂä°Ê®°Âùó -->\n          <div class=\"module-container\" id=\"module-tasks\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"tasks-list\"></div>\n            </div>\n          </div>\n\n          <!-- Êó•ËÆ∞Ê®°Âùó -->\n          <div class=\"module-container\" id=\"module-diary\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"diary-list\"></div>\n            </div>\n          </div>\n\n          <!-- ÈÄöËÆØÊ®°Âùó -->\n          <div class=\"module-container\" id=\"module-communication\">\n            <div class=\"module-body communication-body\">\n              <div class=\"chat-messages\" id=\"chat-messages\"></div>\n              <div class=\"chat-input-container\">\n                <div class=\"chat-input-wrapper\">\n                  <button type=\"button\" id=\"chat-show-options-btn\" class=\"chat-show-options-btn\" title=\"ÊòæÁ§∫ÈÄâÈ°π\">\n                    <i class=\"fas fa-list\"></i>\n                  </button>\n                  <textarea id=\"chat-input\" class=\"chat-input\" placeholder=\"ËæìÂÖ•Ê∂àÊÅØ...\" rows=\"1\"></textarea>\n                  <button type=\"button\" id=\"chat-send-btn\" class=\"chat-send-btn\">\n                    <i class=\"fas fa-paper-plane\"></i>\n                  </button>\n                </div>\n              </div>\n              <!-- Option ÈÄâÈ°πÊµÆÂ±ÇÂÆπÂô® -->\n              <div class=\"chat-options-overlay\" id=\"chat-options-overlay\">\n                <div class=\"chat-options-container\" id=\"chat-options-container\">\n                  <div class=\"chat-options-header\">\n                    <span class=\"chat-options-title\">ÂèØÁî®ÈÄâÈ°π</span>\n                    <button type=\"button\" class=\"chat-options-close\" id=\"chat-options-close\" title=\"ÂÖ≥Èó≠\">\n                      <i class=\"fas fa-times\"></i>\n                    </button>\n                  </div>\n                </div>\n                <div class=\"chat-options-list\" id=\"chat-options-list\"></div>\n              </div>\n            </div>\n          </div>\n        </section>\n      </main>\n\n      <!-- Ê®°ÊÄÅÊ°ÜÂÆπÂô® -->\n      <div class=\"modal-overlay\" id=\"modal-overlay\">\n        <div class=\"modal-container\" id=\"modal-container\">\n          <div class=\"modal-header\">\n            <h3 class=\"modal-title\" id=\"modal-title\">Ê†áÈ¢ò</h3>\n            <button class=\"modal-close\" id=\"modal-close\">\n              <i class=\"fas fa-times\"></i>\n            </button>\n          </div>\n          <div class=\"modal-body\" id=\"modal-body\"></div>\n        </div>\n      </div>\n    `;\n  }\n\n  private setupEnterKeyFullscreen(): void {\n    try {\n      // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ\n      if (this.keyDownHandler) {\n        document.removeEventListener('keydown', this.keyDownHandler);\n        this.keyDownHandler = null;\n      }\n\n      // ÂàõÂª∫Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®\n      this.keyDownHandler = (e: KeyboardEvent) => {\n        try {\n          // Âè™Âú® Dashboard ÊòæÁ§∫Êó∂ÂìçÂ∫î\n          if (!this.element?.classList.contains('active')) {\n            return;\n          }\n\n          // Â¶ÇÊûúËæìÂÖ•Ê°ÜËÅöÁÑ¶Ôºå‰∏çÂ§ÑÁêÜ Enter ÈîÆ\n          const activeElement = document.activeElement;\n          if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {\n            return;\n          }\n\n          // Enter ÈîÆËß¶ÂèëÂÖ®Â±è\n          if (e.key === 'Enter') {\n            e.preventDefault();\n            this.toggleFullscreen();\n          }\n        } catch (error) {\n          console.error('‚ùå Enter ÈîÆÂ§ÑÁêÜÂ§±Ë¥•:', error);\n        }\n      };\n\n      document.addEventListener('keydown', this.keyDownHandler);\n      console.log('‚úÖ Enter ÈîÆÂÖ®Â±èÊîØÊåÅÂ∑≤ËÆæÁΩÆ');\n    } catch (error) {\n      console.error('‚ùå ËÆæÁΩÆ Enter ÈîÆÂÖ®Â±èÊîØÊåÅÂ§±Ë¥•:', error);\n    }\n  }\n\n  private requestFullscreen(): void {\n    try {\n      const element = document.documentElement;\n      if (element.requestFullscreen) {\n        element.requestFullscreen().catch((err) => {\n          console.warn('ÂÖ®Â±èËØ∑Ê±ÇÂ§±Ë¥•:', err);\n        });\n      } else if ((element as any).webkitRequestFullscreen) {\n        (element as any).webkitRequestFullscreen();\n      } else if ((element as any).mozRequestFullScreen) {\n        (element as any).mozRequestFullScreen();\n      } else if ((element as any).msRequestFullscreen) {\n        (element as any).msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error('‚ùå ËØ∑Ê±ÇÂÖ®Â±èÂ§±Ë¥•:', error);\n    }\n  }\n\n  private exitFullscreen(): void {\n    try {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    } catch (error) {\n      console.error('‚ùå ÈÄÄÂá∫ÂÖ®Â±èÂ§±Ë¥•:', error);\n    }\n  }\n\n  private toggleFullscreen(): void {\n    try {\n      if (!document.fullscreenElement) {\n        this.requestFullscreen();\n      } else {\n        this.exitFullscreen();\n      }\n    } catch (error) {\n      console.error('‚ùå ÂàáÊç¢ÂÖ®Â±èÂ§±Ë¥•:', error);\n    }\n  }\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = _;","import { GameData, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * Êõ¥Êñ∞ MVU ÂèòÈáèÔºàÂ∞ÜË°®ÂçïËæìÂÖ•ÁöÑÂÄºÂÜôÂÖ• MVU ÂèòÈáèÁ≥ªÁªüÔºâ\n */\nexport async function updateMvuVariables(config: GameConfig): Promise<void> {\n  try {\n    // Á°Æ‰øù MVU Â∑≤ÂàùÂßãÂåñ\n    await waitGlobalInitialized('Mvu');\n\n    // Ëé∑ÂèñÂΩìÂâçÁöÑ MVU Êï∞ÊçÆ\n    const currentMvuData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    const currentStatData = currentMvuData?.stat_data || {};\n\n    // ÊûÑÂª∫Êõ¥Êñ∞ÂêéÁöÑ stat_data\n    const updatedStatData = _.cloneDeep(currentStatData);\n\n    // Êõ¥Êñ∞ system_state.antimatter.reserveÔºàÁ≥ªÁªüÂâ©‰ΩôËÉΩÊ∫êÔºâ\n    if (config.reserve !== undefined) {\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // Á°Æ‰øù reserve Âú® 0-100000 ËåÉÂõ¥ÂÜÖ\n      const clampedReserve = _.clamp(config.reserve, 0, 100000);\n      updatedStatData.system_state.antimatter.reserve = clampedReserve;\n      console.info(`‚úÖ Êõ¥Êñ∞ system_state.antimatter.reserve: ${clampedReserve}`);\n    }\n\n    // Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆÂÜôÂõû MVU\n    const updatedMvuData = {\n      ...currentMvuData,\n      stat_data: updatedStatData,\n    };\n\n    await Mvu.replaceMvuData(updatedMvuData, { type: 'message', message_id: 'latest' });\n    console.info('‚úÖ MVU ÂèòÈáèÂ∑≤Êõ¥Êñ∞');\n  } catch (error) {\n    console.error('‚ùå Êõ¥Êñ∞ MVU ÂèòÈáèÂ§±Ë¥•:', error);\n    throw error;\n  }\n}\n\n/**\n * Êõ¥Êñ∞Ê∏∏ÊàèÊï∞ÊçÆÂà∞ÈÖíÈ¶ÜÂèòÈáèÁ≥ªÁªü\n */\nexport async function updateGameData(data: Partial<GameData>): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_data: {\n        ...(currentData.game_data || {}),\n        ...data,\n      },\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤Êõ¥Êñ∞');\n  } catch (error) {\n    console.error('Êõ¥Êñ∞Ê∏∏ÊàèÊï∞ÊçÆÂ§±Ë¥•:', error);\n    throw error;\n  }\n}\n\n/**\n * Êõ¥Êñ∞Ê∏∏ÊàèÈÖçÁΩÆ\n */\nexport async function updateGameConfig(config: GameConfig): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_config: config,\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('Ê∏∏ÊàèÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞');\n  } catch (error) {\n    console.error('Êõ¥Êñ∞Ê∏∏ÊàèÈÖçÁΩÆÂ§±Ë¥•:', error);\n    throw error;\n  }\n}\n\n/**\n * ÂàùÂßãÂåñÊ∏∏ÊàèÊï∞ÊçÆ\n */\nexport async function initializeGameData(config: GameConfig): Promise<GameData> {\n  // ÂÖàÊõ¥Êñ∞ MVU ÂèòÈáèÔºàÂ∞ÜË°®ÂçïËæìÂÖ•ÁöÑÂÄºÂÜôÂÖ• MVUÔºâ\n  await updateMvuVariables(config);\n\n  // ÂàõÂª∫Âü∫Êú¨ÁöÑÊ∏∏ÊàèÊï∞ÊçÆÁªìÊûÑÔºà‰øùÁïôÂÖºÂÆπÊÄßÔºâ\n  const gameData: GameData = {\n    station_name: 'Á©∫Èó¥Á´ô Alpha', // ‰∏çÂÜç‰ªéË°®ÂçïËØªÂèñ\n    difficulty: 'normal', // ‰∏çÂÜç‰ªéË°®ÂçïËØªÂèñ\n    resources: {\n      energy: 100,\n      supplies: 100,\n      crew: 10,\n    },\n    status: {\n      energy: 87,\n      life_support: 92,\n      system: 78,\n      personnel: 'Ê≠£Â∏∏',\n      communication: 95,\n      laboratory: 83,\n      storage: 64,\n      computing: 71,\n    },\n    tasks: [],\n    diary: [],\n    messages: [],\n  };\n\n  await updateGameData(gameData);\n  await updateGameConfig(config);\n\n  return gameData;\n}\n","import { PageState } from '../types/types';\nimport { SplashScreen } from '../components/SplashScreen';\nimport { NewGameSetup } from '../components/NewGameSetup';\nimport { Dashboard } from '../components/Dashboard';\nimport { ComponentCallbacks } from '../types/types';\nimport { initializeNewGame, continueGame } from './gameInitializer';\nimport { hasSaveData } from './variableReader';\n\n/**\n * È°µÈù¢ÊµÅÁ®ãÁÆ°ÁêÜÂô®\n */\nexport class PageManager {\n  private currentPage: PageState = 'splash';\n  private splashScreen: SplashScreen;\n  private setupScreen: NewGameSetup;\n  private dashboard: Dashboard;\n  private appContainer: HTMLElement;\n\n  constructor(appContainer: HTMLElement) {\n    this.appContainer = appContainer;\n\n    const callbacks: ComponentCallbacks = {\n      onStart: () => this.goToSplash(),\n      onNewGame: () => this.goToSetup(),\n      onContinue: () => this.goToGame(),\n      onConfirm: (config) => this.handleConfirm(config),\n      onCancel: () => this.goToSplash(),\n      onFullscreenToggle: () => this.toggleFullscreen(),\n    };\n\n    this.splashScreen = new SplashScreen(callbacks);\n    this.setupScreen = new NewGameSetup(callbacks);\n    this.dashboard = new Dashboard(callbacks);\n  }\n\n  public initialize(): void {\n    // ÂàõÂª∫ÊâÄÊúâÁªÑ‰ª∂\n    this.appContainer.appendChild(this.splashScreen.createElement());\n    this.appContainer.appendChild(this.setupScreen.createElement());\n    this.appContainer.appendChild(this.dashboard.createElement());\n\n    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠òÊ°£ÔºåÂ¶ÇÊûúÊúâÂàôÁõ¥Êé•ËøõÂÖ•Ê∏∏ÊàèÔºåÂê¶ÂàôÊòæÁ§∫ÂºÄÂßãÂ±èÂπï\n    const hasSave = hasSaveData();\n    if (hasSave) {\n      // ÊúâÂ≠òÊ°£ÔºåÁõ¥Êé•ËøõÂÖ•Ê∏∏Êàè\n      this.goToGame();\n    } else {\n      // Ê≤°ÊúâÂ≠òÊ°£ÔºåÊòæÁ§∫ÂºÄÂßãÂ±èÂπï\n      this.showPage('splash');\n    }\n  }\n\n  private showPage(page: PageState): void {\n    console.log(`üîÑ ÂºÄÂßãÂàáÊç¢È°µÈù¢: ${page}`);\n\n    // ÈöêËóèÊâÄÊúâÈ°µÈù¢\n    try {\n      this.splashScreen.hide();\n      this.setupScreen.hide();\n      this.dashboard.hide();\n    } catch (error) {\n      console.warn('‚ö†Ô∏è ÈöêËóèÈ°µÈù¢Êó∂Âá∫Èîô:', error);\n    }\n\n    // ÊòæÁ§∫ÁõÆÊ†áÈ°µÈù¢\n    try {\n      switch (page) {\n        case 'splash':\n          this.splashScreen.show();\n          // ËøõÂÖ•Ê†áÈ¢òÈ°µÈù¢Êó∂ËØ∑Ê±ÇÂÖ®Â±è\n          this.requestFullscreen();\n          break;\n        case 'setup':\n          this.setupScreen.show();\n          break;\n        case 'game':\n          this.dashboard.show();\n          // Á°Æ‰øù Dashboard Â∑≤Ê≠£Á°ÆÊòæÁ§∫\n          setTimeout(() => {\n            const dashboardElement = document.getElementById('main-screen');\n            if (dashboardElement && dashboardElement.classList.contains('active')) {\n              console.log('‚úÖ Dashboard Â∑≤Ê≠£Á°ÆÊòæÁ§∫');\n            } else {\n              console.error('‚ùå Dashboard ÊòæÁ§∫ÂºÇÂ∏∏Ôºåelement:', dashboardElement);\n            }\n          }, 100);\n          break;\n      }\n    } catch (error) {\n      console.error(`‚ùå ÊòæÁ§∫È°µÈù¢ ${page} Â§±Ë¥•:`, error);\n      throw error;\n    }\n\n    this.currentPage = page;\n    console.info(`‚úÖ ÊàêÂäüÂàáÊç¢Âà∞È°µÈù¢: ${page}`);\n  }\n\n  private goToSplash(): void {\n    this.showPage('splash');\n  }\n\n  private goToSetup(): void {\n    this.showPage('setup');\n  }\n\n  private async goToGame(): Promise<void> {\n    try {\n      console.log('üîÑ ÂºÄÂßãÂä†ËΩΩÊ∏∏Êàè...');\n      const gameData = await continueGame();\n      console.log('‚úÖ Ê∏∏ÊàèÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', gameData);\n\n      // Êõ¥Êñ∞Ê∏∏ÊàèÊï∞ÊçÆ\n      this.dashboard.updateGameData(gameData);\n\n      // ÊòæÁ§∫Ê∏∏ÊàèÈ°µÈù¢\n      this.showPage('game');\n\n      console.log('‚úÖ Â∑≤ÂàáÊç¢Âà∞Ê∏∏ÊàèÈ°µÈù¢');\n    } catch (error) {\n      console.error('‚ùå Âä†ËΩΩÊ∏∏ÊàèÂ§±Ë¥•:', error);\n      console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', {\n        error: error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorStack: error instanceof Error ? error.stack : undefined,\n      });\n\n      // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÊòæÁ§∫Ê∏∏ÊàèÈ°µÈù¢Ôºà‰ΩøÁî®Á©∫Êï∞ÊçÆÔºâ\n      try {\n        this.dashboard.updateGameData({});\n        this.showPage('game');\n        console.warn('‚ö†Ô∏è ‰ΩøÁî®Á©∫Êï∞ÊçÆÁªßÁª≠ÊòæÁ§∫Ê∏∏ÊàèÈ°µÈù¢');\n      } catch (fallbackError) {\n        console.error('‚ùå ÊòæÁ§∫Ê∏∏ÊàèÈ°µÈù¢‰πüÂ§±Ë¥•:', fallbackError);\n        toastr.error('Âä†ËΩΩÊ∏∏ÊàèÂ§±Ë¥•', 'ÈîôËØØ');\n      }\n    }\n  }\n\n  private async handleConfirm(config: any): Promise<void> {\n    try {\n      // initializeNewGame ÂÜÖÈÉ®Â∑≤Áªè‰ºöË∞ÉÁî® createOpeningStoryMessage\n      const gameData = await initializeNewGame(config);\n      this.dashboard.updateGameData(gameData);\n      this.showPage('game');\n      toastr.success('Ê∏∏ÊàèÂ∑≤ÂàùÂßãÂåñ', 'ÊàêÂäü');\n    } catch (error) {\n      console.error('ÂàùÂßãÂåñÊ∏∏ÊàèÂ§±Ë¥•:', error);\n      toastr.error('ÂàùÂßãÂåñÊ∏∏ÊàèÂ§±Ë¥•', 'ÈîôËØØ');\n    }\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('ÂÖ®Â±èËØ∑Ê±ÇÂ§±Ë¥•:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private toggleFullscreen(): void {\n    if (!document.fullscreenElement) {\n      this.requestFullscreen();\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    }\n  }\n\n  public getDashboard(): Dashboard {\n    return this.dashboard;\n  }\n}\n","import { GameConfig, GameData } from '../types/types';\nimport { initializeGameData } from './variableUpdater';\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\n\n/**\n * ÂàùÂßãÂåñÊñ∞Ê∏∏Êàè\n * ‰∏çÂÜçÂàõÂª∫ÂºÄÂú∫ÁôΩÔºåÂºÄÂú∫ÁôΩÁî±Áî®Êà∑Ëá™ÂÆö‰πâÔºàÁ¨¨‰∏ÄÊù°assistantÊ∂àÊÅØÔºâ\n */\nexport async function initializeNewGame(config: GameConfig): Promise<GameData> {\n  console.info('ÂàùÂßãÂåñÊñ∞Ê∏∏Êàè...', config);\n\n  const gameData = await initializeGameData(config);\n\n  console.info('Êñ∞Ê∏∏ÊàèÂàùÂßãÂåñÂÆåÊàêÔºàÂºÄÂú∫ÁôΩÁî±Áî®Êà∑Ëá™ÂÆö‰πâÔºâ');\n  return gameData;\n}\n\n/**\n * ÁªßÁª≠Ê∏∏Êàè\n */\nexport async function continueGame(): Promise<Partial<GameData>> {\n  console.info('ÁªßÁª≠Ê∏∏Êàè...');\n\n  const variables = getVariables({ type: 'message' });\n  const gameData = variables.game_data || variables.stat_data || {};\n\n  console.info('Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤Âä†ËΩΩ');\n  return gameData as Partial<GameData>;\n}\n","// Èîö - Dashboard ÈÄªËæë\n// ÂåÖÂê´ÂØºËà™„ÄÅÊ®°ÊÄÅÊ°Ü„ÄÅÂä®Áîª„ÄÅÁä∂ÊÄÅÂç°Áâá‰∫§‰∫í„ÄÅËÅäÂ§©ÁïåÈù¢Á≠âÂäüËÉΩ\n\n// ÂÖ®Â±ÄÂáΩÊï∞Â£∞ÊòéÔºàÁî±ÈÖíÈ¶ÜÂä©ÊâãÊèê‰æõÔºâ\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare const errorCatched: (fn: () => void) => () => void;\n\n// ========== ÂØºËà™ÂäüËÉΩ ==========\nexport function initNavigation() {\n  const navItems = document.querySelectorAll('.nav-item');\n  const modules = document.querySelectorAll('.module-container');\n\n  // ÂàáÊç¢Ê®°ÂùóÁöÑÂáΩÊï∞\n  function switchModule(moduleId: string) {\n    if (!moduleId) return;\n\n    // ÁßªÈô§ÊâÄÊúâ active Á±ª\n    navItems.forEach(nav => nav.classList.remove('active'));\n    modules.forEach(module => module.classList.remove('active'));\n\n    // Ê∑ªÂä† active Á±ª\n    const targetNavItem = document.querySelector(`.nav-item[data-module=\"${moduleId}\"]`);\n    const targetModule = document.getElementById(`module-${moduleId}`);\n\n    if (targetNavItem) {\n      targetNavItem.classList.add('active');\n    }\n    if (targetModule) {\n      targetModule.classList.add('active');\n    }\n  }\n\n  // ÁÇπÂáªÂàáÊç¢\n  navItems.forEach(item => {\n    item.addEventListener('click', () => {\n      const moduleId = item.getAttribute('data-module');\n      if (moduleId) {\n        switchModule(moduleId);\n      }\n    });\n  });\n\n  // ÈîÆÁõòÂø´Êç∑ÈîÆÂàáÊç¢Ôºà1, 2, 3, 4Ôºâ\n  const moduleMap: Record<string, string> = {\n    '1': 'status',\n    '2': 'tasks',\n    '3': 'diary',\n    '4': 'communication',\n  };\n\n  document.addEventListener('keydown', e => {\n    // Âè™Âú®‰∏ªÊ∏∏ÊàèÁïåÈù¢ÊøÄÊ¥ªÊó∂ÂìçÂ∫îÔºå‰∏î‰∏çÂú®ËæìÂÖ•Ê°Ü‰∏≠\n    const mainScreen = document.getElementById('main-screen');\n    if (!mainScreen || !mainScreen.classList.contains('active')) {\n      return;\n    }\n\n    // Â¶ÇÊûúÁÑ¶ÁÇπÂú®ËæìÂÖ•Ê°ÜÊàñÂÖ∂‰ªñÂèØËæìÂÖ•ÂÖÉÁ¥†‰∏äÔºå‰∏çÂìçÂ∫î\n    const activeElement = document.activeElement;\n    if (\n      activeElement &&\n      (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.isContentEditable)\n    ) {\n      return;\n    }\n\n    // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ãÊï∞Â≠óÈîÆ 1-4\n    if (e.key >= '1' && e.key <= '4') {\n      const moduleId = moduleMap[e.key];\n      if (moduleId) {\n        e.preventDefault();\n        switchModule(moduleId);\n        console.log(`‚å®Ô∏è Âø´Êç∑ÈîÆÂàáÊç¢Ê®°Âùó: ${moduleId} (${e.key})`);\n      }\n    }\n  });\n}\n\n// ========== Ê®°ÊÄÅÊ°ÜÂäüËÉΩ ==========\nexport function initModals() {\n  const modalOverlay = document.getElementById('modal-overlay');\n  const modalClose = document.getElementById('modal-close');\n\n  if (!modalOverlay || !modalClose) return;\n\n  modalClose.addEventListener('click', () => {\n    modalOverlay.classList.remove('active');\n  });\n\n  modalOverlay.addEventListener('click', e => {\n    if (e.target === modalOverlay) {\n      modalOverlay.classList.remove('active');\n    }\n  });\n}\n\n// ========== Âä®ÁîªÂäüËÉΩ ==========\nexport function initAnimations() {\n  // Âü∫Á°ÄÂä®ÁîªÂ∑≤ÈÄöËøá CSS ÂÆûÁé∞\n  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä† JS Âä®ÁîªÈÄªËæëÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ\n}\n\n// ========== Áä∂ÊÄÅÂç°Áâá‰∫§‰∫í ==========\nexport function initStatusCardInteractions() {\n  const statusCards = document.querySelectorAll('.status-card');\n  statusCards.forEach(card => {\n    card.addEventListener('click', () => {\n      // Áä∂ÊÄÅÂç°ÁâáÁÇπÂáª‰∫§‰∫íÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ\n      console.log('Áä∂ÊÄÅÂç°ÁâáË¢´ÁÇπÂáª');\n    });\n  });\n}\n\n// ========== ËÅäÂ§©ÁïåÈù¢ÂäüËÉΩ ==========\n\n/**\n * ‰∏ÄËΩÆÂØπËØùÁöÑÊï∞ÊçÆÁªìÊûÑ\n */\ninterface ConversationRound {\n  assistantMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  userMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  pending?: boolean; // Ê†áËÆ∞‰∏∫ÂæÖÂ§ÑÁêÜÁöÑËΩÆÊ¨°ÔºàÁî®Êà∑Â∑≤ÂèëÈÄÅÔºåAIÊú™ÂõûÂ§çÔºâ\n  pendingUserMessage?: string; // ÂæÖÂ§ÑÁêÜÁöÑÁî®Êà∑Ê∂àÊÅØÂÜÖÂÆπ\n}\n\n/**\n * ÂàùÂßãÂåñÂØπËØùÁïåÈù¢ÔºàÊîØÊåÅÂ∑¶Âè≥ÊªëÂä®ÂíåÊµÅÂºèÊ∏≤ÊüìÔºâ\n */\nexport function initChatInterface() {\n  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;\n  const chatSendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;\n  const chatMessages = document.getElementById('chat-messages') as HTMLElement;\n\n  if (!chatInput || !chatSendBtn || !chatMessages) {\n    return;\n  }\n\n  // ÂØπËØùËΩÆÊ¨°Êï∞ÁªÑ\n  let rounds: ConversationRound[] = [];\n  let currentRoundIndex = -1; // ÂΩìÂâçÊòæÁ§∫ÁöÑËΩÆÊ¨°Á¥¢Âºï\n\n  // ÂΩìÂâçÊµÅÂºèËæìÂá∫ÂÖÉÁ¥†ÔºàÁî®‰∫éÂÆûÊó∂Ê∏≤ÊüìÔºâ\n  let streamingElement: HTMLElement | null = null;\n\n  // ‰øùÂ≠òÊúÄÂêé‰∏ÄÊ¨°ÊµÅÂºèÊñáÊú¨ÔºàrawÔºåÂåÖÂê´Ê†áÁ≠æÔºâ\n  let lastStreamedRawMessage: string = '';\n\n  // ÊòØÂê¶Ê≠£Âú®ÁîüÊàêÊ∂àÊÅØ\n  let isGenerating = false;\n\n  // ÊòØÂê¶Ê≠£Âú®ÂèëÈÄÅÊ∂àÊÅØÔºàÈò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅÔºâ\n  let isSending = false;\n\n  // ‰øùÂ≠òÊúÄÊñ∞ÊèêÂèñÁöÑÈÄâÈ°πÔºà‰ªé messageGenerator ‰º†ÈÄíÔºåÈÅøÂÖç‰ªéÊ∂àÊÅØ‰∏≠ÊèêÂèñÔºâ\n  let latestOptions: string[] = [];\n\n  // Á°Æ‰øù generateMessage Â∑≤Âä†ËΩΩ\n  let generateMessagePromise: Promise<any> | null = null;\n\n  // È¢ÑÂä†ËΩΩÊ∂àÊÅØÁîüÊàêÊúçÂä°\n  function ensureMessageGeneratorLoaded(): Promise<any> {\n    if (!generateMessagePromise) {\n      generateMessagePromise = import('./utils/messageGenerator').then(module => module.generateMessage);\n    }\n    return generateMessagePromise;\n  }\n\n  // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶\n  function adjustInputHeight() {\n    chatInput.style.height = 'auto';\n    const maxHeight = 80;\n    const newHeight = Math.min(chatInput.scrollHeight, maxHeight);\n    chatInput.style.height = `${newHeight}px`;\n  }\n\n  chatInput.addEventListener('input', adjustInputHeight);\n\n  // HTMLËΩ¨‰πâ\n  function escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // Â∞ÜÊ∂àÊÅØÂàÜÁªÑ‰∏∫ËΩÆÊ¨°\n  // ËßÑÂàôÔºà‰øÆÊ≠£ÁâàÔºåÁ¨¶ÂêàÁúüÂÆûÊó∂Èó¥Á∫øÔºâÔºö\n  // 1. Á¨¨‰∏ÄÊù° assistant Ê∂àÊÅØÔºàÂºÄÂú∫ÁôΩÔºâ‰Ωú‰∏∫Â≠§Á´ãÊ∂àÊÅØÔºåÂè™Êúâ assistantMessageÔºåÊ≤°Êúâ userMessage\n  // 2. ÊØè‰∏ÄÊù° user Ê∂àÊÅØÈÉΩ‰ºöÂºÄÂêØ‰∏ÄËΩÆ\n  // 3. Á¥ßÈöèÂÖ∂ÂêéÁöÑ assistant Ê∂àÊÅØË°•ÂÖ®ËØ•ËΩÆ\n  function groupMessagesIntoRounds(\n    allMessages: Array<{\n      message: string;\n      message_id: number;\n      role: string;\n    }>,\n  ): ConversationRound[] {\n    const rounds: ConversationRound[] = [];\n\n    // ÂΩìÂâçÊ≠£Âú®Á≠âÂæÖ assistant Ë°•ÂÖ®ÁöÑËΩÆÊ¨°\n    let pendingRound: ConversationRound | null = null;\n\n    // ÊåâÊ∂àÊÅØÁúüÂÆûÂá∫Áé∞È°∫Â∫èÈÅçÂéÜÔºàÊó∂Èó¥Á∫øÔºâ\n    allMessages.forEach((msg, index) => {\n      // Â§ÑÁêÜ user Ê∂àÊÅØÔºöÊ∞∏ËøúÂºÄÂêØÊñ∞‰∏ÄËΩÆ\n      if (msg.role === 'user') {\n        const round: ConversationRound = {\n          userMessage: {\n            message_id: msg.message_id,\n            message: msg.message,\n          },\n          assistantMessage: null,\n        };\n\n        rounds.push(round);\n        pendingRound = round;\n        return;\n      }\n\n      // Â§ÑÁêÜ assistant Ê∂àÊÅØ\n      if (msg.role === 'assistant') {\n        // Â¶ÇÊûúÂ≠òÂú®Á≠âÂæÖË°•ÂÖ®ÁöÑËΩÆÊ¨°ÔºåÂàôË°•ÂÖ®ÂÆÉ\n        if (pendingRound && !pendingRound.assistantMessage) {\n          pendingRound.assistantMessage = {\n            message_id: msg.message_id,\n            message: msg.message,\n          };\n          pendingRound = null;\n        } else {\n          // Âê¶ÂàôËßÜ‰∏∫ÂºÄÂú∫ÁôΩ / Â≠§Á´ã assistant Ê∂àÊÅØ\n          rounds.push({\n            userMessage: null,\n            assistantMessage: {\n              message_id: msg.message_id,\n              message: msg.message,\n            },\n          });\n        }\n      }\n    });\n\n    return rounds;\n  }\n\n  // ÊòæÁ§∫ÊåáÂÆöËΩÆÊ¨°ÁöÑÂØπËØù\n  async function displayRound(roundIndex: number) {\n    // Â¶ÇÊûúÊ≠£Âú®ÁîüÊàêÔºå‰∏çÊ∏ÖÈô§ÊµÅÂºèÂÖÉÁ¥†\n    if (!isGenerating) {\n      chatMessages.innerHTML = '';\n      streamingElement = null;\n    } else {\n      // Ê≠£Âú®ÁîüÊàêÊó∂ÔºåÂè™Ê∏ÖÈô§ÈùûÊµÅÂºèÁöÑÊ∂àÊÅØÔºà‰øùÁïôÊµÅÂºèÂÖÉÁ¥†Ôºâ\n      const existingMessages = Array.from(chatMessages.children).filter(child => child !== streamingElement);\n      existingMessages.forEach(msg => msg.remove());\n    }\n\n    // Â¶ÇÊûúÁ¥¢ÂºïË∂ÖÂá∫ËåÉÂõ¥ÔºåÊòæÁ§∫Á©∫ËΩÆÊ¨°ÔºàÁî®‰∫éÊòæÁ§∫Áî®Êà∑Ê∂àÊÅØÁ≠âÂæÖAIÂõûÂ§çÔºâ\n    if (roundIndex < 0 || roundIndex >= rounds.length) {\n      return;\n    }\n\n    const round = rounds[roundIndex];\n\n    // ÂÖàÊòæÁ§∫ user Ê∂àÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ- Á°Æ‰øùÂú®‰∏äÊñπ\n    if (round.userMessage) {\n      renderUserMessage(round.userMessage.message);\n    } else if (round.pendingUserMessage) {\n      // ÊòæÁ§∫ÂæÖÂ§ÑÁêÜÁöÑÁî®Êà∑Ê∂àÊÅØ\n      renderUserMessage(round.pendingUserMessage);\n    }\n\n    // ÂÜçÊòæÁ§∫ assistant Ê∂àÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ- Á°Æ‰øùÂú®‰∏ãÊñπ\n    if (round.assistantMessage) {\n      await renderAssistantMessage(round.assistantMessage.message, round.assistantMessage.message);\n    } else if (round.pending && isGenerating) {\n      // Â¶ÇÊûúÊòØÂæÖÂ§ÑÁêÜÁöÑËΩÆÊ¨°‰∏îÊ≠£Âú®ÁîüÊàêÔºåÁ°Æ‰øùÊµÅÂºèÂÖÉÁ¥†Âú®Áî®Êà∑Ê∂àÊÅØ‰∏ãÊñπ\n      if (!streamingElement) {\n        showGenerating();\n      }\n      // Â¶ÇÊûúÊµÅÂºèÂÖÉÁ¥†Â∑≤Â≠òÂú®‰ΩÜ‰∏çÂú®Ê≠£Á°Æ‰ΩçÁΩÆÔºåÁßªÂä®Âà∞Áî®Êà∑Ê∂àÊÅØ‰∏ãÊñπ\n      if (streamingElement && streamingElement.parentNode === chatMessages) {\n        // Á°Æ‰øùÊµÅÂºèÂÖÉÁ¥†Âú®ÊúÄÂêéÔºàÁî®Êà∑Ê∂àÊÅØ‰πãÂêéÔºâ\n        chatMessages.appendChild(streamingElement);\n      }\n    } else if (!round.assistantMessage) {\n      // Â¶ÇÊûúÊ≤°ÊúâassistantÊ∂àÊÅØ‰∏î‰∏çÂú®ÁîüÊàêÔºåÊòæÁ§∫Á≠âÂæÖÈÄâÊã©\n      if (!isGenerating) {\n        showWaitingMessage();\n      }\n    }\n  }\n\n  // Ê∏≤Êüì assistant Ê∂àÊÅØÔºàÂè™Ëß£ÊûêÂ≠òÂú®ÁöÑÊ†áÁ≠æÔºâ\n  async function renderAssistantMessage(content: string, rawMessage: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-assistant';\n\n    try {\n      const { extractContinueChoice, extractResult, extractNextChoice } = await import('./utils/textParser');\n\n      // ‰ªé rawMessage ‰∏≠ÊèêÂèñ maintextÔºåÁÑ∂Âêé‰ªé maintext ‰∏≠ÊèêÂèñ‰∏âÊ†èÊ†áÁ≠æ\n      const { extractLastMaintext } = await import('./utils/textParser');\n      const maintext = extractLastMaintext(rawMessage);\n\n      // Â¶ÇÊûú maintext Â≠òÂú®Ôºå‰ªé maintext ‰∏≠ÊèêÂèñÔºõÂê¶Âàô‰ªéÊï¥‰∏™Ê∂àÊÅØ‰∏≠ÊèêÂèñ\n      const searchText = maintext || rawMessage;\n\n      const continueChoice = extractContinueChoice(searchText);\n      const result = extractResult(searchText);\n      const nextChoice = extractNextChoice(searchText);\n\n      // ÊûÑÂª∫‰∏âÊ†èÂÜÖÂÆπÔºåÂè™ÊòæÁ§∫Â≠òÂú®ÁöÑÊ†áÁ≠æ\n      const columns: Array<{ header: string; content: string; key: string }> = [];\n\n      if (continueChoice) {\n        columns.push({ header: 'ÈÄâÊã©Âª∂Áª≠', content: continueChoice, key: 'continue' });\n      }\n      if (result) {\n        columns.push({ header: 'ÂêéÊûúÊÄªÁªì', content: result, key: 'result' });\n      }\n      if (nextChoice) {\n        columns.push({ header: 'Êñ∞ÂâßÊÉÖ', content: nextChoice, key: 'next' });\n      }\n\n      if (columns.length > 0) {\n        // ÊòæÁ§∫‰∏âÊ†èÔºàÂèØËÉΩÂè™Êúâ1-3Ê†èÔºâ\n        const columnsHtml = columns\n          .map(\n            col => `\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">${escapeHtml(col.header)}</div>\n            <div class=\"message-column-content\">${escapeHtml(col.content)}</div>\n          </div>\n        `,\n          )\n          .join('');\n\n        messageItem.innerHTML = `\n          <div class=\"message-role\">AI</div>\n          <div class=\"message-content message-content-three-columns\">\n            ${columnsHtml}\n          </div>\n          <div class=\"message-time\"></div>\n        `;\n      } else {\n        // Ê≤°ÊúâÁªìÊûÑÂåñÊ†áÁ≠æÔºåÊòæÁ§∫ÂçïÊ†è\n        messageItem.innerHTML = `\n          <div class=\"message-role\">AI</div>\n          <div class=\"message-content\">${escapeHtml(content)}</div>\n          <div class=\"message-time\"></div>\n        `;\n      }\n    } catch (error) {\n      console.error('‚ùå Ëß£ÊûêÁªìÊûÑÂåñÊ†áÁ≠æÂ§±Ë¥•Ôºå‰ΩøÁî®ÂçïÊ†èÊòæÁ§∫:', error);\n      messageItem.innerHTML = `\n        <div class=\"message-role\">AI</div>\n        <div class=\"message-content\">${escapeHtml(content)}</div>\n        <div class=\"message-time\"></div>\n      `;\n    }\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // Ê∏≤Êüì user Ê∂àÊÅØ\n  function renderUserMessage(content: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-user';\n\n    // Áî®Êà∑Ê∂àÊÅØÊòæÁ§∫ÂçïÊ†è\n    messageItem.innerHTML = `\n      <div class=\"message-role\">Áî®Êà∑</div>\n      <div class=\"message-content\">${escapeHtml(content)}</div>\n      <div class=\"message-time\"></div>\n    `;\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // Âä†ËΩΩÂØπËØùÂéÜÂè≤Âπ∂ÂàÜÁªÑ\n  async function loadChatHistory() {\n    try {\n      const lastMessageId = getLastMessageId();\n\n      const allMessages = lastMessageId >= 0 ? getChatMessages(`0-${lastMessageId}`) : [];\n      const newRounds = groupMessagesIntoRounds(allMessages);\n\n      rounds = newRounds;\n\n      // ÊòæÁ§∫ÊúÄÂêé‰∏ÄËΩÆ\n      if (rounds.length > 0) {\n        currentRoundIndex = rounds.length - 1;\n        if (!isGenerating) {\n          await displayRound(currentRoundIndex);\n        }\n      }\n\n      console.log('‚úÖ Â∑≤Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤ÔºåÂÖ±', rounds.length, 'ËΩÆÂØπËØùÔºåÂΩìÂâçÊòæÁ§∫Á¨¨', currentRoundIndex + 1, 'ËΩÆ');\n    } catch (error) {\n      console.error('Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error);\n    }\n  }\n\n  // Âà∑Êñ∞ÊòæÁ§∫ÔºàÂΩìÊ®°ÂùóË¢´ÊøÄÊ¥ªÊó∂Ë∞ÉÁî®Ôºâ\n  async function refreshDisplay() {\n    await loadChatHistory();\n  }\n\n  // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂ÔºàÂ∑¶ÁÆ≠Â§¥ÂíåÂè≥ÁÆ≠Â§¥Ôºâ\n  function setupKeyboardNavigation() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const keyHandler = (e: KeyboardEvent) => {\n      // Âè™Âú®ÈÄöËÆØÊ®°ÂùóÊøÄÊ¥ª‰∏î‰∏çÂú®ËæìÂÖ•Ê°Ü‰∏≠Êó∂ÂìçÂ∫î\n      if (!communicationModule.classList.contains('active')) return;\n      if (document.activeElement === chatInput) return;\n\n      if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        goToPreviousRound();\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        goToNextRound();\n      }\n    };\n\n    document.addEventListener('keydown', keyHandler);\n  }\n\n  // ÂèëÈÄÅÊ∂àÊÅØ\n  async function sendMessage() {\n    // Èò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅ\n    if (isSending) {\n      console.warn('‚ö†Ô∏è Ê≠£Âú®ÂèëÈÄÅÊ∂àÊÅØÔºåËØ∑ÂãøÈáçÂ§çÁÇπÂáª');\n      return;\n    }\n\n    const message = chatInput.value.trim();\n    if (!message) {\n      return;\n    }\n\n    // ËÆæÁΩÆÂèëÈÄÅÊ†áÂøó\n    isSending = true;\n\n    chatInput.value = '';\n    adjustInputHeight();\n\n    // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆÂíåËæìÂÖ•Ê°Ü\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n\n    // ËÆæÁΩÆÁîüÊàêÊ†áÂøóÔºàÂú®ÂàõÂª∫Áî®Êà∑Ê∂àÊÅØ‰πãÂâçÔºâ\n    isGenerating = true;\n\n    // Ê≥®ÊÑèÔºö‰∏çÂú® sendMessage ‰∏≠Áõ¥Êé•Ê∏≤ÊüìÁî®Êà∑Ê∂àÊÅØ\n    // Áî®Êà∑Ê∂àÊÅØ‰ºöÂú® generateMessage ÂàõÂª∫ÂêéÔºåÈÄöËøá loadChatHistory ÈáçÊñ∞Âä†ËΩΩÊó∂ÊòæÁ§∫\n\n    try {\n      const generateMessage = await ensureMessageGeneratorLoaded();\n      console.log('üöÄ ÂºÄÂßãÁîüÊàêÊ∂àÊÅØÔºåÁî®Êà∑ËæìÂÖ•:', message);\n\n      const success = await generateMessage(message, {\n        onShowGenerating: () => {\n          // ÊòæÁ§∫ÁîüÊàêÊèêÁ§∫ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÊµÅÂºèÂÖÉÁ¥†Ôºâ\n          if (!streamingElement) {\n            showGenerating();\n          }\n        },\n        onHideGenerating: () => {\n          hideGenerating();\n          isGenerating = false;\n        },\n        onError: (error: string) => {\n          console.error('‚ùå ÁîüÊàêÊ∂àÊÅØÂ§±Ë¥•:', error);\n          hideGenerating();\n          isGenerating = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          isSending = false;\n        },\n        onStreamingUpdate: (text: string) => {\n          // ‰º†ÈÄíÂÆåÊï¥ÁöÑÊñáÊú¨ÔºàÂåÖÂê´Ê†áÁ≠æÔºâÔºåÁî®‰∫éÊ£ÄÊµãÊ†áÁ≠æÂºÄÂßã/ÁªìÊùü\n          updateStreamingMessage(text);\n        },\n        onRefreshStoryIfOpen: (userMessage: string) => {\n          // user Ê∂àÊÅØÂàõÂª∫ÂêéÔºåÁ´ãÂç≥ÂàõÂª∫‰∏Ä‰∏™pendingËΩÆÊ¨°Âπ∂ÊòæÁ§∫\n          console.log('üìù user Ê∂àÊÅØÂ∑≤ÂàõÂª∫ÔºåÁ´ãÂç≥ÊòæÁ§∫:', userMessage);\n\n          // ËÆæÁΩÆÁîüÊàêÊ†áÂøó\n          isGenerating = true;\n\n          // ÂàõÂª∫‰∏Ä‰∏™pendingËΩÆÊ¨°\n          const pendingRound: ConversationRound = {\n            assistantMessage: null,\n            userMessage: null,\n            pending: true,\n            pendingUserMessage: userMessage,\n          };\n\n          // Â∞ÜpendingËΩÆÊ¨°Ê∑ªÂä†Âà∞roundsÊï∞ÁªÑ\n          rounds.push(pendingRound);\n          currentRoundIndex = rounds.length - 1;\n\n          // Á´ãÂç≥ÊòæÁ§∫Ëøô‰∏™ËΩÆÊ¨°\n          displayRound(currentRoundIndex);\n        },\n        onRefreshStory: (options?: string[]) => {\n          // assistant Ê∂àÊÅØÂàõÂª∫ÂêéÔºåËΩ¨‰∏∫ÊúÄÁªàÊ∂àÊÅØ\n          console.log('üìù assistant Ê∂àÊÅØÂ∑≤ÂàõÂª∫ÔºåËΩ¨‰∏∫ÊúÄÁªàÊ∂àÊÅØ');\n\n          if (options && options.length > 0) {\n            latestOptions = options;\n          } else {\n            latestOptions = [];\n          }\n\n          // ‚úÖ Ê†∏ÂøÉÔºöÁõ¥Êé• finalizeÔºå‰∏çÈáçËΩΩÂéÜÂè≤\n          // Â∞ÜÊúÄÂêéÁöÑÊµÅÂºè raw ÊñáÊú¨‰º†ÂÖ• finalizeÔºàÂ¶ÇÊûú‰∏∫Á©∫‰πü‰º† ''Ôºå‰ª•‰øùËØÅ finalize ËÉΩÂ§ÑÁêÜÔºâ\n          finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n\n          // üîï ‰∏çË¶ÅÂÜçË∞ÉÁî® loadChatHistory()\n\n          // ÂÖ∂‰ªñÊ®°ÂùóÊõ¥Êñ∞ÂèØ‰ª•‰øùÁïô\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n            } catch {}\n          }, 200);\n        },\n      });\n\n      if (success) {\n        console.log('‚úÖ Ê∂àÊÅØÁîüÊàêÊàêÂäü');\n        // Ê≥®ÊÑèÔºö‰∏çË¶ÅÂú®ËøôÈáåÂêØÁî®ÊåâÈíÆÔºåÊåâÈíÆÂ∫îËØ•Âú® onRefreshStory ‰∏≠ÂêØÁî®\n        // Âõ†‰∏∫Ê≠§Êó∂ AI ÂèØËÉΩËøòÂú®ÊµÅÂºèËæìÂá∫\n      }\n    } catch (error) {\n      console.error('‚ùå ÂèëÈÄÅÊ∂àÊÅØÂºÇÂ∏∏:', error);\n      hideGenerating();\n      isGenerating = false;\n      // ÂèëÁîüÈîôËØØÊó∂ÔºåÁ´ãÂç≥ÂêØÁî®ÊåâÈíÆÂíåËæìÂÖ•Ê°Ü\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      isSending = false;\n    }\n    // Ê≥®ÊÑèÔºöÁßªÈô§‰∫Ü finally ÂùóÔºåÂõ†‰∏∫ÊåâÈíÆÂ∫îËØ•Âú® onRefreshStory ‰∏≠ÂêØÁî®\n    // ËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùÂú® AI ÂÆåÂÖ®ÁîüÊàêÂÆåÊàêÂêéÊâçÂêØÁî®ÊåâÈíÆ\n  }\n\n  // ÊòæÁ§∫ÁîüÊàêÊèêÁ§∫\n  function showGenerating() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant message-streaming';\n      streamingElement.innerHTML = `\n        <div class=\"message-role\">AI</div>\n        <div class=\"message-content message-content-three-columns\"></div>\n        <div class=\"message-time\">ÁîüÊàê‰∏≠</div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // ÊòæÁ§∫Á≠âÂæÖÈÄâÊã©ÊèêÁ§∫ÔºàÂΩìËΩÆÊ¨°Ê≤°ÊúâassistantÊ∂àÊÅØ‰∏î‰∏çÂú®ÁîüÊàêÊó∂Ôºâ\n  function showWaitingMessage() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant';\n      streamingElement.innerHTML = `\n        <div class=\"message-role\">AI</div>\n        <div class=\"message-content message-content-three-columns\">\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">Êñ∞ÂâßÊÉÖ</div>\n            <div class=\"message-column-content\">Á≠âÂæÖÈÄâÊã©„ÄÇ</div>\n          </div>\n        </div>\n        <div class=\"message-time\"></div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // ÈöêËóèÁîüÊàêÊèêÁ§∫\n  function hideGenerating() {\n    if (streamingElement) {\n      streamingElement.remove();\n      streamingElement = null;\n    }\n  }\n\n  // Êèê‰∫§ÊµÅÂºè‰∏∫Ê≠£ÂºèÊ∂àÊÅØÔºàÈÅøÂÖçÂÖ®ÈáèÈáçÊ∏≤ÊüìÔºâ\n  async function finalizeStreamingAsAssistant(finalText: string) {\n    // Âç≥‰Ωø streamingElement ‰∏çÂ≠òÂú®Ôºå‰πüÂ∫îËØ•Êää rounds Ë°•ÂÖ®ÔºàÈò≤Ê≠¢ raceÔºâ\n    // ÂÖàÊääÊµÅÂºè DOM Êõ¥Êñ∞‰∏∫ÊúÄÁªàÂÜÖÂÆπÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ\n    if (streamingElement) {\n      try {\n        // Â¶ÇÊûúÊúâ‰∏âÊ†èÂÆπÂô®ÔºåÂ∞±Áî®Áé∞ÊúâËß£ÊûêÂáΩÊï∞Êää finalText Â°´ËøõÂéª\n        let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) {\n          // Â¶ÇÊûúÊ≤°Êúâ‰∏âÊ†èÂÆπÂô®ÔºåÂ∞ùËØïÂàõÂª∫‰∏Ä‰∏™ÂÆπÂô®‰ª•‰æø updateColumnsFromStream ‰ΩøÁî®\n          streamingElement.innerHTML = `\n            <div class=\"message-role\">AI</div>\n            <div class=\"message-content message-content-three-columns\"></div>\n            <div class=\"message-time\"></div>\n          `;\n          columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        }\n\n        // ‰ΩøÁî®Â∑≤ÊúâÁöÑËß£ÊûêÈÄªËæëÊää finalText Ê∏≤ÊüìÂà∞Ê†èÁõÆÈáåÔºà‰øùËØÅÊúÄÁªàËßÜÂõæÂÆåÊï¥Ôºâ\n        await updateColumnsFromStream(finalText, columnsContainer);\n      } catch (err) {\n        // Ëß£ÊûêÂ§±Ë¥•Êó∂ÂõûÈÄÄ‰∏∫ÂçïÊ†èÊñáÊú¨\n        console.error('‚ùå finalize Êõ¥Êñ∞ÊµÅÂºè DOM Â§±Ë¥•ÔºåÂõûÈÄÄ‰∏∫ÂçïÊ†è:', err);\n        if (streamingElement) {\n          streamingElement.innerHTML = `\n            <div class=\"message-role\">AI</div>\n            <div class=\"message-content\">${escapeHtml(finalText)}</div>\n            <div class=\"message-time\"></div>\n          `;\n        }\n      }\n\n      // ÁßªÈô§ÊµÅÂºèÊ†∑ÂºèÔºàÂèò‰∏∫Ê≠£ÂºèÊ∂àÊÅØÔºâ\n      streamingElement.classList.remove('message-streaming');\n      const timeEl = streamingElement.querySelector('.message-time');\n      if (timeEl) timeEl.textContent = '';\n    }\n\n    // ÂÖ≥ÈîÆÔºöÁ´ãÂç≥Êää rounds Ë°•ÂÖ®‰∏∫Ê≠£ÂºèÊ∂àÊÅØÔºå‰ΩøÁî® finalTextÔºà‰∏ç‰æùËµñÂêéÁ´ØÔºâ\n    if (currentRoundIndex >= 0 && currentRoundIndex < rounds.length) {\n      const currentRound = rounds[currentRoundIndex];\n      if (currentRound && currentRound.pending) {\n        // Â¶ÇÊûú pendingÔºåÂàôÁõ¥Êé•Áî® finalText Â°´ÂÖÖ assistantMessage\n        currentRound.assistantMessage = {\n          // ‰∏¥Êó∂ idÔºåÂêéÈù¢ÂèØ‰ª•ÂºÇÊ≠•Áî®ÁúüÂÆû id Ë¶ÜÁõñ\n          message_id: Date.now(),\n          message: finalText || (streamingElement ? streamingElement.textContent || '' : ''),\n        };\n\n        // Â¶ÇÊûúÊúâ pendingUserMessage -> Â∞ÜÂÖ∂ËΩ¨‰∏∫ userMessageÔºà‰∏¥Êó∂ idÔºâ\n        if (currentRound.pendingUserMessage) {\n          currentRound.userMessage = {\n            message_id: Date.now() - 1,\n            message: currentRound.pendingUserMessage,\n          };\n        }\n\n        currentRound.pending = false;\n        delete currentRound.pendingUserMessage;\n      }\n    }\n\n    // ‰ΩøÁî® rounds ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçËΩÆÔºàÁ°Æ‰øù DOM ‰∏é rounds ÂêåÊ≠•Ôºâ\n    // displayRound ‰ºöÊ∏ÖÁ©∫Âπ∂Âü∫‰∫é rounds ÁîüÊàêÊ≠£ÂºèÁöÑ DOM\n    try {\n      await displayRound(currentRoundIndex);\n    } catch (err) {\n      console.error('‚ùå finalize Âêé displayRound Âá∫Èîô:', err);\n    }\n\n    // Ê∏ÖÁêÜ streamingElement ÁöÑÂºïÁî®ÔºàDOM Â∑≤Áî± displayRound ÈáçÊñ∞Ê∏≤ÊüìÔºâ\n    streamingElement = null;\n  }\n\n  // Êõ¥Êñ∞ÊµÅÂºèÊ∂àÊÅØÔºàÂÆûÊó∂Ê∏≤ÊüìÔºåÊ£ÄÊµãÊ†áÁ≠æÂºÄÂßã/ÁªìÊùüÔºâ\n  async function updateStreamingMessage(text: string) {\n    // ‰øùÂ≠òÊúÄÊñ∞ÊµÅÂºèÊñáÊú¨Ôºå‰æõ finalize ‰ΩøÁî®ÔºàÈÅøÂÖç‰æùËµñÂêéÁ´ØÁ´ãÂç≥ÊåÅ‰πÖÂåñÔºâ\n    lastStreamedRawMessage = text;\n\n    if (!streamingElement) {\n      // Â¶ÇÊûúËøòÊ≤°ÊúâÊµÅÂºèÂÖÉÁ¥†ÔºåÂàõÂª∫‰∏Ä‰∏™\n      showGenerating();\n    }\n\n    if (!streamingElement) return;\n\n    try {\n      // Ëé∑ÂèñÊàñÂàõÂª∫Ê†èÁõÆÂÆπÂô®\n      let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n      if (!columnsContainer) {\n        streamingElement.innerHTML = `\n          <div class=\"message-role\">AI</div>\n          <div class=\"message-content message-content-three-columns\"></div>\n          <div class=\"message-time\">ÁîüÊàê‰∏≠</div>\n        `;\n        columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) return;\n      }\n\n      await updateColumnsFromStream(text, columnsContainer);\n    } catch (error) {\n      console.error('‚ùå Êõ¥Êñ∞ÊµÅÂºèÊ∂àÊÅØÂ§±Ë¥•:', error);\n    }\n  }\n\n  // ‰ªéÊµÅÂºèÊñáÊú¨Êõ¥Êñ∞Ê†èÁõÆÔºàÊ£ÄÊµãÊ†áÁ≠æÂºÄÂßã/ÁªìÊùüÔºåÂä®ÊÄÅÂàõÂª∫Ê†èÁõÆÔºâ\n  async function updateColumnsFromStream(text: string, container: HTMLElement) {\n    // ÂÆö‰πâÊ†èÁõÆÈÖçÁΩÆ\n    const columnConfigs = [\n      { tag: 'continue_choice', header: 'ÈÄâÊã©Âª∂Áª≠', key: 'continue' },\n      { tag: 'result', header: 'ÂêéÊûúÊÄªÁªì', key: 'result' },\n      { tag: 'decision_node', header: 'Êñ∞ÂâßÊÉÖ', key: 'next' },\n    ];\n\n    // Ê£ÄÊµãÊØè‰∏™Ê†áÁ≠æÁöÑÂºÄÂßãÂíåÁªìÊùüÔºåÊèêÂèñÂÜÖÂÆπ\n    for (const config of columnConfigs) {\n      const startTag = `<${config.tag}>`;\n      const endTag = `</${config.tag}>`;\n\n      // Ëé∑ÂèñÊàñÂàõÂª∫Ê†èÁõÆÂÖÉÁ¥†ÔºàÂÖàÊ£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ôºâ\n      let columnElement = container.querySelector(`[data-column-key=\"${config.key}\"]`) as HTMLElement;\n\n      // Ê£ÄÊü•ËØ•Ê†èÁõÆÊòØÂê¶Â∑≤ÁªèÈó≠ÂêàÔºàÂ¶ÇÊûúÂ∑≤Â≠òÂú®‰∏îÂ∑≤Èó≠ÂêàÔºå‰∏çÂÜçÊõ¥Êñ∞Ôºâ\n      if (columnElement) {\n        const isClosed = columnElement.hasAttribute('data-closed');\n        if (isClosed) {\n          // Ê†èÁõÆÂ∑≤Èó≠ÂêàÔºå‰∏çÂÜçÊõ¥Êñ∞\n          continue;\n        }\n      }\n\n      // Ê£ÄÊµãÊòØÂê¶Â∑≤ÁªèÂºÄÂßãÔºàÊúâÂºÄÂßãÊ†áÁ≠æÔºâ\n      const startIndex = text.indexOf(startTag);\n      if (startIndex === -1) {\n        // ËøòÊ≤°ÊúâÂºÄÂßãÊ†áÁ≠æÔºåË∑≥ËøáËøô‰∏™Ê†èÁõÆ\n        continue;\n      }\n\n      // ÊèêÂèñÂºÄÂßãÊ†áÁ≠æ‰πãÂêéÁöÑÂÜÖÂÆπ\n      const contentStart = startIndex + startTag.length;\n      const endIndex = text.indexOf(endTag, contentStart);\n\n      let content = '';\n\n      if (endIndex !== -1) {\n        // ÊúâÁªìÊùüÊ†áÁ≠æÔºåÊèêÂèñÂÆåÊï¥ÂÜÖÂÆπÔºåÂπ∂Ê†áËÆ∞‰∏∫Â∑≤Èó≠Âêà\n        content = text.substring(contentStart, endIndex);\n\n        // Â¶ÇÊûúÊ†èÁõÆÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.textContent = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n\n        // Ê†áËÆ∞‰∏∫Â∑≤Èó≠ÂêàÔºå‰πãÂêé‰∏çÂÜçÊõ¥Êñ∞\n        columnElement.setAttribute('data-closed', 'true');\n      } else {\n        // ËøòÊ≤°ÊúâÁªìÊùüÊ†áÁ≠æÔºåÊèêÂèñÂà∞ÁõÆÂâç‰∏∫Ê≠¢ÁöÑÂÜÖÂÆπ\n        content = text.substring(contentStart);\n\n        // Â¶ÇÊûúÊ†èÁõÆÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂàõÂª∫ÂÆÉ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.textContent = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n      }\n\n      // Êõ¥Êñ∞Ê†èÁõÆÂÜÖÂÆπÔºàÂè™Êõ¥Êñ∞ÊñáÊú¨ÂÜÖÂÆπÔºå‰∏çÊõøÊç¢Êï¥‰∏™ HTMLÔºå‰øùÊåÅÊªöÂä®‰ΩçÁΩÆÔºâ\n      const contentElement = columnElement.querySelector('.message-column-content') as HTMLElement;\n      if (contentElement) {\n        // ‰øùÂ≠òÊªöÂä®Áä∂ÊÄÅ\n        const oldScrollTop = contentElement.scrollTop;\n        const oldScrollHeight = contentElement.scrollHeight;\n        const wasAtBottom = oldScrollTop + contentElement.clientHeight >= oldScrollHeight - 10;\n\n        // Êõ¥Êñ∞ÂÜÖÂÆπ\n        contentElement.textContent = content;\n\n        // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ\n        if (wasAtBottom) {\n          // Â¶ÇÊûú‰πãÂâçÂú®Â∫ïÈÉ®ÔºåÊªöÂä®Âà∞Â∫ïÈÉ®\n          contentElement.scrollTop = contentElement.scrollHeight;\n        } else {\n          // Âê¶Âàô‰øùÊåÅÁõ∏ÂØπ‰ΩçÁΩÆÔºàÂ∞ΩÈáè‰øùÊåÅÂéüÊúâ‰ΩçÁΩÆÔºâ\n          const newScrollHeight = contentElement.scrollHeight;\n          if (newScrollHeight > oldScrollHeight) {\n            // ÂÜÖÂÆπÂ¢ûÂä†‰∫ÜÔºå‰øùÊåÅÁõ∏ÂØπ‰ΩçÁΩÆ\n            contentElement.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);\n          } else {\n            // ÂÜÖÂÆπÂáèÂ∞ë‰∫ÜÊàñ‰∏çÂèòÔºå‰øùÊåÅÂéü‰ΩçÁΩÆ\n            contentElement.scrollTop = oldScrollTop;\n          }\n        }\n      }\n    }\n  }\n\n  // ‰∏ä‰∏ÄËΩÆ\n  function goToPreviousRound() {\n    if (currentRoundIndex > 0) {\n      currentRoundIndex--;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ‰∏ã‰∏ÄËΩÆ\n  function goToNextRound() {\n    if (currentRoundIndex < rounds.length - 1) {\n      currentRoundIndex++;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ========== Option ÈÄâÈ°πÂäüËÉΩ ==========\n  const optionsOverlay = document.getElementById('chat-options-overlay');\n  const optionsContainer = document.getElementById('chat-options-container');\n  const optionsList = document.getElementById('chat-options-list');\n  const showOptionsBtn = document.getElementById('chat-show-options-btn');\n  const closeOptionsBtn = document.getElementById('chat-options-close');\n\n  // ‰ªéÊúÄÊñ∞Ê∂àÊÅØÊèêÂèñÈÄâÈ°πÊï∞ÊçÆ\n  async function getOptionsFromLatestMessage(): Promise<string[]> {\n    try {\n      // ‰ºòÂÖà‰ΩøÁî®‰øùÂ≠òÁöÑÈÄâÈ°πÔºà‰ªé messageGenerator ‰º†ÈÄíÔºâ\n      if (latestOptions.length > 0) {\n        console.log('‚úÖ ‰ΩøÁî®‰øùÂ≠òÁöÑÈÄâÈ°πÔºà‰ªé messageGenerator ‰º†ÈÄíÔºâ');\n        return latestOptions;\n      }\n\n      // Ê¨°‰ºòÂÖàÔºö‰ªé assistant Ê∂àÊÅØÁöÑ data ‰∏≠ËØªÂèñÔºàÊåÅ‰πÖÂåñÈÄâÈ°πÔºâ\n      const messages = getChatMessages(-1, { role: 'assistant' });\n      const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n      if (!lastMessage) {\n        return [];\n      }\n\n      if (lastMessage.data?.__options && lastMessage.data.__options.length > 0) {\n        console.log('‚úÖ ‰ªé assistant.data ËØªÂèñÈÄâÈ°πÔºàÊåÅ‰πÖÂåñÔºâ');\n        return lastMessage.data.__options;\n      }\n\n      // ÈôçÁ∫ßÔºö‰ªéÊ∂àÊÅØ‰∏≠ÊèêÂèñÔºàÂ¶ÇÊûú‰ª•‰∏äÊñπÊ°àÂùá‰∏çÂèØÁî®Ôºâ\n      const { extractAllOptions } = await import('./utils/textParser');\n      const messageContent = lastMessage.message || '';\n      const options = extractAllOptions(messageContent);\n      if (options.length > 0) {\n        console.log('‚úÖ ‰ªéÊ∂àÊÅØ‰∏≠ÊèêÂèñÈÄâÈ°πÔºàÈôçÁ∫ßÊñπÊ°àÔºâ');\n      }\n      return options;\n    } catch (error) {\n      console.error('‚ùå Ëé∑ÂèñÈÄâÈ°πÂ§±Ë¥•:', error);\n      return [];\n    }\n  }\n\n  // ÊòæÁ§∫ÈÄâÈ°πÊµÆÂ±Ç\n  async function showOptionsOverlay() {\n    if (!optionsOverlay || !optionsContainer || !optionsList) {\n      return;\n    }\n\n    const options = await getOptionsFromLatestMessage();\n\n    if (options.length === 0) {\n      // Â¶ÇÊûúoption‰∏∫Á©∫ÔºåÊòæÁ§∫ÊèêÁ§∫\n      showNoOptionsMessage();\n      return;\n    }\n\n    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÈ°π\n    optionsList.innerHTML = '';\n\n    // ÈáçÁΩÆÁä∂ÊÄÅ\n    optionsList.classList.remove('collapse');\n\n    // ËÆæÁΩÆÈÄâÈ°πÂàóË°®‰∏∫ÂÖ®Â±èÂÆö‰ΩçÂÆπÂô®\n    optionsList.style.position = 'absolute';\n    optionsList.style.top = '0';\n    optionsList.style.left = '0';\n    optionsList.style.right = '0';\n    optionsList.style.bottom = '0';\n    optionsList.style.width = '100%';\n    optionsList.style.height = '100%';\n    optionsList.style.pointerEvents = 'none'; // ÂÖÅËÆ∏ÁÇπÂáªÁ©øÈÄèÂà∞Ê∞îÊ≥°\n\n    // Ëé∑Âèñ overlay ÁöÑÂ∞∫ÂØ∏ÔºåÁî®‰∫éËÆ°ÁÆóÈöèÊú∫‰ΩçÁΩÆ\n    if (!optionsOverlay) return;\n\n    // Â≠òÂÇ®Â∑≤‰ΩøÁî®ÁöÑ‰ΩçÁΩÆÔºåÈÅøÂÖçÈáçÂè†\n    const usedPositions: Array<{ x: number; y: number }> = [];\n    const minDistance = 150; // ÊúÄÂ∞èÈó¥Ë∑ùÔºàÂÉèÁ¥†Ôºâ\n\n    // ÁîüÊàêÈöèÊú∫‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çÈáçÂè†‰∏î‰∏çÈù†ËæπÁºò\n    function generateRandomPosition(): { x: number; y: number } {\n      const maxAttempts = 50;\n      let attempts = 0;\n      const margin = 0.15; // ËæπÁºòËæπË∑ùÔºà15%Ôºâ\n\n      while (attempts < maxAttempts) {\n        // ÈöèÊú∫‰ΩçÁΩÆÔºå‰ΩÜÁïôÂá∫ËæπÁºòÁ©∫Èó¥\n        const x = margin + Math.random() * (1 - 2 * margin);\n        const y = margin + Math.random() * (1 - 2 * margin);\n\n        // Ê£ÄÊü•ÊòØÂê¶‰∏éÂ∑≤Êúâ‰ΩçÁΩÆÂ§™Ëøë\n        const tooClose = usedPositions.some(pos => {\n          const overlayWidth = optionsOverlay!.clientWidth;\n          const overlayHeight = optionsOverlay!.clientHeight;\n          const dx = (x - pos.x) * overlayWidth;\n          const dy = (y - pos.y) * overlayHeight;\n          const distance = Math.sqrt(dx * dx + dy * dy);\n          return distance < minDistance;\n        });\n\n        if (!tooClose) {\n          usedPositions.push({ x, y });\n          return { x, y };\n        }\n\n        attempts++;\n      }\n\n      // Â¶ÇÊûúÊó†Ê≥ïÊâæÂà∞‰∏çÈáçÂè†ÁöÑ‰ΩçÁΩÆÔºå‰ΩøÁî®ÈöèÊú∫‰ΩçÁΩÆÔºà‰ΩÜ‰ªçÊúâËæπË∑ùÔºâ\n      const x = margin + Math.random() * (1 - 2 * margin);\n      const y = margin + Math.random() * (1 - 2 * margin);\n      usedPositions.push({ x, y });\n      return { x, y };\n    }\n\n    // Ê∏≤ÊüìÊØè‰∏™ÈÄâÈ°π‰∏∫ÂúÜÂΩ¢Ê∞îÊ≥°ÔºåÈöèÊú∫‰ΩçÁΩÆ\n    options.forEach((optionText, index) => {\n      // ÂèØ‰ª•ÂêåÊó∂ÊµÆÁé∞Â§ö‰∏™ÈÄâÈ°πÔºàÂèØÈÄâÂäüËÉΩÔºâ\n      const delay = index * 80; // ÂáèÂ∞ëÂª∂ËøüÔºåËÆ©ÈÄâÈ°πÊõ¥Âø´ÊµÆÁé∞\n\n      setTimeout(() => {\n        // STEP 1: ÂàõÂª∫ÂÆπÂô® + Ê∞îÊ≥°ÁªìÊûÑ\n        const chatOption = document.createElement('div');\n        chatOption.className = 'chat-option';\n\n        const optionButton = document.createElement('button');\n        optionButton.type = 'button';\n        optionButton.className = 'chat-option-button';\n\n        const optionTextSpan = document.createElement('span');\n        optionTextSpan.className = 'chat-option-text';\n        optionTextSpan.textContent = optionText;\n        optionButton.title = optionText;\n\n        optionButton.appendChild(optionTextSpan);\n        chatOption.appendChild(optionButton);\n\n        // ÁîüÊàêÈöèÊú∫‰ΩçÁΩÆ\n        const position = generateRandomPosition();\n        const rotate = (Math.random() - 0.5) * 30; // -15 Âà∞ 15 Â∫¶ÈöèÊú∫ÊóãËΩ¨\n\n        chatOption.style.setProperty('--rot', `${rotate}deg`);\n        chatOption.style.left = `${position.x * 100}%`;\n        chatOption.style.top = `${position.y * 100}%`;\n        chatOption.style.position = 'absolute';\n        chatOption.style.pointerEvents = 'auto'; // Ê∞îÊ≥°Êú¨Ë∫´ÂèØÁÇπÂáª\n\n        // ÊÄùÁª¥ÊùÉÈáçÔºàË∂äÈù†ÂâçË∂ä\"Ê∏ÖÊô∞\"Ôºâ\n        const weight = options.length - index;\n        optionButton.style.opacity = `${0.45 + weight * 0.1}`;\n\n        // ÁÇπÂáªÔºöÊÄùÁª¥ÂùçÁº©\n        optionButton.addEventListener('click', () => {\n          optionButton.classList.add('selected');\n          chatOption.classList.add('selected-parent');\n          optionsList.classList.add('collapse');\n\n          setTimeout(() => {\n            chatInput.value = optionText;\n            adjustInputHeight();\n            sendMessage();\n            hideOptionsOverlay();\n          }, 220);\n        });\n\n        optionsList.appendChild(chatOption);\n\n        // Ëß¶Âèë\"ÂøµÂ§¥ÊàêÂΩ¢\"Âä®Áîª\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            chatOption.classList.add('show');\n          });\n        });\n      }, delay);\n    });\n\n    optionsOverlay.classList.add('active');\n    console.log(`‚úÖ Â∑≤ÊòæÁ§∫ ${options.length} ‰∏™ÈÄâÈ°π`);\n  }\n\n  // ÊòæÁ§∫Êó†ÈÄâÈ°πÊèêÁ§∫\n  function showNoOptionsMessage() {\n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'chat-no-options-message';\n    messageDiv.innerHTML = `\n      <div class=\"chat-no-options-content\">\n        <div class=\"chat-no-options-text\">ÂÅöÂÜ≥ÂÆöÂêß qwq</div>\n        <button type=\"button\" class=\"chat-no-options-close\" title=\"ÂÖ≥Èó≠\">√ó</button>\n      </div>\n    `;\n\n    const closeBtn = messageDiv.querySelector('.chat-no-options-close');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        hideOptionsOverlay();\n      });\n    }\n\n    // Ê∑ªÂä†Âà∞ÈÄâÈ°πÂàóË°®ÂÆπÂô®‰∏≠\n    if (optionsList) {\n      optionsList.innerHTML = '';\n      // ÈáçÁΩÆÊ†∑ÂºèÔºåÁ°Æ‰øùÊó†ÈÄâÈ°πÊ∂àÊÅØÊ≠£Â∏∏ÊòæÁ§∫\n      optionsList.style.position = 'absolute';\n      optionsList.style.top = '50%';\n      optionsList.style.left = '50%';\n      optionsList.style.transform = 'translate(-50%, -50%)';\n      optionsList.style.width = 'auto';\n      optionsList.style.height = 'auto';\n      optionsList.style.pointerEvents = 'auto';\n      optionsList.classList.remove('collapse');\n      optionsList.appendChild(messageDiv);\n    }\n\n    // ÊòæÁ§∫ÊµÆÂ±Ç\n    if (optionsOverlay) {\n      optionsOverlay.classList.add('active');\n    }\n  }\n\n  // ÈöêËóèÈÄâÈ°πÊµÆÂ±Ç\n  function hideOptionsOverlay() {\n    if (optionsOverlay) {\n      optionsOverlay.classList.remove('active');\n    }\n    // ÈáçÁΩÆ collapse Áä∂ÊÄÅÔºå‰ª•‰æø‰∏ãÊ¨°ÊâìÂºÄÊó∂ËÉΩÊ≠£Â∏∏ÊòæÁ§∫\n    if (optionsList) {\n      optionsList.classList.remove('collapse');\n    }\n  }\n\n  // ÁªëÂÆöÈÄâÈ°πÁõ∏ÂÖ≥‰∫ã‰ª∂\n  if (showOptionsBtn) {\n    showOptionsBtn.addEventListener('click', showOptionsOverlay);\n  }\n\n  if (closeOptionsBtn) {\n    closeOptionsBtn.addEventListener('click', hideOptionsOverlay);\n  }\n\n  if (optionsOverlay) {\n    optionsOverlay.addEventListener('click', e => {\n      if (e.target === optionsOverlay) {\n        hideOptionsOverlay();\n      }\n    });\n  }\n\n  // ÁªëÂÆöÂèëÈÄÅÊåâÈíÆ‰∫ã‰ª∂\n  chatSendBtn.addEventListener('click', sendMessage);\n\n  // ÁªëÂÆö Enter ÈîÆÂèëÈÄÅÔºàShift+Enter Êç¢Ë°åÔºâ\n  chatInput.addEventListener('keydown', e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n\n  // ËÆæÁΩÆÈîÆÁõòÂØºËà™\n  setupKeyboardNavigation();\n\n  // ËÆæÁΩÆÊ®°ÂùóÂàáÊç¢ÁõëÂê¨\n  function setupModuleSwitchListener() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const observer = new MutationObserver(() => {\n      if (communicationModule.classList.contains('active')) {\n        console.log('üì° ÈÄöËÆØÊ®°ÂùóÂ∑≤ÊøÄÊ¥ªÔºåÂà∑Êñ∞ÊòæÁ§∫');\n        refreshDisplay();\n      }\n    });\n\n    observer.observe(communicationModule, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // ÂàùÂßãÂåñÊó∂Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ\n  loadChatHistory();\n\n  // ËÆæÁΩÆÊ®°ÂùóÂàáÊç¢ÁõëÂê¨\n  setupModuleSwitchListener();\n}\n","// Èîö - ‰∏ªÈÄªËæë\nimport { PageManager } from './utils/pageManager';\nimport { initNavigation, initModals, initAnimations, initStatusCardInteractions, initChatInterface } from './dashboardLogic';\n\nlet pageManager: PageManager | null = null;\n\n/**\n * ÂàùÂßãÂåñÂ∫îÁî®\n */\nfunction initApp() {\n  const appContainer = document.getElementById('app');\n  if (!appContainer) {\n    console.error('Êú™ÊâæÂà∞ #app ÂÆπÂô®');\n    return;\n  }\n\n  // ÂàùÂßãÂåñÈ°µÈù¢ÁÆ°ÁêÜÂô®\n  pageManager = new PageManager(appContainer);\n  pageManager.initialize();\n\n  // ÁõëÂê¨È°µÈù¢ÂàáÊç¢ÔºåÂΩìËøõÂÖ•Ê∏∏ÊàèÈ°µÈù¢Êó∂ÂàùÂßãÂåñÂäüËÉΩ\n  const mainScreen = document.getElementById('main-screen');\n  if (mainScreen) {\n    const observer = new MutationObserver(() => {\n      if (mainScreen.classList.contains('active')) {\n        // Âª∂ËøüÂàùÂßãÂåñÔºåÁ°Æ‰øùDOMÂ∑≤ÂÆåÂÖ®Ê∏≤Êüì\n        setTimeout(() => {\n          initDashboardFeatures();\n        }, 100);\n      }\n    });\n\n    observer.observe(mainScreen, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // ÁõëÂê¨ÈÖíÈ¶ÜÊ∂àÊÅØÊõ¥Êñ∞‰∫ã‰ª∂\n  eventOn(tavern_events.MESSAGE_UPDATED, () => {\n    if (pageManager) {\n      const dashboard = pageManager.getDashboard();\n      // Âà∑Êñ∞Ê∏∏ÊàèÊï∞ÊçÆ\n      // ËøôÈáåÂèØ‰ª•‰ªéÂèòÈáèÁ≥ªÁªüËØªÂèñÊúÄÊñ∞Êï∞ÊçÆÂπ∂Êõ¥Êñ∞\n      console.info('Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºåÂà∑Êñ∞Ê∏∏ÊàèÊï∞ÊçÆ');\n    }\n  });\n}\n\n/**\n * ÂàùÂßãÂåñ‰∏ªÊ∏∏ÊàèÁïåÈù¢ÂäüËÉΩ\n */\nfunction initDashboardFeatures() {\n  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂàùÂßãÂåñËøá\n  if (document.querySelector('.nav-item[data-module=\"status\"]')?.hasAttribute('data-initialized')) {\n    return;\n  }\n\n  initNavigation();\n  initModals();\n  initAnimations();\n  initStatusCardInteractions();\n  initChatInterface();\n\n  // Ê†áËÆ∞Â∑≤ÂàùÂßãÂåñ\n  document.querySelectorAll('.nav-item').forEach(item => {\n    item.setAttribute('data-initialized', 'true');\n  });\n\n  console.info('‰∏ªÊ∏∏ÊàèÁïåÈù¢ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');\n}\n\n// ‰ΩøÁî® jQuery Âú®Âä†ËΩΩÊó∂ÊâßË°åÂàùÂßãÂåñÔºàÁ¨¶ÂêàÈ°πÁõÆËßÑËåÉÔºâ\n$(() => {\n  errorCatched(initApp)();\n});\n\n// Âú®ÁïåÈù¢Âç∏ËΩΩÊó∂ÊâßË°åÊ∏ÖÁêÜ\n$(window).on('pagehide', () => {\n  console.info('ÈîöÁïåÈù¢Â∑≤Âç∏ËΩΩ');\n  if (pageManager) {\n    // ÂèØ‰ª•Âú®ËøôÈáåÊ∏ÖÁêÜËµÑÊ∫ê\n  }\n});\n","// ÂØºÂÖ•Ê†∑Âºè\nimport './styles.css';\n\n// ÂàùÂßãÂåñÂáΩÊï∞\nfunction init() {\n  // Ê∑ªÂä† FontAwesome CSS\n  if (!document.querySelector('link[href*=\"font-awesome\"]')) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';\n    document.head.appendChild(link);\n  }\n\n  // Ê∑ªÂä† meta Ê†áÁ≠æ\n  if (!document.querySelector('meta[charset]')) {\n    const charset = document.createElement('meta');\n    charset.setAttribute('charset', 'UTF-8');\n    document.head.appendChild(charset);\n  }\n\n  if (!document.querySelector('meta[name=\"viewport\"]')) {\n    const viewport = document.createElement('meta');\n    viewport.setAttribute('name', 'viewport');\n    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');\n    document.head.appendChild(viewport);\n  }\n\n  // ËÆæÁΩÆÊ†áÈ¢ò\n  document.title = 'Èîö';\n\n  // Ê∑ªÂä†ÊèèËø∞\n  if (!document.querySelector('meta[name=\"description\"]')) {\n    const description = document.createElement('meta');\n    description.setAttribute('name', 'description');\n    description.setAttribute('content', 'Èîö - Ëà∞‰ΩìÁîüÂ≠òÁªèËê•Ê∏∏Êàè - ÁÆ°ÁêÜ‰ªªÂä°„ÄÅËÆ∞ÂΩïÊó•Âøó„ÄÅÂ§ÑÁêÜÈÄöËÆØ„ÄÅÁõëÊéßËà∞‰ΩìÁä∂ÊÄÅ');\n    document.head.appendChild(description);\n  }\n}\n\n// ‰ΩøÁî® jQuery Âú®Âä†ËΩΩÊó∂ÊâßË°åÂàùÂßãÂåñÔºàÁ¨¶ÂêàÈ°πÁõÆËßÑËåÉÔºâ\n$(() => {\n  init();\n  console.info('ÈîöÁïåÈù¢Â∑≤Âä†ËΩΩ');\n});\n\n// Âú®ÁïåÈù¢Âç∏ËΩΩÊó∂ÊâßË°åÊ∏ÖÁêÜ\n$(window).on('pagehide', () => {\n  console.info('ÈîöÁïåÈù¢Â∑≤Âç∏ËΩΩ');\n});\n\n// ÂØºÂÖ•Â∫îÁî®ÈÄªËæë\nimport './app';\n"],"names":["removeThinkingTags","text","result","lastResult","replace","removeThinkingTagsFromStream","cleaned","lastThinkingStart","lastIndexOf","substring","trim","extractLastMaintext","matches","match","length","contentMatch","extractContinueChoice","extractResult","extractNextChoice","extractLastOption","extractAllOptions","suboptionMatches","options","forEach","content","push","optionMatches","lines","split","map","line","filter","extractLastSum","extractLastUpdateVariable","console","log","validateMessage","messageContent","maintext","option","warn","async","generateMessage","userInput","callbacks","userMessageId","onShowGenerating","mvu_data","waitGlobalInitialized","base","Mvu","getMvuData","type","message_id","stat_data","display_data","delta_data","error","getBaseMvuData","createChatMessages","role","message","data","refresh","getLastMessageId","checkAndRefresh","retries","checkMessageId","messages","getChatMessages","onRefreshStoryIfOpen","setTimeout","createError","Error","String","streamingHandler","eventOn","iframe_events","STREAM_TOKEN_RECEIVED_FULLY","fullText","cleanedText","onStreamingUpdate","generate","window","generatePromise","should_stream","timeoutPromise","Promise","_","reject","race","generateError","errorType","errorMessage","errorStack","stack","undefined","includes","cleanedResult","deleteChatMessages","onHideGenerating","onError","sum","updateVariable","finalMessage","userMessage","finalData","parseMessage","parsed","extractedOptions","maintextContent","messageToSave","__options","assistantMessageId","onRefreshStory","deleteError","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","module","__webpack_modules__","hasSaveData","lastMessageId","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","SplashScreen","element","constructor","this","createElement","div","document","className","id","innerHTML","getHTML","bindEvents","updateContinueButton","show","classList","add","hide","remove","destroy","$","off","keyDownHandler","removeEventListener","continueButton","querySelector","style","display","newGameButton","addEventListener","onNewGame","onContinue","fullscreenButton","requestFullscreen","e","contains","preventDefault","documentElement","catch","err","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","NewGameSetup","reserveInput","config","getConfig","reserve","updateMvuVariable","confirmButton","inputValue","value","toastr","parseInt","isNaN","Number","isInteger","onConfirm","cancelButton","onCancel","replaceMvuData","currentMvuData","updatedStatData","system_state","antimatter","Math","max","min","updatedMvuData","info","Dashboard","gameData","loadedMessageIds","Set","refreshData","fallbackDiv","updateGameData","updateStatusCards","updateTasksList","updateDiaryList","loadMaintextFromChat","statusGrid","systemState","assistantMessages","latestAssistant","mvuData","cycle","leak_risk","population","active","standby","archived","system_pressure","instability","cards","leakRisk","reservePercent","round","riskLevel","toLocaleString","toFixed","pop","total","pressure","pressurePercent","pressureLevel","instabilityPercent","instabilityLevel","join","tasksList","tasks","Array","isArray","getDefaultTasks","task","getTaskIcon","status","escapeHtml","title","getStatusText","time","priority","getPriorityText","description","diaryList","diary","getDefaultDiary","entry","date","updateChatMessages","getDefaultMessages","textContent","parseMaintext","maintextMatch","lastMessage","has","then","continueChoice","nextChoice","continueChoiceArea","resultArea","nextChoiceArea","setupMessageListener","tavern_events","handleMessageReceived","MESSAGE_RECEIVED","CHAT_CHANGED","toggleFullscreen","setupEnterKeyFullscreen","activeElement","tagName","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","fullscreenElement","initializeGameData","currentStatData","clampedReserve","updateMvuVariables","station_name","difficulty","resources","energy","supplies","crew","life_support","system","personnel","communication","laboratory","storage","computing","currentData","getVariables","updatedData","game_data","replaceVariables","game_config","updateGameConfig","PageManager","currentPage","splashScreen","setupScreen","dashboard","appContainer","onStart","goToSplash","goToSetup","goToGame","handleConfirm","onFullscreenToggle","initialize","appendChild","showPage","page","dashboardElement","getElementById","variables","continueGame","fallbackError","initializeNewGame","success","getDashboard","initChatInterface","chatInput","chatSendBtn","chatMessages","rounds","currentRoundIndex","streamingElement","lastStreamedRawMessage","isGenerating","isSending","latestOptions","generateMessagePromise","adjustInputHeight","height","newHeight","scrollHeight","displayRound","roundIndex","from","children","child","msg","renderUserMessage","pendingUserMessage","assistantMessage","rawMessage","messageItem","searchText","columns","header","columnsHtml","col","renderAssistantMessage","pending","showGenerating","parentNode","loadChatHistory","newRounds","allMessages","pendingRound","index","groupMessagesIntoRounds","sendMessage","disabled","hideGenerating","columnsContainer","updateColumnsFromStream","updateStreamingMessage","finalText","timeEl","currentRound","Date","now","finalizeStreamingAsAssistant","dispatchEvent","CustomEvent","container","columnConfigs","tag","startTag","endTag","columnElement","hasAttribute","startIndex","indexOf","contentStart","endIndex","setAttribute","headerElement","contentElement","oldScrollTop","scrollTop","oldScrollHeight","wasAtBottom","clientHeight","newScrollHeight","optionsOverlay","optionsContainer","optionsList","showOptionsBtn","closeOptionsBtn","hideOptionsOverlay","getOptionsFromLatestMessage","messageDiv","closeBtn","position","top","left","transform","width","pointerEvents","showNoOptionsMessage","right","bottom","usedPositions","optionText","chatOption","optionButton","optionTextSpan","attempts","margin","x","random","y","some","pos","overlayWidth","clientWidth","overlayHeight","dx","dy","sqrt","generateRandomPosition","rotate","setProperty","weight","opacity","requestAnimationFrame","target","shiftKey","communicationModule","setupKeyboardNavigation","MutationObserver","refreshDisplay","observe","attributes","attributeFilter","setupModuleSwitchListener","pageManager","initApp","mainScreen","navItems","querySelectorAll","modules","switchModule","nav","targetNavItem","targetModule","item","getAttribute","moduleMap","isContentEditable","initNavigation","modalOverlay","modalClose","initModals","card","initDashboardFeatures","MESSAGE_UPDATED","errorCatched","on","link","rel","href","head","charset","viewport","init"],"ignoreList":[],"sourceRoot":""}