{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/anchor/utils/messageGenerator.ts","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/anchor/utils/variableUpdater.ts","src://tavern_helper_template/src/anchor/utils/textParser.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/anchor/utils/variableReader.ts","src://tavern_helper_template/src/anchor/components/SplashScreen.ts","src://tavern_helper_template/src/anchor/components/NewGameSetup.ts","src://tavern_helper_template/external var \"showdown\"","src://tavern_helper_template/external var \"YAML\"","src://tavern_helper_template/src/anchor/components/Dashboard.ts","src://tavern_helper_template/src/anchor/utils/pageManager.ts","src://tavern_helper_template/src/anchor/utils/gameInitializer.ts","src://tavern_helper_template/src/anchor/dashboardLogic.ts","src://tavern_helper_template/src/anchor/app.ts","src://tavern_helper_template/src/anchor/index.ts"],"sourcesContent":["/**\n * \n *  ->  user  ->  LLM ->  ->  assistant \n */\n\n// \ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function createChatMessages(\n  messages: Array<{ role: 'user' | 'assistant' | 'system'; message: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function generate(config: { user_input?: string; should_stream?: boolean }): Promise<string>;\n\n//  generate \nfunction checkGenerateAvailable(): boolean {\n  if (typeof generate === 'undefined') {\n    //  window \n    if (typeof window !== 'undefined' && (window as any).generate) {\n      return true;\n    }\n    return false;\n  }\n  return true;\n}\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const iframe_events: {\n  STREAM_TOKEN_RECEIVED_FULLY: 'js_stream_token_received_fully';\n  GENERATION_ENDED: 'js_generation_ended';\n};\n\n// MVU \ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  parseMessage?: (message: string, old_data: any) => Promise<any | undefined>;\n};\n\nimport _ from 'lodash';\nimport {\n  extractAllOptions,\n  extractLastMaintext,\n  extractLastOption,\n  extractLastSum,\n  extractLastUpdateVariable,\n  removeOptionTags,\n  removeSuboptionTags,\n  removeThinkingTags,\n  removeThinkingTagsFromStream,\n  validateMessage,\n} from './textParser';\n\n//  setChatMessages\ndeclare function setChatMessages(\n  chat_messages: Array<{ message_id: number; message?: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\n/**\n *  data \n */\nasync function cleanOpeningMessage(): Promise<void> {\n  try {\n    const messages = getChatMessages(0);\n    if (!messages || messages.length === 0) return;\n\n    const openingMsg = messages[0];\n    if (openingMsg.role !== 'assistant') return;\n\n    const hasOptions = openingMsg.message.includes('<option>') || openingMsg.message.includes('<suboption>');\n    if (!hasOptions) return;\n\n    console.log(' ...');\n\n    // 1. \n    const options = extractAllOptions(openingMsg.message);\n\n    // 2. \n    let cleanedMessage = removeOptionTags(openingMsg.message);\n    cleanedMessage = removeSuboptionTags(cleanedMessage);\n\n    // 3. \n    await setChatMessages(\n      [\n        {\n          message_id: 0,\n          message: cleanedMessage,\n          data: {\n            ...(openingMsg.data || {}),\n            __options: options,\n          },\n        },\n      ],\n      { refresh: 'none' },\n    );\n\n    console.log('  data.__options');\n  } catch (error) {\n    console.warn(' :', error);\n  }\n}\n\n/**\n *  MVU \n */\nasync function getBaseMvuData(): Promise<any> {\n  try {\n    //  MVU \n    await waitGlobalInitialized('Mvu');\n\n    //  init(0) / latest message / chatchat  base\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    try {\n      chatData = Mvu.getMvuData({ type: 'chat' });\n    } catch {\n      // ignore\n    }\n\n    const base = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    console.log('  MVU(merged) ');\n\n    // \n    return (\n      base ?? {\n        stat_data: {},\n        display_data: {},\n        delta_data: {},\n      }\n    );\n  } catch (error) {\n    console.warn('  MVU :', error);\n    //  MVU  MVU \n    return {\n      stat_data: {},\n      display_data: {},\n      delta_data: {},\n    };\n  }\n}\n\n/**\n * \n */\nexport interface MessageGeneratorCallbacks {\n  onShowGenerating?: () => void; // \n  onHideGenerating?: () => void; // \n  onError?: (error: string) => void; // \n  onStreamingUpdate?: (text: string) => void; //  maintext \n  onRefreshStoryIfOpen?: (userMessage: string) => void; // user\n  onRefreshStory?: (options?: string[]) => void; // assistant\n  onCreatedMessages?: (ids: { userMessageId: number; assistantMessageId: number }) => void; // user+assistant  id\n}\n\n/**\n *  assistant  user \n *  assistant  user  AI \n */\nexport async function regenerateAssistantMessage(\n  userMessageId: number,\n  callbacks: MessageGeneratorCallbacks = {},\n): Promise<boolean> {\n  try {\n    if (callbacks.onShowGenerating) callbacks.onShowGenerating();\n\n    // \n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          callbacks.onStreamingUpdate?.('');\n          return;\n        }\n        callbacks.onStreamingUpdate?.(cleanedText);\n      };\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log(' [regen] ');\n    } else {\n      console.log(' [regen] ');\n    }\n\n    //  generate \n    if (!checkGenerateAvailable()) {\n      throw new Error('generate ');\n    }\n\n    // generate user_input/\n    const generatePromise = generate({ should_stream: true });\n    const timeoutPromise = new Promise<string>((_, reject) => {\n      setTimeout(() => reject(new Error('generate 5')), 5 * 60 * 1000);\n    });\n    const result = await Promise.race([generatePromise, timeoutPromise]);\n\n    const cleanedResult = removeThinkingTags(result);\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('');\n      return false;\n    }\n\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.(' maintext  option');\n      return false;\n    }\n\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) finalMessage += `\\n\\n<sum>${sum}</sum>`;\n    if (updateVariable) finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n\n    // base  userMessage.data regenerate  user \n    let base: any = null;\n    try {\n      const userMsg = getChatMessages(userMessageId)?.[0];\n      if (userMsg?.data) base = userMsg.data;\n    } catch {\n      // ignore\n    }\n    if (!base) {\n      try {\n        base =\n          getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n          Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        base = { stat_data: {}, display_data: {}, delta_data: {} };\n      }\n    }\n\n    if (!base || typeof base !== 'object') base = { stat_data: {}, display_data: {}, delta_data: {} };\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // MVU \n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) finalData = parsed;\n      } catch (e) {\n        console.warn(' [regen] MVU :', e);\n      }\n    }\n\n    const extractedOptions = extractAllOptions(finalMessage);\n\n    //  maintext  sum\n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave,\n          data: {\n            ...finalData,\n            __options: extractedOptions,\n          },\n        },\n      ],\n      { refresh: 'none' },\n    );\n\n    const assistantMessageId = getLastMessageId();\n    console.log(' [regen] assistant ID:', assistantMessageId);\n\n    //  iduserMessageId \n    callbacks.onCreatedMessages?.({ userMessageId, assistantMessageId });\n\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n\n    setTimeout(() => {\n      callbacks.onRefreshStory?.(extractedOptions);\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error(' [regen]  assistant :', error);\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n    callbacks.onError?.(error instanceof Error ? error.message : '');\n    return false;\n  }\n}\n\n/**\n * \n * @param userInput \n * @param callbacks \n */\nexport async function generateMessage(userInput: string, callbacks: MessageGeneratorCallbacks = {}): Promise<boolean> {\n  let userMessageId: number | null = null;\n\n  try {\n    // 0. \n    await cleanOpeningMessage();\n\n    // 1. UI\n    // \n\n    // 2. \"\"\n    if (callbacks.onShowGenerating) {\n      callbacks.onShowGenerating();\n    }\n\n    // 3.  MVU \n    const mvu_data = await getBaseMvuData();\n\n    // 4.  user \n    console.log(' [2]  user ...');\n    console.log(' [2] :', userInput);\n    console.log(' [2] MVU :', mvu_data ? '' : '');\n\n    try {\n      await createChatMessages(\n        [\n          {\n            role: 'user',\n            message: userInput, //  \n            data: mvu_data, //  MVU \n          },\n        ],\n        {\n          refresh: 'none', // \n        },\n      );\n      console.log(' [2] user ');\n\n      // 9.  user  ID\n      userMessageId = getLastMessageId();\n      console.log(' [2] user ID:', userMessageId);\n\n      //  ID AI  User  ID\n      if (callbacks.onCreatedMessages && userMessageId !== null) {\n        try {\n          callbacks.onCreatedMessages({ userMessageId, assistantMessageId: -1 });\n        } catch (e) {\n          console.warn(' onCreatedMessages (user) :', e);\n        }\n      }\n\n      // 10. mhjg\n      // \n      const checkAndRefresh = async (retries = 5) => {\n        const checkMessageId = getLastMessageId();\n        if (checkMessageId === userMessageId) {\n          // \n          const messages = getChatMessages(checkMessageId);\n          if (messages && messages.length > 0 && messages[0].role === 'user') {\n            if (callbacks.onRefreshStoryIfOpen) {\n              callbacks.onRefreshStoryIfOpen(messages[0].message);\n              console.log(' [2] ID:', userMessageId);\n            }\n            return;\n          }\n        }\n\n        // \n        if (retries > 0) {\n          setTimeout(() => checkAndRefresh(retries - 1), 50);\n        } else if (callbacks.onRefreshStoryIfOpen) {\n          // \n          callbacks.onRefreshStoryIfOpen(userInput);\n          console.log(' [2] ');\n        }\n      };\n\n      setTimeout(() => checkAndRefresh(), 50);\n    } catch (createError) {\n      console.error(' [2] createChatMessages :', createError);\n      throw new Error(\n        ` user : ${createError instanceof Error ? createError.message : String(createError)}`,\n      );\n    }\n\n    // 5.  generate \n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        //  <thinking> \n        const cleanedText = removeThinkingTagsFromStream(fullText);\n\n        //  thinking \n        if (!cleanedText || cleanedText.trim().length === 0) {\n          if (callbacks.onStreamingUpdate) {\n            callbacks.onStreamingUpdate('');\n          }\n          return;\n        }\n\n        //  cleanedText/\n        if (callbacks.onStreamingUpdate) {\n          callbacks.onStreamingUpdate(cleanedText);\n        }\n      };\n\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log(' [3] ');\n    } else {\n      console.log(' [3] ');\n    }\n\n    // 6.  generate  LLM \n    console.log(' [3]  generate ...');\n    console.log(' [3] :', userInput);\n\n    //  generate \n    if (!checkGenerateAvailable()) {\n      console.error(' [3] generate ');\n      console.error(' [3] ');\n      console.error('   1. ');\n      console.error('   2.  iframe ');\n      console.error('   3.  generate ');\n      throw new Error('generate ');\n    }\n\n    let result: string;\n    try {\n      console.log(' [3]  generate...');\n      console.log(' [3] generate :', typeof generate);\n\n      // \n      const generatePromise = generate({\n        // user_input: userInput, // \n        should_stream: true, // \n      });\n\n      // 5\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(\n          () => {\n            reject(new Error('generate 5'));\n          },\n          5 * 60 * 1000,\n        );\n      });\n\n      result = await Promise.race([generatePromise, timeoutPromise]);\n\n      console.log(' [3] generate :', result?.length || 0);\n      if (!result || result.length === 0) {\n        console.warn(' [3] generate ');\n      } else {\n        console.log(' [3] generate :', result.substring(0, 200) + '...');\n      }\n    } catch (generateError) {\n      console.error(' [3] generate :', generateError);\n      console.error(' [3] :', {\n        error: generateError,\n        errorType: typeof generateError,\n        errorMessage: generateError instanceof Error ? generateError.message : String(generateError),\n        errorStack: generateError instanceof Error ? generateError.stack : undefined,\n      });\n\n      // \n      if (generateError instanceof Error && generateError.message.includes('')) {\n        throw new Error('generate  LLM ');\n      }\n\n      throw new Error(\n        `generate : ${generateError instanceof Error ? generateError.message : String(generateError)}`,\n      );\n    }\n\n    // 7.  <thinking> \n    const cleanedResult = removeThinkingTags(result);\n\n    // 8. \n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      console.error(' [4] generate ');\n      // \n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('');\n      }\n      return false;\n    }\n\n    // 12.  <maintext><option><sum>  <UpdateVariable>\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      console.error(' [5]  maintext  option');\n      // \n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError(' maintext  option');\n      }\n      return false;\n    }\n\n    // 13.  maintextoptionsum UpdateVariable\n    //  MVU \n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) {\n      finalMessage += `\\n\\n<sum>${sum}</sum>`;\n      console.log(' [5]  <sum> ');\n    }\n    if (updateVariable) {\n      finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n      console.log(' [5]  <UpdateVariable> ');\n    }\n\n    // 14.  MVU  user \n    console.log(' [6]  MVU ...');\n    let base: any;\n    if (userMessageId !== null) {\n      const userMessage = getChatMessages(userMessageId)?.[0];\n      if (userMessage?.data) {\n        base = userMessage.data;\n        console.log(' [6]  user ');\n      }\n    }\n\n    //  user  data assistant  MVU \n    if (!base) {\n      console.log(' [6]  assistant  MVU ...');\n      base =\n        getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n        Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      console.log(' [6]  assistant  MVU ');\n    }\n\n    //  base \n    if (!base || typeof base !== 'object') {\n      console.log(' [6] base ');\n      base = { stat_data: {}, display_data: {}, delta_data: {} };\n    }\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // 15.  MVU  MVU.parseMessage \n    console.log(' [7]  MVU ...');\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) {\n          finalData = parsed;\n          console.log(' [7] MVU ');\n        } else {\n          console.log(' [7] MVU  undefined');\n        }\n      } catch (error) {\n        console.warn(' [7] MVU :', error);\n      }\n    } else {\n      console.log(' [7] MVU.parseMessage ');\n    }\n\n    // 16.  createChatMessages  finalMessage \n    console.log(' [8] ...');\n    const extractedOptions = extractAllOptions(finalMessage);\n    console.log(' [8] :', extractedOptions.length, '');\n\n    // 17.  assistant  <maintext>  <sum> \n    console.log(' [9]  assistant ...');\n    //  finalMessage  maintext  maintext \n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    if (!maintextContent) {\n      console.warn(' [9]  finalMessage  maintext finalMessage');\n    } else {\n      console.log(' [9]  maintext  maintext  sum ');\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave, //  maintext \n          data: {\n            ...finalData, // \n            __options: extractedOptions, //   data \n          },\n        },\n      ],\n      {\n        refresh: 'none', // \n      },\n    );\n    console.log(' [9] assistant ');\n\n    // 18.  ID\n    const assistantMessageId = getLastMessageId();\n    console.log(' [10]  ID:', assistantMessageId);\n\n    // 18.1  message_id/\n    if (callbacks.onCreatedMessages && userMessageId !== null) {\n      try {\n        callbacks.onCreatedMessages({ userMessageId, assistantMessageId });\n      } catch (e) {\n        console.warn(' onCreatedMessages :', e);\n      }\n    }\n\n    // 19. \n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 20. \n    // \n    setTimeout(() => {\n      if (callbacks.onRefreshStory) {\n        callbacks.onRefreshStory(extractedOptions);\n        console.log(' [11] ');\n      }\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error(' :', error);\n\n    // \n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // \n    if (callbacks.onError) {\n      callbacks.onError(error instanceof Error ? error.message : '');\n    }\n\n    return false;\n  }\n}\n","module.exports = _;","import _ from 'lodash';\nimport { GameConfig, GameData } from '../types/types';\n\n// \ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (\n    mvu_data: any,\n    options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' },\n  ) => Promise<void>;\n};\n\n/**\n *  MVU  MVU \n */\nexport async function updateMvuVariables(config: GameConfig): Promise<void> {\n  try {\n    //  MVU \n    await waitGlobalInitialized('Mvu');\n\n    //  MVU \n    //  chat \n    //  init(0) / latest message  reserve  system_state \n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    chatData = Mvu.getMvuData({ type: 'chat' });\n\n    const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    const currentStatData = currentMvuData?.stat_data || {};\n\n    //  stat_data\n    const updatedStatData = _.cloneDeep(currentStatData);\n\n    //  system_state.antimatter.reserve\n    if (config.reserve !== undefined) {\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      //  reserve  0-100000 \n      const clampedReserve = _.clamp(config.reserve, 0, 100000);\n      updatedStatData.system_state.antimatter.reserve = clampedReserve;\n      console.info(`  system_state.antimatter.reserve: ${clampedReserve}`);\n    }\n\n    //  MVU\n    const updatedMvuData = {\n      ...currentMvuData,\n      stat_data: updatedStatData,\n    };\n\n    await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n    console.info(' MVU ');\n  } catch (error) {\n    console.error('  MVU :', error);\n    throw error;\n  }\n}\n\n/**\n * \n */\nexport async function updateGameData(data: Partial<GameData>): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_data: {\n        ...(currentData.game_data || {}),\n        ...data,\n      },\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('');\n  } catch (error) {\n    console.error(':', error);\n    throw error;\n  }\n}\n\n/**\n * \n */\nexport async function updateGameConfig(config: GameConfig): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_config: config,\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('');\n  } catch (error) {\n    console.error(':', error);\n    throw error;\n  }\n}\n\n/**\n * \n */\nexport async function initializeGameData(config: GameConfig): Promise<GameData> {\n  //  MVU  MVU\n  await updateMvuVariables(config);\n\n  // \n  const gameData: GameData = {\n    station_name: ' Alpha', // \n    difficulty: 'normal', // \n    resources: {\n      energy: 100,\n      supplies: 100,\n      crew: 10,\n    },\n    status: {\n      energy: 87,\n      life_support: 92,\n      system: 78,\n      personnel: '',\n      communication: 95,\n      laboratory: 83,\n      storage: 64,\n      computing: 71,\n    },\n    tasks: [],\n    diary: [],\n    messages: [],\n  };\n\n  await updateGameData(gameData);\n  await updateGameConfig(config);\n\n  return gameData;\n}\n","/**\n * \n *  LLM \n */\n\n/**\n *  <thinking> \n */\nexport function removeThinkingTags(text: string): string {\n  if (!text) return '';\n\n  //  <thinking>...</thinking> \n  let result = text;\n  let lastResult = '';\n\n  //  <thinking> \n  while (result !== lastResult) {\n    lastResult = result;\n    result = result.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n  }\n\n  return result;\n}\n\n/**\n *  <thinking> \n * -  <thinking>...</thinking>\n * -  <thinking> <thinking> \n */\nexport function removeThinkingTagsFromStream(text: string): string {\n  if (!text) return '';\n\n  //  <thinking>...</thinking> \n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n\n  //  <thinking> \n  const lastThinkingStart = cleaned.lastIndexOf('<thinking>');\n\n  //  <thinking>\n  if (lastThinkingStart !== -1) {\n    cleaned = cleaned.substring(0, lastThinkingStart).trim();\n  }\n\n  return cleaned;\n}\n\n/**\n *  <sum> \n */\nexport function removeSumTags(text: string): string {\n  if (!text) return '';\n  return text.replace(/<sum>[\\s\\S]*?<\\/sum>/gi, '').trim();\n}\n\n/**\n *  <option> \n */\nexport function removeOptionTags(text: string): string {\n  if (!text) return '';\n  return text.replace(/<option>[\\s\\S]*?<\\/option>/gi, '').trim();\n}\n\n/**\n *  <suboption> \n */\nexport function removeSuboptionTags(text: string): string {\n  if (!text) return '';\n  return text.replace(/<suboption>[\\s\\S]*?<\\/suboption>/gi, '').trim();\n}\n\n/**\n *  summary \n * : : ... | : ... | : ... | : ...\n */\nexport function parseSummary(sumText: string): Record<string, string> {\n  if (!sumText) return {};\n\n  const result: Record<string, string> = {};\n  // \n  // : () (/) ( | )\n  const parts = sumText.split('|');\n\n  parts.forEach(part => {\n    const match = part.match(/^\\s*(||||Time|Location|Characters|Event)\\s*[:]\\s*([\\s\\S]*)$/i);\n    if (match) {\n      const key = match[1].trim();\n      const value = match[2].trim();\n      result[key] = value;\n    }\n  });\n\n  return result;\n}\n\n/**\n *  <maintext> \n */\nexport function extractLastMaintext(text: string): string {\n  const matches = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // \n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <continue_choice> \n */\nexport function extractContinueChoice(text: string): string {\n  const matches = text.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <result> \n */\nexport function extractResult(text: string): string {\n  const matches = text.match(/<result>([\\s\\S]*?)<\\/result>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<result>([\\s\\S]*?)<\\/result>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <decision_node> \n */\nexport function extractNextChoice(text: string): string {\n  const matches = text.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <option> \n */\nexport function extractLastOption(text: string): string {\n  const matches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // \n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<option>([\\s\\S]*?)<\\/option>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <suboption> \n * @returns  suboption \n */\nexport function extractAllOptions(text: string): string[] {\n  if (!text) return [];\n\n  //  <suboption> \n  const suboptionMatches = text.match(/<suboption>([\\s\\S]*?)<\\/suboption>/gi);\n  if (suboptionMatches && suboptionMatches.length > 0) {\n    const options: string[] = [];\n    suboptionMatches.forEach(match => {\n      const contentMatch = match.match(/<suboption>([\\s\\S]*?)<\\/suboption>/i);\n      if (contentMatch && contentMatch[1]) {\n        const content = contentMatch[1].trim();\n        if (content) {\n          options.push(content);\n        }\n      }\n    });\n    if (options.length > 0) {\n      return options;\n    }\n  }\n\n  //  <suboption> <option> \n  const optionMatches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!optionMatches || optionMatches.length === 0) {\n    return [];\n  }\n\n  //  option \n  const options: string[] = [];\n  optionMatches.forEach(match => {\n    const contentMatch = match.match(/<option>([\\s\\S]*?)<\\/option>/i);\n    if (contentMatch && contentMatch[1]) {\n      const content = contentMatch[1].trim();\n      if (content) {\n        // \n        const lines = content\n          .split('\\n')\n          .map(line => line.trim())\n          .filter(line => line);\n        if (lines.length > 1) {\n          // \n          options.push(...lines);\n        } else {\n          // \n          options.push(content);\n        }\n      }\n    }\n  });\n\n  return options;\n}\n\n/**\n *  <sum> \n */\nexport function extractLastSum(text: string): string {\n  const matches = text.match(/<sum>([\\s\\S]*?)<\\/sum>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // \n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n *  <UpdateVariable> \n */\nexport function extractLastUpdateVariable(text: string): string {\n  const matches = text.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // \n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/i);\n  if (!contentMatch) {\n    return '';\n  }\n\n  const content = contentMatch[1].trim();\n\n  // \n  // MVU  JSONPatch \n  console.log('  <UpdateVariable> ');\n  return content;\n}\n\n/**\n *  maintext  option\n */\nexport function validateMessage(messageContent: string): boolean {\n  if (!messageContent || typeof messageContent !== 'string') {\n    return false;\n  }\n\n  //  thinking \n  const cleaned = removeThinkingTags(messageContent);\n  const maintext = extractLastMaintext(cleaned);\n  const option = extractLastOption(cleaned);\n\n  if (!maintext || !option) {\n    console.warn('  <maintext>  <option> ');\n    return false;\n  }\n\n  return true;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { GameData, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// \ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\ndeclare function getLastMessageId(): number;\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n *  MVU \n */\nexport async function readGameData(): Promise<any> {\n  try {\n    //  MVU \n    if (typeof waitGlobalInitialized !== 'undefined') {\n      await waitGlobalInitialized('Mvu');\n    }\n\n    //  MVU  stat_data\n    if (typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n      // init(0) -> latest message -> chatchat \n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      try {\n        chatData = Mvu.getMvuData({ type: 'chat' });\n      } catch {\n        // ignore\n      }\n\n      const merged = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      return _.get(merged, 'stat_data') || {};\n    }\n\n    // \n    const variables = getVariables({ type: 'message' });\n    const gameData = variables.game_data || variables.stat_data || {};\n    return gameData;\n  } catch (error) {\n    console.warn(':', error);\n    return {};\n  }\n}\n\n/**\n * \n *  assistant \n * - assistant  1  false\n * - assistant  > 1  true\n */\nexport function hasSaveData(): boolean {\n  try {\n    //  assistant \n    const lastMessageId = getLastMessageId();\n    if (lastMessageId < 0) {\n      return false; // \n    }\n\n    //  assistant \n    const messages = getChatMessages(`0-${lastMessageId}`, { role: 'assistant' });\n\n    //  1  assistant \n    //  1  assistant \n    return messages && messages.length > 1;\n  } catch (error) {\n    console.warn(':', error);\n    return false;\n  }\n}\n\n/**\n * \n */\nexport function readGameConfig(): Partial<GameConfig> {\n  try {\n    const variables = getVariables({ type: 'message' });\n    const config = variables.game_config || {};\n    return config as Partial<GameConfig>;\n  } catch (error) {\n    console.warn(':', error);\n    return {};\n  }\n}\n","import { ComponentCallbacks } from '../types/types';\nimport { hasSaveData } from '../utils/variableReader';\n\n/**\n * \n */\nexport class SplashScreen {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen splash-screen';\n    div.id = 'splash-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    this.updateContinueButton();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      this.updateContinueButton();\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // \n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  private updateContinueButton(): void {\n    if (!this.element) return;\n\n    const continueButton = this.element.querySelector('#continue-button') as HTMLElement;\n    if (continueButton) {\n      if (hasSaveData()) {\n        continueButton.style.display = 'flex';\n      } else {\n        continueButton.style.display = 'none';\n      }\n    }\n  }\n\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    const newGameButton = this.element.querySelector('#new-game-button');\n    if (newGameButton) {\n      newGameButton.addEventListener('click', () => {\n        this.callbacks.onNewGame?.();\n      });\n    }\n\n    const continueButton = this.element.querySelector('#continue-button');\n    if (continueButton) {\n      continueButton.addEventListener('click', () => {\n        this.callbacks.onContinue?.();\n      });\n    }\n\n    const fullscreenButton = this.element.querySelector('#fullscreen-button');\n    if (fullscreenButton) {\n      fullscreenButton.addEventListener('click', () => {\n        this.requestFullscreen();\n      });\n    }\n\n    // Enter\n    this.keyDownHandler = (e: KeyboardEvent) => {\n      if (e.key === 'Enter' && this.element?.classList.contains('active')) {\n        e.preventDefault();\n        this.requestFullscreen();\n      }\n    };\n    document.addEventListener('keydown', this.keyDownHandler);\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch(err => {\n        console.warn(':', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"splash-screen-content\">\n        <div class=\"splash-header\">\n          <div class=\"splash-logo\">\n            <i class=\"fas fa-anchor\"></i>\n          </div>\n          <h1 class=\"splash-title\"></h1>\n          <p class=\"splash-subtitle\">ANCHOR</p>\n        </div>\n        <div class=\"splash-actions\">\n          <button type=\"button\" class=\"splash-button primary\" id=\"new-game-button\">\n            <i class=\"fas fa-play\"></i>\n            <span></span>\n          </button>\n          <button type=\"button\" class=\"splash-button secondary\" id=\"continue-button\" style=\"display: none;\">\n            <i class=\"fas fa-redo\"></i>\n            <span></span>\n          </button>\n          <button type=\"button\" class=\"splash-button icon-only\" id=\"fullscreen-button\" title=\" (Enter)\">\n            <i class=\"fas fa-expand\"></i>\n          </button>\n        </div>\n        <div class=\"splash-footer\">\n          <p class=\"splash-copyright\"> 2026 </p>\n          <p class=\"splash-author\">Silly Tavern</p>\n          <p class=\"splash-hint\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-tertiary);\"> Enter </p>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// \ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const toastr: any;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * \n */\nexport class NewGameSetup {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen setup-screen';\n    div.id = 'setup-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    //  MVU \n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    if (reserveInput) {\n      reserveInput.addEventListener('input', async () => {\n        const config = this.getConfig();\n        if (config.reserve !== undefined) {\n          await this.updateMvuVariable(config.reserve);\n        }\n      });\n    }\n\n    const confirmButton = this.element.querySelector('#setup-confirm-button');\n    if (confirmButton) {\n      confirmButton.addEventListener('click', () => {\n        const reserveInput = this.element?.querySelector('#energy-reserve') as HTMLInputElement;\n        const inputValue = reserveInput?.value?.trim() || '';\n\n        // \n        if (!inputValue) {\n          toastr.error('', '');\n          return;\n        }\n\n        // \n        if (inputValue.includes('.')) {\n          toastr.error('', '');\n          return;\n        }\n\n        const reserve = parseInt(inputValue, 10);\n        if (isNaN(reserve)) {\n          toastr.error('', '');\n          return;\n        }\n\n        if (!Number.isInteger(reserve)) {\n          toastr.error('', '');\n          return;\n        }\n\n        if (reserve < 0 || reserve > 100000) {\n          toastr.error(' 0-100000 ', '');\n          return;\n        }\n\n        const config: GameConfig = { reserve };\n        this.callbacks.onConfirm?.(config);\n      });\n    }\n\n    const cancelButton = this.element.querySelector('#setup-cancel-button');\n    if (cancelButton) {\n      cancelButton.addEventListener('click', () => {\n        this.callbacks.onCancel?.();\n      });\n    }\n  }\n\n  private async updateMvuVariable(value: number): Promise<void> {\n    try {\n      //  MVU \n      if (typeof waitGlobalInitialized !== 'undefined') {\n        await waitGlobalInitialized('Mvu');\n      }\n\n      if (typeof Mvu === 'undefined' || !Mvu.getMvuData || !Mvu.replaceMvuData) {\n        console.warn(' MVU ');\n        return;\n      }\n\n      //  MVU \n      //  init(0) / latest message / chatchat  reserve  system_state \n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      chatData = Mvu.getMvuData({ type: 'chat' });\n\n      const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      const currentStatData = currentMvuData?.stat_data || {};\n\n      //  stat_data\n      const updatedStatData = { ...currentStatData };\n\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      //  reserve  0-100000 \n      updatedStatData.system_state.antimatter.reserve = Math.max(0, Math.min(100000, value));\n\n      //  MVU\n      const updatedMvuData = {\n        ...currentMvuData,\n        stat_data: updatedStatData,\n      };\n\n      await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n      console.info(`  MVU  reserve: ${value}`);\n    } catch (error) {\n      console.warn(`  MVU  reserve :`, error);\n    }\n  }\n\n  private getConfig(): GameConfig {\n    if (!this.element) {\n      return {};\n    }\n\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    return {\n      reserve: reserveInput?.value ? parseInt(reserveInput.value, 10) : undefined,\n    };\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"setup-screen-content\">\n        <div class=\"setup-header\">\n          <h1 class=\"setup-title\"></h1>\n          <p class=\"setup-subtitle\"></p>\n        </div>\n        <div class=\"setup-form\">\n          <div class=\"setup-form-group\">\n            <label class=\"setup-label\" for=\"energy-reserve\"></label>\n            <input\n              type=\"number\"\n              id=\"energy-reserve\"\n              class=\"setup-input\"\n              min=\"0\"\n              max=\"100000\"\n              step=\"1\"\n              placeholder=\"\"\n              required\n            />\n            <small style=\"color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;\">\n              0 - 100000\n            </small>\n          </div>\n        </div>\n        <div class=\"setup-actions\">\n          <button type=\"button\" class=\"setup-button secondary\" id=\"setup-cancel-button\">\n            <i class=\"fas fa-times\"></i>\n            <span></span>\n          </button>\n          <button type=\"button\" class=\"setup-button primary\" id=\"setup-confirm-button\">\n            <i class=\"fas fa-check\"></i>\n            <span></span>\n          </button>\n        </div>\n      </div>\n    `;\n  }\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = showdown;","const __WEBPACK_NAMESPACE_OBJECT__ = YAML;","import { waitUntil } from 'async-wait-until';\nimport showdown from \"showdown\";\nimport _ from 'lodash';\nimport { parse } from 'yaml';\nimport { ComponentCallbacks, GameData, NetItem } from '../types/types';\n\n// \ndeclare function getWorldbook(worldbook_name: string): Promise<WorldbookEntry[]>;\ndeclare function getVariables(option: { type: 'message'; message_id: number | 'latest' }): Record<string, any>;\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): { stop: () => void };\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  CHAT_CHANGED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  events: {\n    VARIABLE_UPDATE_ENDED: 'mag_variable_update_ended';\n  };\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\ntype WorldbookEntry = {\n  uid: number;\n  name: string;\n  enabled: boolean;\n  content: string;\n};\n\ninterface NetCategory {\n  id: string; //  <module>,  'Manual'\n  label: string; //  <alias>,  ''\n  items: NetItem[];\n}\n\n/**\n * Dashboard\n */\nexport class Dashboard {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n  private gameData: Partial<GameData> = {};\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n  private mvuUpdateListener: { stop: () => void } | null = null;\n  private statusRetryCount = 0;\n  private statusRetryTimer: number | null = null;\n  private markdownConverter: showdown.Converter;\n\n  // \n  private netCategories: NetCategory[] = [];\n  private netReport: string = '';\n  private expandedSections: Set<string> = new Set();\n  private selectedItem: { categoryId: string; index: number } | null = null;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n    this.markdownConverter = new showdown.Converter({ tables: true, strikethrough: true, tasklists: true, simpleLineBreaks: true, ghCodeBlocks: true, openLinksInNewWindow: true });\n  }\n\n  public createElement(): HTMLElement {\n    try {\n      const div = document.createElement('div');\n      div.className = 'screen main-screen';\n      div.id = 'main-screen';\n      div.innerHTML = this.getHTML();\n      this.element = div;\n\n      //  innerHTML \n      this.bindEvents();\n\n      // \n      this.refreshData();\n\n      console.log(' Dashboard ');\n      return div;\n    } catch (error) {\n      console.error('  Dashboard :', error);\n      //  div \n      const fallbackDiv = document.createElement('div');\n      fallbackDiv.className = 'screen main-screen';\n      fallbackDiv.id = 'main-screen';\n      fallbackDiv.innerHTML = '<div style=\"padding: 2rem; color: var(--text-primary);\">...</div>';\n      this.element = fallbackDiv;\n      return fallbackDiv;\n    }\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      // \n      try {\n        this.refreshData();\n        console.log(' Dashboard ');\n      } catch (error) {\n        console.error(' Dashboard :', error);\n        // \n      }\n    } else {\n      console.error(' Dashboard element  null');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // \n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n\n    if (this.mvuUpdateListener) {\n      this.mvuUpdateListener.stop();\n      this.mvuUpdateListener = null;\n    }\n\n    if (this.statusRetryTimer !== null) {\n      window.clearTimeout(this.statusRetryTimer);\n      this.statusRetryTimer = null;\n    }\n  }\n\n  public updateGameData(data: Partial<GameData>): void {\n    this.gameData = { ...this.gameData, ...data };\n    this.refreshData();\n  }\n\n  private refreshData(): void {\n    if (!this.element) {\n      console.warn(' Dashboard element  null');\n      return;\n    }\n\n    try {\n      //  MVU \n      this.updateStatusCards().catch(error => {\n        console.warn(' :', error);\n      });\n\n      // \n      this.updateTasksList();\n\n      // \n      this.updateNetContent();\n\n      //  maintext\n      setTimeout(() => {\n        try {\n          this.loadMaintextFromChat();\n        } catch (error) {\n          console.warn('  maintext :', error);\n        }\n      }, 100);\n\n      // \n      this.loadNetFromWorldbook().catch(err => console.error(' :', err));\n\n      console.info(' ');\n    } catch (error) {\n      console.error(' :', error);\n      // \n    }\n  }\n\n  private async updateStatusCards(): Promise<void> {\n    if (!this.element) return;\n\n    const statusGrid = this.element.querySelector('#status-grid');\n    if (!statusGrid) return;\n\n    try {\n      //  MVU  system_state \n      //  MVU  stat_data  ->  -> \n      await waitGlobalInitialized('Mvu');\n      await waitUntil(() => _.has(getVariables({ type: 'message' }), 'stat_data'), {\n        timeout: 3000,\n        intervalBetweenAttempts: 100,\n      }).catch(() => {\n        // timeout \n      });\n\n      //  chat \n      const chatData = Mvu.getMvuData({ type: 'chat' });\n      const chatSystemState = _.get(chatData, 'stat_data.system_state');\n\n      // latest message + 0 initvar\n      let latestSystemState: any = null;\n      let initSystemState: any = null;\n      try {\n        const latest = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n        latestSystemState = _.get(latest, 'stat_data.system_state');\n      } catch (e) {\n        console.warn('  latest message  system_state :', e);\n      }\n      try {\n        const initMsg = Mvu.getMvuData({ type: 'message', message_id: 0 });\n        initSystemState = _.get(initMsg, 'stat_data.system_state');\n      } catch (e) {\n        // message 0 \n      }\n\n      // init -> latest -> chatchat \n      const systemState: any = _.merge({}, initSystemState || {}, latestSystemState || {}, chatSystemState || {});\n\n      const hasSystemStateData =\n        systemState &&\n        (systemState.cycle !== undefined ||\n          systemState.system_pressure !== undefined ||\n          systemState.instability !== undefined ||\n          !!systemState.population ||\n          !!systemState.antimatter);\n\n      // \n      if (!hasSystemStateData) {\n        statusGrid.innerHTML = '<div class=\"status-empty\"></div>';\n\n        if (this.statusRetryCount < 10) {\n          this.statusRetryCount += 1;\n          if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n          this.statusRetryTimer = window.setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 250);\n        }\n        return;\n      }\n\n      // \n      this.statusRetryCount = 0;\n      if (this.statusRetryTimer !== null) {\n        window.clearTimeout(this.statusRetryTimer);\n        this.statusRetryTimer = null;\n      }\n\n      //  initvar \n      const cards: string[] = [];\n\n      // Cycle ()\n      if (systemState.cycle !== undefined) {\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-clock status-card-icon\"></i>\n              <span class=\"status-card-title\"></span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${systemState.cycle}</span>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Antimatter ()\n      if (systemState.antimatter) {\n        const reserve = systemState.antimatter.reserve ?? 0;\n        const leakRisk = systemState.antimatter.leak_risk ?? 0;\n        const reservePercent = Math.round((reserve / 100000) * 100);\n        const riskLevel = leakRisk < 0.3 ? 'low' : leakRisk < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-atom status-card-icon\"></i>\n              <span class=\"status-card-title\"></span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${reserve.toLocaleString()}</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill\" style=\"width: ${reservePercent}%\"></div>\n                </div>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  : <span class=\"risk-${riskLevel}\">${(leakRisk * 100).toFixed(1)}%</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Population ()\n      if (systemState.population) {\n        const pop = systemState.population;\n        const active = pop.active ?? 0;\n        const standby = pop.standby ?? 0;\n        const archived = pop.archived ?? 0;\n        const total = active + standby + archived;\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-users status-card-icon\"></i>\n              <span class=\"status-card-title\"></span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${total}</span>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  : ${active} | : ${standby} | : ${archived}\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // System Pressure ()\n      if (systemState.system_pressure !== undefined) {\n        const pressure = systemState.system_pressure ?? 0;\n        const pressurePercent = Math.round(pressure * 100);\n        const pressureLevel = pressure < 0.5 ? 'low' : pressure < 0.8 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-tachometer-alt status-card-icon\"></i>\n              <span class=\"status-card-title\"></span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${pressurePercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${pressureLevel}\" style=\"width: ${pressurePercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Instability ()\n      if (systemState.instability !== undefined) {\n        const instability = systemState.instability ?? 0;\n        const instabilityPercent = Math.round(instability * 100);\n        const instabilityLevel = instability < 0.3 ? 'low' : instability < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-exclamation-triangle status-card-icon\"></i>\n              <span class=\"status-card-title\"></span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${instabilityPercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${instabilityLevel}\" style=\"width: ${instabilityPercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      if (cards.length > 0) {\n        statusGrid.innerHTML = cards.join('');\n      } else {\n        statusGrid.innerHTML = '<div class=\"status-empty\"></div>';\n      }\n    } catch (error) {\n      console.error(' :', error);\n      statusGrid.innerHTML = '<div class=\"status-empty\"></div>';\n    }\n  }\n\n  private updateTasksList(): void {\n    if (!this.element) return;\n\n    const tasksList = this.element.querySelector('#tasks-list');\n    if (!tasksList) return;\n\n    // gameData.tasks\n    const tasks =\n      this.gameData.tasks && Array.isArray(this.gameData.tasks) && this.gameData.tasks.length > 0\n        ? this.gameData.tasks\n        : this.getDefaultTasks();\n\n    tasksList.innerHTML = tasks\n      .map(\n        task => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas ${this.getTaskIcon(task.status)}\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(task.title)}</span>\n            <span class=\"entry-status ${task.status}\">${this.getStatusText(task.status)}</span>\n          </div>\n          <div class=\"entry-meta\">\n            <span class=\"entry-time\">${task.time}</span>\n            <span class=\"entry-priority priority-${task.priority}\">${this.getPriorityText(task.priority)}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(task.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateNetContent(): void {\n    if (!this.element) return;\n\n    const netContainer = this.element.querySelector('#module-net .net-body');\n    if (!netContainer) return;\n\n    // \n    const sidebarHtml = this.netCategories.map(cat => this.renderSidebarSection(cat.id, cat.label, cat.items)).join('');\n\n    // \n    const reportSidebarHtml = this.renderSidebarSection('report', '', [{ title: '' }]);\n\n    //  HTML\n    netContainer.innerHTML = `\n      <div class=\"net-explorer\">\n        <div class=\"net-sidebar\">\n          ${sidebarHtml}\n          ${reportSidebarHtml}\n        </div>\n        <div class=\"net-viewer\" id=\"net-viewer\">\n          ${this.renderNetViewer()}\n        </div>\n      </div>\n    `;\n\n    // \n    this.bindNetSidebarEvents();\n\n    // \n    if (this.selectedItem?.categoryId === 'report') {\n      const editor = this.element.querySelector('#net-report-editor') as HTMLTextAreaElement;\n      if (editor) {\n        $(editor).on(\n          'input',\n          _.debounce((e: any) => {\n            this.netReport = e.target.value;\n            this.saveReportToVariables(this.netReport);\n          }, 1000),\n        );\n      }\n    }\n  }\n\n  private renderSidebarSection(id: string, label: string, items: any[]): string {\n    const isExpanded = this.expandedSections.has(id);\n    const icon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';\n\n    let itemsHtml = '';\n    if (isExpanded) {\n      itemsHtml = `\n        <div class=\"net-sidebar-items\">\n          ${items\n            .map((item, index) => {\n              const isSelected = this.selectedItem?.categoryId === id && this.selectedItem?.index === index;\n              return `\n              <div class=\"net-sidebar-item ${isSelected ? 'active' : ''}\" data-net-section=\"${id}\" data-net-index=\"${index}\">\n                <i class=\"far fa-file-alt\"></i>\n                <span class=\"net-sidebar-item-title\">${this.escapeHtml(item.title)}</span>\n              </div>\n            `;\n            })\n            .join('')}\n        </div>\n      `;\n    }\n\n    return `\n      <div class=\"net-sidebar-section\" data-section-id=\"${id}\">\n        <div class=\"net-sidebar-header\">\n          <i class=\"fas ${icon}\"></i>\n          <span>${label}</span>\n        </div>\n        ${itemsHtml}\n      </div>\n    `;\n  }\n\n  private renderMarkdown(text: string): string {\n    return this.markdownConverter.makeHtml(text);\n  }\n\n  private renderNetViewer(): string {\n    if (!this.selectedItem) {\n      return '<div class=\"net-viewer-empty\"></div>';\n    }\n\n    const { categoryId, index } = this.selectedItem;\n\n    if (categoryId === 'report') {\n      return `\n        <div class=\"net-report-container\">\n          <div class=\"net-viewer-header\">\n            <span class=\"net-viewer-title\"></span>\n          </div>\n          <textarea id=\"net-report-editor\" class=\"net-report-editor\" placeholder=\"...\">${this.netReport || ''}</textarea>\n        </div>\n      `;\n    }\n\n    const category = this.netCategories.find(c => c.id === categoryId);\n    const item = category?.items[index];\n\n    if (!item) {\n      return '<div class=\"net-viewer-empty\"></div>';\n    }\n\n    return `\n      <div class=\"net-item-viewer\">\n        <div class=\"net-viewer-header\">\n          <h2 class=\"net-viewer-title\">${this.escapeHtml(item.title)}</h2>\n          <div class=\"net-viewer-meta\">: ${this.escapeHtml(item.author)}</div>\n        </div>\n        <div class=\"net-viewer-content\">${this.renderMarkdown(item.content)}</div>\n      </div>\n    `;\n  }\n\n  private bindNetSidebarEvents(): void {\n    if (!this.element) return;\n\n    // /\n    $(this.element).off('click', '.net-sidebar-header');\n    $(this.element).on('click', '.net-sidebar-header', e => {\n      const sectionId = $(e.currentTarget).closest('.net-sidebar-section').attr('data-section-id');\n      if (sectionId) {\n        if (this.expandedSections.has(sectionId)) {\n          this.expandedSections.delete(sectionId);\n        } else {\n          this.expandedSections.add(sectionId);\n        }\n        this.updateNetContent();\n      }\n    });\n\n    // \n    $(this.element).off('click', '.net-sidebar-item');\n    $(this.element).on('click', '.net-sidebar-item', e => {\n      const categoryId = $(e.currentTarget).attr('data-net-section') as string;\n      const index = parseInt($(e.currentTarget).attr('data-net-index') || '0', 10);\n      this.selectedItem = { categoryId, index };\n      this.updateNetContent();\n    });\n  }\n\n  private async loadNetFromWorldbook(): Promise<void> {\n    const WORLDBOOK_NAME = 'anchor';\n    // : net-<module>-<alias>\n    const NET_ENTRY_REGEX = /^net-([^-]+)-(.+)$/;\n\n    try {\n      const worldbook = await getWorldbook(WORLDBOOK_NAME);\n      const newCategories: NetCategory[] = [];\n\n      worldbook.forEach(entry => {\n        const match = entry.name.match(NET_ENTRY_REGEX);\n        if (match && entry.content) {\n          const moduleId = match[1];\n          const alias = match[2];\n\n          try {\n            const items = parse(entry.content) || [];\n            newCategories.push({\n              id: moduleId,\n              label: alias,\n              items: Array.isArray(items) ? items : [items], // \n            });\n\n            // \n            if (newCategories.length === 1 && !this.selectedItem) {\n              this.expandedSections.add(moduleId);\n              this.selectedItem = { categoryId: moduleId, index: 0 };\n            }\n          } catch (e) {\n            console.error(`  [${entry.name}] YAML :`, e);\n          }\n        }\n      });\n\n      this.netCategories = newCategories;\n\n      // \n      try {\n        const gameVariables = getVariables({ type: 'message', message_id: 'latest' });\n        this.netReport = gameVariables.stat_data?.player_report || '';\n      } catch (e) {\n        console.warn(' :', e);\n      }\n\n      this.updateNetContent();\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private async saveReportToVariables(content: string): Promise<void> {\n    try {\n      //  variableUpdater\n      const { updateStatDataVariable } = await import('../utils/variableUpdater');\n      await updateStatDataVariable('player_report', content);\n      console.info(' ');\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private updateChatMessages(): void {\n    //  dashboardLogic.ts  initChatInterface \n    // \n    //  getChatMessages \n  }\n\n  private getDefaultTasks() {\n    return [\n      {\n        id: '1',\n        title: '',\n        status: 'completed' as const,\n        priority: 'high' as const,\n        time: '01-15 14:30',\n        description: '',\n      },\n    ];\n  }\n\n  private getDefaultMessages() {\n    return [\n      { id: '1', role: 'user' as const, content: '', time: '14:32' },\n      {\n        id: '2',\n        role: 'assistant' as const,\n        content:\n          '87%92%78%',\n        time: '14:32',\n      },\n      { id: '3', role: 'user' as const, content: '', time: '14:33' },\n      {\n        id: '4',\n        role: 'assistant' as const,\n        content:\n          '87%30',\n        time: '14:33',\n      },\n    ];\n  }\n\n  private getTaskIcon(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'fa-check-circle';\n      case 'in-progress':\n        return 'fa-clock';\n      case 'pending':\n        return 'fa-exclamation-circle';\n      default:\n        return 'fa-circle';\n    }\n  }\n\n  private getStatusText(status: string): string {\n    switch (status) {\n      case 'completed':\n        return '';\n      case 'in-progress':\n        return '';\n      case 'pending':\n        return '';\n      default:\n        return status;\n    }\n  }\n\n  private getPriorityText(priority: string): string {\n    switch (priority) {\n      case 'urgent':\n        return '';\n      case 'high':\n        return '';\n      case 'medium':\n        return '';\n      case 'low':\n        return '';\n      default:\n        return priority;\n    }\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   *  maintext \n   */\n  private parseMaintext(messageContent: string): string {\n    const maintextMatch = messageContent.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n    if (!maintextMatch) {\n      return '';\n    }\n    return maintextMatch[1].trim();\n  }\n\n  /**\n   *  maintext \n   */\n  public updateMaintextDisplay(messageContent: string): void {\n    if (!this.element) return;\n\n    //  textParser\n    import('../utils/textParser')\n      .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n        const el = this.element;\n        if (!el) return;\n\n        // 1. \n        const continueChoice = extractContinueChoice(messageContent);\n        const result = extractResult(messageContent);\n        const nextChoice = extractNextChoice(messageContent);\n\n        // 2. \n        const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n        const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n        const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n        if (continueChoice || result || nextChoice) {\n          // \n          if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n          if (resultArea) resultArea.textContent = result || '';\n          if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n        } else {\n          //  maintext  next_choice \n          const maintext = this.parseMaintext(messageContent);\n          if (nextChoiceArea) {\n            nextChoiceArea.textContent = maintext || '';\n          }\n          // \n          if (continueChoiceArea) continueChoiceArea.textContent = '';\n          if (resultArea) resultArea.textContent = '';\n        }\n\n        console.info(`  maintext`);\n      })\n      .catch(error => {\n        console.error('  maintext :', error);\n      });\n  }\n\n  /**\n   *  maintext \n   * continue_choice, result, decision_node\n   */\n  public loadMaintextFromChat(): void {\n    if (!this.element) return;\n\n    try {\n      //  getChatMessages \n      if (typeof getChatMessages === 'undefined') {\n        console.warn(' getChatMessages ');\n        return;\n      }\n\n      // 1.  assistant \n      let messages: Array<{ message: string; message_id: number; role: string }> = [];\n      try {\n        messages = getChatMessages(-1, { role: 'assistant' });\n      } catch (error) {\n        console.warn('  assistant :', error);\n      }\n\n      let lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n\n      // 2.  assistant  role\n      if (!lastMessage) {\n        try {\n          messages = getChatMessages(-1);\n          lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n        } catch (error) {\n          console.warn(' :', error);\n        }\n      }\n\n      if (!lastMessage) {\n        return;\n      }\n\n      // 4. \n      const messageContent = lastMessage.message || '';\n\n      //  textParser\n      import('../utils/textParser')\n        .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n          const el = this.element;\n          if (!el) return;\n\n          // 5. \n          const continueChoice = extractContinueChoice(messageContent);\n          const result = extractResult(messageContent);\n          const nextChoice = extractNextChoice(messageContent);\n\n          // 6. \n          const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n          const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n          if (continueChoice || result || nextChoice) {\n            // \n            if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n            if (resultArea) resultArea.textContent = result || '';\n            if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n          } else {\n            //  maintext  next_choice \n            const maintext = this.parseMaintext(messageContent);\n            if (nextChoiceArea && maintext) {\n              nextChoiceArea.textContent = maintext;\n            }\n            // \n            if (continueChoiceArea) continueChoiceArea.textContent = '';\n            if (resultArea) resultArea.textContent = '';\n          }\n\n          console.info(`  maintext (message_id: ${lastMessage.message_id})`);\n        })\n        .catch(error => {\n          console.error('  textParser :', error);\n          const el = this.element;\n          if (!el) return;\n          // \n          const maintext = this.parseMaintext(messageContent);\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n          if (nextChoiceArea && maintext) {\n            nextChoiceArea.textContent = maintext;\n          }\n        });\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  /**\n   * \n   */\n  private setupMessageListener(): void {\n    try {\n      if (typeof eventOn === 'undefined' || typeof tavern_events === 'undefined') {\n        console.warn('  API ');\n        return;\n      }\n\n      const handleMessageReceived = () => {\n        // \n        setTimeout(() => {\n          try {\n            this.loadMaintextFromChat();\n            //  MVU \n            this.updateStatusCards().catch(() => {});\n          } catch (error) {\n            console.error(' :', error);\n          }\n        }, 150);\n      };\n\n      //  MESSAGE_RECEIVED  CHAT_CHANGED \n      if (tavern_events.MESSAGE_RECEIVED) {\n        eventOn(tavern_events.MESSAGE_RECEIVED, handleMessageReceived);\n      }\n      if (tavern_events.CHAT_CHANGED) {\n        eventOn(tavern_events.CHAT_CHANGED, handleMessageReceived);\n      }\n      if (tavern_events.MESSAGE_UPDATED) {\n        eventOn(tavern_events.MESSAGE_UPDATED, handleMessageReceived);\n      }\n\n      //  refresh-maintext\n      if (this.element) {\n        this.element.addEventListener('refresh-maintext', (e: any) => {\n          //  chat  and \n          const latestMessage = e.detail?.message;\n          if (latestMessage) {\n            this.updateMaintextDisplay(latestMessage);\n          } else {\n            // \n            setTimeout(() => {\n              this.loadMaintextFromChat();\n            }, 100);\n          }\n        });\n        this.element.addEventListener('refresh-status', () => {\n          setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 50);\n        });\n      }\n\n      console.info(' ');\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) {\n      console.warn(' Dashboard element  null');\n      return;\n    }\n\n    try {\n      // \n      const fullscreenButton = this.element.querySelector('#dashboard-fullscreen-button');\n      if (fullscreenButton) {\n        fullscreenButton.addEventListener('click', () => {\n          this.toggleFullscreen();\n        });\n      } else {\n        console.warn(' ');\n      }\n\n      // Enter \n      this.setupEnterKeyFullscreen();\n\n      //  app.ts \n\n      //  API \n      setTimeout(() => {\n        try {\n          if (typeof eventOn !== 'undefined' && typeof tavern_events !== 'undefined') {\n            this.setupMessageListener();\n          } else {\n            console.warn('  API ');\n          }\n        } catch (error) {\n          console.warn(' :', error);\n        }\n      }, 200);\n\n      //  MVU  -> \n      setTimeout(async () => {\n        try {\n          await waitGlobalInitialized('Mvu');\n          if (this.mvuUpdateListener) return;\n          if (typeof Mvu === 'undefined' || !Mvu.events?.VARIABLE_UPDATE_ENDED) return;\n\n          this.mvuUpdateListener = eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, () => {\n            if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n            this.statusRetryTimer = window.setTimeout(() => {\n              this.updateStatusCards().catch(() => {});\n            }, 50);\n          });\n        } catch (e) {\n          console.warn(' MVU :', e);\n        }\n      }, 250);\n    } catch (error) {\n      console.error(' bindEvents :', error);\n      // \n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <!--  -->\n      <header class=\"main-header\">\n        <div class=\"header-content\">\n          <div class=\"logo-section\">\n            <i class=\"fas fa-anchor logo-icon\"></i>\n            <h1 class=\"logo-text\"></h1>\n          </div>\n          <!--  -->\n          <nav class=\"top-nav-menu\">\n            <button type=\"button\" class=\"nav-item active\" data-module=\"status\" id=\"nav-status\" title=\" (1)\">\n              <span class=\"nav-shortcut\">1</span>\n              <i class=\"fas fa-chart-line nav-icon\"></i>\n              <span class=\"nav-text\"></span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"tasks\" id=\"nav-tasks\" title=\" (2)\">\n              <span class=\"nav-shortcut\">2</span>\n              <i class=\"fas fa-tasks nav-icon\"></i>\n              <span class=\"nav-text\"></span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"net\" id=\"nav-net\" title=\" (3)\">\n              <span class=\"nav-shortcut\">3</span>\n              <i class=\"fas fa-network-wired nav-icon\"></i>\n              <span class=\"nav-text\"></span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"communication\" id=\"nav-communication\" title=\" (4)\">\n              <span class=\"nav-shortcut\">4</span>\n              <i class=\"fas fa-comments nav-icon\"></i>\n              <span class=\"nav-text\"></span>\n            </button>\n          </nav>\n          <div class=\"header-actions\">\n            <button type=\"button\" class=\"fullscreen-button\" id=\"dashboard-fullscreen-button\" title=\" (Enter)\">\n              <i class=\"fas fa-expand\"></i>\n            </button>\n            <div class=\"header-status\">\n              <div class=\"status-indicator online\">\n                <span class=\"status-dot\"></span>\n                <span class=\"status-text\"></span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <!--  -->\n      <main class=\"main-content\">\n        <!--  -->\n        <section class=\"content-panel\">\n          <!--  -->\n          <div class=\"module-container active\" id=\"module-status\">\n            <div class=\"module-body\">\n              <!--  -->\n              <div class=\"maintext-container\">\n                <div class=\"maintext-header\">\n                  <h3 class=\"maintext-title\">\n                    <i class=\"fas fa-scroll\"></i>\n                    \n                  </h3>\n                </div>\n                <div class=\"maintext-areas\">\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-history\" title=\"\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-continue-choice\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-microchip\" title=\"\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-result\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-bolt\" title=\"\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-next-choice\"></div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"status-grid\" id=\"status-grid\"></div>\n            </div>\n          </div>\n\n          <!--  -->\n          <div class=\"module-container\" id=\"module-tasks\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"tasks-list\"></div>\n            </div>\n          </div>\n\n          <!--  -->\n          <div class=\"module-container\" id=\"module-net\">\n            <div class=\"module-body net-body\">\n              <!--  updateNetContent  -->\n            </div>\n          </div>\n\n          <!--  -->\n          <div class=\"module-container\" id=\"module-communication\">\n            <div class=\"module-body communication-body\">\n              <div class=\"chat-messages\" id=\"chat-messages\"></div>\n              <div class=\"chat-input-container\">\n                <div class=\"chat-input-wrapper\">\n                  <button type=\"button\" id=\"chat-show-options-btn\" class=\"chat-show-options-btn\" title=\"\">\n                    <i class=\"fas fa-list\"></i>\n                  </button>\n                  <button\n                    type=\"button\"\n                    id=\"chat-regenerate-btn\"\n                    class=\"chat-regenerate-btn\"\n                    title=\" assistant \"\n                  >\n                    <i class=\"fas fa-rotate-right\"></i>\n                  </button>\n                  <button\n                    type=\"button\"\n                    id=\"chat-rollback-btn\"\n                    class=\"chat-rollback-btn\"\n                    title=\"\"\n                  >\n                    <i class=\"fas fa-arrow-left\"></i>\n                  </button>\n                  <textarea id=\"chat-input\" class=\"chat-input\" placeholder=\"...\" rows=\"1\"></textarea>\n                  <button type=\"button\" id=\"chat-send-btn\" class=\"chat-send-btn\">\n                    <i class=\"fas fa-paper-plane\"></i>\n                  </button>\n                </div>\n              </div>\n              <!-- Option  -->\n              <div class=\"chat-options-overlay\" id=\"chat-options-overlay\">\n                <div class=\"chat-options-container\" id=\"chat-options-container\">\n                  <div class=\"chat-options-header\">\n                    <span class=\"chat-options-title\"></span>\n                    <button type=\"button\" class=\"chat-options-close\" id=\"chat-options-close\" title=\"\">\n                      <i class=\"fas fa-times\"></i>\n                    </button>\n                  </div>\n                </div>\n                <div class=\"chat-options-list\" id=\"chat-options-list\"></div>\n              </div>\n            </div>\n          </div>\n        </section>\n      </main>\n\n      <!--  -->\n      <div class=\"modal-overlay\" id=\"modal-overlay\">\n        <div class=\"modal-container\" id=\"modal-container\">\n          <div class=\"modal-header\">\n            <h3 class=\"modal-title\" id=\"modal-title\"></h3>\n            <button class=\"modal-close\" id=\"modal-close\">\n              <i class=\"fas fa-times\"></i>\n            </button>\n          </div>\n          <div class=\"modal-body\" id=\"modal-body\"></div>\n        </div>\n      </div>\n\n    `;\n  }\n\n  private setupEnterKeyFullscreen(): void {\n    try {\n      // \n      if (this.keyDownHandler) {\n        document.removeEventListener('keydown', this.keyDownHandler);\n        this.keyDownHandler = null;\n      }\n\n      // \n      this.keyDownHandler = (e: KeyboardEvent) => {\n        try {\n          //  Dashboard \n          if (!this.element?.classList.contains('active')) {\n            return;\n          }\n\n          //  Enter  Esc \n          const activeElement = document.activeElement;\n          if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {\n            return;\n          }\n\n          // Enter \n          if (e.key === 'Enter') {\n            e.preventDefault();\n            this.toggleFullscreen();\n          }\n        } catch (error) {\n          console.error(' :', error);\n        }\n      };\n\n      document.addEventListener('keydown', this.keyDownHandler);\n      console.log(' Enter ');\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private requestFullscreen(): void {\n    try {\n      const element = document.documentElement;\n      if (element.requestFullscreen) {\n        element.requestFullscreen().catch(err => {\n          console.warn(':', err);\n        });\n      } else if ((element as any).webkitRequestFullscreen) {\n        (element as any).webkitRequestFullscreen();\n      } else if ((element as any).mozRequestFullScreen) {\n        (element as any).mozRequestFullScreen();\n      } else if ((element as any).msRequestFullscreen) {\n        (element as any).msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private exitFullscreen(): void {\n    try {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  private toggleFullscreen(): void {\n    try {\n      if (!document.fullscreenElement) {\n        this.requestFullscreen();\n      } else {\n        this.exitFullscreen();\n      }\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n}\n","import { PageState } from '../types/types';\nimport { SplashScreen } from '../components/SplashScreen';\nimport { NewGameSetup } from '../components/NewGameSetup';\nimport { Dashboard } from '../components/Dashboard';\nimport { ComponentCallbacks } from '../types/types';\nimport { initializeNewGame, continueGame } from './gameInitializer';\nimport { hasSaveData } from './variableReader';\n\n/**\n * \n */\nexport class PageManager {\n  private currentPage: PageState = 'splash';\n  private splashScreen: SplashScreen;\n  private setupScreen: NewGameSetup;\n  private dashboard: Dashboard;\n  private appContainer: HTMLElement;\n\n  constructor(appContainer: HTMLElement) {\n    this.appContainer = appContainer;\n\n    const callbacks: ComponentCallbacks = {\n      onStart: () => this.goToSplash(),\n      onNewGame: () => this.goToSetup(),\n      onContinue: () => this.goToGame(),\n      onConfirm: (config) => this.handleConfirm(config),\n      onCancel: () => this.goToSplash(),\n      onFullscreenToggle: () => this.toggleFullscreen(),\n    };\n\n    this.splashScreen = new SplashScreen(callbacks);\n    this.setupScreen = new NewGameSetup(callbacks);\n    this.dashboard = new Dashboard(callbacks);\n  }\n\n  public initialize(): void {\n    // \n    this.appContainer.appendChild(this.splashScreen.createElement());\n    this.appContainer.appendChild(this.setupScreen.createElement());\n    this.appContainer.appendChild(this.dashboard.createElement());\n\n    // \n    const hasSave = hasSaveData();\n    if (hasSave) {\n      // \n      this.goToGame();\n    } else {\n      // \n      this.showPage('splash');\n    }\n  }\n\n  private showPage(page: PageState): void {\n    console.log(` : ${page}`);\n\n    // \n    try {\n      this.splashScreen.hide();\n      this.setupScreen.hide();\n      this.dashboard.hide();\n    } catch (error) {\n      console.warn(' :', error);\n    }\n\n    // \n    try {\n      switch (page) {\n        case 'splash':\n          this.splashScreen.show();\n          // \n          this.requestFullscreen();\n          break;\n        case 'setup':\n          this.setupScreen.show();\n          break;\n        case 'game':\n          this.dashboard.show();\n          //  Dashboard \n          setTimeout(() => {\n            const dashboardElement = document.getElementById('main-screen');\n            if (dashboardElement && dashboardElement.classList.contains('active')) {\n              console.log(' Dashboard ');\n            } else {\n              console.error(' Dashboard element:', dashboardElement);\n            }\n          }, 100);\n          break;\n      }\n    } catch (error) {\n      console.error(`  ${page} :`, error);\n      throw error;\n    }\n\n    this.currentPage = page;\n    console.info(` : ${page}`);\n  }\n\n  private goToSplash(): void {\n    this.showPage('splash');\n  }\n\n  private goToSetup(): void {\n    this.showPage('setup');\n  }\n\n  private async goToGame(): Promise<void> {\n    try {\n      console.log(' ...');\n      const gameData = await continueGame();\n      console.log(' :', gameData);\n\n      // \n      this.dashboard.updateGameData(gameData);\n\n      // \n      this.showPage('game');\n\n      console.log(' ');\n    } catch (error) {\n      console.error(' :', error);\n      console.error(' :', {\n        error: error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorStack: error instanceof Error ? error.stack : undefined,\n      });\n\n      // \n      try {\n        this.dashboard.updateGameData({});\n        this.showPage('game');\n        console.warn(' ');\n      } catch (fallbackError) {\n        console.error(' :', fallbackError);\n        toastr.error('', '');\n      }\n    }\n  }\n\n  private async handleConfirm(config: any): Promise<void> {\n    try {\n      // initializeNewGame  createOpeningStoryMessage\n      const gameData = await initializeNewGame(config);\n      this.dashboard.updateGameData(gameData);\n      this.showPage('game');\n      toastr.success('', '');\n    } catch (error) {\n      console.error(':', error);\n      toastr.error('', '');\n    }\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn(':', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private toggleFullscreen(): void {\n    if (!document.fullscreenElement) {\n      this.requestFullscreen();\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    }\n  }\n\n  public getDashboard(): Dashboard {\n    return this.dashboard;\n  }\n}\n","import { GameConfig, GameData } from '../types/types';\nimport { initializeGameData } from './variableUpdater';\n\n// \ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\n\n/**\n * \n * assistant\n */\nexport async function initializeNewGame(config: GameConfig): Promise<GameData> {\n  console.info('...', config);\n\n  const gameData = await initializeGameData(config);\n\n  console.info('');\n  return gameData;\n}\n\n/**\n * \n */\nexport async function continueGame(): Promise<Partial<GameData>> {\n  console.info('...');\n\n  const variables = getVariables({ type: 'message' });\n  const gameData = variables.game_data || variables.stat_data || {};\n\n  console.info('');\n  return gameData as Partial<GameData>;\n}\n","//  - Dashboard \n// \n\n// \ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare const errorCatched: (fn: () => void) => () => void;\n\n// ==========  ==========\nexport function initNavigation() {\n  const navItems = document.querySelectorAll('.nav-item');\n  const modules = document.querySelectorAll('.module-container');\n\n  // \n  function switchModule(moduleId: string) {\n    if (!moduleId) return;\n\n    //  active \n    navItems.forEach(nav => nav.classList.remove('active'));\n    modules.forEach(module => module.classList.remove('active'));\n\n    //  active \n    const targetNavItem = document.querySelector(`.nav-item[data-module=\"${moduleId}\"]`);\n    const targetModule = document.getElementById(`module-${moduleId}`);\n\n    if (targetNavItem) {\n      targetNavItem.classList.add('active');\n    }\n    if (targetModule) {\n      targetModule.classList.add('active');\n    }\n  }\n\n  // \n  navItems.forEach(item => {\n    item.addEventListener('click', () => {\n      const moduleId = item.getAttribute('data-module');\n      if (moduleId) {\n        switchModule(moduleId);\n      }\n    });\n  });\n\n  // 1, 2, 3, 4\n  const moduleMap: Record<string, string> = {\n    '1': 'status',\n    '2': 'tasks',\n    '3': 'net',\n    '4': 'communication',\n  };\n\n  document.addEventListener('keydown', e => {\n    // \n    const mainScreen = document.getElementById('main-screen');\n    if (!mainScreen || !mainScreen.classList.contains('active')) {\n      return;\n    }\n\n    // \n    const activeElement = document.activeElement;\n    if (\n      activeElement &&\n      (activeElement.tagName === 'INPUT' ||\n        activeElement.tagName === 'TEXTAREA' ||\n        (activeElement instanceof HTMLElement && activeElement.isContentEditable))\n    ) {\n      return;\n    }\n\n    //  1-4\n    if (e.key >= '1' && e.key <= '4') {\n      const moduleId = moduleMap[e.key];\n      if (moduleId) {\n        e.preventDefault();\n        switchModule(moduleId);\n        console.log(` : ${moduleId} (${e.key})`);\n      }\n    }\n  });\n}\n\n// ==========  ==========\nexport function initModals() {\n  const modalOverlay = document.getElementById('modal-overlay');\n  const modalClose = document.getElementById('modal-close');\n\n  if (!modalOverlay || !modalClose) return;\n\n  modalClose.addEventListener('click', () => {\n    modalOverlay.classList.remove('active');\n  });\n\n  modalOverlay.addEventListener('click', e => {\n    if (e.target === modalOverlay) {\n      modalOverlay.classList.remove('active');\n    }\n  });\n}\n\n// ==========  ==========\nexport function initAnimations() {\n  //  CSS \n  //  JS \n}\n\n// ==========  ==========\nexport function initStatusCardInteractions() {\n  const statusCards = document.querySelectorAll('.status-card');\n  statusCards.forEach(card => {\n    card.addEventListener('click', () => {\n      // \n      console.log('');\n    });\n  });\n}\n\n// ==========  ==========\n\n/**\n * \n */\ninterface ConversationRound {\n  assistantMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  userMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  summary?: string; //  <sum> \n  pending?: boolean; // AI\n  pendingUserMessage?: string; // \n}\n\n/**\n * \n */\nexport function initChatInterface() {\n  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;\n  const chatSendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;\n  const chatRegenerateBtn = document.getElementById('chat-regenerate-btn') as HTMLButtonElement;\n  const chatRollbackBtn = document.getElementById('chat-rollback-btn') as HTMLButtonElement;\n  const chatMessages = document.getElementById('chat-messages') as HTMLElement;\n\n  if (!chatInput || !chatSendBtn || !chatMessages) {\n    return;\n  }\n\n  // \n  let rounds: ConversationRound[] = [];\n  let currentRoundIndex = -1; // \n\n  // / currentRoundIndex \n  let activePendingRoundIndex: number | null = null;\n\n  function findLastPendingRoundIndex(): number | null {\n    for (let i = rounds.length - 1; i >= 0; i--) {\n      const r = rounds[i];\n      if (r && r.pending) return i;\n    }\n    return null;\n  }\n\n  function getPendingRoundIndexSafe(): number | null {\n    if (\n      activePendingRoundIndex !== null &&\n      activePendingRoundIndex >= 0 &&\n      activePendingRoundIndex < rounds.length &&\n      rounds[activePendingRoundIndex]?.pending\n    ) {\n      return activePendingRoundIndex;\n    }\n    return findLastPendingRoundIndex();\n  }\n\n  // \n  let streamingElement: HTMLElement | null = null;\n\n  // raw\n  let lastStreamedRawMessage: string = '';\n\n  // \n  let isGenerating = false;\n\n  // \n  let isSending = false;\n\n  //  messageGenerator \n  let latestOptions: string[] = [];\n\n  //  message_id rounds  id  id\n  let lastCreatedIds: { userMessageId: number; assistantMessageId: number } | null = null;\n\n  //  generateMessage \n  let generateMessagePromise: Promise<any> | null = null;\n\n  //  regenerateAssistantMessage \n  let regenerateAssistantMessagePromise: Promise<any> | null = null;\n\n  function ensureRegenerateAssistantLoaded(): Promise<any> {\n    if (!regenerateAssistantMessagePromise) {\n      regenerateAssistantMessagePromise = import('./utils/messageGenerator').then(\n        module => module.regenerateAssistantMessage,\n      );\n    }\n    return regenerateAssistantMessagePromise;\n  }\n\n  // \n  function ensureMessageGeneratorLoaded(): Promise<any> {\n    if (!generateMessagePromise) {\n      generateMessagePromise = import('./utils/messageGenerator').then(module => module.generateMessage);\n    }\n    return generateMessagePromise;\n  }\n\n  // \n  function adjustInputHeight() {\n    chatInput.style.height = 'auto';\n    const maxHeight = 80;\n    const newHeight = Math.min(chatInput.scrollHeight, maxHeight);\n    chatInput.style.height = `${newHeight}px`;\n  }\n\n  chatInput.addEventListener('input', adjustInputHeight);\n\n  // HTML\n  function escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // \n  // \n  // 1.  assistant  assistantMessage userMessage\n  // 2.  user \n  // 3.  assistant \n  function groupMessagesIntoRounds(\n    allMessages: Array<{\n      message: string;\n      message_id: number;\n      role: string;\n    }>,\n  ): ConversationRound[] {\n    const rounds: ConversationRound[] = [];\n\n    //  assistant \n    let pendingRound: ConversationRound | null = null;\n\n    // \n    allMessages.forEach(msg => {\n      //  user \n      if (msg.role === 'user') {\n        const round: ConversationRound = {\n          userMessage: {\n            message_id: msg.message_id,\n            message: msg.message,\n          },\n          assistantMessage: null,\n        };\n\n        rounds.push(round);\n        pendingRound = round;\n        return;\n      }\n\n      //  assistant \n      if (msg.role === 'assistant') {\n        //  sum\n        let sum = '';\n        const sumMatch = msg.message.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        // \n        if (pendingRound && !pendingRound.assistantMessage) {\n          pendingRound.assistantMessage = {\n            message_id: msg.message_id,\n            message: msg.message,\n          };\n          if (sum) pendingRound.summary = sum;\n          pendingRound = null;\n        } else {\n          //  /  assistant \n          rounds.push({\n            userMessage: null,\n            assistantMessage: {\n              message_id: msg.message_id,\n              message: msg.message,\n            },\n            summary: sum || undefined,\n          });\n        }\n      }\n    });\n\n    return rounds;\n  }\n\n  // \n  async function displayRound(roundIndex: number) {\n    // \n    if (!isGenerating) {\n      chatMessages.innerHTML = '';\n      streamingElement = null;\n    } else {\n      // \n      const existingMessages = Array.from(chatMessages.children).filter(child => child !== streamingElement);\n      existingMessages.forEach(msg => msg.remove());\n    }\n\n    // AI\n    if (roundIndex < 0 || roundIndex >= rounds.length) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const round = rounds[roundIndex];\n\n    //  user - \n    if (round.userMessage) {\n      renderUserMessage(round.userMessage.message);\n    } else if (round.pendingUserMessage) {\n      // \n      renderUserMessage(round.pendingUserMessage);\n    }\n\n    //  assistant - \n    if (round.assistantMessage) {\n      await renderAssistantMessage(\n        round.assistantMessage.message,\n        round.assistantMessage.message,\n        round.summary, // \n      );\n    } else if (round.pending && isGenerating) {\n      // \n      if (!streamingElement) {\n        showGenerating();\n      }\n      // \n      if (streamingElement && streamingElement.parentNode === chatMessages) {\n        // \n        chatMessages.appendChild(streamingElement);\n      }\n    }\n\n    updateRegenerateButtonState();\n  }\n\n  function updateRegenerateButtonState() {\n    if (!chatRegenerateBtn) return;\n\n    if (isGenerating || isSending) {\n      if (chatRegenerateBtn) chatRegenerateBtn.disabled = true;\n      if (chatRollbackBtn) chatRollbackBtn.disabled = true;\n      return;\n    }\n\n    const round = rounds[currentRoundIndex];\n    const hasUserMessage = !!round && !!round.userMessage && typeof round.userMessage.message_id === 'number';\n    const isNotPending = !!round && !round.pending;\n\n    //  assistantMessage \n    chatRegenerateBtn.disabled = !(hasUserMessage && isNotPending);\n\n    // \n    if (chatRollbackBtn) {\n      chatRollbackBtn.disabled = currentRoundIndex <= 0;\n    }\n  }\n\n  //  assistant \n  async function renderAssistantMessage(content: string, rawMessage: string, summaryText?: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-assistant';\n\n    try {\n      const { extractContinueChoice, extractResult, extractNextChoice, removeSumTags } =\n        await import('./utils/textParser');\n\n      //  rawMessage  maintext maintext \n      const { extractLastMaintext } = await import('./utils/textParser');\n      const maintext = extractLastMaintext(rawMessage);\n\n      //  maintext  maintext \n      const searchText = maintext || rawMessage;\n\n      const continueChoice = extractContinueChoice(searchText);\n      const result = extractResult(searchText);\n      const nextChoice = extractNextChoice(searchText);\n\n      // \n      const columns: Array<{ header: string; content: string; key: string; icon: string }> = [];\n\n      if (continueChoice) {\n        columns.push({\n          header: '',\n          content: continueChoice,\n          key: 'continue',\n          icon: '<i class=\"fas fa-history\" title=\"\"></i>',\n        });\n      }\n      if (result) {\n        columns.push({\n          header: '',\n          content: result,\n          key: 'result',\n          icon: '<i class=\"fas fa-microchip\" title=\"\"></i>',\n        });\n      }\n      if (nextChoice) {\n        columns.push({\n          header: '',\n          content: nextChoice,\n          key: 'next',\n          icon: '<i class=\"fas fa-bolt\" title=\"\"></i>',\n        });\n      }\n\n      if (columns.length > 0) {\n        // 1-3\n        const columnsHtml = columns\n          .map(\n            col => `\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">${col.icon}</div>\n            <div class=\"message-column-content\">${escapeHtml(col.content)}</div>\n          </div>\n        `,\n          )\n          .join('');\n\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\">\n              ${columnsHtml}\n            </div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      } else {\n        //  <sum> \n        const displayContent = removeSumTags(content);\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      }\n\n      //  messageItem \n      if (summaryText) {\n        const summaryCard = await createSummaryCardElement(summaryText);\n        if (summaryCard) {\n          messageItem.appendChild(summaryCard);\n        }\n      }\n    } catch (error) {\n      console.error(' :', error);\n      const { removeSumTags } = await import('./utils/textParser');\n      const displayContent = removeSumTags(content);\n      messageItem.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n          <div class=\"message-time\"></div>\n        </div>\n      `;\n    }\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  //  user \n  function renderUserMessage(content: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-user';\n\n    // \n    messageItem.innerHTML = `\n      <div class=\"message-bubble\">\n        <div class=\"message-content\">${escapeHtml(content)}</div>\n        <div class=\"message-time\"></div>\n      </div>\n    `;\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  //  summary \n  async function createSummaryCardElement(sumText: string): Promise<HTMLElement | null> {\n    if (!sumText) return null;\n\n    try {\n      const { parseSummary } = await import('./utils/textParser');\n      const sumObj = parseSummary(sumText);\n\n      if (Object.keys(sumObj).length === 0) return null;\n\n      const summaryCard = document.createElement('div');\n      summaryCard.className = 'summary-card';\n\n      // \n      const labelIcons: Record<string, string> = {\n        : 'fa-clock',\n        Time: 'fa-clock',\n        : 'fa-location-dot',\n        Location: 'fa-location-dot',\n        : 'fa-users',\n        Characters: 'fa-users',\n        : 'fa-star',\n        Event: 'fa-star',\n      };\n\n      let innerHTML = '<div class=\"summary-content\">';\n      for (const [key, value] of Object.entries(sumObj)) {\n        const icon = labelIcons[key] || 'fa-info-circle';\n        innerHTML += `\n          <div class=\"summary-item\">\n            <span class=\"summary-label\"><i class=\"fas ${icon}\"></i> ${escapeHtml(key)}</span>\n            <span class=\"summary-value\">${escapeHtml(value)}</span>\n          </div>\n        `;\n      }\n      innerHTML += '</div>';\n\n      summaryCard.innerHTML = innerHTML;\n      return summaryCard;\n    } catch (error) {\n      console.error('  summary :', error);\n      return null;\n    }\n  }\n\n  // \n  async function loadChatHistory() {\n    try {\n      const lastMessageId = getLastMessageId();\n\n      const allMessages = lastMessageId >= 0 ? getChatMessages(`0-${lastMessageId}`) : [];\n      const newRounds = groupMessagesIntoRounds(allMessages);\n\n      rounds = newRounds;\n\n      // \n      if (rounds.length > 0) {\n        currentRoundIndex = rounds.length - 1;\n        if (!isGenerating) {\n          await displayRound(currentRoundIndex);\n        }\n      }\n\n      console.log(' ', rounds.length, '', currentRoundIndex + 1, '');\n    } catch (error) {\n      console.error(':', error);\n    }\n  }\n\n  // \n  async function refreshDisplay() {\n    await loadChatHistory();\n  }\n\n  // \n  function setupKeyboardNavigation() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const keyHandler = (e: KeyboardEvent) => {\n      // \n      if (!communicationModule.classList.contains('active')) return;\n      if (document.activeElement === chatInput) return;\n\n      if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        goToPreviousRound();\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        goToNextRound();\n      } else if (e.key === 'o' || e.key === 'O') {\n        // O \n        e.preventDefault();\n        const showOptionsBtn = document.getElementById('chat-show-options-btn') as HTMLButtonElement;\n        if (showOptionsBtn) {\n          showOptionsBtn.click();\n        }\n      }\n    };\n\n    document.addEventListener('keydown', keyHandler);\n  }\n\n  // \n  async function sendMessage() {\n    // \n    if (isSending) {\n      console.warn(' ');\n      return;\n    }\n\n    const message = chatInput.value.trim();\n    if (!message) {\n      return;\n    }\n\n    // \n    isSending = true;\n\n    chatInput.value = '';\n    adjustInputHeight();\n\n    // \n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n\n    // \n    isGenerating = true;\n    updateRegenerateButtonState();\n\n    //  sendMessage \n    //  generateMessage  loadChatHistory \n\n    try {\n      const generateMessage = await ensureMessageGeneratorLoaded();\n      console.log(' :', message);\n\n      const success = await generateMessage(message, {\n        onShowGenerating: () => {\n          // \n          if (!streamingElement) {\n            showGenerating();\n          }\n        },\n        onHideGenerating: () => {\n          //  DOM \n          //  onRefreshStory -> finalizeStreamingAsAssistant \n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error(' :', error);\n          hideGenerating();\n          isGenerating = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          isSending = false;\n\n          //  pending \n          const idx = getPendingRoundIndexSafe();\n          const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n          if (r && r.pending) {\n            r.pending = false;\n            if (lastCreatedIds) {\n              r.userMessage = {\n                message_id: lastCreatedIds.userMessageId,\n                message: r.pendingUserMessage || '',\n              };\n            }\n            delete r.pendingUserMessage;\n          }\n          updateRegenerateButtonState(); // \n        },\n        onStreamingUpdate: (text: string) => {\n          // /\n          updateStreamingMessage(text);\n\n          //  Dashboard \n          const dashboardElement = document.getElementById('main-screen');\n          dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext', { detail: { message: text } }));\n        },\n        onRefreshStoryIfOpen: (userMessage: string) => {\n          // user pending\n          console.log(' user :', userMessage);\n\n          // \n          isGenerating = true;\n\n          // pending\n          const pendingRound: ConversationRound = {\n            assistantMessage: null,\n            userMessage: null,\n            pending: true,\n            pendingUserMessage: userMessage,\n          };\n\n          // pendingrounds\n          rounds.push(pendingRound);\n          currentRoundIndex = rounds.length - 1;\n          activePendingRoundIndex = currentRoundIndex;\n\n          // \n          displayRound(currentRoundIndex);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          // assistant \n          console.log(' assistant ');\n\n          if (options && options.length > 0) {\n            latestOptions = options;\n          } else {\n            latestOptions = [];\n          }\n\n          //   finalize\n          //  raw  finalize '' finalize \n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          //  message_id  id/\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.userMessage) r.userMessage.message_id = lastCreatedIds.userMessageId;\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          //   loadChatHistory()\n\n          // \n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(\n                new CustomEvent('refresh-maintext', { detail: { message: lastStreamedRawMessage } }),\n              );\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          lastCreatedIds = ids;\n        },\n      });\n\n      if (success) {\n        console.log(' ');\n        //  onRefreshStory \n        //  AI \n      }\n    } catch (error) {\n      console.error(' :', error);\n      hideGenerating();\n      isGenerating = false;\n      // \n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      isSending = false;\n      updateRegenerateButtonState();\n    }\n    //  finally  onRefreshStory \n    //  AI \n  }\n\n  //  assistant  generate  assistant \n  async function regenerateCurrentRound() {\n    if (!chatRegenerateBtn) return;\n    if (isGenerating || isSending) return;\n\n    const round = rounds[currentRoundIndex];\n    if (!round?.userMessage) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const userMessageId = round.userMessage.message_id;\n    const assistantMessageId = round.assistantMessage?.message_id;\n\n    if (typeof userMessageId !== 'number' || !Number.isFinite(userMessageId)) return;\n\n    // UI \n    isSending = true;\n    isGenerating = true;\n    lastStreamedRawMessage = '';\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n    chatRegenerateBtn.disabled = true;\n    if (chatRollbackBtn) chatRollbackBtn.disabled = true;\n\n    //  pending userMessage assistantMessage\n    round.assistantMessage = null;\n    round.pending = true;\n    activePendingRoundIndex = currentRoundIndex;\n    await displayRound(currentRoundIndex);\n\n    try {\n      if (typeof assistantMessageId === 'number' && Number.isFinite(assistantMessageId)) {\n        await deleteChatMessages([assistantMessageId], { refresh: 'none' });\n        console.log('  assistant :', assistantMessageId);\n\n        // \n        const dashboardElement = document.getElementById('main-screen');\n        dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n      } else {\n        console.log('  assistant ');\n      }\n\n      const regenerateAssistantMessage = await ensureRegenerateAssistantLoaded();\n\n      await regenerateAssistantMessage(userMessageId, {\n        onShowGenerating: () => {\n          if (!streamingElement) showGenerating();\n        },\n        onHideGenerating: () => {\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error(' :', error);\n          hideGenerating();\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          round.pending = false;\n          updateRegenerateButtonState();\n          // \n          loadChatHistory();\n        },\n        onStreamingUpdate: (text: string) => {\n          updateStreamingMessage(text);\n\n          //  Dashboard \n          const dashboardElement = document.getElementById('main-screen');\n          dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext', { detail: { message: text } }));\n        },\n        onRefreshStory: async (options?: string[]) => {\n          console.log(' assistant ');\n\n          latestOptions = options && options.length > 0 ? options : [];\n\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          //  assistant  assistantMessageId\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          //  pending\n          round.pending = false;\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(\n                new CustomEvent('refresh-maintext', { detail: { message: lastStreamedRawMessage } }),\n              );\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          // regenerate  assistant userMessageId\n          lastCreatedIds = ids;\n        },\n      });\n    } catch (e) {\n      console.error(' :', e);\n      hideGenerating();\n      round.pending = false;\n      isGenerating = false;\n      isSending = false;\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      updateRegenerateButtonState();\n      loadChatHistory();\n    }\n  }\n\n  /**\n   * User + Assistant\n   */\n  async function rollbackToPreviousRound() {\n    if (isGenerating || isSending) return;\n\n    // \n    const round = rounds[currentRoundIndex];\n    if (!round) return;\n\n    // \n    if (rounds.length <= 1) {\n      console.warn(' ');\n      return;\n    }\n\n    const idsToDelete: number[] = [];\n    if (round.assistantMessage?.message_id && typeof round.assistantMessage.message_id === 'number') {\n      idsToDelete.push(round.assistantMessage.message_id);\n    }\n    if (round.userMessage?.message_id && typeof round.userMessage.message_id === 'number') {\n      idsToDelete.push(round.userMessage.message_id);\n    }\n\n    //  pending \n    if (round.pending && lastCreatedIds?.userMessageId) {\n      idsToDelete.push(lastCreatedIds.userMessageId);\n    }\n\n    if (idsToDelete.length === 0) {\n      console.warn('  ID');\n      //  ID\n      rounds.splice(currentRoundIndex, 1);\n      currentRoundIndex = Math.max(0, rounds.length - 1);\n      await displayRound(currentRoundIndex);\n      updateRegenerateButtonState();\n      return;\n    }\n\n    // \n    if (!confirm('')) {\n      return;\n    }\n\n    try {\n      // UI \n      isSending = true;\n      chatSendBtn.disabled = true;\n      chatInput.disabled = true;\n      if (chatRegenerateBtn) chatRegenerateBtn.disabled = true;\n      if (chatRollbackBtn) chatRollbackBtn.disabled = true;\n\n      // 1. \n      await deleteChatMessages(idsToDelete, { refresh: 'none' });\n      console.log(' :', idsToDelete);\n\n      // 2. \n      rounds.splice(currentRoundIndex, 1);\n\n      // 3. \n      currentRoundIndex = Math.max(0, rounds.length - 1);\n\n      // 4. \n      latestOptions = [];\n\n      // 5. \n      await displayRound(currentRoundIndex);\n\n      // 6. \n      const dashboardElement = document.getElementById('main-screen');\n      dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n      dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n\n      // 7. \n      setTimeout(() => {\n        showOptionsOverlay();\n      }, 300);\n\n      console.log(' ');\n    } catch (error) {\n      console.error(' :', error);\n      alert('');\n    } finally {\n      isSending = false;\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      updateRegenerateButtonState();\n    }\n  }\n\n  // \n  function showGenerating() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant message-streaming';\n      streamingElement.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content message-content-three-columns\"></div>\n        </div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // \n  function hideGenerating() {\n    if (streamingElement) {\n      streamingElement.remove();\n      streamingElement = null;\n    }\n  }\n\n  // \n  async function finalizeStreamingAsAssistant(finalText: string) {\n    //  streamingElement  rounds  race\n    //  DOM \n    if (streamingElement) {\n      try {\n        //  finalText \n        let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) {\n          //  updateColumnsFromStream \n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content message-content-three-columns\"></div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n          columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        }\n\n        //  finalText \n        await updateColumnsFromStream(finalText, columnsContainer);\n      } catch (err) {\n        //  <sum> \n        console.error(' finalize  DOM :', err);\n        const { removeSumTags } = await import('./utils/textParser');\n        const displayContent = removeSumTags(finalText);\n        if (streamingElement) {\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n        }\n      }\n\n      // \n      streamingElement.classList.remove('message-streaming');\n      const timeEl = streamingElement.querySelector('.message-time');\n      if (timeEl) timeEl.textContent = '';\n    }\n\n    //  rounds  finalText\n    //  currentRoundIndex\n    const pendingIdx = getPendingRoundIndexSafe();\n    if (typeof pendingIdx === 'number' && pendingIdx >= 0 && pendingIdx < rounds.length) {\n      const targetRound = rounds[pendingIdx];\n      if (targetRound && targetRound.pending) {\n        //  sum\n        let sum = '';\n        const sumMatch = finalText.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        //  pending finalText  assistantMessage\n        targetRound.assistantMessage = {\n          //  id id \n          message_id: Date.now(),\n          message: finalText || (streamingElement ? streamingElement.textContent || '' : ''),\n        };\n\n        if (sum) targetRound.summary = sum;\n\n        //  pendingUserMessage ->  userMessage id\n        if (targetRound.pendingUserMessage) {\n          targetRound.userMessage = {\n            message_id: Date.now() - 1,\n            message: targetRound.pendingUserMessage,\n          };\n        }\n\n        targetRound.pending = false;\n        delete targetRound.pendingUserMessage;\n\n        //  sum summary \n        if (sum && streamingElement) {\n          const summaryCard = await createSummaryCardElement(sum);\n          if (summaryCard) {\n            streamingElement.appendChild(summaryCard);\n          }\n        }\n      }\n    } else {\n      console.warn(' finalize:  pending ');\n    }\n\n    //   displayRound()  DOM\n    //  chatMessages //\n    //  rounds \n    streamingElement = null;\n    activePendingRoundIndex = null;\n  }\n\n  // /\n  async function updateStreamingMessage(text: string) {\n    //  finalize \n    lastStreamedRawMessage = text;\n\n    if (!streamingElement) {\n      // \n      showGenerating();\n    }\n\n    if (!streamingElement) return;\n\n    try {\n      // \n      let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n      if (!columnsContainer) {\n        streamingElement.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\"></div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n        columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) return;\n      }\n\n      await updateColumnsFromStream(text, columnsContainer);\n    } catch (error) {\n      console.error(' :', error);\n    }\n  }\n\n  // /\n  async function updateColumnsFromStream(text: string, container: HTMLElement) {\n    // \n    const columnConfigs = [\n      {\n        tag: 'continue_choice',\n        header: '<i class=\"fas fa-history\" title=\"\"></i>',\n        key: 'continue',\n      },\n      {\n        tag: 'result',\n        header: '<i class=\"fas fa-microchip\" title=\"\"></i>',\n        key: 'result',\n      },\n      {\n        tag: 'decision_node',\n        header: '<i class=\"fas fa-bolt\" title=\"\"></i>',\n        key: 'next',\n      },\n    ];\n\n    // \n    for (const config of columnConfigs) {\n      const startTag = `<${config.tag}>`;\n      const endTag = `</${config.tag}>`;\n\n      // \n      let columnElement = container.querySelector(`[data-column-key=\"${config.key}\"]`) as HTMLElement;\n\n      // \n      if (columnElement) {\n        const isClosed = columnElement.hasAttribute('data-closed');\n        if (isClosed) {\n          // \n          continue;\n        }\n      }\n\n      // \n      const startIndex = text.indexOf(startTag);\n      if (startIndex === -1) {\n        // \n        continue;\n      }\n\n      // \n      const contentStart = startIndex + startTag.length;\n      const endIndex = text.indexOf(endTag, contentStart);\n\n      let content = '';\n\n      if (endIndex !== -1) {\n        // \n        content = text.substring(contentStart, endIndex);\n\n        // \n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n\n        // \n        columnElement.setAttribute('data-closed', 'true');\n      } else {\n        // \n        content = text.substring(contentStart);\n\n        // \n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n      }\n\n      //  HTML\n      const contentElement = columnElement.querySelector('.message-column-content') as HTMLElement;\n      if (contentElement) {\n        // \n        const oldScrollTop = contentElement.scrollTop;\n        const oldScrollHeight = contentElement.scrollHeight;\n        const wasAtBottom = oldScrollTop + contentElement.clientHeight >= oldScrollHeight - 10;\n\n        // \n        contentElement.textContent = content;\n\n        // \n        if (wasAtBottom) {\n          // \n          contentElement.scrollTop = contentElement.scrollHeight;\n        } else {\n          // \n          const newScrollHeight = contentElement.scrollHeight;\n          if (newScrollHeight > oldScrollHeight) {\n            // \n            contentElement.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);\n          } else {\n            // \n            contentElement.scrollTop = oldScrollTop;\n          }\n        }\n      }\n    }\n  }\n\n  // \n  function goToPreviousRound() {\n    if (currentRoundIndex > 0) {\n      currentRoundIndex--;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // \n  function goToNextRound() {\n    if (currentRoundIndex < rounds.length - 1) {\n      currentRoundIndex++;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ========== Option  ==========\n  const optionsOverlay = document.getElementById('chat-options-overlay');\n  const optionsContainer = document.getElementById('chat-options-container');\n  const optionsList = document.getElementById('chat-options-list');\n  const showOptionsBtn = document.getElementById('chat-show-options-btn');\n  const closeOptionsBtn = document.getElementById('chat-options-close');\n\n  // \n  async function getOptionsFromLatestMessage(): Promise<string[]> {\n    try {\n      //  messageGenerator \n      if (latestOptions.length > 0) {\n        console.log('  messageGenerator ');\n        return latestOptions;\n      }\n\n      //  assistant  data \n      const messages = getChatMessages(-1, { role: 'assistant' });\n      const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n      if (!lastMessage) {\n        return [];\n      }\n\n      if (lastMessage.data?.__options && lastMessage.data.__options.length > 0) {\n        console.log('  assistant.data ');\n        return lastMessage.data.__options;\n      }\n\n      // \n      const { extractAllOptions } = await import('./utils/textParser');\n      const messageContent = lastMessage.message || '';\n      const options = extractAllOptions(messageContent);\n      if (options.length > 0) {\n        console.log(' ');\n      }\n      return options;\n    } catch (error) {\n      console.error(' :', error);\n      return [];\n    }\n  }\n\n  // \n  async function showOptionsOverlay() {\n    if (!optionsOverlay || !optionsContainer || !optionsList) {\n      return;\n    }\n\n    const options = await getOptionsFromLatestMessage();\n\n    if (options.length === 0) {\n      // option\n      showNoOptionsMessage();\n      return;\n    }\n\n    // \n    optionsList.innerHTML = '';\n\n    // \n    optionsList.classList.remove('collapse');\n\n    // \n    optionsList.style.position = 'absolute';\n    optionsList.style.top = '0';\n    optionsList.style.left = '0';\n    optionsList.style.right = '0';\n    optionsList.style.bottom = '0';\n    optionsList.style.width = '100%';\n    optionsList.style.height = '100%';\n    //  list  hover hover / CSS \n    //  click handler  list  overlay \n    optionsList.style.pointerEvents = 'auto';\n\n    //  overlay \n    if (!optionsOverlay) return;\n\n    // \n    const usedPositions: Array<{ x: number; y: number }> = [];\n    const minDistance = 150; // \n\n    // \n    function generateRandomPosition(): { x: number; y: number } {\n      const maxAttempts = 50;\n      let attempts = 0;\n      const margin = 0.15; // 15%\n\n      while (attempts < maxAttempts) {\n        // \n        const x = margin + Math.random() * (1 - 2 * margin);\n        const y = margin + Math.random() * (1 - 2 * margin);\n\n        // \n        const tooClose = usedPositions.some(pos => {\n          const overlayWidth = optionsOverlay!.clientWidth;\n          const overlayHeight = optionsOverlay!.clientHeight;\n          const dx = (x - pos.x) * overlayWidth;\n          const dy = (y - pos.y) * overlayHeight;\n          const distance = Math.sqrt(dx * dx + dy * dy);\n          return distance < minDistance;\n        });\n\n        if (!tooClose) {\n          usedPositions.push({ x, y });\n          return { x, y };\n        }\n\n        attempts++;\n      }\n\n      // \n      const x = margin + Math.random() * (1 - 2 * margin);\n      const y = margin + Math.random() * (1 - 2 * margin);\n      usedPositions.push({ x, y });\n      return { x, y };\n    }\n\n    // \n    options.forEach((optionText, index) => {\n      // \n      const delay = index * 80; // \n\n      setTimeout(() => {\n        // STEP 1:  + \n        const chatOption = document.createElement('div');\n        chatOption.className = 'chat-option';\n\n        const optionButton = document.createElement('button');\n        optionButton.type = 'button';\n        optionButton.className = 'chat-option-button';\n\n        const optionTextSpan = document.createElement('span');\n        optionTextSpan.className = 'chat-option-text';\n        optionTextSpan.textContent = optionText;\n        optionButton.title = optionText;\n\n        optionButton.appendChild(optionTextSpan);\n        chatOption.appendChild(optionButton);\n\n        // \n        const position = generateRandomPosition();\n        const rotate = (Math.random() - 0.5) * 30; // -15  15 \n\n        chatOption.style.setProperty('--rot', `${rotate}deg`);\n        chatOption.style.left = `${position.x * 100}%`;\n        chatOption.style.top = `${position.y * 100}%`;\n        chatOption.style.position = 'absolute';\n        chatOption.style.pointerEvents = 'auto'; // \n\n        // \"\"\n        const weight = options.length - index;\n        // \n        optionButton.style.opacity = `${0.85 + weight * 0.03}`;\n        // \n        optionButton.style.filter = 'none';\n\n        // \n        optionButton.addEventListener('click', () => {\n          optionButton.classList.add('selected');\n          chatOption.classList.add('selected-parent');\n          optionsList.classList.add('collapse');\n\n          setTimeout(() => {\n            chatInput.value = optionText;\n            adjustInputHeight();\n            sendMessage();\n            hideOptionsOverlay();\n          }, 220);\n        });\n\n        optionsList.appendChild(chatOption);\n\n        // \"\"\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            chatOption.classList.add('show');\n          });\n        });\n      }, delay);\n    });\n\n    optionsOverlay.classList.add('active');\n    console.log(`  ${options.length} `);\n  }\n\n  // \n  function showNoOptionsMessage() {\n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'chat-no-options-message';\n    messageDiv.innerHTML = `\n      <div class=\"chat-no-options-content\">\n        <div class=\"chat-no-options-text\"> qwq</div>\n        <button type=\"button\" class=\"chat-no-options-close\" title=\"\"></button>\n      </div>\n    `;\n\n    const closeBtn = messageDiv.querySelector('.chat-no-options-close');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        hideOptionsOverlay();\n      });\n    }\n\n    // \n    if (optionsList) {\n      optionsList.innerHTML = '';\n      // \n      optionsList.style.position = 'absolute';\n      optionsList.style.top = '50%';\n      optionsList.style.left = '50%';\n      optionsList.style.transform = 'translate(-50%, -50%)';\n      optionsList.style.width = 'auto';\n      optionsList.style.height = 'auto';\n      optionsList.style.pointerEvents = 'auto';\n      optionsList.classList.remove('collapse');\n      optionsList.appendChild(messageDiv);\n    }\n\n    // \n    if (optionsOverlay) {\n      optionsOverlay.classList.add('active');\n    }\n  }\n\n  // \n  function hideOptionsOverlay() {\n    if (optionsOverlay) {\n      optionsOverlay.classList.remove('active');\n    }\n    //  collapse \n    if (optionsList) {\n      optionsList.classList.remove('collapse');\n    }\n  }\n\n  // \n  if (showOptionsBtn) {\n    showOptionsBtn.addEventListener('click', showOptionsOverlay);\n  }\n\n  if (closeOptionsBtn) {\n    closeOptionsBtn.addEventListener('click', hideOptionsOverlay);\n  }\n\n  if (optionsOverlay) {\n    optionsOverlay.addEventListener('click', e => {\n      // \n      // - target  overlay\n      // -  target  list list \n      if (e.target === optionsOverlay || e.target === optionsList) {\n        hideOptionsOverlay();\n      }\n    });\n  }\n\n  // \n  chatSendBtn.addEventListener('click', sendMessage);\n\n  // \n  if (chatRegenerateBtn) {\n    chatRegenerateBtn.addEventListener('click', regenerateCurrentRound);\n  }\n\n  // \n  if (chatRollbackBtn) {\n    chatRollbackBtn.addEventListener('click', rollbackToPreviousRound);\n  }\n\n  //  Enter Shift+Enter \n  chatInput.addEventListener('keydown', e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n\n  // \n  setupKeyboardNavigation();\n\n  // \n  function setupModuleSwitchListener() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const observer = new MutationObserver(() => {\n      if (communicationModule.classList.contains('active')) {\n        console.log(' ');\n        refreshDisplay();\n      }\n    });\n\n    observer.observe(communicationModule, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // \n  loadChatHistory();\n\n  // \n  setupModuleSwitchListener();\n}\n","//  - \nimport { PageManager } from './utils/pageManager';\nimport { initNavigation, initModals, initAnimations, initStatusCardInteractions, initChatInterface } from './dashboardLogic';\n\nlet pageManager: PageManager | null = null;\n\n/**\n * \n */\nfunction initApp() {\n  const appContainer = document.getElementById('app');\n  if (!appContainer) {\n    console.error(' #app ');\n    return;\n  }\n\n  // \n  pageManager = new PageManager(appContainer);\n  pageManager.initialize();\n\n  // \n  const mainScreen = document.getElementById('main-screen');\n  if (mainScreen) {\n    const observer = new MutationObserver(() => {\n      if (mainScreen.classList.contains('active')) {\n        // DOM\n        setTimeout(() => {\n          initDashboardFeatures();\n        }, 100);\n      }\n    });\n\n    observer.observe(mainScreen, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // \n  eventOn(tavern_events.MESSAGE_UPDATED, () => {\n    if (pageManager) {\n      const dashboard = pageManager.getDashboard();\n      // \n      // \n      console.info('');\n    }\n  });\n}\n\n/**\n * \n */\nfunction initDashboardFeatures() {\n  // \n  if (document.querySelector('.nav-item[data-module=\"status\"]')?.hasAttribute('data-initialized')) {\n    return;\n  }\n\n  initNavigation();\n  initModals();\n  initAnimations();\n  initStatusCardInteractions();\n  initChatInterface();\n\n  // \n  document.querySelectorAll('.nav-item').forEach(item => {\n    item.setAttribute('data-initialized', 'true');\n  });\n\n  console.info('');\n}\n\n//  jQuery \n$(() => {\n  errorCatched(initApp)();\n});\n\n// \n$(window).on('pagehide', () => {\n  console.info('');\n  if (pageManager) {\n    // \n  }\n});\n","// \nimport './styles.css';\n\n// \nfunction init() {\n  //  FontAwesome CSS\n  if (!document.querySelector('link[href*=\"font-awesome\"]')) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';\n    document.head.appendChild(link);\n  }\n\n  //  meta \n  if (!document.querySelector('meta[charset]')) {\n    const charset = document.createElement('meta');\n    charset.setAttribute('charset', 'UTF-8');\n    document.head.appendChild(charset);\n  }\n\n  if (!document.querySelector('meta[name=\"viewport\"]')) {\n    const viewport = document.createElement('meta');\n    viewport.setAttribute('name', 'viewport');\n    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');\n    document.head.appendChild(viewport);\n  }\n\n  // \n  document.title = '';\n\n  // \n  if (!document.querySelector('meta[name=\"description\"]')) {\n    const description = document.createElement('meta');\n    description.setAttribute('name', 'description');\n    description.setAttribute('content', ' -  - ');\n    document.head.appendChild(description);\n  }\n}\n\n//  jQuery \n$(() => {\n  init();\n  console.info('');\n});\n\n// \n$(window).on('pagehide', () => {\n  console.info('');\n});\n\n// \nimport './app';\n"],"names":["checkGenerateAvailable","generate","window","async","regenerateAssistantMessage","userMessageId","callbacks","onShowGenerating","streamingHandler","eventOn","iframe_events","STREAM_TOKEN_RECEIVED_FULLY","fullText","cleanedText","trim","length","onStreamingUpdate","console","log","Error","generatePromise","should_stream","timeoutPromise","Promise","_","reject","setTimeout","result","race","cleanedResult","onHideGenerating","onError","maintext","extractLastMaintext","option","sum","updateVariable","finalMessage","base","userMsg","getChatMessages","data","role","Mvu","getMvuData","type","message_id","stat_data","display_data","delta_data","finalData","parseMessage","parsed","e","warn","extractedOptions","extractAllOptions","maintextContent","sumContent","messageToSave","includes","createChatMessages","message","__options","refresh","assistantMessageId","getLastMessageId","onCreatedMessages","onRefreshStory","error","generateMessage","userInput","messages","openingMsg","options","cleanedMessage","setChatMessages","cleanOpeningMessage","mvu_data","waitGlobalInitialized","initData","latestData","chatData","getBaseMvuData","checkAndRefresh","retries","checkMessageId","onRefreshStoryIfOpen","createError","String","substring","generateError","errorType","errorMessage","errorStack","stack","undefined","userMessage","module","exports","initializeGameData","config","currentMvuData","currentStatData","updatedStatData","reserve","system_state","antimatter","clampedReserve","info","updatedMvuData","replaceMvuData","updateMvuVariables","gameData","station_name","difficulty","resources","energy","supplies","crew","status","life_support","system","personnel","communication","laboratory","storage","computing","tasks","diary","currentData","getVariables","updatedData","game_data","replaceVariables","updateGameData","game_config","updateGameConfig","removeThinkingTags","text","lastResult","replace","removeThinkingTagsFromStream","cleaned","lastThinkingStart","lastIndexOf","removeSumTags","removeOptionTags","removeSuboptionTags","parseSummary","sumText","split","forEach","part","match","key","value","matches","contentMatch","extractContinueChoice","extractResult","extractNextChoice","extractLastOption","suboptionMatches","content","push","optionMatches","lines","map","line","filter","extractLastSum","extractLastUpdateVariable","validateMessage","messageContent","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","hasSaveData","lastMessageId","SplashScreen","element","constructor","this","createElement","div","document","className","id","innerHTML","getHTML","bindEvents","updateContinueButton","show","classList","add","hide","remove","destroy","$","off","keyDownHandler","removeEventListener","continueButton","querySelector","style","display","newGameButton","addEventListener","onNewGame","onContinue","fullscreenButton","requestFullscreen","contains","preventDefault","documentElement","catch","err","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","NewGameSetup","reserveInput","getConfig","updateMvuVariable","confirmButton","inputValue","toastr","parseInt","isNaN","Number","isInteger","onConfirm","cancelButton","onCancel","Math","max","min","showdown","YAML","Dashboard","mvuUpdateListener","statusRetryCount","statusRetryTimer","markdownConverter","netCategories","netReport","expandedSections","Set","selectedItem","tables","strikethrough","tasklists","simpleLineBreaks","ghCodeBlocks","openLinksInNewWindow","refreshData","fallbackDiv","stop","clearTimeout","updateStatusCards","updateTasksList","updateNetContent","loadMaintextFromChat","loadNetFromWorldbook","statusGrid","timeout","intervalBetweenAttempts","chatSystemState","latestSystemState","initSystemState","latest","initMsg","systemState","cycle","system_pressure","instability","population","cards","leakRisk","leak_risk","reservePercent","round","riskLevel","toLocaleString","toFixed","pop","active","standby","archived","total","pressure","pressurePercent","pressureLevel","instabilityPercent","instabilityLevel","join","tasksList","Array","isArray","getDefaultTasks","task","getTaskIcon","escapeHtml","title","getStatusText","time","priority","getPriorityText","description","netContainer","sidebarHtml","cat","renderSidebarSection","label","items","reportSidebarHtml","renderNetViewer","bindNetSidebarEvents","categoryId","editor","on","target","saveReportToVariables","isExpanded","has","icon","itemsHtml","item","index","renderMarkdown","makeHtml","category","find","c","author","sectionId","currentTarget","closest","attr","delete","NET_ENTRY_REGEX","worldbook","getWorldbook","newCategories","entry","name","alias","parse","gameVariables","player_report","updateStatDataVariable","updateChatMessages","getDefaultMessages","textContent","parseMaintext","maintextMatch","updateMaintextDisplay","then","el","continueChoice","nextChoice","continueChoiceArea","resultArea","nextChoiceArea","lastMessage","setupMessageListener","tavern_events","handleMessageReceived","MESSAGE_RECEIVED","CHAT_CHANGED","MESSAGE_UPDATED","latestMessage","detail","toggleFullscreen","setupEnterKeyFullscreen","events","VARIABLE_UPDATE_ENDED","activeElement","tagName","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","fullscreenElement","PageManager","currentPage","splashScreen","setupScreen","dashboard","appContainer","onStart","goToSplash","goToSetup","goToGame","handleConfirm","onFullscreenToggle","initialize","appendChild","showPage","page","dashboardElement","getElementById","variables","continueGame","fallbackError","initializeNewGame","success","getDashboard","initChatInterface","chatInput","chatSendBtn","chatRegenerateBtn","chatRollbackBtn","chatMessages","rounds","currentRoundIndex","activePendingRoundIndex","getPendingRoundIndexSafe","pending","i","r","findLastPendingRoundIndex","streamingElement","lastStreamedRawMessage","isGenerating","isSending","latestOptions","lastCreatedIds","generateMessagePromise","regenerateAssistantMessagePromise","adjustInputHeight","height","newHeight","scrollHeight","displayRound","roundIndex","from","children","child","msg","updateRegenerateButtonState","renderUserMessage","pendingUserMessage","assistantMessage","rawMessage","summaryText","messageItem","searchText","columns","header","columnsHtml","col","displayContent","summaryCard","createSummaryCardElement","renderAssistantMessage","summary","showGenerating","parentNode","disabled","hasUserMessage","isNotPending","sumObj","keys","labelIcons","Time","Location","Characters","Event","entries","loadChatHistory","newRounds","allMessages","pendingRound","sumMatch","groupMessagesIntoRounds","sendMessage","timeEl","hideGenerating","idx","updateStreamingMessage","dispatchEvent","CustomEvent","finalizeStreamingAsAssistant","debug","ids","finalText","columnsContainer","updateColumnsFromStream","pendingIdx","targetRound","Date","now","container","columnConfigs","tag","startTag","endTag","columnElement","hasAttribute","startIndex","indexOf","contentStart","endIndex","setAttribute","headerElement","contentElement","oldScrollTop","scrollTop","oldScrollHeight","wasAtBottom","clientHeight","newScrollHeight","optionsOverlay","optionsContainer","optionsList","showOptionsBtn","closeOptionsBtn","showOptionsOverlay","getOptionsFromLatestMessage","messageDiv","closeBtn","hideOptionsOverlay","position","top","left","transform","width","pointerEvents","showNoOptionsMessage","right","bottom","usedPositions","optionText","chatOption","optionButton","optionTextSpan","attempts","margin","x","random","y","some","pos","overlayWidth","clientWidth","overlayHeight","dx","dy","sqrt","generateRandomPosition","rotate","setProperty","weight","opacity","requestAnimationFrame","isFinite","deleteChatMessages","idsToDelete","splice","confirm","alert","shiftKey","communicationModule","click","setupKeyboardNavigation","MutationObserver","refreshDisplay","observe","attributes","attributeFilter","setupModuleSwitchListener","pageManager","initApp","mainScreen","navItems","querySelectorAll","modules","switchModule","nav","targetNavItem","targetModule","getAttribute","moduleMap","HTMLElement","isContentEditable","initNavigation","modalOverlay","modalClose","initModals","card","initDashboardFeatures","errorCatched","link","rel","href","head","charset","viewport","init"],"ignoreList":[],"sourceRoot":""}