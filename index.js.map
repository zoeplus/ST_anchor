{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/anchor/utils/messageGenerator.ts","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/anchor/utils/textParser.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/anchor/utils/variableReader.ts","src://tavern_helper_template/src/anchor/components/SplashScreen.ts","src://tavern_helper_template/src/anchor/components/NewGameSetup.ts","src://tavern_helper_template/src/anchor/components/Dashboard.ts","src://tavern_helper_template/src/anchor/utils/variableUpdater.ts","src://tavern_helper_template/src/anchor/utils/pageManager.ts","src://tavern_helper_template/src/anchor/utils/gameInitializer.ts","src://tavern_helper_template/src/anchor/dashboardLogic.ts","src://tavern_helper_template/src/anchor/app.ts","src://tavern_helper_template/src/anchor/index.ts"],"sourcesContent":["/**\n * æ¶ˆæ¯ç”ŸæˆæœåŠ¡\n * å¤„ç†å®Œæ•´çš„æ¶ˆæ¯ç”Ÿæˆæµç¨‹ï¼šæ„å»ºæç¤ºè¯ -> åˆ›å»º user æ¶ˆæ¯ -> è°ƒç”¨ LLM -> è§£æç»“æœ -> åˆ›å»º assistant æ¶ˆæ¯\n */\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function createChatMessages(\n  messages: Array<{ role: 'user' | 'assistant' | 'system'; message: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function generate(config: { user_input?: string; should_stream?: boolean }): Promise<string>;\n\n// æ£€æŸ¥ generate å‡½æ•°æ˜¯å¦åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨\nfunction checkGenerateAvailable(): boolean {\n  if (typeof generate === 'undefined') {\n    // å°è¯•ä» window å¯¹è±¡è·å–\n    if (typeof window !== 'undefined' && (window as any).generate) {\n      return true;\n    }\n    return false;\n  }\n  return true;\n}\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const iframe_events: {\n  STREAM_TOKEN_RECEIVED_FULLY: 'js_stream_token_received_fully';\n  GENERATION_ENDED: 'js_generation_ended';\n};\n\n// MVU å˜é‡æ¡†æ¶å£°æ˜\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  parseMessage?: (message: string, old_data: any) => Promise<any | undefined>;\n};\n\nimport _ from 'lodash';\nimport {\n  extractAllOptions,\n  extractLastMaintext,\n  extractLastOption,\n  extractLastSum,\n  extractLastUpdateVariable,\n  removeThinkingTags,\n  removeThinkingTagsFromStream,\n  validateMessage,\n} from './textParser';\n\n/**\n * è·å–åŸºç¡€ MVU æ•°æ®ï¼ˆç”¨äºä¼ é€’åˆ°æ–°æ¥¼å±‚ï¼‰\n */\nasync function getBaseMvuData(): Promise<any> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    await waitGlobalInitialized('Mvu');\n\n    // åˆå¹¶ init(0) / latest message / chatï¼ˆchat ä¼˜å…ˆï¼‰ï¼Œä½œä¸ºæ–°æ¥¼å±‚çš„ base\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    try {\n      chatData = Mvu.getMvuData({ type: 'chat' });\n    } catch {\n      // ignore\n    }\n\n    const base = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    console.log('ğŸ“Š ä» MVU(merged) è·å–åŸºç¡€æ•°æ®');\n\n    // è¿”å›åŸºç¡€æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•è§£æ\n    return (\n      base ?? {\n        stat_data: {},\n        display_data: {},\n        delta_data: {},\n      }\n    );\n  } catch (error) {\n    console.warn('âš ï¸ è·å– MVU æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨ç©ºå¯¹è±¡:', error);\n    // å¦‚æœ MVU ä¸å¯ç”¨ï¼Œè¿”å›ä¸€ä¸ªåŸºæœ¬çš„ MVU æ•°æ®ç»“æ„\n    return {\n      stat_data: {},\n      display_data: {},\n      delta_data: {},\n    };\n  }\n}\n\n/**\n * æ¶ˆæ¯ç”Ÿæˆå›è°ƒæ¥å£\n */\nexport interface MessageGeneratorCallbacks {\n  onShowGenerating?: () => void; // æ˜¾ç¤ºç”Ÿæˆæç¤º\n  onHideGenerating?: () => void; // éšè—ç”Ÿæˆæç¤º\n  onError?: (error: string) => void; // é”™è¯¯å›è°ƒ\n  onStreamingUpdate?: (text: string) => void; // æµå¼æ›´æ–° maintext çš„å›è°ƒ\n  onRefreshStoryIfOpen?: (userMessage: string) => void; // å¦‚æœç•Œé¢å·²æ‰“å¼€åˆ™åˆ·æ–°æ˜¾ç¤ºï¼ˆuseræ¶ˆæ¯åˆ›å»ºåï¼Œä¼ å…¥ç”¨æˆ·æ¶ˆæ¯å†…å®¹ï¼‰\n  onRefreshStory?: (options?: string[]) => void; // åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºçš„å›è°ƒï¼ˆassistantæ¶ˆæ¯åˆ›å»ºåï¼Œä¼ å…¥é€‰é¡¹æ•°ç»„ï¼‰\n  onCreatedMessages?: (ids: { userMessageId: number; assistantMessageId: number }) => void; // user+assistant åˆ›å»ºå®Œæˆåå›ä¼ çœŸå®æ¥¼å±‚ id\n}\n\n/**\n * é‡æ–°ç”Ÿæˆ assistant æ¶ˆæ¯ï¼ˆä¸åˆ›å»º user æ¥¼å±‚ï¼‰\n * å…¸å‹ç”¨é€”ï¼šåˆ é™¤å½“å‰è½®çš„ assistant æ¥¼å±‚åï¼ŒåŸºäºåŒä¸€ä¸ª user æ¥¼å±‚é‡æ–°ç”Ÿæˆ AI å›å¤ã€‚\n */\nexport async function regenerateAssistantMessage(\n  userMessageId: number,\n  callbacks: MessageGeneratorCallbacks = {},\n): Promise<boolean> {\n  try {\n    if (callbacks.onShowGenerating) callbacks.onShowGenerating();\n\n    // æ³¨å†Œæµå¼äº‹ä»¶ç›‘å¬å™¨\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          callbacks.onStreamingUpdate?.('');\n          return;\n        }\n        callbacks.onStreamingUpdate?.(cleanedText);\n      };\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('âœ… [regen] å·²æ³¨å†Œæµå¼è¾“å‡ºç›‘å¬å™¨');\n    } else {\n      console.log('â„¹ï¸ [regen] æµå¼äº‹ä»¶ä¸å¯ç”¨ï¼Œé€€åŒ–ä¸ºéæµå¼æ¨¡å¼');\n    }\n\n    // æ£€æŸ¥ generate å¯ç”¨\n    if (!checkGenerateAvailable()) {\n      throw new Error('generate å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿é…’é¦†åŠ©æ‰‹å·²æ­£ç¡®åŠ è½½');\n    }\n\n    // generateï¼ˆä¸ä¼  user_inputï¼šæ²¿ç”¨å½“å‰ä¸Šä¸‹æ–‡/æç¤ºè¯ï¼‰\n    const generatePromise = generate({ should_stream: true });\n    const timeoutPromise = new Promise<string>((_, reject) => {\n      setTimeout(() => reject(new Error('generate è°ƒç”¨è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰')), 5 * 60 * 1000);\n    });\n    const result = await Promise.race([generatePromise, timeoutPromise]);\n\n    const cleanedResult = removeThinkingTags(result);\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('ç”Ÿæˆçš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      return false;\n    }\n\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('æ— æ³•æå– maintext æˆ– option');\n      return false;\n    }\n\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) finalMessage += `\\n\\n<sum>${sum}</sum>`;\n    if (updateVariable) finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n\n    // base ä¼˜å…ˆä½¿ç”¨ userMessage.dataï¼ˆå› ä¸º regenerate ä¸ä¼šæ–°å»º user æ¥¼å±‚ï¼‰\n    let base: any = null;\n    try {\n      const userMsg = getChatMessages(userMessageId)?.[0];\n      if (userMsg?.data) base = userMsg.data;\n    } catch {\n      // ignore\n    }\n    if (!base) {\n      try {\n        base =\n          getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n          Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        base = { stat_data: {}, display_data: {}, delta_data: {} };\n      }\n    }\n\n    if (!base || typeof base !== 'object') base = { stat_data: {}, display_data: {}, delta_data: {} };\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // MVU è§£æ\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) finalData = parsed;\n      } catch (e) {\n        console.warn('âš ï¸ [regen] MVU è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®:', e);\n      }\n    }\n\n    const extractedOptions = extractAllOptions(finalMessage);\n\n    // åªä¿å­˜ maintext å’Œ sum\n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave,\n          data: {\n            ...finalData,\n            __options: extractedOptions,\n          },\n        },\n      ],\n      { refresh: 'none' },\n    );\n\n    const assistantMessageId = getLastMessageId();\n    console.log('âœ… [regen] assistant æ¶ˆæ¯å·²åˆ›å»ºï¼ŒID:', assistantMessageId);\n\n    // å›ä¼  idï¼ˆuserMessageId ä¸å˜ï¼‰\n    callbacks.onCreatedMessages?.({ userMessageId, assistantMessageId });\n\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n\n    setTimeout(() => {\n      callbacks.onRefreshStory?.(extractedOptions);\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('âŒ [regen] é‡æ–°ç”Ÿæˆ assistant å¤±è´¥:', error);\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n    callbacks.onError?.(error instanceof Error ? error.message : 'é‡æ–°ç”Ÿæˆå¤±è´¥');\n    return false;\n  }\n}\n\n/**\n * ç”Ÿæˆæ¶ˆæ¯\n * @param userInput ç”¨æˆ·è¾“å…¥ï¼ˆé€‰é¡¹æ–‡æœ¬æˆ–è‡ªå®šä¹‰æ¶ˆæ¯ï¼‰\n * @param callbacks å›è°ƒå‡½æ•°\n */\nexport async function generateMessage(userInput: string, callbacks: MessageGeneratorCallbacks = {}): Promise<boolean> {\n  let userMessageId: number | null = null;\n\n  try {\n    // 1. ç¦ç”¨ç›¸å…³UIï¼ˆå¦‚æœéœ€è¦ï¼‰\n    // è¿™é‡Œå¯ä»¥æ·»åŠ ç¦ç”¨é€‰é¡¹æŒ‰é’®ç­‰é€»è¾‘\n\n    // 2. æ˜¾ç¤º\"æ­£åœ¨ç”Ÿæˆ\"æç¤º\n    if (callbacks.onShowGenerating) {\n      callbacks.onShowGenerating();\n    }\n\n    // 3. è·å–åŸºç¡€ MVU æ•°æ®\n    const mvu_data = await getBaseMvuData();\n\n    // 4. åˆ›å»º user æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤2] å¼€å§‹åˆ›å»º user æ¶ˆæ¯...');\n    console.log('ğŸ“ [æ­¥éª¤2] ç”¨æˆ·è¾“å…¥:', userInput);\n    console.log('ğŸ“ [æ­¥éª¤2] MVU æ•°æ®:', mvu_data ? 'å·²è·å–' : 'æœªè·å–');\n\n    try {\n      await createChatMessages(\n        [\n          {\n            role: 'user',\n            message: userInput, // âš ï¸ åªå­˜å‚¨ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œä¸å­˜å‚¨å®Œæ•´æç¤ºè¯\n            data: mvu_data, // ä¼ é€’ MVU æ•°æ®ï¼Œç¡®ä¿å˜é‡æ­£ç¡®ä¼ é€’åˆ°æ–°æ¥¼å±‚\n          },\n        ],\n        {\n          refresh: 'none', // ä¸æ›´æ–°æ˜¾ç¤ºï¼Œç”±æ¸¸æˆç•Œé¢è‡ªå·±è¯»å–\n        },\n      );\n      console.log('âœ… [æ­¥éª¤2] user æ¶ˆæ¯å·²åˆ›å»º');\n\n      // 9. è·å–åˆšåˆ›å»ºçš„ user æ¶ˆæ¯ ID\n      userMessageId = getLastMessageId();\n      console.log('âœ… [æ­¥éª¤2] user æ¶ˆæ¯å·²åˆ›å»ºï¼ŒID:', userMessageId);\n\n      // ç«‹å³å›ä¼  IDï¼Œè¿™æ ·å³ä½¿åé¢ AI ç”Ÿæˆå´©äº†ï¼Œå‰ç«¯ä¹ŸçŸ¥é“ User æ¶ˆæ¯çš„çœŸå® ID\n      if (callbacks.onCreatedMessages && userMessageId !== null) {\n        try {\n          callbacks.onCreatedMessages({ userMessageId, assistantMessageId: -1 });\n        } catch (e) {\n          console.warn('âš ï¸ onCreatedMessages (user) å›è°ƒæ‰§è¡Œå¤±è´¥:', e);\n        }\n      }\n\n      // 10. åˆ·æ–°æ˜¾ç¤ºåˆšå‘é€çš„ç”¨æˆ·æ¶ˆæ¯ï¼ˆå‚è€ƒmhjgå®ç°ï¼‰\n      // ä½¿ç”¨è½®è¯¢æ–¹å¼ç¡®ä¿æ¶ˆæ¯å·²åˆ›å»º\n      const checkAndRefresh = async (retries = 5) => {\n        const checkMessageId = getLastMessageId();\n        if (checkMessageId === userMessageId) {\n          // éªŒè¯æ¶ˆæ¯æ˜¯å¦å­˜åœ¨\n          const messages = getChatMessages(checkMessageId);\n          if (messages && messages.length > 0 && messages[0].role === 'user') {\n            if (callbacks.onRefreshStoryIfOpen) {\n              callbacks.onRefreshStoryIfOpen(messages[0].message);\n              console.log('âœ… [æ­¥éª¤2] å·²åˆ·æ–°æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ŒID:', userMessageId);\n            }\n            return;\n          }\n        }\n\n        // å¦‚æœæ¶ˆæ¯è¿˜æœªåˆ›å»ºï¼Œé‡è¯•\n        if (retries > 0) {\n          setTimeout(() => checkAndRefresh(retries - 1), 50);\n        } else if (callbacks.onRefreshStoryIfOpen) {\n          // å³ä½¿éªŒè¯å¤±è´¥ï¼Œä¹Ÿå°è¯•åˆ·æ–°ï¼ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼‰\n          callbacks.onRefreshStoryIfOpen(userInput);\n          console.log('âš ï¸ [æ­¥éª¤2] éªŒè¯æ¶ˆæ¯å¤±è´¥ï¼Œä½†ä»å°è¯•åˆ·æ–°æ˜¾ç¤º');\n        }\n      };\n\n      setTimeout(() => checkAndRefresh(), 50);\n    } catch (createError) {\n      console.error('âŒ [æ­¥éª¤2] createChatMessages è°ƒç”¨å¤±è´¥:', createError);\n      throw new Error(\n        `åˆ›å»º user æ¶ˆæ¯å¤±è´¥: ${createError instanceof Error ? createError.message : String(createError)}`,\n      );\n    }\n\n    // 5. æ³¨å†Œæµå¼äº‹ä»¶ç›‘å¬å™¨ï¼ˆåœ¨è°ƒç”¨ generate ä¹‹å‰ï¼‰\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        // å®æ—¶å‰”é™¤ <thinking> æ ‡ç­¾ï¼ˆåŒ…æ‹¬æœªé—­åˆçš„ï¼‰\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n\n        // å¦‚æœæ¸…ç†åæ–‡æœ¬ä¸ºç©ºï¼ˆè¯´æ˜æ­£åœ¨ thinking æ ‡ç­¾å†…ï¼‰ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          if (callbacks.onStreamingUpdate) {\n            callbacks.onStreamingUpdate('');\n          }\n          return;\n        }\n\n        // ä¼ é€’å®Œæ•´çš„ cleanedTextï¼ˆåŒ…å«æ‰€æœ‰æ ‡ç­¾ï¼‰ï¼Œç”¨äºæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸ\n        if (callbacks.onStreamingUpdate) {\n          callbacks.onStreamingUpdate(cleanedText);\n        }\n      };\n\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('âœ… [æ­¥éª¤3] å·²æ³¨å†Œæµå¼è¾“å‡ºç›‘å¬å™¨');\n    } else {\n      console.log('â„¹ï¸ [æ­¥éª¤3] æµå¼äº‹ä»¶ä¸å¯ç”¨ï¼Œé€€åŒ–ä¸ºéæµå¼æ¨¡å¼');\n    }\n\n    // 6. ä½¿ç”¨ generate ç”Ÿæˆ LLM å›å¤ï¼ˆæ”¯æŒæµå¼ç”Ÿæˆï¼‰\n    console.log('ğŸš€ [æ­¥éª¤3] å¼€å§‹è°ƒç”¨ generate ç”Ÿæˆå›å¤...');\n    console.log('ğŸ“ [æ­¥éª¤3] ç”¨æˆ·è¾“å…¥:', userInput);\n\n    // æ£€æŸ¥ generate å‡½æ•°æ˜¯å¦å¯ç”¨\n    if (!checkGenerateAvailable()) {\n      console.error('âŒ [æ­¥éª¤3] generate å‡½æ•°æœªå®šä¹‰');\n      console.error('âŒ [æ­¥éª¤3] è¯·æ£€æŸ¥ï¼š');\n      console.error('   1. é…’é¦†åŠ©æ‰‹æ˜¯å¦å·²æ­£ç¡®å®‰è£…');\n      console.error('   2. æ˜¯å¦åœ¨ iframe ç¯å¢ƒä¸­è¿è¡Œ');\n      console.error('   3. å…¨å±€ generate å‡½æ•°æ˜¯å¦å¯ç”¨');\n      throw new Error('generate å‡½æ•°ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿é…’é¦†åŠ©æ‰‹å·²æ­£ç¡®åŠ è½½');\n    }\n\n    let result: string;\n    try {\n      console.log('ğŸš€ [æ­¥éª¤3] è°ƒç”¨ generateï¼Œç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰...');\n      console.log('ğŸš€ [æ­¥éª¤3] generate å‡½æ•°ç±»å‹:', typeof generate);\n\n      // ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆæç¤ºè¯å·²åœ¨é…’é¦†ç•Œé¢å°è£…ï¼‰\n      const generatePromise = generate({\n        // user_input: userInput, // ä¸ä½¿ç”¨ç”¨æˆ·è¾“å…¥\n        should_stream: true, // å¯ç”¨æµå¼ç”Ÿæˆ\n      });\n\n      // è®¾ç½®è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(\n          () => {\n            reject(new Error('generate è°ƒç”¨è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰'));\n          },\n          5 * 60 * 1000,\n        );\n      });\n\n      result = await Promise.race([generatePromise, timeoutPromise]);\n\n      console.log('ğŸ“¨ [æ­¥éª¤3] generate è¿”å›ç»“æœï¼Œé•¿åº¦:', result?.length || 0);\n      if (!result || result.length === 0) {\n        console.warn('âš ï¸ [æ­¥éª¤3] generate è¿”å›ç©ºç»“æœ');\n      } else {\n        console.log('ğŸ“¨ [æ­¥éª¤3] generate è¿”å›ç»“æœé¢„è§ˆ:', result.substring(0, 200) + '...');\n      }\n    } catch (generateError) {\n      console.error('âŒ [æ­¥éª¤3] generate è°ƒç”¨å¤±è´¥:', generateError);\n      console.error('âŒ [æ­¥éª¤3] é”™è¯¯è¯¦æƒ…:', {\n        error: generateError,\n        errorType: typeof generateError,\n        errorMessage: generateError instanceof Error ? generateError.message : String(generateError),\n        errorStack: generateError instanceof Error ? generateError.stack : undefined,\n      });\n\n      // æ£€æŸ¥æ˜¯å¦æ˜¯è¶…æ—¶é”™è¯¯\n      if (generateError instanceof Error && generateError.message.includes('è¶…æ—¶')) {\n        throw new Error('generate è°ƒç”¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– LLM æœåŠ¡çŠ¶æ€');\n      }\n\n      throw new Error(\n        `generate è°ƒç”¨å¤±è´¥: ${generateError instanceof Error ? generateError.message : String(generateError)}`,\n      );\n    }\n\n    // 7. ç§»é™¤ <thinking> æ ‡ç­¾\n    const cleanedResult = removeThinkingTags(result);\n\n    // 8. éªŒè¯è¿”å›ç»“æœæ˜¯å¦ç¬¦åˆè§„èŒƒ\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      console.error('âŒ [æ­¥éª¤4] generate è¿”å›çš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      // éšè—ç”Ÿæˆæç¤ºæ¡†\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('ç”Ÿæˆçš„æ¶ˆæ¯ä¸ç¬¦åˆè§„èŒƒ');\n      }\n      return false;\n    }\n\n    // 12. æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <maintext>ã€<option>ã€<sum> å’Œ <UpdateVariable>\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      console.error('âŒ [æ­¥éª¤5] æ— æ³•æå– maintext æˆ– option');\n      // éšè—ç”Ÿæˆæç¤ºæ¡†\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('æ— æ³•æå– maintext æˆ– option');\n      }\n      return false;\n    }\n\n    // 13. é‡æ–°ç»„åˆæ¶ˆæ¯ï¼ˆåŒ…å«æœ€åä¸€æ¬¡çš„ maintextã€optionã€sumï¼ˆå¦‚æœæœ‰ï¼‰å’Œ UpdateVariableï¼ˆå¦‚æœæœ‰ï¼‰ï¼‰\n    // ç”¨äº MVU è§£æï¼ˆéœ€è¦å®Œæ•´æ¶ˆæ¯ï¼‰\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) {\n      finalMessage += `\\n\\n<sum>${sum}</sum>`;\n      console.log('ğŸ“ [æ­¥éª¤5] æå–åˆ° <sum> æ ‡ç­¾');\n    }\n    if (updateVariable) {\n      finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n      console.log('ğŸ“ [æ­¥éª¤5] æå–åˆ° <UpdateVariable> æ ‡ç­¾');\n    }\n\n    // 14. è·å–åŸºç¡€ MVU æ•°æ®ï¼ˆä¼˜å…ˆä»åˆšåˆ›å»ºçš„ user æ¶ˆæ¯è¯»å–ï¼‰\n    console.log('ğŸ“Š [æ­¥éª¤6] å¼€å§‹è·å–åŸºç¡€ MVU æ•°æ®...');\n    let base: any;\n    if (userMessageId !== null) {\n      const userMessage = getChatMessages(userMessageId)?.[0];\n      if (userMessage?.data) {\n        base = userMessage.data;\n        console.log('âœ… [æ­¥éª¤6] ä»åˆšåˆ›å»ºçš„ user æ¶ˆæ¯è¯»å–åŸºç¡€æ•°æ®');\n      }\n    }\n\n    // å¦‚æœ user æ¶ˆæ¯æ²¡æœ‰ dataï¼Œåˆ™ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–\n    if (!base) {\n      console.log('ğŸ“Š [æ­¥éª¤6] å°è¯•ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–...');\n      base =\n        getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n        Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      console.log('âœ… [æ­¥éª¤6] ä»æœ€æ–°çš„ assistant æ¶ˆæ¯æˆ– MVU è¯»å–åŸºç¡€æ•°æ®');\n    }\n\n    // ç¡®ä¿ base æ•°æ®ç»“æ„å®Œæ•´\n    if (!base || typeof base !== 'object') {\n      console.log('âš ï¸ [æ­¥éª¤6] base æ•°æ®æ— æ•ˆï¼Œä½¿ç”¨ç©ºå¯¹è±¡');\n      base = { stat_data: {}, display_data: {}, delta_data: {} };\n    }\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // 15. è§£ææ¶ˆæ¯ä¸­çš„ MVU å‘½ä»¤ï¼ˆå¦‚æœ MVU.parseMessage å¯ç”¨ï¼‰\n    console.log('ğŸ” [æ­¥éª¤7] å¼€å§‹è§£ææ¶ˆæ¯ä¸­çš„ MVU å‘½ä»¤...');\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) {\n          finalData = parsed;\n          console.log('âœ… [æ­¥éª¤7] MVU è§£ææˆåŠŸ');\n        } else {\n          console.log('â„¹ï¸ [æ­¥éª¤7] MVU è§£æè¿”å› undefinedï¼Œä½¿ç”¨åŸºç¡€æ•°æ®');\n        }\n      } catch (error) {\n        console.warn('âš ï¸ [æ­¥éª¤7] MVU è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ•°æ®:', error);\n      }\n    } else {\n      console.log('â„¹ï¸ [æ­¥éª¤7] MVU.parseMessage ä¸å¯ç”¨ï¼Œè·³è¿‡è§£æ');\n    }\n\n    // 16. æå–é€‰é¡¹ï¼ˆåœ¨ createChatMessages ä¹‹å‰ï¼Œä» finalMessage ä¸­æå–ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤8] å¼€å§‹æå–é€‰é¡¹...');\n    const extractedOptions = extractAllOptions(finalMessage);\n    console.log('ğŸ“ [æ­¥éª¤8] å·²æå–é€‰é¡¹:', extractedOptions.length, 'ä¸ª');\n\n    // 17. åˆ›å»º assistant æ¶ˆæ¯ï¼ˆåªä¿å­˜ <maintext> æ ‡ç­¾é‡Œçš„å†…å®¹å’Œ <sum> æ ‡ç­¾å†…å®¹ï¼‰\n    console.log('ğŸ“ [æ­¥éª¤9] å¼€å§‹åˆ›å»º assistant æ¶ˆæ¯...');\n    // ä» finalMessage ä¸­æå– maintext å†…å®¹ï¼ˆåªä¿ç•™ maintext æ ‡ç­¾é‡Œçš„å†…å®¹ï¼‰\n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    if (!maintextContent) {\n      console.warn('âš ï¸ [æ­¥éª¤9] æ— æ³•ä» finalMessage ä¸­æå– maintextï¼Œä½¿ç”¨å®Œæ•´çš„ finalMessage');\n    } else {\n      console.log('ğŸ“ [æ­¥éª¤9] å·²æå– maintext å†…å®¹ï¼Œä¿å­˜ maintext å’Œ sum éƒ¨åˆ†');\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave, // åªä¿å­˜ maintext å†…å®¹\n          data: {\n            ...finalData, // ä¼ å…¥è§£æåçš„æ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰å˜é‡æ›´æ–°ï¼‰\n            __options: extractedOptions, // âœ… å­˜åœ¨ data é‡Œ\n          },\n        },\n      ],\n      {\n        refresh: 'none', // æ›´æ–°æ˜¾ç¤ºï¼Œç”±æ¸¸æˆç•Œé¢è‡ªå·±è¯»å–\n      },\n    );\n    console.log('âœ… [æ­¥éª¤9] assistant æ¶ˆæ¯å·²åˆ›å»ºï¼Œé…’é¦†ç•Œé¢å†å²å·²åˆ·æ–°');\n\n    // 18. è·å–æ–°åˆ›å»ºçš„æ¶ˆæ¯ ID\n    const assistantMessageId = getLastMessageId();\n    console.log('ğŸ†” [æ­¥éª¤10] è·å–æ–°åˆ›å»ºçš„æ¶ˆæ¯ ID:', assistantMessageId);\n\n    // 18.1 å›ä¼ çœŸå® message_idï¼ˆä¾¿äºä¸Šå±‚åšâ€œé‡æ–°ç”Ÿæˆ/åˆ é™¤æœ¬è½®â€ç­‰æ“ä½œï¼‰\n    if (callbacks.onCreatedMessages && userMessageId !== null) {\n      try {\n        callbacks.onCreatedMessages({ userMessageId, assistantMessageId });\n      } catch (e) {\n        console.warn('âš ï¸ onCreatedMessages å›è°ƒæ‰§è¡Œå¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e);\n      }\n    }\n\n    // 19. éšè—ç”Ÿæˆæç¤ºæ¡†\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 20. åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºï¼ˆå»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿æ¶ˆæ¯å·²ç»å®Œå…¨åˆ›å»ºå¹¶å†™å…¥å†å²ï¼‰\n    // åŒæ—¶ä¼ é€’æå–çš„é€‰é¡¹ï¼Œå‰ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä»æ¶ˆæ¯ä¸­æå–\n    setTimeout(() => {\n      if (callbacks.onRefreshStory) {\n        callbacks.onRefreshStory(extractedOptions);\n        console.log('âœ… [æ­¥éª¤11] å·²åˆ·æ–°æ¸¸æˆæ˜¾ç¤ºï¼ˆå·²ä¼ é€’é€‰é¡¹ï¼‰');\n      }\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('âŒ ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:', error);\n\n    // éšè—ç”Ÿæˆæç¤ºæ¡†\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯\n    if (callbacks.onError) {\n      callbacks.onError(error instanceof Error ? error.message : 'ç”Ÿæˆæ¶ˆæ¯å¤±è´¥');\n    }\n\n    return false;\n  }\n}\n","module.exports = _;","/**\n * æ–‡æœ¬è§£æå·¥å…·\n * ç”¨äºä» LLM è¿”å›çš„æ–‡æœ¬ä¸­æå–æ ¼å¼åŒ–çš„æ ‡ç­¾å†…å®¹\n */\n\n/**\n * ç§»é™¤ <thinking> æ ‡ç­¾åŠå…¶å†…éƒ¨æ‰€æœ‰å†…å®¹ï¼ˆç”¨äºæœ€ç»ˆç»“æœï¼‰\n */\nexport function removeThinkingTags(text: string): string {\n  if (!text) return '';\n\n  // åŒ¹é… <thinking>...</thinking> æ ‡ç­¾ï¼ˆåŒ…æ‹¬ç®€å•åµŒå¥—æƒ…å†µï¼‰\n  let result = text;\n  let lastResult = '';\n\n  // å¾ªç¯å¤„ç†ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šçš„ <thinking> æ ‡ç­¾\n  while (result !== lastResult) {\n    lastResult = result;\n    result = result.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n  }\n\n  return result;\n}\n\n/**\n * ä»æµå¼æ–‡æœ¬ä¸­ç§»é™¤ <thinking> å†…å®¹\n * - å…ˆç§»é™¤æ‰€æœ‰å®Œæ•´çš„ <thinking>...</thinking>\n * - å¦‚æœè¿˜æœ‰æœªé—­åˆçš„ <thinking>ï¼Œåˆ™éšè—ä»æœ€åä¸€ä¸ª <thinking> å¼€å§‹çš„æ‰€æœ‰å†…å®¹\n */\nexport function removeThinkingTagsFromStream(text: string): string {\n  if (!text) return '';\n\n  // å…ˆç§»é™¤æ‰€æœ‰å®Œæ•´çš„ <thinking>...</thinking> æ ‡ç­¾å¯¹\n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n\n  // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªé—­åˆçš„ <thinking> æ ‡ç­¾\n  const lastThinkingStart = cleaned.lastIndexOf('<thinking>');\n\n  // å¦‚æœæ‰¾åˆ°äº†æœªé—­åˆçš„ <thinking>ï¼Œéšè—ä»å®ƒå¼€å§‹çš„æ‰€æœ‰å†…å®¹\n  if (lastThinkingStart !== -1) {\n    cleaned = cleaned.substring(0, lastThinkingStart).trim();\n  }\n\n  return cleaned;\n}\n\n/**\n * ç§»é™¤ <sum> æ ‡ç­¾åŠå…¶å†…å®¹\n */\nexport function removeSumTags(text: string): string {\n  if (!text) return '';\n  return text.replace(/<sum>[\\s\\S]*?<\\/sum>/gi, '').trim();\n}\n\n/**\n * è§£æ summary å­—ç¬¦ä¸²ä¸ºå¯¹è±¡\n * æ ¼å¼: æ—¶é—´: ... | åœ°ç‚¹: ... | äººç‰©: ... | äº‹ä»¶: ...\n */\nexport function parseSummary(sumText: string): Record<string, string> {\n  if (!sumText) return {};\n\n  const result: Record<string, string> = {};\n  // ä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼Œå…¼å®¹ä¸­è‹±æ–‡å†’å·\n  // åŒ¹é…æ¨¡å¼: (é”®å) (ä¸­/è‹±å†’å·) (ç›´åˆ°ä¸‹ä¸€ä¸ª | æˆ–å­—ç¬¦ä¸²ç»“æŸçš„å†…å®¹)\n  const parts = sumText.split('|');\n\n  parts.forEach(part => {\n    const match = part.match(/^\\s*(æ—¶é—´|åœ°ç‚¹|äººç‰©|äº‹ä»¶|Time|Location|Characters|Event)\\s*[:ï¼š]\\s*([\\s\\S]*)$/i);\n    if (match) {\n      const key = match[1].trim();\n      const value = match[2].trim();\n      result[key] = value;\n    }\n  });\n\n  return result;\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <maintext> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastMaintext(text: string): string {\n  const matches = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <continue_choice> æ ‡ç­¾å†…å®¹\n */\nexport function extractContinueChoice(text: string): string {\n  const matches = text.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <result> æ ‡ç­¾å†…å®¹\n */\nexport function extractResult(text: string): string {\n  const matches = text.match(/<result>([\\s\\S]*?)<\\/result>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<result>([\\s\\S]*?)<\\/result>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <decision_node> æ ‡ç­¾å†…å®¹\n */\nexport function extractNextChoice(text: string): string {\n  const matches = text.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <option> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastOption(text: string): string {\n  const matches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<option>([\\s\\S]*?)<\\/option>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æ‰€æœ‰ <suboption> æ ‡ç­¾å†…å®¹ï¼ˆæ–°æ ¼å¼ï¼‰\n * @returns æ‰€æœ‰ suboption æ–‡æœ¬çš„æ•°ç»„\n */\nexport function extractAllOptions(text: string): string[] {\n  if (!text) return [];\n\n  // é¦–å…ˆå°è¯•æå– <suboption> æ ‡ç­¾ï¼ˆæ–°æ ¼å¼ï¼‰\n  const suboptionMatches = text.match(/<suboption>([\\s\\S]*?)<\\/suboption>/gi);\n  if (suboptionMatches && suboptionMatches.length > 0) {\n    const options: string[] = [];\n    suboptionMatches.forEach(match => {\n      const contentMatch = match.match(/<suboption>([\\s\\S]*?)<\\/suboption>/i);\n      if (contentMatch && contentMatch[1]) {\n        const content = contentMatch[1].trim();\n        if (content) {\n          options.push(content);\n        }\n      }\n    });\n    if (options.length > 0) {\n      return options;\n    }\n  }\n\n  // å¦‚æœæ²¡æœ‰æ‰¾åˆ° <suboption>ï¼Œå›é€€åˆ°æ—§çš„ <option> æ ¼å¼ï¼ˆå…¼å®¹æ€§ï¼‰\n  const optionMatches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!optionMatches || optionMatches.length === 0) {\n    return [];\n  }\n\n  // æå–æ¯ä¸ª option çš„å†…å®¹ï¼ˆæ—§æ ¼å¼ï¼‰\n  const options: string[] = [];\n  optionMatches.forEach(match => {\n    const contentMatch = match.match(/<option>([\\s\\S]*?)<\\/option>/i);\n    if (contentMatch && contentMatch[1]) {\n      const content = contentMatch[1].trim();\n      if (content) {\n        // å°è¯•æŒ‰è¡Œåˆ†å‰²ï¼Œæ¯è¡Œä½œä¸ºä¸€ä¸ªé€‰é¡¹ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰\n        const lines = content\n          .split('\\n')\n          .map(line => line.trim())\n          .filter(line => line);\n        if (lines.length > 1) {\n          // å¤šè¡Œï¼Œæ¯è¡Œä½œä¸ºä¸€ä¸ªé€‰é¡¹\n          options.push(...lines);\n        } else {\n          // å•è¡Œï¼Œç›´æ¥æ·»åŠ \n          options.push(content);\n        }\n      }\n    }\n  });\n\n  return options;\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <sum> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastSum(text: string): string {\n  const matches = text.match(/<sum>([\\s\\S]*?)<\\/sum>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * æå–æœ€åä¸€æ¬¡å‡ºç°çš„ <UpdateVariable> æ ‡ç­¾å†…å®¹\n */\nexport function extractLastUpdateVariable(text: string): string {\n  const matches = text.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // è·å–æœ€åä¸€ä¸ªåŒ¹é…\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/i);\n  if (!contentMatch) {\n    return '';\n  }\n\n  const content = contentMatch[1].trim();\n\n  // ç›´æ¥è¿”å›åŸå§‹å†…å®¹ï¼Œä¸è¿›è¡Œä»»ä½•è½¬æ¢\n  // MVU ç³»ç»Ÿå¯èƒ½ç›´æ¥æ”¯æŒ JSONPatch æ ¼å¼ï¼Œè½¬æ¢åè€Œä¼šå¯¼è‡´é—®é¢˜\n  console.log('ğŸ“ æå–åˆ° <UpdateVariable> åŸå§‹å†…å®¹ï¼Œç›´æ¥ä¿ç•™ï¼Œä¸è¿›è¡Œè½¬æ¢');\n  return content;\n}\n\n/**\n * éªŒè¯æ¶ˆæ¯æ˜¯å¦ç¬¦åˆè§„èŒƒï¼ˆè‡³å°‘åŒ…å« maintext å’Œ optionï¼‰\n */\nexport function validateMessage(messageContent: string): boolean {\n  if (!messageContent || typeof messageContent !== 'string') {\n    return false;\n  }\n\n  // ç§»é™¤ thinking æ ‡ç­¾åå†éªŒè¯\n  const cleaned = removeThinkingTags(messageContent);\n  const maintext = extractLastMaintext(cleaned);\n  const option = extractLastOption(cleaned);\n\n  if (!maintext || !option) {\n    console.warn('âš ï¸ æ¶ˆæ¯ç¼ºå°‘ <maintext> æˆ– <option> æ ‡ç­¾');\n    return false;\n  }\n\n  return true;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { GameData, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\ndeclare function getLastMessageId(): number;\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ä» MVU å˜é‡ç³»ç»Ÿè¯»å–æ¸¸æˆæ•°æ®\n */\nexport async function readGameData(): Promise<any> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    if (typeof waitGlobalInitialized !== 'undefined') {\n      await waitGlobalInitialized('Mvu');\n    }\n\n    // ä» MVU ç³»ç»Ÿè¯»å– stat_data\n    if (typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n      // åˆå¹¶å¤šä¸ªæ¥æºï¼šinit(0) -> latest message -> chatï¼ˆchat ä¼˜å…ˆè¦†ç›–ï¼‰ï¼Œç”¨äºè¡¥é½ç¼ºå¤±å­—æ®µ\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      try {\n        chatData = Mvu.getMvuData({ type: 'chat' });\n      } catch {\n        // ignore\n      }\n\n      const merged = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      return _.get(merged, 'stat_data') || {};\n    }\n\n    // é™çº§ï¼šä»é…’é¦†å˜é‡ç³»ç»Ÿè¯»å–\n    const variables = getVariables({ type: 'message' });\n    const gameData = variables.game_data || variables.stat_data || {};\n    return gameData;\n  } catch (error) {\n    console.warn('è¯»å–æ¸¸æˆæ•°æ®å¤±è´¥:', error);\n    return {};\n  }\n}\n\n/**\n * æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£\n * é€šè¿‡æ£€æŸ¥ assistant æ¶ˆæ¯æ•°é‡æ¥åˆ¤æ–­ï¼š\n * - assistant æ¶ˆæ¯åªæœ‰ 1 æ¡ï¼šæ–°å¼€çš„æ¡£ï¼ˆå¼€åœºç™½ï¼‰ï¼Œè¿”å› falseï¼Œæ˜¾ç¤ºå¼€å§‹ç•Œé¢\n * - assistant æ¶ˆæ¯ > 1 æ¡ï¼šç»§ç»­æ¸¸æˆï¼Œè¿”å› trueï¼Œç›´æ¥è¿›å…¥æ¸¸æˆç•Œé¢\n */\nexport function hasSaveData(): boolean {\n  try {\n    // æ£€æŸ¥ assistant æ¶ˆæ¯æ•°é‡\n    const lastMessageId = getLastMessageId();\n    if (lastMessageId < 0) {\n      return false; // æ²¡æœ‰æ¶ˆæ¯ï¼Œè‚¯å®šæ²¡æœ‰å­˜æ¡£\n    }\n\n    // è·å–æ‰€æœ‰ assistant æ¶ˆæ¯\n    const messages = getChatMessages(`0-${lastMessageId}`, { role: 'assistant' });\n\n    // åªæœ‰ 1 æ¡ assistant æ¶ˆæ¯ï¼šæ–°å¼€çš„æ¡£ï¼ˆå¼€åœºç™½ï¼‰ï¼Œåº”è¯¥æ˜¾ç¤ºå¼€å§‹ç•Œé¢\n    // å¤šäº 1 æ¡ assistant æ¶ˆæ¯ï¼šç»§ç»­æ¸¸æˆ\n    return messages && messages.length > 1;\n  } catch (error) {\n    console.warn('æ£€æŸ¥å­˜æ¡£çŠ¶æ€å¤±è´¥:', error);\n    return false;\n  }\n}\n\n/**\n * è¯»å–æ¸¸æˆé…ç½®\n */\nexport function readGameConfig(): Partial<GameConfig> {\n  try {\n    const variables = getVariables({ type: 'message' });\n    const config = variables.game_config || {};\n    return config as Partial<GameConfig>;\n  } catch (error) {\n    console.warn('è¯»å–æ¸¸æˆé…ç½®å¤±è´¥:', error);\n    return {};\n  }\n}\n","import { ComponentCallbacks } from '../types/types';\nimport { hasSaveData } from '../utils/variableReader';\n\n/**\n * æ ‡é¢˜é¡µé¢ç»„ä»¶\n */\nexport class SplashScreen {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen splash-screen';\n    div.id = 'splash-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    this.updateContinueButton();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      this.updateContinueButton();\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬å™¨\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  private updateContinueButton(): void {\n    if (!this.element) return;\n\n    const continueButton = this.element.querySelector('#continue-button') as HTMLElement;\n    if (continueButton) {\n      if (hasSaveData()) {\n        continueButton.style.display = 'flex';\n      } else {\n        continueButton.style.display = 'none';\n      }\n    }\n  }\n\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    const newGameButton = this.element.querySelector('#new-game-button');\n    if (newGameButton) {\n      newGameButton.addEventListener('click', () => {\n        this.callbacks.onNewGame?.();\n      });\n    }\n\n    const continueButton = this.element.querySelector('#continue-button');\n    if (continueButton) {\n      continueButton.addEventListener('click', () => {\n        this.callbacks.onContinue?.();\n      });\n    }\n\n    const fullscreenButton = this.element.querySelector('#fullscreen-button');\n    if (fullscreenButton) {\n      fullscreenButton.addEventListener('click', () => {\n        this.requestFullscreen();\n      });\n    }\n\n    // Enteré”®æ”¯æŒï¼šå…¨å±\n    this.keyDownHandler = (e: KeyboardEvent) => {\n      if (e.key === 'Enter' && this.element?.classList.contains('active')) {\n        e.preventDefault();\n        this.requestFullscreen();\n      }\n    };\n    document.addEventListener('keydown', this.keyDownHandler);\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch(err => {\n        console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"splash-screen-content\">\n        <div class=\"splash-header\">\n          <div class=\"splash-logo\">\n            <i class=\"fas fa-anchor\"></i>\n          </div>\n          <h1 class=\"splash-title\">é”š</h1>\n          <p class=\"splash-subtitle\">ANCHOR</p>\n        </div>\n        <div class=\"splash-actions\">\n          <button type=\"button\" class=\"splash-button primary\" id=\"new-game-button\">\n            <i class=\"fas fa-play\"></i>\n            <span>å¼€å§‹æ–°æ¸¸æˆ</span>\n          </button>\n          <button type=\"button\" class=\"splash-button secondary\" id=\"continue-button\" style=\"display: none;\">\n            <i class=\"fas fa-redo\"></i>\n            <span>ç»§ç»­æ¸¸æˆ</span>\n          </button>\n          <button type=\"button\" class=\"splash-button icon-only\" id=\"fullscreen-button\" title=\"åˆ‡æ¢å…¨å± (Enter)\">\n            <i class=\"fas fa-expand\"></i>\n          </button>\n        </div>\n        <div class=\"splash-footer\">\n          <p class=\"splash-copyright\">Â© 2026 é”š</p>\n          <p class=\"splash-author\">åŸºäºSilly Tavernã€é…’é¦†åŠ©æ‰‹</p>\n          <p class=\"splash-hint\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-tertiary);\">æŒ‰ Enter é”®å…¨å±</p>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const toastr: any;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * å¼€å±€è®¾ç½®é¡µé¢ç»„ä»¶\n */\nexport class NewGameSetup {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen setup-screen';\n    div.id = 'setup-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    // å®æ—¶æ›´æ–° MVU å˜é‡ï¼ˆå½“ç”¨æˆ·è¾“å…¥æ—¶ï¼‰\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    if (reserveInput) {\n      reserveInput.addEventListener('input', async () => {\n        const config = this.getConfig();\n        if (config.reserve !== undefined) {\n          await this.updateMvuVariable(config.reserve);\n        }\n      });\n    }\n\n    const confirmButton = this.element.querySelector('#setup-confirm-button');\n    if (confirmButton) {\n      confirmButton.addEventListener('click', () => {\n        const reserveInput = this.element?.querySelector('#energy-reserve') as HTMLInputElement;\n        const inputValue = reserveInput?.value?.trim() || '';\n\n        // éªŒè¯è¾“å…¥\n        if (!inputValue) {\n          toastr.error('è¯·è¾“å…¥ç³»ç»Ÿå‰©ä½™èƒ½æº', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        // æ£€æŸ¥æ˜¯å¦ä¸ºæ•´æ•°ï¼ˆä¸å…è®¸å°æ•°ç‚¹ï¼‰\n        if (inputValue.includes('.')) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»æ˜¯æ•´æ•°', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        const reserve = parseInt(inputValue, 10);\n        if (isNaN(reserve)) {\n          toastr.error('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        if (!Number.isInteger(reserve)) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»æ˜¯æ•´æ•°', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        if (reserve < 0 || reserve > 100000) {\n          toastr.error('ç³»ç»Ÿå‰©ä½™èƒ½æºå¿…é¡»åœ¨ 0-100000 ä¹‹é—´', 'éªŒè¯å¤±è´¥');\n          return;\n        }\n\n        const config: GameConfig = { reserve };\n        this.callbacks.onConfirm?.(config);\n      });\n    }\n\n    const cancelButton = this.element.querySelector('#setup-cancel-button');\n    if (cancelButton) {\n      cancelButton.addEventListener('click', () => {\n        this.callbacks.onCancel?.();\n      });\n    }\n  }\n\n  private async updateMvuVariable(value: number): Promise<void> {\n    try {\n      // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n      if (typeof waitGlobalInitialized !== 'undefined') {\n        await waitGlobalInitialized('Mvu');\n      }\n\n      if (typeof Mvu === 'undefined' || !Mvu.getMvuData || !Mvu.replaceMvuData) {\n        console.warn('âš ï¸ MVU ä¸å¯ç”¨ï¼Œè·³è¿‡å®æ—¶æ›´æ–°');\n        return;\n      }\n\n      // è·å–å½“å‰çš„ MVU æ•°æ®\n      // åˆå¹¶ init(0) / latest message / chatï¼ˆchat ä¼˜å…ˆï¼‰ï¼Œé¿å…åªå†™ reserve å¯¼è‡´ system_state ç»“æ„æ®‹ç¼º\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      chatData = Mvu.getMvuData({ type: 'chat' });\n\n      const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      const currentStatData = currentMvuData?.stat_data || {};\n\n      // æ„å»ºæ›´æ–°åçš„ stat_data\n      const updatedStatData = { ...currentStatData };\n\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // ç¡®ä¿ reserve åœ¨ 0-100000 èŒƒå›´å†…\n      updatedStatData.system_state.antimatter.reserve = Math.max(0, Math.min(100000, value));\n\n      // å°†æ›´æ–°åçš„æ•°æ®å†™å› MVU\n      const updatedMvuData = {\n        ...currentMvuData,\n        stat_data: updatedStatData,\n      };\n\n      await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n      console.info(`âœ… å®æ—¶æ›´æ–° MVU å˜é‡ reserve: ${value}`);\n    } catch (error) {\n      console.warn(`âš ï¸ å®æ—¶æ›´æ–° MVU å˜é‡ reserve å¤±è´¥:`, error);\n    }\n  }\n\n  private getConfig(): GameConfig {\n    if (!this.element) {\n      return {};\n    }\n\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    return {\n      reserve: reserveInput?.value ? parseInt(reserveInput.value, 10) : undefined,\n    };\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"setup-screen-content\">\n        <div class=\"setup-header\">\n          <h1 class=\"setup-title\">æ–°æ¸¸æˆè®¾ç½®</h1>\n          <p class=\"setup-subtitle\">é…ç½®æ‚¨çš„æ¸¸æˆ</p>\n        </div>\n        <div class=\"setup-form\">\n          <div class=\"setup-form-group\">\n            <label class=\"setup-label\" for=\"energy-reserve\">ç³»ç»Ÿå‰©ä½™èƒ½æº</label>\n            <input\n              type=\"number\"\n              id=\"energy-reserve\"\n              class=\"setup-input\"\n              min=\"0\"\n              max=\"100000\"\n              step=\"1\"\n              placeholder=\"è¾“å…¥ç³»ç»Ÿå‰©ä½™èƒ½æº\"\n              required\n            />\n            <small style=\"color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;\">\n              èŒƒå›´ï¼š0 - 100000ï¼ˆæ•´æ•°ï¼‰\n            </small>\n          </div>\n        </div>\n        <div class=\"setup-actions\">\n          <button type=\"button\" class=\"setup-button secondary\" id=\"setup-cancel-button\">\n            <i class=\"fas fa-times\"></i>\n            <span>å–æ¶ˆ</span>\n          </button>\n          <button type=\"button\" class=\"setup-button primary\" id=\"setup-confirm-button\">\n            <i class=\"fas fa-check\"></i>\n            <span>ç¡®è®¤</span>\n          </button>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { waitUntil } from 'async-wait-until';\nimport _ from 'lodash';\nimport { ComponentCallbacks, GameData } from '../types/types';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): { stop: () => void };\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  CHAT_CHANGED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  events: {\n    VARIABLE_UPDATE_ENDED: 'mag_variable_update_ended';\n  };\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * ä¸»æ¸¸æˆç•Œé¢ç»„ä»¶ï¼ˆDashboardï¼‰\n */\nexport class Dashboard {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n  private gameData: Partial<GameData> = {};\n  private loadedMessageIds: Set<number> = new Set(); // è®°å½•å·²åŠ è½½çš„æ¶ˆæ¯IDï¼Œé¿å…é‡å¤æ˜¾ç¤º\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n  private mvuUpdateListener: { stop: () => void } | null = null;\n  private statusRetryCount = 0;\n  private statusRetryTimer: number | null = null;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    try {\n      const div = document.createElement('div');\n      div.className = 'screen main-screen';\n      div.id = 'main-screen';\n      div.innerHTML = this.getHTML();\n      this.element = div;\n\n      // ç»‘å®šäº‹ä»¶ï¼ˆåœ¨è®¾ç½® innerHTML ä¹‹åï¼‰\n      this.bindEvents();\n\n      // åˆ›å»ºåç«‹å³æ¸²æŸ“é»˜è®¤æ•°æ®\n      this.refreshData();\n\n      console.log('âœ… Dashboard å…ƒç´ å·²åˆ›å»º');\n      return div;\n    } catch (error) {\n      console.error('âŒ åˆ›å»º Dashboard å…ƒç´ å¤±è´¥:', error);\n      // åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ div ä½œä¸ºé™çº§æ–¹æ¡ˆ\n      const fallbackDiv = document.createElement('div');\n      fallbackDiv.className = 'screen main-screen';\n      fallbackDiv.id = 'main-screen';\n      fallbackDiv.innerHTML = '<div style=\"padding: 2rem; color: var(--text-primary);\">é”šåŠ è½½ä¸­...</div>';\n      this.element = fallbackDiv;\n      return fallbackDiv;\n    }\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      // æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®\n      try {\n        this.refreshData();\n        console.log('âœ… Dashboard æ•°æ®å·²åˆ·æ–°');\n      } catch (error) {\n        console.error('âŒ Dashboard åˆ·æ–°æ•°æ®å¤±è´¥:', error);\n        // å³ä½¿åˆ·æ–°å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ˜¾ç¤º\n      }\n    } else {\n      console.error('âŒ Dashboard element ä¸º nullï¼Œæ— æ³•æ˜¾ç¤º');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬å™¨\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n\n    if (this.mvuUpdateListener) {\n      this.mvuUpdateListener.stop();\n      this.mvuUpdateListener = null;\n    }\n\n    if (this.statusRetryTimer !== null) {\n      window.clearTimeout(this.statusRetryTimer);\n      this.statusRetryTimer = null;\n    }\n  }\n\n  public updateGameData(data: Partial<GameData>): void {\n    this.gameData = { ...this.gameData, ...data };\n    this.refreshData();\n  }\n\n  private refreshData(): void {\n    if (!this.element) {\n      console.warn('âš ï¸ Dashboard element ä¸º nullï¼Œæ— æ³•åˆ·æ–°æ•°æ®');\n      return;\n    }\n\n    try {\n      // æ›´æ–°çŠ¶æ€å¡ç‰‡ï¼ˆå¼‚æ­¥ï¼Œä» MVU å˜é‡è¯»å–ï¼‰\n      this.updateStatusCards().catch(error => {\n        console.warn('âš ï¸ æ›´æ–°çŠ¶æ€å¡ç‰‡å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n      });\n\n      // æ›´æ–°ä»»åŠ¡åˆ—è¡¨\n      this.updateTasksList();\n\n      // æ›´æ–°æ—¥è®°åˆ—è¡¨\n      this.updateDiaryList();\n\n      // æ›´æ–°èŠå¤©æ¶ˆæ¯ï¼ˆç°åœ¨ç”± dashboardLogic.ts ç®¡ç†ï¼Œè¿™é‡Œä¸å†æ›´æ–°ï¼‰\n      // this.updateChatMessages();\n\n      // è¯»å–å¹¶æ˜¾ç¤º maintextï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…åœ¨åˆå§‹åŒ–æ—¶å‡ºé”™ï¼‰\n      setTimeout(() => {\n        try {\n          this.loadMaintextFromChat();\n        } catch (error) {\n          console.warn('âš ï¸ åŠ è½½ maintext å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n        }\n      }, 100);\n\n      console.info('âœ… æ¸¸æˆæ•°æ®å·²åˆ·æ–°');\n    } catch (error) {\n      console.error('âŒ åˆ·æ–°æ•°æ®æ—¶å‡ºé”™:', error);\n      // å³ä½¿å‡ºé”™ä¹Ÿç»§ç»­ï¼Œé¿å…å®Œå…¨æ— æ³•æ˜¾ç¤º\n    }\n  }\n\n  private async updateStatusCards(): Promise<void> {\n    if (!this.element) return;\n\n    const statusGrid = this.element.querySelector('#status-grid');\n    if (!statusGrid) return;\n\n    try {\n      // ä» MVU å˜é‡ç³»ç»Ÿè¯»å– system_state æ•°æ®\n      // å…³é”®ï¼šé¿å…â€œåˆšè¿›å…¥ç•Œé¢æ—¶ MVU è¿˜æœªæŠŠ stat_data æ³¨å…¥ -> è¯»ä¸åˆ° -> è½åˆ°é»˜è®¤å€¼ä¸”ä¸å†åˆ·æ–°â€\n      await waitGlobalInitialized('Mvu');\n      await waitUntil(() => _.has(getVariables({ type: 'message' }), 'stat_data'), {\n        timeout: 3000,\n        intervalBetweenAttempts: 100,\n      }).catch(() => {\n        // timeout ä¸ç®—è‡´å‘½ï¼šä¸‹é¢ä¼šå±•ç¤ºâ€œåŠ è½½ä¸­â€¦â€ï¼Œå¹¶è‡ªåŠ¨é‡è¯•\n      });\n\n      // ä¼˜å…ˆä» chat å˜é‡è¡¨è¯»å–ï¼ˆä½œä¸ºâ€œå½“å‰çŠ¶æ€â€æ¥æºï¼‰\n      const chatData = Mvu.getMvuData({ type: 'chat' });\n      const chatSystemState = _.get(chatData, 'stat_data.system_state');\n\n      // å…œåº•æ¥æºï¼šlatest message + 0 å±‚ï¼ˆinitvarï¼‰ï¼Œç”¨äºè¡¥é½ç¼ºå¤±å­—æ®µ\n      let latestSystemState: any = null;\n      let initSystemState: any = null;\n      try {\n        const latest = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n        latestSystemState = _.get(latest, 'stat_data.system_state');\n      } catch (e) {\n        console.warn('âš ï¸ è¯»å– latest message çš„ system_state å¤±è´¥:', e);\n      }\n      try {\n        const initMsg = Mvu.getMvuData({ type: 'message', message_id: 0 });\n        initSystemState = _.get(initMsg, 'stat_data.system_state');\n      } catch (e) {\n        // message 0 å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥\n      }\n\n      // åˆå¹¶ï¼šinit -> latest -> chatï¼ˆchat ä¼˜å…ˆè¦†ç›–ï¼‰\n      const systemState: any = _.merge({}, initSystemState || {}, latestSystemState || {}, chatSystemState || {});\n\n      const hasSystemStateData =\n        systemState &&\n        (systemState.cycle !== undefined ||\n          systemState.system_pressure !== undefined ||\n          systemState.instability !== undefined ||\n          !!systemState.population ||\n          !!systemState.antimatter);\n\n      // ä»ç„¶æ²¡æœ‰ï¼šä¸è¦ç”¨å‡é»˜è®¤å€¼è¦†ç›–ï¼›æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€å¹¶é‡è¯•\n      if (!hasSystemStateData) {\n        statusGrid.innerHTML = '<div class=\"status-empty\">ç³»ç»ŸçŠ¶æ€åŠ è½½ä¸­â€¦</div>';\n\n        if (this.statusRetryCount < 10) {\n          this.statusRetryCount += 1;\n          if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n          this.statusRetryTimer = window.setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 250);\n        }\n        return;\n      }\n\n      // è¯»åˆ°äº†å°±æ¸…ç†é‡è¯•çŠ¶æ€\n      this.statusRetryCount = 0;\n      if (this.statusRetryTimer !== null) {\n        window.clearTimeout(this.statusRetryTimer);\n        this.statusRetryTimer = null;\n      }\n\n      // æ ¹æ® initvar ä¸­çš„å˜é‡ç»“æ„æ¸²æŸ“çŠ¶æ€å¡ç‰‡\n      const cards: string[] = [];\n\n      // Cycle (æ—¶é—´è®¡æ•°å•ä½)\n      if (systemState.cycle !== undefined) {\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-clock status-card-icon\"></i>\n              <span class=\"status-card-title\">æ—¶é—´å‘¨æœŸ</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${systemState.cycle}</span>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Antimatter (åç‰©è´¨)\n      if (systemState.antimatter) {\n        const reserve = systemState.antimatter.reserve ?? 0;\n        const leakRisk = systemState.antimatter.leak_risk ?? 0;\n        const reservePercent = Math.round((reserve / 100000) * 100);\n        const riskLevel = leakRisk < 0.3 ? 'low' : leakRisk < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-atom status-card-icon\"></i>\n              <span class=\"status-card-title\">åç‰©è´¨å‚¨å¤‡</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${reserve.toLocaleString()}</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill\" style=\"width: ${reservePercent}%\"></div>\n                </div>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  æ³„æ¼é£é™©: <span class=\"risk-${riskLevel}\">${(leakRisk * 100).toFixed(1)}%</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Population (äººå£)\n      if (systemState.population) {\n        const pop = systemState.population;\n        const active = pop.active ?? 0;\n        const standby = pop.standby ?? 0;\n        const archived = pop.archived ?? 0;\n        const total = active + standby + archived;\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-users status-card-icon\"></i>\n              <span class=\"status-card-title\">äººå£ç»Ÿè®¡</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${total}</span>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  å¯ç”¨: ${active} | å¾…æœº: ${standby} | å½’æ¡£: ${archived}\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // System Pressure (ç³»ç»Ÿå‹åŠ›)\n      if (systemState.system_pressure !== undefined) {\n        const pressure = systemState.system_pressure ?? 0;\n        const pressurePercent = Math.round(pressure * 100);\n        const pressureLevel = pressure < 0.5 ? 'low' : pressure < 0.8 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-tachometer-alt status-card-icon\"></i>\n              <span class=\"status-card-title\">ç³»ç»Ÿå‹åŠ›</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${pressurePercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${pressureLevel}\" style=\"width: ${pressurePercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Instability (ç³»ç»Ÿä¸ç¨³å®šæ€§)\n      if (systemState.instability !== undefined) {\n        const instability = systemState.instability ?? 0;\n        const instabilityPercent = Math.round(instability * 100);\n        const instabilityLevel = instability < 0.3 ? 'low' : instability < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-exclamation-triangle status-card-icon\"></i>\n              <span class=\"status-card-title\">ç³»ç»Ÿä¸ç¨³å®šæ€§</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${instabilityPercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${instabilityLevel}\" style=\"width: ${instabilityPercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      if (cards.length > 0) {\n        statusGrid.innerHTML = cards.join('');\n      } else {\n        statusGrid.innerHTML = '<div class=\"status-empty\">æš‚æ— ç³»ç»ŸçŠ¶æ€æ•°æ®</div>';\n      }\n    } catch (error) {\n      console.error('âŒ æ›´æ–°çŠ¶æ€å¡ç‰‡å¤±è´¥:', error);\n      statusGrid.innerHTML = '<div class=\"status-empty\">åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥</div>';\n    }\n  }\n\n  private updateTasksList(): void {\n    if (!this.element) return;\n\n    const tasksList = this.element.querySelector('#tasks-list');\n    if (!tasksList) return;\n\n    // å¦‚æœgameData.taskså­˜åœ¨ä¸”æ˜¯æ•°ç»„ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤ä»»åŠ¡\n    const tasks =\n      this.gameData.tasks && Array.isArray(this.gameData.tasks) && this.gameData.tasks.length > 0\n        ? this.gameData.tasks\n        : this.getDefaultTasks();\n\n    tasksList.innerHTML = tasks\n      .map(\n        task => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas ${this.getTaskIcon(task.status)}\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(task.title)}</span>\n            <span class=\"entry-status ${task.status}\">${this.getStatusText(task.status)}</span>\n          </div>\n          <div class=\"entry-meta\">\n            <span class=\"entry-time\">${task.time}</span>\n            <span class=\"entry-priority priority-${task.priority}\">${this.getPriorityText(task.priority)}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(task.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateDiaryList(): void {\n    if (!this.element) return;\n\n    const diaryList = this.element.querySelector('#diary-list');\n    if (!diaryList) return;\n\n    // å¦‚æœgameData.diaryå­˜åœ¨ä¸”æ˜¯æ•°ç»„ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ—¥è®°\n    const diary =\n      this.gameData.diary && Array.isArray(this.gameData.diary) && this.gameData.diary.length > 0\n        ? this.gameData.diary\n        : this.getDefaultDiary();\n\n    diaryList.innerHTML = diary\n      .map(\n        entry => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas fa-book-open\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(entry.title)}</span>\n            <span class=\"entry-date\">${entry.date}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(entry.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateChatMessages(): void {\n    // æ³¨æ„ï¼šé€šè®¯æ¨¡å—çš„æ¶ˆæ¯ç°åœ¨ç”± dashboardLogic.ts ä¸­çš„ initChatInterface ç®¡ç†\n    // è¿™é‡Œä¸å†æ›´æ–°ï¼Œé¿å…å†²çª\n    // é€šè®¯æ¨¡å—ä¼šä» getChatMessages è¯»å–å†å²æ¶ˆæ¯\n  }\n\n  private getDefaultTasks() {\n    return [\n      {\n        id: '1',\n        title: 'ç»´æŠ¤èƒ½æºç³»ç»Ÿ',\n        status: 'completed' as const,\n        priority: 'high' as const,\n        time: '01-15 14:30',\n        description: 'æ£€æŸ¥å¹¶ç»´æŠ¤ç©ºé—´ç«™èƒ½æºç³»ç»Ÿï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡æ­£å¸¸è¿è¡Œ',\n      },\n      {\n        id: '2',\n        title: 'ç‰©èµ„è¡¥ç»™ä»»åŠ¡',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 10:00',\n        description: 'æ¥æ”¶å¹¶åˆ†é…æ–°ä¸€æ‰¹ç‰©èµ„è¡¥ç»™ï¼Œæ›´æ–°åº“å­˜è®°å½•',\n      },\n      {\n        id: '3',\n        title: 'ç´§æ€¥ç»´ä¿®ä»»åŠ¡',\n        status: 'pending' as const,\n        priority: 'urgent' as const,\n        time: '01-15 16:00',\n        description: 'æ£€æµ‹åˆ°ç”Ÿå‘½ç»´æŒç³»ç»Ÿå¼‚å¸¸ï¼Œéœ€è¦ç«‹å³è¿›è¡Œç»´ä¿®æ£€æŸ¥',\n      },\n      {\n        id: '4',\n        title: 'å®éªŒæ•°æ®åˆ†æ',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 09:00',\n        description: 'åˆ†ææœ€æ–°å®éªŒæ•°æ®ï¼Œç”ŸæˆæŠ¥å‘Šå¹¶ä¸Šä¼ è‡³ç³»ç»Ÿ',\n      },\n      {\n        id: '5',\n        title: 'é€šä¿¡ç³»ç»Ÿæ ¡å‡†',\n        status: 'pending' as const,\n        priority: 'low' as const,\n        time: '01-16 08:00',\n        description: 'å®šæœŸæ ¡å‡†é€šä¿¡ç³»ç»Ÿï¼Œç¡®ä¿ä¸åœ°çƒæ€»éƒ¨çš„ç¨³å®šè¿æ¥',\n      },\n      {\n        id: '6',\n        title: 'é˜²æŠ¤ç³»ç»Ÿæ£€æŸ¥',\n        status: 'pending' as const,\n        priority: 'high' as const,\n        time: '01-16 10:00',\n        description: 'æ£€æŸ¥ç©ºé—´ç«™é˜²æŠ¤ç³»ç»Ÿï¼ŒåŒ…æ‹¬è¾å°„é˜²æŠ¤å’Œå¾®é™¨çŸ³é˜²æŠ¤',\n      },\n      {\n        id: '7',\n        title: 'ç³»ç»Ÿå¤‡ä»½',\n        status: 'completed' as const,\n        priority: 'medium' as const,\n        time: '01-15 03:00',\n        description: 'å®Œæˆæ¯æ—¥ç³»ç»Ÿæ•°æ®å¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨',\n      },\n      {\n        id: '8',\n        title: 'äººå‘˜è½®æ¢',\n        status: 'in-progress' as const,\n        priority: 'medium' as const,\n        time: '01-15 12:00',\n        description: 'æ‰§è¡Œäººå‘˜è½®æ¢è®¡åˆ’ï¼Œç¡®ä¿å„å²—ä½æ­£å¸¸è¿è½¬',\n      },\n    ];\n  }\n\n  private getDefaultDiary() {\n    return [\n      {\n        id: '1',\n        title: 'æ—¥å¸¸è®°å½•',\n        date: '01-15',\n        description: 'ç©ºé—´ç«™è¿è¡Œæ­£å¸¸ï¼Œæ‰€æœ‰ç³»ç»ŸæŒ‡æ ‡åœ¨å®‰å…¨èŒƒå›´å†…ã€‚å®Œæˆèƒ½æºç³»ç»Ÿä¾‹è¡Œæ£€æŸ¥ï¼Œæœªå‘ç°å¼‚å¸¸ã€‚',\n      },\n      {\n        id: '2',\n        title: 'ç‰©èµ„è¡¥ç»™',\n        date: '01-14',\n        description: 'æ¥æ”¶æ–°ä¸€æ‰¹ç‰©èµ„è¡¥ç»™ï¼ŒåŒ…æ‹¬é£Ÿç‰©ã€åŒ»ç–—ç”¨å“å’Œå·¥ç¨‹ææ–™ã€‚å·²æŒ‰æ ‡å‡†æµç¨‹æ¸…ç‚¹å’Œåˆ†é…ã€‚',\n      },\n      {\n        id: '3',\n        title: 'ç³»ç»Ÿç»´æŠ¤',\n        date: '01-13',\n        description: 'è¿›è¡Œæœˆåº¦ç³»ç»Ÿç»´æŠ¤ï¼Œæ›´æ–°éƒ¨åˆ†è€åŒ–è®¾å¤‡ã€‚ç»´æŠ¤è¿‡ç¨‹æœªå‘ç°é‡å¤§é—®é¢˜ï¼Œè¿è¡Œç¨³å®šã€‚',\n      },\n      {\n        id: '4',\n        title: 'å®éªŒæŠ¥å‘Š',\n        date: '01-12',\n        description: 'å®Œæˆç¬¬47æ¬¡é›¶é‡åŠ›å®éªŒï¼Œæ•°æ®é‡‡é›†æ­£å¸¸ã€‚åˆæ­¥åˆ†ææ˜¾ç¤ºå®éªŒç»“æœç¬¦åˆé¢„æœŸã€‚',\n      },\n      {\n        id: '5',\n        title: 'é€šä¿¡æ—¥å¿—',\n        date: '01-11',\n        description: 'ä¸åœ°çƒæ€»éƒ¨å»ºç«‹ç¨³å®šè¿æ¥ï¼Œå»¶è¿Ÿ12msã€‚æ¥æ”¶æœ€æ–°æŒ‡ä»¤ï¼Œå‡†å¤‡æ‰§è¡Œä¸‹ä¸€é˜¶æ®µä»»åŠ¡ã€‚',\n      },\n      {\n        id: '6',\n        title: 'å®‰å…¨æ£€æŸ¥',\n        date: '01-10',\n        description: 'å®Œæˆæ¯å‘¨å®‰å…¨æ£€æŸ¥ï¼Œæ‰€æœ‰é˜²æŠ¤ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚è¾å°„æ°´å¹³åœ¨å®‰å…¨èŒƒå›´å†…ã€‚',\n      },\n      {\n        id: '7',\n        title: 'äººå‘˜æ—¥å¿—',\n        date: '01-09',\n        description: 'æ‰§è¡Œäººå‘˜å¥åº·æ£€æŸ¥ï¼Œæ‰€æœ‰æˆå‘˜èº«ä½“çŠ¶å†µè‰¯å¥½ã€‚å®Œæˆå¿ƒç†è¯„ä¼°ï¼ŒçŠ¶æ€æ­£å¸¸ã€‚',\n      },\n      {\n        id: '8',\n        title: 'ç³»ç»Ÿæ›´æ–°',\n        date: '01-08',\n        description: 'å®‰è£…ç³»ç»Ÿè¡¥ä¸v2.3.1ï¼Œä¿®å¤å·²çŸ¥æ¼æ´ã€‚é‡å¯åç³»ç»Ÿè¿è¡Œç¨³å®šï¼Œæ€§èƒ½æå‡5%ã€‚',\n      },\n    ];\n  }\n\n  private getDefaultMessages() {\n    return [\n      { id: '1', role: 'user' as const, content: 'ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ç©ºé—´ç«™çš„å½“å‰çŠ¶æ€ã€‚', time: '14:32' },\n      {\n        id: '2',\n        role: 'assistant' as const,\n        content:\n          'æ‚¨å¥½ï¼ç©ºé—´ç«™å½“å‰è¿è¡ŒçŠ¶æ€è‰¯å¥½ã€‚èƒ½æºç³»ç»Ÿï¼š87%ï¼Œç”Ÿå‘½ç»´æŒç³»ç»Ÿï¼š92%ï¼Œç³»ç»Ÿå®Œæ•´æ€§ï¼š78%ã€‚æ‰€æœ‰å…³é”®æŒ‡æ ‡å‡åœ¨å®‰å…¨èŒƒå›´å†…ã€‚éœ€è¦æˆ‘è¯¦ç»†è¯´æ˜æŸä¸ªç³»ç»Ÿçš„çŠ¶æ€å—ï¼Ÿ',\n        time: '14:32',\n      },\n      { id: '3', role: 'user' as const, content: 'èƒ½æºç³»ç»Ÿçš„è¯¦ç»†æƒ…å†µå¦‚ä½•ï¼Ÿ', time: '14:33' },\n      {\n        id: '4',\n        role: 'assistant' as const,\n        content:\n          'èƒ½æºç³»ç»Ÿå½“å‰è¿è¡Œåœ¨87%çš„å®¹é‡æ°´å¹³ã€‚ä¸»è¦èƒ½æºæ¥æºåŒ…æ‹¬å¤ªé˜³èƒ½ç”µæ± æ¿å’Œå¤‡ç”¨æ ¸èƒ½å‘ç”µæœºã€‚æœ€è¿‘ä¸€æ¬¡æ£€æŸ¥æ˜¾ç¤ºæ‰€æœ‰ç»„ä»¶è¿è¡Œæ­£å¸¸ï¼Œé¢„è®¡å¯ä»¥ç»´æŒå½“å‰è´Ÿè½½è‡³å°‘30å¤©ã€‚å»ºè®®åœ¨ä¸‹å‘¨è¿›è¡Œä¾‹è¡Œç»´æŠ¤æ£€æŸ¥ã€‚',\n        time: '14:33',\n      },\n    ];\n  }\n\n  private getTaskIcon(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'fa-check-circle';\n      case 'in-progress':\n        return 'fa-clock';\n      case 'pending':\n        return 'fa-exclamation-circle';\n      default:\n        return 'fa-circle';\n    }\n  }\n\n  private getStatusText(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'å®Œæˆ';\n      case 'in-progress':\n        return 'è¿›è¡Œä¸­';\n      case 'pending':\n        return 'å¾…å¤„ç†';\n      default:\n        return status;\n    }\n  }\n\n  private getPriorityText(priority: string): string {\n    switch (priority) {\n      case 'urgent':\n        return 'ç´§æ€¥';\n      case 'high':\n        return 'é«˜';\n      case 'medium':\n        return 'ä¸­';\n      case 'low':\n        return 'ä½';\n      default:\n        return priority;\n    }\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * è§£æ maintext çš„å·¥å…·å‡½æ•°ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰\n   */\n  private parseMaintext(messageContent: string): string {\n    const maintextMatch = messageContent.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n    if (!maintextMatch) {\n      return '';\n    }\n    return maintextMatch[1].trim();\n  }\n\n  /**\n   * ä»æœ€æ–°æ¥¼å±‚è¯»å– maintext å¹¶æ˜¾ç¤ºåœ¨ä¸‰ä¸ªæ–‡æœ¬æ¡†ä¸­\n   * ä¼˜å…ˆä½¿ç”¨ç»“æ„åŒ–æ ‡ç­¾ï¼ˆcontinue_choice, result, decision_nodeï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°æ—§æ ¼å¼\n   */\n  public loadMaintextFromChat(): void {\n    if (!this.element) return;\n\n    try {\n      // æ£€æŸ¥ getChatMessages æ˜¯å¦å¯ç”¨\n      if (typeof getChatMessages === 'undefined') {\n        console.warn('âš ï¸ getChatMessages ä¸å¯ç”¨');\n        return;\n      }\n\n      // 1. å…ˆå°è¯•è·å–æœ€æ–°çš„ assistant æ¶ˆæ¯\n      let messages: Array<{ message: string; message_id: number; role: string }> = [];\n      try {\n        messages = getChatMessages(-1, { role: 'assistant' });\n      } catch (error) {\n        console.warn('âš ï¸ è·å– assistant æ¶ˆæ¯å¤±è´¥:', error);\n      }\n\n      let lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n\n      // 2. å¦‚æœæ²¡æœ‰ assistant æ¶ˆæ¯ï¼Œè·å–æœ€æ–°æ¶ˆæ¯ï¼ˆä¸é™åˆ¶ roleï¼‰\n      if (!lastMessage) {\n        try {\n          messages = getChatMessages(-1);\n          lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n        } catch (error) {\n          console.warn('âš ï¸ è·å–æœ€æ–°æ¶ˆæ¯å¤±è´¥:', error);\n        }\n      }\n\n      if (!lastMessage) {\n        return;\n      }\n\n      // 3. æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™æ¡æ¶ˆæ¯ï¼ˆé¿å…é‡å¤ï¼‰\n      if (this.loadedMessageIds.has(lastMessage.message_id)) {\n        return;\n      }\n\n      // 4. è§£ææ¶ˆæ¯å†…å®¹\n      const messageContent = lastMessage.message || '';\n\n      // åŠ¨æ€å¯¼å…¥ textParser\n      import('../utils/textParser')\n        .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n          const el = this.element;\n          if (!el) return;\n\n          // 5. å°è¯•æå–ç»“æ„åŒ–æ ‡ç­¾\n          const continueChoice = extractContinueChoice(messageContent);\n          const result = extractResult(messageContent);\n          const nextChoice = extractNextChoice(messageContent);\n\n          // 6. è·å–ä¸‰ä¸ªæ–‡æœ¬æ¡†å…ƒç´ \n          const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n          const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n          if (continueChoice || result || nextChoice) {\n            // ä½¿ç”¨ç»“æ„åŒ–æ ‡ç­¾\n            if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n            if (resultArea) resultArea.textContent = result || '';\n            if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n          } else {\n            // å›é€€åˆ°æ—§æ ¼å¼ï¼šå°† maintext å†…å®¹æ˜¾ç¤ºåœ¨ next_choice åŒºåŸŸ\n            const maintext = this.parseMaintext(messageContent);\n            if (nextChoiceArea && maintext) {\n              nextChoiceArea.textContent = maintext;\n            }\n            // æ¸…ç©ºå…¶ä»–ä¸¤ä¸ªåŒºåŸŸ\n            if (continueChoiceArea) continueChoiceArea.textContent = '';\n            if (resultArea) resultArea.textContent = '';\n          }\n\n          // æ ‡è®°å·²åŠ è½½\n          this.loadedMessageIds.add(lastMessage.message_id);\n          console.info(`âœ… å·²åŠ è½½ maintext (message_id: ${lastMessage.message_id})`);\n        })\n        .catch(error => {\n          console.error('âŒ å¯¼å…¥ textParser å¤±è´¥:', error);\n          const el = this.element;\n          if (!el) return;\n          // é™çº§å¤„ç†ï¼šä½¿ç”¨æ—§æ ¼å¼\n          const maintext = this.parseMaintext(messageContent);\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n          if (nextChoiceArea && maintext) {\n            nextChoiceArea.textContent = maintext;\n          }\n        });\n    } catch (error) {\n      console.error('âŒ åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);\n    }\n  }\n\n  /**\n   * ç›‘å¬æ¶ˆæ¯å˜åŒ–äº‹ä»¶ï¼Œè‡ªåŠ¨æ›´æ–°æ˜¾ç¤º\n   */\n  private setupMessageListener(): void {\n    try {\n      if (typeof eventOn === 'undefined' || typeof tavern_events === 'undefined') {\n        console.warn('âš ï¸ äº‹ä»¶ç›‘å¬ API ä¸å¯ç”¨');\n        return;\n      }\n\n      const handleMessageReceived = () => {\n        // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ¶ˆæ¯å·²å†™å…¥\n        setTimeout(() => {\n          try {\n            this.loadMaintextFromChat();\n            // å…œåº•ï¼šæ¶ˆæ¯å˜åŒ–æ—¶ä¹Ÿåˆ·æ–°çŠ¶æ€æ ï¼ˆé˜²æ­¢ MVU äº‹ä»¶åœ¨æŸäº›é“¾è·¯ä¸è§¦å‘ï¼‰\n            this.updateStatusCards().catch(() => {});\n          } catch (error) {\n            console.error('âŒ å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);\n          }\n        }, 150);\n      };\n\n      // ç›‘å¬ MESSAGE_RECEIVED å’Œ CHAT_CHANGED äº‹ä»¶\n      if (tavern_events.MESSAGE_RECEIVED) {\n        eventOn(tavern_events.MESSAGE_RECEIVED, handleMessageReceived);\n      }\n      if (tavern_events.CHAT_CHANGED) {\n        eventOn(tavern_events.CHAT_CHANGED, handleMessageReceived);\n      }\n      if (tavern_events.MESSAGE_UPDATED) {\n        eventOn(tavern_events.MESSAGE_UPDATED, handleMessageReceived);\n      }\n\n      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ refresh-maintextï¼ˆç”¨äºåœ¨å¯¹è¯å®Œæˆåæ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼‰\n      if (this.element) {\n        this.element.addEventListener('refresh-maintext', () => {\n          setTimeout(() => {\n            this.loadMaintextFromChat();\n          }, 100);\n        });\n        this.element.addEventListener('refresh-status', () => {\n          setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 50);\n        });\n      }\n\n      console.info('âœ… å·²è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');\n    } catch (error) {\n      console.error('âŒ è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨å¤±è´¥:', error);\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) {\n      console.warn('âš ï¸ Dashboard element ä¸º nullï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');\n      return;\n    }\n\n    try {\n      // å…¨å±æŒ‰é’®\n      const fullscreenButton = this.element.querySelector('#dashboard-fullscreen-button');\n      if (fullscreenButton) {\n        fullscreenButton.addEventListener('click', () => {\n          this.toggleFullscreen();\n        });\n      } else {\n        console.warn('âš ï¸ æœªæ‰¾åˆ°å…¨å±æŒ‰é’®å…ƒç´ ');\n      }\n\n      // Enter é”®å…¨å±æ”¯æŒ\n      this.setupEnterKeyFullscreen();\n\n      // å¯¼èˆªåˆ‡æ¢äº‹ä»¶å°†åœ¨ app.ts ä¸­å¤„ç†\n\n      // è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆéœ€è¦æ£€æŸ¥ API æ˜¯å¦å¯ç”¨ï¼Œå»¶è¿Ÿæ‰§è¡Œé¿å…åˆå§‹åŒ–æ—¶å‡ºé”™ï¼‰\n      setTimeout(() => {\n        try {\n          if (typeof eventOn !== 'undefined' && typeof tavern_events !== 'undefined') {\n            this.setupMessageListener();\n          } else {\n            console.warn('âš ï¸ äº‹ä»¶ç›‘å¬ API ä¸å¯ç”¨ï¼Œè·³è¿‡æ¶ˆæ¯ç›‘å¬å™¨è®¾ç½®');\n          }\n        } catch (error) {\n          console.warn('âš ï¸ è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨å¤±è´¥ï¼ˆéå…³é”®é”™è¯¯ï¼‰:', error);\n        }\n      }, 200);\n\n      // ç›‘å¬ MVU å˜é‡æ›´æ–°ç»“æŸ -> åˆ·æ–°çŠ¶æ€å¡ç‰‡\n      setTimeout(async () => {\n        try {\n          await waitGlobalInitialized('Mvu');\n          if (this.mvuUpdateListener) return;\n          if (typeof Mvu === 'undefined' || !Mvu.events?.VARIABLE_UPDATE_ENDED) return;\n\n          this.mvuUpdateListener = eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, () => {\n            if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n            this.statusRetryTimer = window.setTimeout(() => {\n              this.updateStatusCards().catch(() => {});\n            }, 50);\n          });\n        } catch (e) {\n          console.warn('âš ï¸ MVU äº‹ä»¶ç›‘å¬å®‰è£…å¤±è´¥:', e);\n        }\n      }, 250);\n    } catch (error) {\n      console.error('âŒ bindEvents å¤±è´¥:', error);\n      // å³ä½¿ç»‘å®šå¤±è´¥ï¼Œä¹Ÿç»§ç»­ï¼Œé¿å…å®Œå…¨æ— æ³•ä½¿ç”¨\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <!-- é¡¶éƒ¨å¯¼èˆªæ  -->\n      <header class=\"main-header\">\n        <div class=\"header-content\">\n          <div class=\"logo-section\">\n            <i class=\"fas fa-anchor logo-icon\"></i>\n            <h1 class=\"logo-text\">é”š</h1>\n          </div>\n          <!-- æ¨¡å—åˆ‡æ¢å¯¼èˆª -->\n          <nav class=\"top-nav-menu\">\n            <button type=\"button\" class=\"nav-item active\" data-module=\"status\" id=\"nav-status\" title=\"èˆ°ä½“çŠ¶æ€ (1)\">\n              <span class=\"nav-shortcut\">1</span>\n              <i class=\"fas fa-chart-line nav-icon\"></i>\n              <span class=\"nav-text\">èˆ°ä½“çŠ¶æ€</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"tasks\" id=\"nav-tasks\" title=\"ä»»åŠ¡æ¨¡å— (2)\">\n              <span class=\"nav-shortcut\">2</span>\n              <i class=\"fas fa-tasks nav-icon\"></i>\n              <span class=\"nav-text\">ä»»åŠ¡æ¨¡å—</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"diary\" id=\"nav-diary\" title=\"æ—¥è®°æ¨¡å— (3)\">\n              <span class=\"nav-shortcut\">3</span>\n              <i class=\"fas fa-book nav-icon\"></i>\n              <span class=\"nav-text\">æ—¥è®°æ¨¡å—</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"communication\" id=\"nav-communication\" title=\"é€šè®¯æ¨¡å— (4)\">\n              <span class=\"nav-shortcut\">4</span>\n              <i class=\"fas fa-comments nav-icon\"></i>\n              <span class=\"nav-text\">é€šè®¯æ¨¡å—</span>\n            </button>\n          </nav>\n          <div class=\"header-actions\">\n            <button type=\"button\" class=\"fullscreen-button\" id=\"dashboard-fullscreen-button\" title=\"å…¨å± (Enter)\">\n              <i class=\"fas fa-expand\"></i>\n            </button>\n            <div class=\"header-status\">\n              <div class=\"status-indicator online\">\n                <span class=\"status-dot\"></span>\n                <span class=\"status-text\">ç³»ç»Ÿåœ¨çº¿</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <!-- ä¸»å†…å®¹åŒºåŸŸ -->\n      <main class=\"main-content\">\n        <!-- å†…å®¹é¢æ¿ -->\n        <section class=\"content-panel\">\n          <!-- ç©ºé—´ç«™çŠ¶æ€æ¨¡å—ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->\n          <div class=\"module-container active\" id=\"module-status\">\n            <div class=\"module-body\">\n              <!-- ä¸»æ–‡æœ¬æ¡†åŒºåŸŸ -->\n              <div class=\"maintext-container\">\n                <div class=\"maintext-header\">\n                  <h3 class=\"maintext-title\">\n                    <i class=\"fas fa-scroll\"></i>\n                    å½“å‰å‰§æƒ…\n                  </h3>\n                </div>\n                <div class=\"maintext-areas\">\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-history\" title=\"äº‹ä»¶å»¶ç»­\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-continue-choice\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-microchip\" title=\"ç³»ç»Ÿè®°å½•\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-result\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-bolt\" title=\"æ–°çš„äº‹ä»¶\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-next-choice\"></div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"status-grid\" id=\"status-grid\"></div>\n            </div>\n          </div>\n\n          <!-- ä»»åŠ¡æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-tasks\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"tasks-list\"></div>\n            </div>\n          </div>\n\n          <!-- æ—¥è®°æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-diary\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"diary-list\"></div>\n            </div>\n          </div>\n\n          <!-- é€šè®¯æ¨¡å— -->\n          <div class=\"module-container\" id=\"module-communication\">\n            <div class=\"module-body communication-body\">\n              <div class=\"chat-messages\" id=\"chat-messages\"></div>\n              <div class=\"chat-input-container\">\n                <div class=\"chat-input-wrapper\">\n                  <button type=\"button\" id=\"chat-show-options-btn\" class=\"chat-show-options-btn\" title=\"æ˜¾ç¤ºé€‰é¡¹\">\n                    <i class=\"fas fa-list\"></i>\n                  </button>\n                  <button\n                    type=\"button\"\n                    id=\"chat-regenerate-btn\"\n                    class=\"chat-regenerate-btn\"\n                    title=\"é‡æ–°ç”Ÿæˆå½“å‰è½®ï¼ˆä¼šåˆ é™¤æœ¬è½® user/assistant æ¶ˆæ¯ï¼‰\"\n                  >\n                    <i class=\"fas fa-rotate-right\"></i>\n                  </button>\n                  <textarea id=\"chat-input\" class=\"chat-input\" placeholder=\"è¾“å…¥æ¶ˆæ¯...\" rows=\"1\"></textarea>\n                  <button type=\"button\" id=\"chat-send-btn\" class=\"chat-send-btn\">\n                    <i class=\"fas fa-paper-plane\"></i>\n                  </button>\n                </div>\n              </div>\n              <!-- Option é€‰é¡¹æµ®å±‚å®¹å™¨ -->\n              <div class=\"chat-options-overlay\" id=\"chat-options-overlay\">\n                <div class=\"chat-options-container\" id=\"chat-options-container\">\n                  <div class=\"chat-options-header\">\n                    <span class=\"chat-options-title\">å¯ç”¨é€‰é¡¹</span>\n                    <button type=\"button\" class=\"chat-options-close\" id=\"chat-options-close\" title=\"å…³é—­\">\n                      <i class=\"fas fa-times\"></i>\n                    </button>\n                  </div>\n                </div>\n                <div class=\"chat-options-list\" id=\"chat-options-list\"></div>\n              </div>\n            </div>\n          </div>\n        </section>\n      </main>\n\n      <!-- æ¨¡æ€æ¡†å®¹å™¨ -->\n      <div class=\"modal-overlay\" id=\"modal-overlay\">\n        <div class=\"modal-container\" id=\"modal-container\">\n          <div class=\"modal-header\">\n            <h3 class=\"modal-title\" id=\"modal-title\">æ ‡é¢˜</h3>\n            <button class=\"modal-close\" id=\"modal-close\">\n              <i class=\"fas fa-times\"></i>\n            </button>\n          </div>\n          <div class=\"modal-body\" id=\"modal-body\"></div>\n        </div>\n      </div>\n\n    `;\n  }\n\n  private setupEnterKeyFullscreen(): void {\n    try {\n      // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n      if (this.keyDownHandler) {\n        document.removeEventListener('keydown', this.keyDownHandler);\n        this.keyDownHandler = null;\n      }\n\n      // åˆ›å»ºæ–°çš„äº‹ä»¶ç›‘å¬å™¨\n      this.keyDownHandler = (e: KeyboardEvent) => {\n        try {\n          // åªåœ¨ Dashboard æ˜¾ç¤ºæ—¶å“åº”\n          if (!this.element?.classList.contains('active')) {\n            return;\n          }\n\n          // å¦‚æœè¾“å…¥æ¡†èšç„¦ï¼Œä¸å¤„ç† Enter é”®å’Œ Esc é”®\n          const activeElement = document.activeElement;\n          if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {\n            return;\n          }\n\n          // Enter é”®è§¦å‘å…¨å±\n          if (e.key === 'Enter') {\n            e.preventDefault();\n            this.toggleFullscreen();\n          }\n        } catch (error) {\n          console.error('âŒ é”®ç›˜äº‹ä»¶å¤„ç†å¤±è´¥:', error);\n        }\n      };\n\n      document.addEventListener('keydown', this.keyDownHandler);\n      console.log('âœ… Enter é”®å…¨å±æ”¯æŒå·²è®¾ç½®');\n    } catch (error) {\n      console.error('âŒ è®¾ç½®é”®ç›˜äº‹ä»¶æ”¯æŒå¤±è´¥:', error);\n    }\n  }\n\n  private requestFullscreen(): void {\n    try {\n      const element = document.documentElement;\n      if (element.requestFullscreen) {\n        element.requestFullscreen().catch(err => {\n          console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n        });\n      } else if ((element as any).webkitRequestFullscreen) {\n        (element as any).webkitRequestFullscreen();\n      } else if ((element as any).mozRequestFullScreen) {\n        (element as any).mozRequestFullScreen();\n      } else if ((element as any).msRequestFullscreen) {\n        (element as any).msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ è¯·æ±‚å…¨å±å¤±è´¥:', error);\n    }\n  }\n\n  private exitFullscreen(): void {\n    try {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ é€€å‡ºå…¨å±å¤±è´¥:', error);\n    }\n  }\n\n  private toggleFullscreen(): void {\n    try {\n      if (!document.fullscreenElement) {\n        this.requestFullscreen();\n      } else {\n        this.exitFullscreen();\n      }\n    } catch (error) {\n      console.error('âŒ åˆ‡æ¢å…¨å±å¤±è´¥:', error);\n    }\n  }\n}\n","import _ from 'lodash';\nimport { GameConfig, GameData } from '../types/types';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (\n    mvu_data: any,\n    options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' },\n  ) => Promise<void>;\n};\n\n/**\n * æ›´æ–° MVU å˜é‡ï¼ˆå°†è¡¨å•è¾“å…¥çš„å€¼å†™å…¥ MVU å˜é‡ç³»ç»Ÿï¼‰\n */\nexport async function updateMvuVariables(config: GameConfig): Promise<void> {\n  try {\n    // ç¡®ä¿ MVU å·²åˆå§‹åŒ–\n    await waitGlobalInitialized('Mvu');\n\n    // è·å–å½“å‰çš„ MVU æ•°æ®\n    // ä¼˜å…ˆæ›´æ–° chat å˜é‡è¡¨ï¼Œä½œä¸ºâ€œå½“å‰çŠ¶æ€â€æ¥æºã€‚\n    // åŒæ—¶åˆå¹¶ init(0) / latest message ä»¥è¡¥é½ç¼ºå¤±å­—æ®µï¼Œé¿å…åªå†™ reserve å¯¼è‡´ system_state ç»“æ„æ®‹ç¼ºã€‚\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    chatData = Mvu.getMvuData({ type: 'chat' });\n\n    const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    const currentStatData = currentMvuData?.stat_data || {};\n\n    // æ„å»ºæ›´æ–°åçš„ stat_data\n    const updatedStatData = _.cloneDeep(currentStatData);\n\n    // æ›´æ–° system_state.antimatter.reserveï¼ˆç³»ç»Ÿå‰©ä½™èƒ½æºï¼‰\n    if (config.reserve !== undefined) {\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // ç¡®ä¿ reserve åœ¨ 0-100000 èŒƒå›´å†…\n      const clampedReserve = _.clamp(config.reserve, 0, 100000);\n      updatedStatData.system_state.antimatter.reserve = clampedReserve;\n      console.info(`âœ… æ›´æ–° system_state.antimatter.reserve: ${clampedReserve}`);\n    }\n\n    // å°†æ›´æ–°åçš„æ•°æ®å†™å› MVU\n    const updatedMvuData = {\n      ...currentMvuData,\n      stat_data: updatedStatData,\n    };\n\n    await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n    console.info('âœ… MVU å˜é‡å·²æ›´æ–°');\n  } catch (error) {\n    console.error('âŒ æ›´æ–° MVU å˜é‡å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°æ¸¸æˆæ•°æ®åˆ°é…’é¦†å˜é‡ç³»ç»Ÿ\n */\nexport async function updateGameData(data: Partial<GameData>): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_data: {\n        ...(currentData.game_data || {}),\n        ...data,\n      },\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('æ¸¸æˆæ•°æ®å·²æ›´æ–°');\n  } catch (error) {\n    console.error('æ›´æ–°æ¸¸æˆæ•°æ®å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * æ›´æ–°æ¸¸æˆé…ç½®\n */\nexport async function updateGameConfig(config: GameConfig): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_config: config,\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('æ¸¸æˆé…ç½®å·²æ›´æ–°');\n  } catch (error) {\n    console.error('æ›´æ–°æ¸¸æˆé…ç½®å¤±è´¥:', error);\n    throw error;\n  }\n}\n\n/**\n * åˆå§‹åŒ–æ¸¸æˆæ•°æ®\n */\nexport async function initializeGameData(config: GameConfig): Promise<GameData> {\n  // å…ˆæ›´æ–° MVU å˜é‡ï¼ˆå°†è¡¨å•è¾“å…¥çš„å€¼å†™å…¥ MVUï¼‰\n  await updateMvuVariables(config);\n\n  // åˆ›å»ºåŸºæœ¬çš„æ¸¸æˆæ•°æ®ç»“æ„ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰\n  const gameData: GameData = {\n    station_name: 'ç©ºé—´ç«™ Alpha', // ä¸å†ä»è¡¨å•è¯»å–\n    difficulty: 'normal', // ä¸å†ä»è¡¨å•è¯»å–\n    resources: {\n      energy: 100,\n      supplies: 100,\n      crew: 10,\n    },\n    status: {\n      energy: 87,\n      life_support: 92,\n      system: 78,\n      personnel: 'æ­£å¸¸',\n      communication: 95,\n      laboratory: 83,\n      storage: 64,\n      computing: 71,\n    },\n    tasks: [],\n    diary: [],\n    messages: [],\n  };\n\n  await updateGameData(gameData);\n  await updateGameConfig(config);\n\n  return gameData;\n}\n","import { PageState } from '../types/types';\nimport { SplashScreen } from '../components/SplashScreen';\nimport { NewGameSetup } from '../components/NewGameSetup';\nimport { Dashboard } from '../components/Dashboard';\nimport { ComponentCallbacks } from '../types/types';\nimport { initializeNewGame, continueGame } from './gameInitializer';\nimport { hasSaveData } from './variableReader';\n\n/**\n * é¡µé¢æµç¨‹ç®¡ç†å™¨\n */\nexport class PageManager {\n  private currentPage: PageState = 'splash';\n  private splashScreen: SplashScreen;\n  private setupScreen: NewGameSetup;\n  private dashboard: Dashboard;\n  private appContainer: HTMLElement;\n\n  constructor(appContainer: HTMLElement) {\n    this.appContainer = appContainer;\n\n    const callbacks: ComponentCallbacks = {\n      onStart: () => this.goToSplash(),\n      onNewGame: () => this.goToSetup(),\n      onContinue: () => this.goToGame(),\n      onConfirm: (config) => this.handleConfirm(config),\n      onCancel: () => this.goToSplash(),\n      onFullscreenToggle: () => this.toggleFullscreen(),\n    };\n\n    this.splashScreen = new SplashScreen(callbacks);\n    this.setupScreen = new NewGameSetup(callbacks);\n    this.dashboard = new Dashboard(callbacks);\n  }\n\n  public initialize(): void {\n    // åˆ›å»ºæ‰€æœ‰ç»„ä»¶\n    this.appContainer.appendChild(this.splashScreen.createElement());\n    this.appContainer.appendChild(this.setupScreen.createElement());\n    this.appContainer.appendChild(this.dashboard.createElement());\n\n    // æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¿›å…¥æ¸¸æˆï¼Œå¦åˆ™æ˜¾ç¤ºå¼€å§‹å±å¹•\n    const hasSave = hasSaveData();\n    if (hasSave) {\n      // æœ‰å­˜æ¡£ï¼Œç›´æ¥è¿›å…¥æ¸¸æˆ\n      this.goToGame();\n    } else {\n      // æ²¡æœ‰å­˜æ¡£ï¼Œæ˜¾ç¤ºå¼€å§‹å±å¹•\n      this.showPage('splash');\n    }\n  }\n\n  private showPage(page: PageState): void {\n    console.log(`ğŸ”„ å¼€å§‹åˆ‡æ¢é¡µé¢: ${page}`);\n\n    // éšè—æ‰€æœ‰é¡µé¢\n    try {\n      this.splashScreen.hide();\n      this.setupScreen.hide();\n      this.dashboard.hide();\n    } catch (error) {\n      console.warn('âš ï¸ éšè—é¡µé¢æ—¶å‡ºé”™:', error);\n    }\n\n    // æ˜¾ç¤ºç›®æ ‡é¡µé¢\n    try {\n      switch (page) {\n        case 'splash':\n          this.splashScreen.show();\n          // è¿›å…¥æ ‡é¢˜é¡µé¢æ—¶è¯·æ±‚å…¨å±\n          this.requestFullscreen();\n          break;\n        case 'setup':\n          this.setupScreen.show();\n          break;\n        case 'game':\n          this.dashboard.show();\n          // ç¡®ä¿ Dashboard å·²æ­£ç¡®æ˜¾ç¤º\n          setTimeout(() => {\n            const dashboardElement = document.getElementById('main-screen');\n            if (dashboardElement && dashboardElement.classList.contains('active')) {\n              console.log('âœ… Dashboard å·²æ­£ç¡®æ˜¾ç¤º');\n            } else {\n              console.error('âŒ Dashboard æ˜¾ç¤ºå¼‚å¸¸ï¼Œelement:', dashboardElement);\n            }\n          }, 100);\n          break;\n      }\n    } catch (error) {\n      console.error(`âŒ æ˜¾ç¤ºé¡µé¢ ${page} å¤±è´¥:`, error);\n      throw error;\n    }\n\n    this.currentPage = page;\n    console.info(`âœ… æˆåŠŸåˆ‡æ¢åˆ°é¡µé¢: ${page}`);\n  }\n\n  private goToSplash(): void {\n    this.showPage('splash');\n  }\n\n  private goToSetup(): void {\n    this.showPage('setup');\n  }\n\n  private async goToGame(): Promise<void> {\n    try {\n      console.log('ğŸ”„ å¼€å§‹åŠ è½½æ¸¸æˆ...');\n      const gameData = await continueGame();\n      console.log('âœ… æ¸¸æˆæ•°æ®åŠ è½½å®Œæˆ:', gameData);\n\n      // æ›´æ–°æ¸¸æˆæ•°æ®\n      this.dashboard.updateGameData(gameData);\n\n      // æ˜¾ç¤ºæ¸¸æˆé¡µé¢\n      this.showPage('game');\n\n      console.log('âœ… å·²åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢');\n    } catch (error) {\n      console.error('âŒ åŠ è½½æ¸¸æˆå¤±è´¥:', error);\n      console.error('âŒ é”™è¯¯è¯¦æƒ…:', {\n        error: error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorStack: error instanceof Error ? error.stack : undefined,\n      });\n\n      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºæ¸¸æˆé¡µé¢ï¼ˆä½¿ç”¨ç©ºæ•°æ®ï¼‰\n      try {\n        this.dashboard.updateGameData({});\n        this.showPage('game');\n        console.warn('âš ï¸ ä½¿ç”¨ç©ºæ•°æ®ç»§ç»­æ˜¾ç¤ºæ¸¸æˆé¡µé¢');\n      } catch (fallbackError) {\n        console.error('âŒ æ˜¾ç¤ºæ¸¸æˆé¡µé¢ä¹Ÿå¤±è´¥:', fallbackError);\n        toastr.error('åŠ è½½æ¸¸æˆå¤±è´¥', 'é”™è¯¯');\n      }\n    }\n  }\n\n  private async handleConfirm(config: any): Promise<void> {\n    try {\n      // initializeNewGame å†…éƒ¨å·²ç»ä¼šè°ƒç”¨ createOpeningStoryMessage\n      const gameData = await initializeNewGame(config);\n      this.dashboard.updateGameData(gameData);\n      this.showPage('game');\n      toastr.success('æ¸¸æˆå·²åˆå§‹åŒ–', 'æˆåŠŸ');\n    } catch (error) {\n      console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', error);\n      toastr.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥', 'é”™è¯¯');\n    }\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('å…¨å±è¯·æ±‚å¤±è´¥:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private toggleFullscreen(): void {\n    if (!document.fullscreenElement) {\n      this.requestFullscreen();\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    }\n  }\n\n  public getDashboard(): Dashboard {\n    return this.dashboard;\n  }\n}\n","import { GameConfig, GameData } from '../types/types';\nimport { initializeGameData } from './variableUpdater';\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\n\n/**\n * åˆå§‹åŒ–æ–°æ¸¸æˆ\n * ä¸å†åˆ›å»ºå¼€åœºç™½ï¼Œå¼€åœºç™½ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼ˆç¬¬ä¸€æ¡assistantæ¶ˆæ¯ï¼‰\n */\nexport async function initializeNewGame(config: GameConfig): Promise<GameData> {\n  console.info('åˆå§‹åŒ–æ–°æ¸¸æˆ...', config);\n\n  const gameData = await initializeGameData(config);\n\n  console.info('æ–°æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼ˆå¼€åœºç™½ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼‰');\n  return gameData;\n}\n\n/**\n * ç»§ç»­æ¸¸æˆ\n */\nexport async function continueGame(): Promise<Partial<GameData>> {\n  console.info('ç»§ç»­æ¸¸æˆ...');\n\n  const variables = getVariables({ type: 'message' });\n  const gameData = variables.game_data || variables.stat_data || {};\n\n  console.info('æ¸¸æˆæ•°æ®å·²åŠ è½½');\n  return gameData as Partial<GameData>;\n}\n","// é”š - Dashboard é€»è¾‘\n// åŒ…å«å¯¼èˆªã€æ¨¡æ€æ¡†ã€åŠ¨ç”»ã€çŠ¶æ€å¡ç‰‡äº¤äº’ã€èŠå¤©ç•Œé¢ç­‰åŠŸèƒ½\n\n// å…¨å±€å‡½æ•°å£°æ˜ï¼ˆç”±é…’é¦†åŠ©æ‰‹æä¾›ï¼‰\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare const errorCatched: (fn: () => void) => () => void;\n\n// ========== å¯¼èˆªåŠŸèƒ½ ==========\nexport function initNavigation() {\n  const navItems = document.querySelectorAll('.nav-item');\n  const modules = document.querySelectorAll('.module-container');\n\n  // åˆ‡æ¢æ¨¡å—çš„å‡½æ•°\n  function switchModule(moduleId: string) {\n    if (!moduleId) return;\n\n    // ç§»é™¤æ‰€æœ‰ active ç±»\n    navItems.forEach(nav => nav.classList.remove('active'));\n    modules.forEach(module => module.classList.remove('active'));\n\n    // æ·»åŠ  active ç±»\n    const targetNavItem = document.querySelector(`.nav-item[data-module=\"${moduleId}\"]`);\n    const targetModule = document.getElementById(`module-${moduleId}`);\n\n    if (targetNavItem) {\n      targetNavItem.classList.add('active');\n    }\n    if (targetModule) {\n      targetModule.classList.add('active');\n    }\n  }\n\n  // ç‚¹å‡»åˆ‡æ¢\n  navItems.forEach(item => {\n    item.addEventListener('click', () => {\n      const moduleId = item.getAttribute('data-module');\n      if (moduleId) {\n        switchModule(moduleId);\n      }\n    });\n  });\n\n  // é”®ç›˜å¿«æ·é”®åˆ‡æ¢ï¼ˆ1, 2, 3, 4ï¼‰\n  const moduleMap: Record<string, string> = {\n    '1': 'status',\n    '2': 'tasks',\n    '3': 'diary',\n    '4': 'communication',\n  };\n\n  document.addEventListener('keydown', e => {\n    // åªåœ¨ä¸»æ¸¸æˆç•Œé¢æ¿€æ´»æ—¶å“åº”ï¼Œä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­\n    const mainScreen = document.getElementById('main-screen');\n    if (!mainScreen || !mainScreen.classList.contains('active')) {\n      return;\n    }\n\n    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–å…¶ä»–å¯è¾“å…¥å…ƒç´ ä¸Šï¼Œä¸å“åº”\n    const activeElement = document.activeElement;\n    if (\n      activeElement &&\n      (activeElement.tagName === 'INPUT' ||\n        activeElement.tagName === 'TEXTAREA' ||\n        (activeElement instanceof HTMLElement && activeElement.isContentEditable))\n    ) {\n      return;\n    }\n\n    // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹æ•°å­—é”® 1-4\n    if (e.key >= '1' && e.key <= '4') {\n      const moduleId = moduleMap[e.key];\n      if (moduleId) {\n        e.preventDefault();\n        switchModule(moduleId);\n        console.log(`âŒ¨ï¸ å¿«æ·é”®åˆ‡æ¢æ¨¡å—: ${moduleId} (${e.key})`);\n      }\n    }\n  });\n}\n\n// ========== æ¨¡æ€æ¡†åŠŸèƒ½ ==========\nexport function initModals() {\n  const modalOverlay = document.getElementById('modal-overlay');\n  const modalClose = document.getElementById('modal-close');\n\n  if (!modalOverlay || !modalClose) return;\n\n  modalClose.addEventListener('click', () => {\n    modalOverlay.classList.remove('active');\n  });\n\n  modalOverlay.addEventListener('click', e => {\n    if (e.target === modalOverlay) {\n      modalOverlay.classList.remove('active');\n    }\n  });\n}\n\n// ========== åŠ¨ç”»åŠŸèƒ½ ==========\nexport function initAnimations() {\n  // åŸºç¡€åŠ¨ç”»å·²é€šè¿‡ CSS å®ç°\n  // è¿™é‡Œå¯ä»¥æ·»åŠ  JS åŠ¨ç”»é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ï¼‰\n}\n\n// ========== çŠ¶æ€å¡ç‰‡äº¤äº’ ==========\nexport function initStatusCardInteractions() {\n  const statusCards = document.querySelectorAll('.status-card');\n  statusCards.forEach(card => {\n    card.addEventListener('click', () => {\n      // çŠ¶æ€å¡ç‰‡ç‚¹å‡»äº¤äº’ï¼ˆå¦‚æœéœ€è¦ï¼‰\n      console.log('çŠ¶æ€å¡ç‰‡è¢«ç‚¹å‡»');\n    });\n  });\n}\n\n// ========== èŠå¤©ç•Œé¢åŠŸèƒ½ ==========\n\n/**\n * ä¸€è½®å¯¹è¯çš„æ•°æ®ç»“æ„\n */\ninterface ConversationRound {\n  assistantMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  userMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  summary?: string; // å­˜å‚¨ <sum> å†…å®¹\n  pending?: boolean; // æ ‡è®°ä¸ºå¾…å¤„ç†çš„è½®æ¬¡ï¼ˆç”¨æˆ·å·²å‘é€ï¼ŒAIæœªå›å¤ï¼‰\n  pendingUserMessage?: string; // å¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯å†…å®¹\n}\n\n/**\n * åˆå§‹åŒ–å¯¹è¯ç•Œé¢ï¼ˆæ”¯æŒå·¦å³æ»‘åŠ¨å’Œæµå¼æ¸²æŸ“ï¼‰\n */\nexport function initChatInterface() {\n  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;\n  const chatSendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;\n  const chatRegenerateBtn = document.getElementById('chat-regenerate-btn') as HTMLButtonElement;\n  const chatMessages = document.getElementById('chat-messages') as HTMLElement;\n\n  if (!chatInput || !chatSendBtn || !chatMessages) {\n    return;\n  }\n\n  // å¯¹è¯è½®æ¬¡æ•°ç»„\n  let rounds: ConversationRound[] = [];\n  let currentRoundIndex = -1; // å½“å‰æ˜¾ç¤ºçš„è½®æ¬¡ç´¢å¼•\n\n  // æ­£åœ¨ç”Ÿæˆ/è½¬æ­£çš„è½®æ¬¡ç´¢å¼•ï¼ˆä¸ currentRoundIndex è§£è€¦ï¼šç”¨æˆ·å¯èƒ½åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æµè§ˆå†å²è½®æ¬¡ï¼‰\n  let activePendingRoundIndex: number | null = null;\n\n  function findLastPendingRoundIndex(): number | null {\n    for (let i = rounds.length - 1; i >= 0; i--) {\n      const r = rounds[i];\n      if (r && r.pending) return i;\n    }\n    return null;\n  }\n\n  function getPendingRoundIndexSafe(): number | null {\n    if (\n      activePendingRoundIndex !== null &&\n      activePendingRoundIndex >= 0 &&\n      activePendingRoundIndex < rounds.length &&\n      rounds[activePendingRoundIndex]?.pending\n    ) {\n      return activePendingRoundIndex;\n    }\n    return findLastPendingRoundIndex();\n  }\n\n  // å½“å‰æµå¼è¾“å‡ºå…ƒç´ ï¼ˆç”¨äºå®æ—¶æ¸²æŸ“ï¼‰\n  let streamingElement: HTMLElement | null = null;\n\n  // ä¿å­˜æœ€åä¸€æ¬¡æµå¼æ–‡æœ¬ï¼ˆrawï¼ŒåŒ…å«æ ‡ç­¾ï¼‰\n  let lastStreamedRawMessage: string = '';\n\n  // æ˜¯å¦æ­£åœ¨ç”Ÿæˆæ¶ˆæ¯\n  let isGenerating = false;\n\n  // æ˜¯å¦æ­£åœ¨å‘é€æ¶ˆæ¯ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰\n  let isSending = false;\n\n  // ä¿å­˜æœ€æ–°æå–çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼Œé¿å…ä»æ¶ˆæ¯ä¸­æå–ï¼‰\n  let latestOptions: string[] = [];\n\n  // è®°å½•æœ€è¿‘ä¸€æ¬¡ç”Ÿæˆåˆ›å»ºçš„çœŸå® message_idï¼ˆç”¨äºæŠŠ rounds çš„ä¸´æ—¶ id è¦†ç›–ä¸ºçœŸå® idï¼‰\n  let lastCreatedIds: { userMessageId: number; assistantMessageId: number } | null = null;\n\n  // ç¡®ä¿ generateMessage å·²åŠ è½½\n  let generateMessagePromise: Promise<any> | null = null;\n\n  // ç¡®ä¿ regenerateAssistantMessage å·²åŠ è½½\n  let regenerateAssistantMessagePromise: Promise<any> | null = null;\n\n  function ensureRegenerateAssistantLoaded(): Promise<any> {\n    if (!regenerateAssistantMessagePromise) {\n      regenerateAssistantMessagePromise = import('./utils/messageGenerator').then(\n        module => module.regenerateAssistantMessage,\n      );\n    }\n    return regenerateAssistantMessagePromise;\n  }\n\n  // é¢„åŠ è½½æ¶ˆæ¯ç”ŸæˆæœåŠ¡\n  function ensureMessageGeneratorLoaded(): Promise<any> {\n    if (!generateMessagePromise) {\n      generateMessagePromise = import('./utils/messageGenerator').then(module => module.generateMessage);\n    }\n    return generateMessagePromise;\n  }\n\n  // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦\n  function adjustInputHeight() {\n    chatInput.style.height = 'auto';\n    const maxHeight = 80;\n    const newHeight = Math.min(chatInput.scrollHeight, maxHeight);\n    chatInput.style.height = `${newHeight}px`;\n  }\n\n  chatInput.addEventListener('input', adjustInputHeight);\n\n  // HTMLè½¬ä¹‰\n  function escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // å°†æ¶ˆæ¯åˆ†ç»„ä¸ºè½®æ¬¡\n  // è§„åˆ™ï¼ˆä¿®æ­£ç‰ˆï¼Œç¬¦åˆçœŸå®æ—¶é—´çº¿ï¼‰ï¼š\n  // 1. ç¬¬ä¸€æ¡ assistant æ¶ˆæ¯ï¼ˆå¼€åœºç™½ï¼‰ä½œä¸ºå­¤ç«‹æ¶ˆæ¯ï¼Œåªæœ‰ assistantMessageï¼Œæ²¡æœ‰ userMessage\n  // 2. æ¯ä¸€æ¡ user æ¶ˆæ¯éƒ½ä¼šå¼€å¯ä¸€è½®\n  // 3. ç´§éšå…¶åçš„ assistant æ¶ˆæ¯è¡¥å…¨è¯¥è½®\n  function groupMessagesIntoRounds(\n    allMessages: Array<{\n      message: string;\n      message_id: number;\n      role: string;\n    }>,\n  ): ConversationRound[] {\n    const rounds: ConversationRound[] = [];\n\n    // å½“å‰æ­£åœ¨ç­‰å¾… assistant è¡¥å…¨çš„è½®æ¬¡\n    let pendingRound: ConversationRound | null = null;\n\n    // æŒ‰æ¶ˆæ¯çœŸå®å‡ºç°é¡ºåºéå†ï¼ˆæ—¶é—´çº¿ï¼‰\n    allMessages.forEach(msg => {\n      // å¤„ç† user æ¶ˆæ¯ï¼šæ°¸è¿œå¼€å¯æ–°ä¸€è½®\n      if (msg.role === 'user') {\n        const round: ConversationRound = {\n          userMessage: {\n            message_id: msg.message_id,\n            message: msg.message,\n          },\n          assistantMessage: null,\n        };\n\n        rounds.push(round);\n        pendingRound = round;\n        return;\n      }\n\n      // å¤„ç† assistant æ¶ˆæ¯\n      if (msg.role === 'assistant') {\n        // å°è¯•æå– sum\n        let sum = '';\n        const sumMatch = msg.message.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        // å¦‚æœå­˜åœ¨ç­‰å¾…è¡¥å…¨çš„è½®æ¬¡ï¼Œåˆ™è¡¥å…¨å®ƒ\n        if (pendingRound && !pendingRound.assistantMessage) {\n          pendingRound.assistantMessage = {\n            message_id: msg.message_id,\n            message: msg.message,\n          };\n          if (sum) pendingRound.summary = sum;\n          pendingRound = null;\n        } else {\n          // å¦åˆ™è§†ä¸ºå¼€åœºç™½ / å­¤ç«‹ assistant æ¶ˆæ¯\n          rounds.push({\n            userMessage: null,\n            assistantMessage: {\n              message_id: msg.message_id,\n              message: msg.message,\n            },\n            summary: sum || undefined,\n          });\n        }\n      }\n    });\n\n    return rounds;\n  }\n\n  // æ˜¾ç¤ºæŒ‡å®šè½®æ¬¡çš„å¯¹è¯\n  async function displayRound(roundIndex: number) {\n    // å¦‚æœæ­£åœ¨ç”Ÿæˆï¼Œä¸æ¸…é™¤æµå¼å…ƒç´ \n    if (!isGenerating) {\n      chatMessages.innerHTML = '';\n      streamingElement = null;\n    } else {\n      // æ­£åœ¨ç”Ÿæˆæ—¶ï¼Œåªæ¸…é™¤éæµå¼çš„æ¶ˆæ¯ï¼ˆä¿ç•™æµå¼å…ƒç´ ï¼‰\n      const existingMessages = Array.from(chatMessages.children).filter(child => child !== streamingElement);\n      existingMessages.forEach(msg => msg.remove());\n    }\n\n    // å¦‚æœç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œæ˜¾ç¤ºç©ºè½®æ¬¡ï¼ˆç”¨äºæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ç­‰å¾…AIå›å¤ï¼‰\n    if (roundIndex < 0 || roundIndex >= rounds.length) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const round = rounds[roundIndex];\n\n    // å…ˆæ˜¾ç¤º user æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰- ç¡®ä¿åœ¨ä¸Šæ–¹\n    if (round.userMessage) {\n      renderUserMessage(round.userMessage.message);\n    } else if (round.pendingUserMessage) {\n      // æ˜¾ç¤ºå¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯\n      renderUserMessage(round.pendingUserMessage);\n    }\n\n    // å†æ˜¾ç¤º assistant æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰- ç¡®ä¿åœ¨ä¸‹æ–¹\n    if (round.assistantMessage) {\n      await renderAssistantMessage(\n        round.assistantMessage.message,\n        round.assistantMessage.message,\n        round.summary, // ä¼ å…¥æ€»ç»“\n      );\n    } else if (round.pending && isGenerating) {\n      // å¦‚æœæ˜¯å¾…å¤„ç†çš„è½®æ¬¡ä¸”æ­£åœ¨ç”Ÿæˆï¼Œç¡®ä¿æµå¼å…ƒç´ åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸‹æ–¹\n      if (!streamingElement) {\n        showGenerating();\n      }\n      // å¦‚æœæµå¼å…ƒç´ å·²å­˜åœ¨ä½†ä¸åœ¨æ­£ç¡®ä½ç½®ï¼Œç§»åŠ¨åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸‹æ–¹\n      if (streamingElement && streamingElement.parentNode === chatMessages) {\n        // ç¡®ä¿æµå¼å…ƒç´ åœ¨æœ€åï¼ˆç”¨æˆ·æ¶ˆæ¯ä¹‹åï¼‰\n        chatMessages.appendChild(streamingElement);\n      }\n    }\n\n    updateRegenerateButtonState();\n  }\n\n  function updateRegenerateButtonState() {\n    if (!chatRegenerateBtn) return;\n\n    if (isGenerating || isSending) {\n      chatRegenerateBtn.disabled = true;\n      return;\n    }\n\n    const round = rounds[currentRoundIndex];\n    const hasUserMessage = !!round && !!round.userMessage && typeof round.userMessage.message_id === 'number';\n    const isNotPending = !!round && !round.pending;\n\n    // åªè¦æœ‰ç”¨æˆ·æ¶ˆæ¯ä¸”ä¸åœ¨ç”ŸæˆçŠ¶æ€ï¼Œå°±å…è®¸é‡æ–°ç”Ÿæˆï¼ˆå³ä½¿ assistantMessage ä¸ºç©ºï¼‰\n    chatRegenerateBtn.disabled = !(hasUserMessage && isNotPending);\n  }\n\n  // æ¸²æŸ“ assistant æ¶ˆæ¯ï¼ˆåªè§£æå­˜åœ¨çš„æ ‡ç­¾ï¼‰\n  async function renderAssistantMessage(content: string, rawMessage: string, summaryText?: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-assistant';\n\n    try {\n      const { extractContinueChoice, extractResult, extractNextChoice, removeSumTags } =\n        await import('./utils/textParser');\n\n      // ä» rawMessage ä¸­æå– maintextï¼Œç„¶åä» maintext ä¸­æå–ä¸‰æ æ ‡ç­¾\n      const { extractLastMaintext } = await import('./utils/textParser');\n      const maintext = extractLastMaintext(rawMessage);\n\n      // å¦‚æœ maintext å­˜åœ¨ï¼Œä» maintext ä¸­æå–ï¼›å¦åˆ™ä»æ•´ä¸ªæ¶ˆæ¯ä¸­æå–\n      const searchText = maintext || rawMessage;\n\n      const continueChoice = extractContinueChoice(searchText);\n      const result = extractResult(searchText);\n      const nextChoice = extractNextChoice(searchText);\n\n      // æ„å»ºä¸‰æ å†…å®¹ï¼Œåªæ˜¾ç¤ºå­˜åœ¨çš„æ ‡ç­¾\n      const columns: Array<{ header: string; content: string; key: string; icon: string }> = [];\n\n      if (continueChoice) {\n        columns.push({\n          header: 'äº‹ä»¶å»¶ç»­',\n          content: continueChoice,\n          key: 'continue',\n          icon: '<i class=\"fas fa-history\" title=\"äº‹ä»¶å»¶ç»­\"></i>',\n        });\n      }\n      if (result) {\n        columns.push({\n          header: 'åæœæ€»ç»“',\n          content: result,\n          key: 'result',\n          icon: '<i class=\"fas fa-microchip\" title=\"åæœæ€»ç»“\"></i>',\n        });\n      }\n      if (nextChoice) {\n        columns.push({\n          header: 'æ–°å‰§æƒ…',\n          content: nextChoice,\n          key: 'next',\n          icon: '<i class=\"fas fa-bolt\" title=\"æ–°å‰§æƒ…\"></i>',\n        });\n      }\n\n      if (columns.length > 0) {\n        // æ˜¾ç¤ºä¸‰æ ï¼ˆå¯èƒ½åªæœ‰1-3æ ï¼‰\n        const columnsHtml = columns\n          .map(\n            col => `\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">${col.icon}</div>\n            <div class=\"message-column-content\">${escapeHtml(col.content)}</div>\n          </div>\n        `,\n          )\n          .join('');\n\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\">\n              ${columnsHtml}\n            </div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      } else {\n        // æ²¡æœ‰ç»“æ„åŒ–æ ‡ç­¾ï¼Œæ˜¾ç¤ºå•æ ï¼ˆç§»é™¤ <sum> æ ‡ç­¾ï¼‰\n        const displayContent = removeSumTags(content);\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      }\n\n      // å¦‚æœæœ‰æ€»ç»“ï¼Œæ¸²æŸ“æ€»ç»“å¡ç‰‡åˆ°åŒä¸€ä¸ª messageItem ä¸­\n      if (summaryText) {\n        const summaryCard = await createSummaryCardElement(summaryText);\n        if (summaryCard) {\n          messageItem.appendChild(summaryCard);\n        }\n      }\n    } catch (error) {\n      console.error('âŒ è§£æç»“æ„åŒ–æ ‡ç­¾å¤±è´¥ï¼Œä½¿ç”¨å•æ æ˜¾ç¤º:', error);\n      const { removeSumTags } = await import('./utils/textParser');\n      const displayContent = removeSumTags(content);\n      messageItem.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n          <div class=\"message-time\"></div>\n        </div>\n      `;\n    }\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // æ¸²æŸ“ user æ¶ˆæ¯\n  function renderUserMessage(content: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-user';\n\n    // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºå•æ \n    messageItem.innerHTML = `\n      <div class=\"message-bubble\">\n        <div class=\"message-content\">${escapeHtml(content)}</div>\n        <div class=\"message-time\"></div>\n      </div>\n    `;\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // åˆ›å»º summary å¡ç‰‡å…ƒç´ \n  async function createSummaryCardElement(sumText: string): Promise<HTMLElement | null> {\n    if (!sumText) return null;\n\n    try {\n      const { parseSummary } = await import('./utils/textParser');\n      const sumObj = parseSummary(sumText);\n\n      if (Object.keys(sumObj).length === 0) return null;\n\n      const summaryCard = document.createElement('div');\n      summaryCard.className = 'summary-card';\n\n      // é¢„å®šä¹‰çš„æ ‡ç­¾å’Œå›¾æ ‡\n      const labelIcons: Record<string, string> = {\n        æ—¶é—´: 'fa-clock',\n        Time: 'fa-clock',\n        åœ°ç‚¹: 'fa-location-dot',\n        Location: 'fa-location-dot',\n        äººç‰©: 'fa-users',\n        Characters: 'fa-users',\n        äº‹ä»¶: 'fa-star',\n        Event: 'fa-star',\n      };\n\n      let innerHTML = '<div class=\"summary-content\">';\n      for (const [key, value] of Object.entries(sumObj)) {\n        const icon = labelIcons[key] || 'fa-info-circle';\n        innerHTML += `\n          <div class=\"summary-item\">\n            <span class=\"summary-label\"><i class=\"fas ${icon}\"></i> ${escapeHtml(key)}</span>\n            <span class=\"summary-value\">${escapeHtml(value)}</span>\n          </div>\n        `;\n      }\n      innerHTML += '</div>';\n\n      summaryCard.innerHTML = innerHTML;\n      return summaryCard;\n    } catch (error) {\n      console.error('âŒ åˆ›å»º summary å¡ç‰‡å¤±è´¥:', error);\n      return null;\n    }\n  }\n\n  // åŠ è½½å¯¹è¯å†å²å¹¶åˆ†ç»„\n  async function loadChatHistory() {\n    try {\n      const lastMessageId = getLastMessageId();\n\n      const allMessages = lastMessageId >= 0 ? getChatMessages(`0-${lastMessageId}`) : [];\n      const newRounds = groupMessagesIntoRounds(allMessages);\n\n      rounds = newRounds;\n\n      // æ˜¾ç¤ºæœ€åä¸€è½®\n      if (rounds.length > 0) {\n        currentRoundIndex = rounds.length - 1;\n        if (!isGenerating) {\n          await displayRound(currentRoundIndex);\n        }\n      }\n\n      console.log('âœ… å·²åŠ è½½èŠå¤©å†å²ï¼Œå…±', rounds.length, 'è½®å¯¹è¯ï¼Œå½“å‰æ˜¾ç¤ºç¬¬', currentRoundIndex + 1, 'è½®');\n    } catch (error) {\n      console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);\n    }\n  }\n\n  // åˆ·æ–°æ˜¾ç¤ºï¼ˆå½“æ¨¡å—è¢«æ¿€æ´»æ—¶è°ƒç”¨ï¼‰\n  async function refreshDisplay() {\n    await loadChatHistory();\n  }\n\n  // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼ˆå·¦ç®­å¤´å’Œå³ç®­å¤´ï¼‰\n  function setupKeyboardNavigation() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const keyHandler = (e: KeyboardEvent) => {\n      // åªåœ¨é€šè®¯æ¨¡å—æ¿€æ´»ä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶å“åº”\n      if (!communicationModule.classList.contains('active')) return;\n      if (document.activeElement === chatInput) return;\n\n      if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        goToPreviousRound();\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        goToNextRound();\n      } else if (e.key === 'o' || e.key === 'O') {\n        // O é”®æ‰“å¼€é€‰é¡¹ç•Œé¢\n        e.preventDefault();\n        const showOptionsBtn = document.getElementById('chat-show-options-btn') as HTMLButtonElement;\n        if (showOptionsBtn) {\n          showOptionsBtn.click();\n        }\n      }\n    };\n\n    document.addEventListener('keydown', keyHandler);\n  }\n\n  // å‘é€æ¶ˆæ¯\n  async function sendMessage() {\n    // é˜²æ­¢é‡å¤å‘é€\n    if (isSending) {\n      console.warn('âš ï¸ æ­£åœ¨å‘é€æ¶ˆæ¯ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');\n      return;\n    }\n\n    const message = chatInput.value.trim();\n    if (!message) {\n      return;\n    }\n\n    // è®¾ç½®å‘é€æ ‡å¿—\n    isSending = true;\n\n    chatInput.value = '';\n    adjustInputHeight();\n\n    // ç¦ç”¨å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n\n    // è®¾ç½®ç”Ÿæˆæ ‡å¿—ï¼ˆåœ¨åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ä¹‹å‰ï¼‰\n    isGenerating = true;\n    updateRegenerateButtonState();\n\n    // æ³¨æ„ï¼šä¸åœ¨ sendMessage ä¸­ç›´æ¥æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯\n    // ç”¨æˆ·æ¶ˆæ¯ä¼šåœ¨ generateMessage åˆ›å»ºåï¼Œé€šè¿‡ loadChatHistory é‡æ–°åŠ è½½æ—¶æ˜¾ç¤º\n\n    try {\n      const generateMessage = await ensureMessageGeneratorLoaded();\n      console.log('ğŸš€ å¼€å§‹ç”Ÿæˆæ¶ˆæ¯ï¼Œç”¨æˆ·è¾“å…¥:', message);\n\n      const success = await generateMessage(message, {\n        onShowGenerating: () => {\n          // æ˜¾ç¤ºç”Ÿæˆæç¤ºï¼ˆå¦‚æœè¿˜æ²¡æœ‰æµå¼å…ƒç´ ï¼‰\n          if (!streamingElement) {\n            showGenerating();\n          }\n        },\n        onHideGenerating: () => {\n          // ç”Ÿæˆç»“æŸæ—¶ä¸è¦æŠŠæµå¼ DOM åˆ æ‰ï¼Œå¦åˆ™ç”¨æˆ·ä¼šçœ‹åˆ°â€œå…ˆæ¶ˆå¤±å†å‡ºç°â€çš„é—ªå±ã€‚\n          // æœ€ç»ˆçš„â€œè½¬æ­£â€ä¸ºæ­£å¼æ¶ˆæ¯åœ¨ onRefreshStory -> finalizeStreamingAsAssistant ä¸­å®Œæˆã€‚\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('âŒ ç”Ÿæˆæ¶ˆæ¯å¤±è´¥:', error);\n          hideGenerating();\n          isGenerating = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          isSending = false;\n\n          // å³ä½¿å¤±è´¥ï¼Œä¹Ÿå°†å½“å‰è½®æ¬¡ä» pending è½¬ä¸ºæ­£å¼ï¼ˆè¿™æ ·é‡æ–°ç”ŸæˆæŒ‰é’®å°±ä¼šäº®èµ·ï¼‰\n          const idx = getPendingRoundIndexSafe();\n          const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n          if (r && r.pending) {\n            r.pending = false;\n            if (lastCreatedIds) {\n              r.userMessage = {\n                message_id: lastCreatedIds.userMessageId,\n                message: r.pendingUserMessage || '',\n              };\n            }\n            delete r.pendingUserMessage;\n          }\n          updateRegenerateButtonState(); // åˆ·æ–°æŒ‰é’®çŠ¶æ€\n        },\n        onStreamingUpdate: (text: string) => {\n          // ä¼ é€’å®Œæ•´çš„æ–‡æœ¬ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰ï¼Œç”¨äºæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸ\n          updateStreamingMessage(text);\n        },\n        onRefreshStoryIfOpen: (userMessage: string) => {\n          // user æ¶ˆæ¯åˆ›å»ºåï¼Œç«‹å³åˆ›å»ºä¸€ä¸ªpendingè½®æ¬¡å¹¶æ˜¾ç¤º\n          console.log('ğŸ“ user æ¶ˆæ¯å·²åˆ›å»ºï¼Œç«‹å³æ˜¾ç¤º:', userMessage);\n\n          // è®¾ç½®ç”Ÿæˆæ ‡å¿—\n          isGenerating = true;\n\n          // åˆ›å»ºä¸€ä¸ªpendingè½®æ¬¡\n          const pendingRound: ConversationRound = {\n            assistantMessage: null,\n            userMessage: null,\n            pending: true,\n            pendingUserMessage: userMessage,\n          };\n\n          // å°†pendingè½®æ¬¡æ·»åŠ åˆ°roundsæ•°ç»„\n          rounds.push(pendingRound);\n          currentRoundIndex = rounds.length - 1;\n          activePendingRoundIndex = currentRoundIndex;\n\n          // ç«‹å³æ˜¾ç¤ºè¿™ä¸ªè½®æ¬¡\n          displayRound(currentRoundIndex);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          // assistant æ¶ˆæ¯åˆ›å»ºåï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯\n          console.log('ğŸ“ assistant æ¶ˆæ¯å·²åˆ›å»ºï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯');\n\n          if (options && options.length > 0) {\n            latestOptions = options;\n          } else {\n            latestOptions = [];\n          }\n\n          // âœ… æ ¸å¿ƒï¼šç›´æ¥ finalizeï¼Œä¸é‡è½½å†å²\n          // å°†æœ€åçš„æµå¼ raw æ–‡æœ¬ä¼ å…¥ finalizeï¼ˆå¦‚æœä¸ºç©ºä¹Ÿä¼  ''ï¼Œä»¥ä¿è¯ finalize èƒ½å¤„ç†ï¼‰\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // ç”¨çœŸå® message_id è¦†ç›–ä¸´æ—¶ idï¼ˆç¡®ä¿åç»­å¯ç²¾å‡†åˆ é™¤/é‡æ–°ç”Ÿæˆï¼‰\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.userMessage) r.userMessage.message_id = lastCreatedIds.userMessageId;\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          // ğŸ”• ä¸è¦å†è°ƒç”¨ loadChatHistory()\n\n          // å…¶ä»–æ¨¡å—æ›´æ–°å¯ä»¥ä¿ç•™\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          lastCreatedIds = ids;\n        },\n      });\n\n      if (success) {\n        console.log('âœ… æ¶ˆæ¯ç”ŸæˆæˆåŠŸ');\n        // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œå¯ç”¨æŒ‰é’®ï¼ŒæŒ‰é’®åº”è¯¥åœ¨ onRefreshStory ä¸­å¯ç”¨\n        // å› ä¸ºæ­¤æ—¶ AI å¯èƒ½è¿˜åœ¨æµå¼è¾“å‡º\n      }\n    } catch (error) {\n      console.error('âŒ å‘é€æ¶ˆæ¯å¼‚å¸¸:', error);\n      hideGenerating();\n      isGenerating = false;\n      // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç«‹å³å¯ç”¨æŒ‰é’®å’Œè¾“å…¥æ¡†\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      isSending = false;\n      updateRegenerateButtonState();\n    }\n    // æ³¨æ„ï¼šç§»é™¤äº† finally å—ï¼Œå› ä¸ºæŒ‰é’®åº”è¯¥åœ¨ onRefreshStory ä¸­å¯ç”¨\n    // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ AI å®Œå…¨ç”Ÿæˆå®Œæˆåæ‰å¯ç”¨æŒ‰é’®\n  }\n\n  // é‡æ–°ç”Ÿæˆå½“å‰è½®ï¼šåªåˆ é™¤ assistant æ¶ˆæ¯ï¼Œç„¶åè§¦å‘ generate å†åˆ›å»ºæ–°çš„ assistant æ¶ˆæ¯\n  async function regenerateCurrentRound() {\n    if (!chatRegenerateBtn) return;\n    if (isGenerating || isSending) return;\n\n    const round = rounds[currentRoundIndex];\n    if (!round?.userMessage) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const userMessageId = round.userMessage.message_id;\n    const assistantMessageId = round.assistantMessage?.message_id;\n\n    if (typeof userMessageId !== 'number' || !Number.isFinite(userMessageId)) return;\n\n    // UI é”å®š\n    isSending = true;\n    isGenerating = true;\n    lastStreamedRawMessage = '';\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n    chatRegenerateBtn.disabled = true;\n\n    // å½“å‰è½®è¿›å…¥ pendingï¼šä¿ç•™ userMessageï¼Œä»…æ¸…ç©º assistantMessage\n    round.assistantMessage = null;\n    round.pending = true;\n    activePendingRoundIndex = currentRoundIndex;\n    await displayRound(currentRoundIndex);\n\n    try {\n      if (typeof assistantMessageId === 'number' && Number.isFinite(assistantMessageId)) {\n        await deleteChatMessages([assistantMessageId], { refresh: 'none' });\n        console.log('ğŸ—‘ï¸ å·²åˆ é™¤å½“å‰è½® assistant æ¶ˆæ¯ï¼Œå‡†å¤‡é‡æ–°ç”Ÿæˆ:', assistantMessageId);\n      } else {\n        console.log('â„¹ï¸ å½“å‰è½®æ—  assistant æ¶ˆæ¯ï¼Œç›´æ¥å¼€å§‹ç”Ÿæˆ');\n      }\n\n      const regenerateAssistantMessage = await ensureRegenerateAssistantLoaded();\n\n      await regenerateAssistantMessage(userMessageId, {\n        onShowGenerating: () => {\n          if (!streamingElement) showGenerating();\n        },\n        onHideGenerating: () => {\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('âŒ é‡æ–°ç”Ÿæˆå¤±è´¥:', error);\n          hideGenerating();\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          round.pending = false;\n          updateRegenerateButtonState();\n          // å…œåº•ï¼šé‡æ–°åŠ è½½å†å²ï¼ˆç¡®ä¿ä¸é…’é¦†çœŸå®å†å²ä¸€è‡´ï¼‰\n          loadChatHistory();\n        },\n        onStreamingUpdate: (text: string) => {\n          updateStreamingMessage(text);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          console.log('ğŸ“ assistant æ¶ˆæ¯å·²é‡æ–°ç”Ÿæˆï¼Œè½¬ä¸ºæœ€ç»ˆæ¶ˆæ¯');\n\n          latestOptions = options && options.length > 0 ? options : [];\n\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // é‡æ–°ç”Ÿæˆåªä¼šåˆ›å»ºæ–°çš„ assistant æ¶ˆæ¯ï¼Œå›è°ƒé‡Œä¼šç»™å‡ºæ–°çš„ assistantMessageId\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          // æ¸…é™¤ pending\n          round.pending = false;\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          // regenerate åªåˆ›å»º assistantï¼Œä½†æˆ‘ä»¬ä¿æŒåŒä¸€ä¸ª userMessageId\n          lastCreatedIds = ids;\n        },\n      });\n    } catch (e) {\n      console.error('âŒ é‡æ–°ç”Ÿæˆå¼‚å¸¸:', e);\n      hideGenerating();\n      round.pending = false;\n      isGenerating = false;\n      isSending = false;\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      updateRegenerateButtonState();\n      loadChatHistory();\n    }\n  }\n\n  // æ˜¾ç¤ºç”Ÿæˆæç¤º\n  function showGenerating() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant message-streaming';\n      streamingElement.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content message-content-three-columns\"></div>\n        </div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // éšè—ç”Ÿæˆæç¤º\n  function hideGenerating() {\n    if (streamingElement) {\n      streamingElement.remove();\n      streamingElement = null;\n    }\n  }\n\n  // æäº¤æµå¼ä¸ºæ­£å¼æ¶ˆæ¯ï¼ˆé¿å…å…¨é‡é‡æ¸²æŸ“ï¼‰\n  async function finalizeStreamingAsAssistant(finalText: string) {\n    // å³ä½¿ streamingElement ä¸å­˜åœ¨ï¼Œä¹Ÿåº”è¯¥æŠŠ rounds è¡¥å…¨ï¼ˆé˜²æ­¢ raceï¼‰\n    // å…ˆæŠŠæµå¼ DOM æ›´æ–°ä¸ºæœ€ç»ˆå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰\n    if (streamingElement) {\n      try {\n        // å¦‚æœæœ‰ä¸‰æ å®¹å™¨ï¼Œå°±ç”¨ç°æœ‰è§£æå‡½æ•°æŠŠ finalText å¡«è¿›å»\n        let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) {\n          // å¦‚æœæ²¡æœ‰ä¸‰æ å®¹å™¨ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªå®¹å™¨ä»¥ä¾¿ updateColumnsFromStream ä½¿ç”¨\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content message-content-three-columns\"></div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n          columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        }\n\n        // ä½¿ç”¨å·²æœ‰çš„è§£æé€»è¾‘æŠŠ finalText æ¸²æŸ“åˆ°æ ç›®é‡Œï¼ˆä¿è¯æœ€ç»ˆè§†å›¾å®Œæ•´ï¼‰\n        await updateColumnsFromStream(finalText, columnsContainer);\n      } catch (err) {\n        // è§£æå¤±è´¥æ—¶å›é€€ä¸ºå•æ æ–‡æœ¬ï¼ˆç§»é™¤ <sum> æ ‡ç­¾ï¼‰\n        console.error('âŒ finalize æ›´æ–°æµå¼ DOM å¤±è´¥ï¼Œå›é€€ä¸ºå•æ :', err);\n        const { removeSumTags } = await import('./utils/textParser');\n        const displayContent = removeSumTags(finalText);\n        if (streamingElement) {\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n        }\n      }\n\n      // ç§»é™¤æµå¼æ ·å¼ï¼ˆå˜ä¸ºæ­£å¼æ¶ˆæ¯ï¼‰\n      streamingElement.classList.remove('message-streaming');\n      const timeEl = streamingElement.querySelector('.message-time');\n      if (timeEl) timeEl.textContent = '';\n    }\n\n    // å…³é”®ï¼šç«‹å³æŠŠ rounds è¡¥å…¨ä¸ºæ­£å¼æ¶ˆæ¯ï¼Œä½¿ç”¨ finalTextï¼ˆä¸ä¾èµ–åç«¯ï¼‰\n    // æ³¨æ„ï¼šç”¨æˆ·å¯èƒ½åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æµè§ˆå†å²è½®æ¬¡ï¼Œå› æ­¤ä¸èƒ½ä¾èµ– currentRoundIndex\n    const pendingIdx = getPendingRoundIndexSafe();\n    if (typeof pendingIdx === 'number' && pendingIdx >= 0 && pendingIdx < rounds.length) {\n      const targetRound = rounds[pendingIdx];\n      if (targetRound && targetRound.pending) {\n        // å°è¯•æå– sum\n        let sum = '';\n        const sumMatch = finalText.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        // å¦‚æœ pendingï¼Œåˆ™ç›´æ¥ç”¨ finalText å¡«å…… assistantMessage\n        targetRound.assistantMessage = {\n          // ä¸´æ—¶ idï¼Œåé¢å¯ä»¥å¼‚æ­¥ç”¨çœŸå® id è¦†ç›–\n          message_id: Date.now(),\n          message: finalText || (streamingElement ? streamingElement.textContent || '' : ''),\n        };\n\n        if (sum) targetRound.summary = sum;\n\n        // å¦‚æœæœ‰ pendingUserMessage -> å°†å…¶è½¬ä¸º userMessageï¼ˆä¸´æ—¶ idï¼‰\n        if (targetRound.pendingUserMessage) {\n          targetRound.userMessage = {\n            message_id: Date.now() - 1,\n            message: targetRound.pendingUserMessage,\n          };\n        }\n\n        targetRound.pending = false;\n        delete targetRound.pendingUserMessage;\n\n        // å¦‚æœæœ‰ sumï¼Œç«‹å³åœ¨æµå¼å…ƒç´ ä¸­æ·»åŠ  summary å¡ç‰‡\n        if (sum && streamingElement) {\n          const summaryCard = await createSummaryCardElement(sum);\n          if (summaryCard) {\n            streamingElement.appendChild(summaryCard);\n          }\n        }\n      }\n    } else {\n      console.warn('âš ï¸ finalize: æœªæ‰¾åˆ° pending è½®æ¬¡ï¼Œå¯èƒ½æ˜¯çŠ¶æ€ç«äº‰æˆ–å·²è¢«åˆ·æ–°é‡å»º');\n    }\n\n    // âœ… ä¸è¦åœ¨ç”Ÿæˆç»“æŸåå† displayRound() å…¨é‡é‡å»º DOM\n    // è¿™ä¼šå¯¼è‡´ chatMessages æ¸…ç©º/é‡å»ºï¼Œè‚‰çœ¼è¡¨ç°ä¸ºâ€œåˆ·æ–°é—ªä¸€ä¸‹â€ï¼Œå¹¶ä¸”å®¹æ˜“å¼•å…¥ä½ç½®/æ»šåŠ¨ç­‰æ–°é—®é¢˜ã€‚\n    // è¿™é‡Œä»…æŠŠæµå¼å…ƒç´ â€œè½¬æ­£â€ä¸ºæœ€ç»ˆæ¶ˆæ¯ï¼Œå¹¶æ›´æ–° rounds æ•°æ®å³å¯ã€‚\n    streamingElement = null;\n    activePendingRoundIndex = null;\n  }\n\n  // æ›´æ–°æµå¼æ¶ˆæ¯ï¼ˆå®æ—¶æ¸²æŸ“ï¼Œæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸï¼‰\n  async function updateStreamingMessage(text: string) {\n    // ä¿å­˜æœ€æ–°æµå¼æ–‡æœ¬ï¼Œä¾› finalize ä½¿ç”¨ï¼ˆé¿å…ä¾èµ–åç«¯ç«‹å³æŒä¹…åŒ–ï¼‰\n    lastStreamedRawMessage = text;\n\n    if (!streamingElement) {\n      // å¦‚æœè¿˜æ²¡æœ‰æµå¼å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª\n      showGenerating();\n    }\n\n    if (!streamingElement) return;\n\n    try {\n      // è·å–æˆ–åˆ›å»ºæ ç›®å®¹å™¨\n      let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n      if (!columnsContainer) {\n        streamingElement.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\"></div>\n            <div class=\"message-time\">ç”Ÿæˆä¸­</div>\n          </div>\n        `;\n        columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) return;\n      }\n\n      await updateColumnsFromStream(text, columnsContainer);\n    } catch (error) {\n      console.error('âŒ æ›´æ–°æµå¼æ¶ˆæ¯å¤±è´¥:', error);\n    }\n  }\n\n  // ä»æµå¼æ–‡æœ¬æ›´æ–°æ ç›®ï¼ˆæ£€æµ‹æ ‡ç­¾å¼€å§‹/ç»“æŸï¼ŒåŠ¨æ€åˆ›å»ºæ ç›®ï¼‰\n  async function updateColumnsFromStream(text: string, container: HTMLElement) {\n    // å®šä¹‰æ ç›®é…ç½®\n    const columnConfigs = [\n      {\n        tag: 'continue_choice',\n        header: '<i class=\"fas fa-history\" title=\"äº‹ä»¶å»¶ç»­\"></i>',\n        key: 'continue',\n      },\n      {\n        tag: 'result',\n        header: '<i class=\"fas fa-microchip\" title=\"åæœæ€»ç»“\"></i>',\n        key: 'result',\n      },\n      {\n        tag: 'decision_node',\n        header: '<i class=\"fas fa-bolt\" title=\"æ–°å‰§æƒ…\"></i>',\n        key: 'next',\n      },\n    ];\n\n    // æ£€æµ‹æ¯ä¸ªæ ‡ç­¾çš„å¼€å§‹å’Œç»“æŸï¼Œæå–å†…å®¹\n    for (const config of columnConfigs) {\n      const startTag = `<${config.tag}>`;\n      const endTag = `</${config.tag}>`;\n\n      // è·å–æˆ–åˆ›å»ºæ ç›®å…ƒç´ ï¼ˆå…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼‰\n      let columnElement = container.querySelector(`[data-column-key=\"${config.key}\"]`) as HTMLElement;\n\n      // æ£€æŸ¥è¯¥æ ç›®æ˜¯å¦å·²ç»é—­åˆï¼ˆå¦‚æœå·²å­˜åœ¨ä¸”å·²é—­åˆï¼Œä¸å†æ›´æ–°ï¼‰\n      if (columnElement) {\n        const isClosed = columnElement.hasAttribute('data-closed');\n        if (isClosed) {\n          // æ ç›®å·²é—­åˆï¼Œä¸å†æ›´æ–°\n          continue;\n        }\n      }\n\n      // æ£€æµ‹æ˜¯å¦å·²ç»å¼€å§‹ï¼ˆæœ‰å¼€å§‹æ ‡ç­¾ï¼‰\n      const startIndex = text.indexOf(startTag);\n      if (startIndex === -1) {\n        // è¿˜æ²¡æœ‰å¼€å§‹æ ‡ç­¾ï¼Œè·³è¿‡è¿™ä¸ªæ ç›®\n        continue;\n      }\n\n      // æå–å¼€å§‹æ ‡ç­¾ä¹‹åçš„å†…å®¹\n      const contentStart = startIndex + startTag.length;\n      const endIndex = text.indexOf(endTag, contentStart);\n\n      let content = '';\n\n      if (endIndex !== -1) {\n        // æœ‰ç»“æŸæ ‡ç­¾ï¼Œæå–å®Œæ•´å†…å®¹ï¼Œå¹¶æ ‡è®°ä¸ºå·²é—­åˆ\n        content = text.substring(contentStart, endIndex);\n\n        // å¦‚æœæ ç›®å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n\n        // æ ‡è®°ä¸ºå·²é—­åˆï¼Œä¹‹åä¸å†æ›´æ–°\n        columnElement.setAttribute('data-closed', 'true');\n      } else {\n        // è¿˜æ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼Œæå–åˆ°ç›®å‰ä¸ºæ­¢çš„å†…å®¹\n        content = text.substring(contentStart);\n\n        // å¦‚æœæ ç›®å…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n      }\n\n      // æ›´æ–°æ ç›®å†…å®¹ï¼ˆåªæ›´æ–°æ–‡æœ¬å†…å®¹ï¼Œä¸æ›¿æ¢æ•´ä¸ª HTMLï¼Œä¿æŒæ»šåŠ¨ä½ç½®ï¼‰\n      const contentElement = columnElement.querySelector('.message-column-content') as HTMLElement;\n      if (contentElement) {\n        // ä¿å­˜æ»šåŠ¨çŠ¶æ€\n        const oldScrollTop = contentElement.scrollTop;\n        const oldScrollHeight = contentElement.scrollHeight;\n        const wasAtBottom = oldScrollTop + contentElement.clientHeight >= oldScrollHeight - 10;\n\n        // æ›´æ–°å†…å®¹\n        contentElement.textContent = content;\n\n        // æ¢å¤æ»šåŠ¨ä½ç½®\n        if (wasAtBottom) {\n          // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨\n          contentElement.scrollTop = contentElement.scrollHeight;\n        } else {\n          // å¦åˆ™ä¿æŒç›¸å¯¹ä½ç½®ï¼ˆå°½é‡ä¿æŒåŸæœ‰ä½ç½®ï¼‰\n          const newScrollHeight = contentElement.scrollHeight;\n          if (newScrollHeight > oldScrollHeight) {\n            // å†…å®¹å¢åŠ äº†ï¼Œä¿æŒç›¸å¯¹ä½ç½®\n            contentElement.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);\n          } else {\n            // å†…å®¹å‡å°‘äº†æˆ–ä¸å˜ï¼Œä¿æŒåŸä½ç½®\n            contentElement.scrollTop = oldScrollTop;\n          }\n        }\n      }\n    }\n  }\n\n  // ä¸Šä¸€è½®\n  function goToPreviousRound() {\n    if (currentRoundIndex > 0) {\n      currentRoundIndex--;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ä¸‹ä¸€è½®\n  function goToNextRound() {\n    if (currentRoundIndex < rounds.length - 1) {\n      currentRoundIndex++;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ========== Option é€‰é¡¹åŠŸèƒ½ ==========\n  const optionsOverlay = document.getElementById('chat-options-overlay');\n  const optionsContainer = document.getElementById('chat-options-container');\n  const optionsList = document.getElementById('chat-options-list');\n  const showOptionsBtn = document.getElementById('chat-show-options-btn');\n  const closeOptionsBtn = document.getElementById('chat-options-close');\n\n  // ä»æœ€æ–°æ¶ˆæ¯æå–é€‰é¡¹æ•°æ®\n  async function getOptionsFromLatestMessage(): Promise<string[]> {\n    try {\n      // ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼‰\n      if (latestOptions.length > 0) {\n        console.log('âœ… ä½¿ç”¨ä¿å­˜çš„é€‰é¡¹ï¼ˆä» messageGenerator ä¼ é€’ï¼‰');\n        return latestOptions;\n      }\n\n      // æ¬¡ä¼˜å…ˆï¼šä» assistant æ¶ˆæ¯çš„ data ä¸­è¯»å–ï¼ˆæŒä¹…åŒ–é€‰é¡¹ï¼‰\n      const messages = getChatMessages(-1, { role: 'assistant' });\n      const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n      if (!lastMessage) {\n        return [];\n      }\n\n      if (lastMessage.data?.__options && lastMessage.data.__options.length > 0) {\n        console.log('âœ… ä» assistant.data è¯»å–é€‰é¡¹ï¼ˆæŒä¹…åŒ–ï¼‰');\n        return lastMessage.data.__options;\n      }\n\n      // é™çº§ï¼šä»æ¶ˆæ¯ä¸­æå–ï¼ˆå¦‚æœä»¥ä¸Šæ–¹æ¡ˆå‡ä¸å¯ç”¨ï¼‰\n      const { extractAllOptions } = await import('./utils/textParser');\n      const messageContent = lastMessage.message || '';\n      const options = extractAllOptions(messageContent);\n      if (options.length > 0) {\n        console.log('âœ… ä»æ¶ˆæ¯ä¸­æå–é€‰é¡¹ï¼ˆé™çº§æ–¹æ¡ˆï¼‰');\n      }\n      return options;\n    } catch (error) {\n      console.error('âŒ è·å–é€‰é¡¹å¤±è´¥:', error);\n      return [];\n    }\n  }\n\n  // æ˜¾ç¤ºé€‰é¡¹æµ®å±‚\n  async function showOptionsOverlay() {\n    if (!optionsOverlay || !optionsContainer || !optionsList) {\n      return;\n    }\n\n    const options = await getOptionsFromLatestMessage();\n\n    if (options.length === 0) {\n      // å¦‚æœoptionä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º\n      showNoOptionsMessage();\n      return;\n    }\n\n    // æ¸…ç©ºä¹‹å‰çš„é€‰é¡¹\n    optionsList.innerHTML = '';\n\n    // é‡ç½®çŠ¶æ€\n    optionsList.classList.remove('collapse');\n\n    // è®¾ç½®é€‰é¡¹åˆ—è¡¨ä¸ºå…¨å±å®šä½å®¹å™¨\n    optionsList.style.position = 'absolute';\n    optionsList.style.top = '0';\n    optionsList.style.left = '0';\n    optionsList.style.right = '0';\n    optionsList.style.bottom = '0';\n    optionsList.style.width = '100%';\n    optionsList.style.height = '100%';\n    // éœ€è¦è®© list èƒ½ hoverï¼ˆç”¨äº hover èšç„¦/æ¨¡ç³Šæ•ˆæœçš„ CSS å›é€€æ–¹æ¡ˆï¼‰ï¼›\n    // åŒæ—¶é€šè¿‡ click handler æ”¯æŒâ€œç‚¹ç©ºç™½å¤„å…³é—­â€ï¼Œé¿å… list åƒæ‰ overlay çš„ç‚¹å‡»ã€‚\n    optionsList.style.pointerEvents = 'auto';\n\n    // è·å– overlay çš„å°ºå¯¸ï¼Œç”¨äºè®¡ç®—éšæœºä½ç½®\n    if (!optionsOverlay) return;\n\n    // å­˜å‚¨å·²ä½¿ç”¨çš„ä½ç½®ï¼Œé¿å…é‡å \n    const usedPositions: Array<{ x: number; y: number }> = [];\n    const minDistance = 150; // æœ€å°é—´è·ï¼ˆåƒç´ ï¼‰\n\n    // ç”Ÿæˆéšæœºä½ç½®ï¼Œç¡®ä¿ä¸é‡å ä¸”ä¸é è¾¹ç¼˜\n    function generateRandomPosition(): { x: number; y: number } {\n      const maxAttempts = 50;\n      let attempts = 0;\n      const margin = 0.15; // è¾¹ç¼˜è¾¹è·ï¼ˆ15%ï¼‰\n\n      while (attempts < maxAttempts) {\n        // éšæœºä½ç½®ï¼Œä½†ç•™å‡ºè¾¹ç¼˜ç©ºé—´\n        const x = margin + Math.random() * (1 - 2 * margin);\n        const y = margin + Math.random() * (1 - 2 * margin);\n\n        // æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰ä½ç½®å¤ªè¿‘\n        const tooClose = usedPositions.some(pos => {\n          const overlayWidth = optionsOverlay!.clientWidth;\n          const overlayHeight = optionsOverlay!.clientHeight;\n          const dx = (x - pos.x) * overlayWidth;\n          const dy = (y - pos.y) * overlayHeight;\n          const distance = Math.sqrt(dx * dx + dy * dy);\n          return distance < minDistance;\n        });\n\n        if (!tooClose) {\n          usedPositions.push({ x, y });\n          return { x, y };\n        }\n\n        attempts++;\n      }\n\n      // å¦‚æœæ— æ³•æ‰¾åˆ°ä¸é‡å çš„ä½ç½®ï¼Œä½¿ç”¨éšæœºä½ç½®ï¼ˆä½†ä»æœ‰è¾¹è·ï¼‰\n      const x = margin + Math.random() * (1 - 2 * margin);\n      const y = margin + Math.random() * (1 - 2 * margin);\n      usedPositions.push({ x, y });\n      return { x, y };\n    }\n\n    // æ¸²æŸ“æ¯ä¸ªé€‰é¡¹ä¸ºåœ†å½¢æ°”æ³¡ï¼Œéšæœºä½ç½®\n    options.forEach((optionText, index) => {\n      // å¯ä»¥åŒæ—¶æµ®ç°å¤šä¸ªé€‰é¡¹ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰\n      const delay = index * 80; // å‡å°‘å»¶è¿Ÿï¼Œè®©é€‰é¡¹æ›´å¿«æµ®ç°\n\n      setTimeout(() => {\n        // STEP 1: åˆ›å»ºå®¹å™¨ + æ°”æ³¡ç»“æ„\n        const chatOption = document.createElement('div');\n        chatOption.className = 'chat-option';\n\n        const optionButton = document.createElement('button');\n        optionButton.type = 'button';\n        optionButton.className = 'chat-option-button';\n\n        const optionTextSpan = document.createElement('span');\n        optionTextSpan.className = 'chat-option-text';\n        optionTextSpan.textContent = optionText;\n        optionButton.title = optionText;\n\n        optionButton.appendChild(optionTextSpan);\n        chatOption.appendChild(optionButton);\n\n        // ç”Ÿæˆéšæœºä½ç½®\n        const position = generateRandomPosition();\n        const rotate = (Math.random() - 0.5) * 30; // -15 åˆ° 15 åº¦éšæœºæ—‹è½¬\n\n        chatOption.style.setProperty('--rot', `${rotate}deg`);\n        chatOption.style.left = `${position.x * 100}%`;\n        chatOption.style.top = `${position.y * 100}%`;\n        chatOption.style.position = 'absolute';\n        chatOption.style.pointerEvents = 'auto'; // æ°”æ³¡æœ¬èº«å¯ç‚¹å‡»\n\n        // æ€ç»´æƒé‡ï¼ˆè¶Šé å‰è¶Š\"æ¸…æ™°\"ï¼‰\n        const weight = options.length - index;\n        // é™ä½åŸºç¡€ä¸é€æ˜åº¦å·®å¼‚ï¼Œç¡®ä¿åœ¨æ¨¡ç³Šæ—¶ä¾ç„¶å¯è§\n        optionButton.style.opacity = `${0.85 + weight * 0.03}`;\n        // ç§»é™¤åˆå§‹æ¨¡ç³Šï¼Œç¡®ä¿æ‰€æœ‰é€‰é¡¹åŸºç¡€æ¸…æ™°åº¦\n        optionButton.style.filter = 'none';\n\n        // ç‚¹å‡»ï¼šæ€ç»´åç¼©\n        optionButton.addEventListener('click', () => {\n          optionButton.classList.add('selected');\n          chatOption.classList.add('selected-parent');\n          optionsList.classList.add('collapse');\n\n          setTimeout(() => {\n            chatInput.value = optionText;\n            adjustInputHeight();\n            sendMessage();\n            hideOptionsOverlay();\n          }, 220);\n        });\n\n        optionsList.appendChild(chatOption);\n\n        // è§¦å‘\"å¿µå¤´æˆå½¢\"åŠ¨ç”»\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            chatOption.classList.add('show');\n          });\n        });\n      }, delay);\n    });\n\n    optionsOverlay.classList.add('active');\n    console.log(`âœ… å·²æ˜¾ç¤º ${options.length} ä¸ªé€‰é¡¹`);\n  }\n\n  // æ˜¾ç¤ºæ— é€‰é¡¹æç¤º\n  function showNoOptionsMessage() {\n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'chat-no-options-message';\n    messageDiv.innerHTML = `\n      <div class=\"chat-no-options-content\">\n        <div class=\"chat-no-options-text\">åšå†³å®šå§ qwq</div>\n        <button type=\"button\" class=\"chat-no-options-close\" title=\"å…³é—­\">Ã—</button>\n      </div>\n    `;\n\n    const closeBtn = messageDiv.querySelector('.chat-no-options-close');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        hideOptionsOverlay();\n      });\n    }\n\n    // æ·»åŠ åˆ°é€‰é¡¹åˆ—è¡¨å®¹å™¨ä¸­\n    if (optionsList) {\n      optionsList.innerHTML = '';\n      // é‡ç½®æ ·å¼ï¼Œç¡®ä¿æ— é€‰é¡¹æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤º\n      optionsList.style.position = 'absolute';\n      optionsList.style.top = '50%';\n      optionsList.style.left = '50%';\n      optionsList.style.transform = 'translate(-50%, -50%)';\n      optionsList.style.width = 'auto';\n      optionsList.style.height = 'auto';\n      optionsList.style.pointerEvents = 'auto';\n      optionsList.classList.remove('collapse');\n      optionsList.appendChild(messageDiv);\n    }\n\n    // æ˜¾ç¤ºæµ®å±‚\n    if (optionsOverlay) {\n      optionsOverlay.classList.add('active');\n    }\n  }\n\n  // éšè—é€‰é¡¹æµ®å±‚\n  function hideOptionsOverlay() {\n    if (optionsOverlay) {\n      optionsOverlay.classList.remove('active');\n    }\n    // é‡ç½® collapse çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æ—¶èƒ½æ­£å¸¸æ˜¾ç¤º\n    if (optionsList) {\n      optionsList.classList.remove('collapse');\n    }\n  }\n\n  // ç»‘å®šé€‰é¡¹ç›¸å…³äº‹ä»¶\n  if (showOptionsBtn) {\n    showOptionsBtn.addEventListener('click', showOptionsOverlay);\n  }\n\n  if (closeOptionsBtn) {\n    closeOptionsBtn.addEventListener('click', hideOptionsOverlay);\n  }\n\n  if (optionsOverlay) {\n    optionsOverlay.addEventListener('click', e => {\n      // å…è®¸ç‚¹å‡»ç©ºç™½å¤„å…³é—­ï¼š\n      // - target æ˜¯ overlayï¼ˆçœŸæ­£èƒŒæ™¯ï¼‰\n      // - æˆ– target æ˜¯ list æœ¬èº«ï¼ˆlist è¦†ç›–å…¨å±æ—¶ï¼‰\n      if (e.target === optionsOverlay || e.target === optionsList) {\n        hideOptionsOverlay();\n      }\n    });\n  }\n\n  // ç»‘å®šå‘é€æŒ‰é’®äº‹ä»¶\n  chatSendBtn.addEventListener('click', sendMessage);\n\n  // ç»‘å®šé‡æ–°ç”ŸæˆæŒ‰é’®äº‹ä»¶\n  if (chatRegenerateBtn) {\n    chatRegenerateBtn.addEventListener('click', regenerateCurrentRound);\n  }\n\n  // ç»‘å®š Enter é”®å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰\n  chatInput.addEventListener('keydown', e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n\n  // è®¾ç½®é”®ç›˜å¯¼èˆª\n  setupKeyboardNavigation();\n\n  // è®¾ç½®æ¨¡å—åˆ‡æ¢ç›‘å¬\n  function setupModuleSwitchListener() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const observer = new MutationObserver(() => {\n      if (communicationModule.classList.contains('active')) {\n        console.log('ğŸ“¡ é€šè®¯æ¨¡å—å·²æ¿€æ´»ï¼Œåˆ·æ–°æ˜¾ç¤º');\n        refreshDisplay();\n      }\n    });\n\n    observer.observe(communicationModule, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // åˆå§‹åŒ–æ—¶åŠ è½½å†å²æ¶ˆæ¯\n  loadChatHistory();\n\n  // è®¾ç½®æ¨¡å—åˆ‡æ¢ç›‘å¬\n  setupModuleSwitchListener();\n}\n","// é”š - ä¸»é€»è¾‘\nimport { PageManager } from './utils/pageManager';\nimport { initNavigation, initModals, initAnimations, initStatusCardInteractions, initChatInterface } from './dashboardLogic';\n\nlet pageManager: PageManager | null = null;\n\n/**\n * åˆå§‹åŒ–åº”ç”¨\n */\nfunction initApp() {\n  const appContainer = document.getElementById('app');\n  if (!appContainer) {\n    console.error('æœªæ‰¾åˆ° #app å®¹å™¨');\n    return;\n  }\n\n  // åˆå§‹åŒ–é¡µé¢ç®¡ç†å™¨\n  pageManager = new PageManager(appContainer);\n  pageManager.initialize();\n\n  // ç›‘å¬é¡µé¢åˆ‡æ¢ï¼Œå½“è¿›å…¥æ¸¸æˆé¡µé¢æ—¶åˆå§‹åŒ–åŠŸèƒ½\n  const mainScreen = document.getElementById('main-screen');\n  if (mainScreen) {\n    const observer = new MutationObserver(() => {\n      if (mainScreen.classList.contains('active')) {\n        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“\n        setTimeout(() => {\n          initDashboardFeatures();\n        }, 100);\n      }\n    });\n\n    observer.observe(mainScreen, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // ç›‘å¬é…’é¦†æ¶ˆæ¯æ›´æ–°äº‹ä»¶\n  eventOn(tavern_events.MESSAGE_UPDATED, () => {\n    if (pageManager) {\n      const dashboard = pageManager.getDashboard();\n      // åˆ·æ–°æ¸¸æˆæ•°æ®\n      // è¿™é‡Œå¯ä»¥ä»å˜é‡ç³»ç»Ÿè¯»å–æœ€æ–°æ•°æ®å¹¶æ›´æ–°\n      console.info('æ¶ˆæ¯å·²æ›´æ–°ï¼Œåˆ·æ–°æ¸¸æˆæ•°æ®');\n    }\n  });\n}\n\n/**\n * åˆå§‹åŒ–ä¸»æ¸¸æˆç•Œé¢åŠŸèƒ½\n */\nfunction initDashboardFeatures() {\n  // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡\n  if (document.querySelector('.nav-item[data-module=\"status\"]')?.hasAttribute('data-initialized')) {\n    return;\n  }\n\n  initNavigation();\n  initModals();\n  initAnimations();\n  initStatusCardInteractions();\n  initChatInterface();\n\n  // æ ‡è®°å·²åˆå§‹åŒ–\n  document.querySelectorAll('.nav-item').forEach(item => {\n    item.setAttribute('data-initialized', 'true');\n  });\n\n  console.info('ä¸»æ¸¸æˆç•Œé¢åŠŸèƒ½å·²åˆå§‹åŒ–');\n}\n\n// ä½¿ç”¨ jQuery åœ¨åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–ï¼ˆç¬¦åˆé¡¹ç›®è§„èŒƒï¼‰\n$(() => {\n  errorCatched(initApp)();\n});\n\n// åœ¨ç•Œé¢å¸è½½æ—¶æ‰§è¡Œæ¸…ç†\n$(window).on('pagehide', () => {\n  console.info('é”šç•Œé¢å·²å¸è½½');\n  if (pageManager) {\n    // å¯ä»¥åœ¨è¿™é‡Œæ¸…ç†èµ„æº\n  }\n});\n","// å¯¼å…¥æ ·å¼\nimport './styles.css';\n\n// åˆå§‹åŒ–å‡½æ•°\nfunction init() {\n  // æ·»åŠ  FontAwesome CSS\n  if (!document.querySelector('link[href*=\"font-awesome\"]')) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';\n    document.head.appendChild(link);\n  }\n\n  // æ·»åŠ  meta æ ‡ç­¾\n  if (!document.querySelector('meta[charset]')) {\n    const charset = document.createElement('meta');\n    charset.setAttribute('charset', 'UTF-8');\n    document.head.appendChild(charset);\n  }\n\n  if (!document.querySelector('meta[name=\"viewport\"]')) {\n    const viewport = document.createElement('meta');\n    viewport.setAttribute('name', 'viewport');\n    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');\n    document.head.appendChild(viewport);\n  }\n\n  // è®¾ç½®æ ‡é¢˜\n  document.title = 'é”š';\n\n  // æ·»åŠ æè¿°\n  if (!document.querySelector('meta[name=\"description\"]')) {\n    const description = document.createElement('meta');\n    description.setAttribute('name', 'description');\n    description.setAttribute('content', 'é”š - èˆ°ä½“ç”Ÿå­˜ç»è¥æ¸¸æˆ - ç®¡ç†ä»»åŠ¡ã€è®°å½•æ—¥å¿—ã€å¤„ç†é€šè®¯ã€ç›‘æ§èˆ°ä½“çŠ¶æ€');\n    document.head.appendChild(description);\n  }\n}\n\n// ä½¿ç”¨ jQuery åœ¨åŠ è½½æ—¶æ‰§è¡Œåˆå§‹åŒ–ï¼ˆç¬¦åˆé¡¹ç›®è§„èŒƒï¼‰\n$(() => {\n  init();\n  console.info('é”šç•Œé¢å·²åŠ è½½');\n});\n\n// åœ¨ç•Œé¢å¸è½½æ—¶æ‰§è¡Œæ¸…ç†\n$(window).on('pagehide', () => {\n  console.info('é”šç•Œé¢å·²å¸è½½');\n});\n\n// å¯¼å…¥åº”ç”¨é€»è¾‘\nimport './app';\n"],"names":["checkGenerateAvailable","generate","window","async","regenerateAssistantMessage","userMessageId","callbacks","onShowGenerating","streamingHandler","eventOn","iframe_events","STREAM_TOKEN_RECEIVED_FULLY","fullText","cleanedText","trim","length","onStreamingUpdate","console","log","Error","generatePromise","should_stream","timeoutPromise","Promise","_","reject","setTimeout","result","race","cleanedResult","onHideGenerating","onError","maintext","extractLastMaintext","option","sum","updateVariable","finalMessage","base","userMsg","getChatMessages","data","role","Mvu","getMvuData","type","message_id","stat_data","display_data","delta_data","finalData","parseMessage","parsed","e","warn","extractedOptions","extractAllOptions","maintextContent","sumContent","messageToSave","includes","createChatMessages","message","__options","refresh","assistantMessageId","getLastMessageId","onCreatedMessages","onRefreshStory","error","generateMessage","userInput","mvu_data","waitGlobalInitialized","initData","latestData","chatData","getBaseMvuData","checkAndRefresh","retries","checkMessageId","messages","onRefreshStoryIfOpen","createError","String","substring","generateError","errorType","errorMessage","errorStack","stack","undefined","userMessage","module","exports","removeThinkingTags","text","lastResult","replace","removeThinkingTagsFromStream","cleaned","lastThinkingStart","lastIndexOf","removeSumTags","parseSummary","sumText","split","forEach","part","match","key","value","matches","contentMatch","extractContinueChoice","extractResult","extractNextChoice","extractLastOption","suboptionMatches","options","content","push","optionMatches","lines","map","line","filter","extractLastSum","extractLastUpdateVariable","validateMessage","messageContent","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","hasSaveData","lastMessageId","SplashScreen","element","constructor","this","createElement","div","document","className","id","innerHTML","getHTML","bindEvents","updateContinueButton","show","classList","add","hide","remove","destroy","$","off","keyDownHandler","removeEventListener","continueButton","querySelector","style","display","newGameButton","addEventListener","onNewGame","onContinue","fullscreenButton","requestFullscreen","contains","preventDefault","documentElement","catch","err","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","NewGameSetup","reserveInput","config","getConfig","reserve","updateMvuVariable","confirmButton","inputValue","toastr","parseInt","isNaN","Number","isInteger","onConfirm","cancelButton","onCancel","replaceMvuData","currentMvuData","updatedStatData","system_state","antimatter","Math","max","min","updatedMvuData","info","Dashboard","gameData","loadedMessageIds","Set","mvuUpdateListener","statusRetryCount","statusRetryTimer","refreshData","fallbackDiv","stop","clearTimeout","updateGameData","updateStatusCards","updateTasksList","updateDiaryList","loadMaintextFromChat","statusGrid","getVariables","timeout","intervalBetweenAttempts","chatSystemState","latestSystemState","initSystemState","latest","initMsg","systemState","cycle","system_pressure","instability","population","cards","leakRisk","leak_risk","reservePercent","round","riskLevel","toLocaleString","toFixed","pop","active","standby","archived","total","pressure","pressurePercent","pressureLevel","instabilityPercent","instabilityLevel","join","tasksList","tasks","Array","isArray","getDefaultTasks","task","getTaskIcon","status","escapeHtml","title","getStatusText","time","priority","getPriorityText","description","diaryList","diary","getDefaultDiary","entry","date","updateChatMessages","getDefaultMessages","textContent","parseMaintext","maintextMatch","lastMessage","has","then","el","continueChoice","nextChoice","continueChoiceArea","resultArea","nextChoiceArea","setupMessageListener","tavern_events","handleMessageReceived","MESSAGE_RECEIVED","CHAT_CHANGED","MESSAGE_UPDATED","toggleFullscreen","setupEnterKeyFullscreen","events","VARIABLE_UPDATE_ENDED","activeElement","tagName","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","fullscreenElement","initializeGameData","currentStatData","clampedReserve","updateMvuVariables","station_name","difficulty","resources","energy","supplies","crew","life_support","system","personnel","communication","laboratory","storage","computing","currentData","updatedData","game_data","replaceVariables","game_config","updateGameConfig","PageManager","currentPage","splashScreen","setupScreen","dashboard","appContainer","onStart","goToSplash","goToSetup","goToGame","handleConfirm","onFullscreenToggle","initialize","appendChild","showPage","page","dashboardElement","getElementById","variables","continueGame","fallbackError","initializeNewGame","success","getDashboard","initChatInterface","chatInput","chatSendBtn","chatRegenerateBtn","chatMessages","rounds","currentRoundIndex","activePendingRoundIndex","getPendingRoundIndexSafe","pending","i","r","findLastPendingRoundIndex","streamingElement","lastStreamedRawMessage","isGenerating","isSending","latestOptions","lastCreatedIds","generateMessagePromise","regenerateAssistantMessagePromise","adjustInputHeight","height","newHeight","scrollHeight","displayRound","roundIndex","from","children","child","msg","updateRegenerateButtonState","renderUserMessage","pendingUserMessage","assistantMessage","rawMessage","summaryText","messageItem","searchText","columns","header","icon","columnsHtml","col","displayContent","summaryCard","createSummaryCardElement","renderAssistantMessage","summary","showGenerating","parentNode","disabled","hasUserMessage","isNotPending","sumObj","keys","labelIcons","Time","Location","Characters","Event","entries","loadChatHistory","newRounds","allMessages","pendingRound","sumMatch","groupMessagesIntoRounds","sendMessage","timeEl","hideGenerating","idx","updateStreamingMessage","finalizeStreamingAsAssistant","dispatchEvent","CustomEvent","debug","ids","finalText","columnsContainer","updateColumnsFromStream","pendingIdx","targetRound","Date","now","container","columnConfigs","tag","startTag","endTag","columnElement","hasAttribute","startIndex","indexOf","contentStart","endIndex","setAttribute","headerElement","contentElement","oldScrollTop","scrollTop","oldScrollHeight","wasAtBottom","clientHeight","newScrollHeight","optionsOverlay","optionsContainer","optionsList","showOptionsBtn","closeOptionsBtn","hideOptionsOverlay","getOptionsFromLatestMessage","messageDiv","closeBtn","position","top","left","transform","width","pointerEvents","showNoOptionsMessage","right","bottom","usedPositions","optionText","index","chatOption","optionButton","optionTextSpan","attempts","margin","x","random","y","some","pos","overlayWidth","clientWidth","overlayHeight","dx","dy","sqrt","generateRandomPosition","rotate","setProperty","weight","opacity","requestAnimationFrame","target","isFinite","deleteChatMessages","shiftKey","communicationModule","click","setupKeyboardNavigation","MutationObserver","refreshDisplay","observe","attributes","attributeFilter","setupModuleSwitchListener","pageManager","initApp","mainScreen","navItems","querySelectorAll","modules","switchModule","nav","targetNavItem","targetModule","item","getAttribute","moduleMap","HTMLElement","isContentEditable","initNavigation","modalOverlay","modalClose","initModals","card","initDashboardFeatures","errorCatched","on","link","rel","href","head","charset","viewport","init"],"ignoreList":[],"sourceRoot":""}