{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/anchor/utils/messageGenerator.ts","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/anchor/utils/variableUpdater.ts","src://tavern_helper_template/src/anchor/utils/textParser.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/src/anchor/utils/variableReader.ts","src://tavern_helper_template/src/anchor/components/SplashScreen.ts","src://tavern_helper_template/src/anchor/components/NewGameSetup.ts","src://tavern_helper_template/external var \"showdown\"","src://tavern_helper_template/external var \"YAML\"","src://tavern_helper_template/src/anchor/components/Dashboard.ts","src://tavern_helper_template/src/anchor/utils/pageManager.ts","src://tavern_helper_template/src/anchor/utils/gameInitializer.ts","src://tavern_helper_template/src/anchor/dashboardLogic.ts","src://tavern_helper_template/src/anchor/app.ts","src://tavern_helper_template/src/anchor/index.ts"],"sourcesContent":["/**\n * 消息生成服务\n * 处理完整的消息生成流程：构建提示词 -> 创建 user 消息 -> 调用 LLM -> 解析结果 -> 创建 assistant 消息\n */\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function createChatMessages(\n  messages: Array<{ role: 'user' | 'assistant' | 'system'; message: string; data?: Record<string, any> }>,\n  options?: { refresh?: 'none' | 'affected' | 'all' },\n): Promise<void>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function generate(config: { user_input?: string; should_stream?: boolean }): Promise<string>;\n\n// 检查 generate 函数是否在全局作用域可用\nfunction checkGenerateAvailable(): boolean {\n  if (typeof generate === 'undefined') {\n    // 尝试从 window 对象获取\n    if (typeof window !== 'undefined' && (window as any).generate) {\n      return true;\n    }\n    return false;\n  }\n  return true;\n}\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const iframe_events: {\n  STREAM_TOKEN_RECEIVED_FULLY: 'js_stream_token_received_fully';\n  GENERATION_ENDED: 'js_generation_ended';\n};\n\n// MVU 变量框架声明\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  parseMessage?: (message: string, old_data: any) => Promise<any | undefined>;\n};\n\nimport _ from 'lodash';\nimport {\n  extractAllOptions,\n  extractLastMaintext,\n  extractLastOption,\n  extractLastSum,\n  extractLastUpdateVariable,\n  removeThinkingTags,\n  removeThinkingTagsFromStream,\n  validateMessage,\n} from './textParser';\n\n/**\n * 获取基础 MVU 数据（用于传递到新楼层）\n */\nasync function getBaseMvuData(): Promise<any> {\n  try {\n    // 确保 MVU 已初始化\n    await waitGlobalInitialized('Mvu');\n\n    // 合并 init(0) / latest message / chat（chat 优先），作为新楼层的 base\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    try {\n      chatData = Mvu.getMvuData({ type: 'chat' });\n    } catch {\n      // ignore\n    }\n\n    const base = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    console.log('📊 从 MVU(merged) 获取基础数据');\n\n    // 返回基础数据，不进行任何解析\n    return (\n      base ?? {\n        stat_data: {},\n        display_data: {},\n        delta_data: {},\n      }\n    );\n  } catch (error) {\n    console.warn('⚠️ 获取 MVU 数据失败，使用空对象:', error);\n    // 如果 MVU 不可用，返回一个基本的 MVU 数据结构\n    return {\n      stat_data: {},\n      display_data: {},\n      delta_data: {},\n    };\n  }\n}\n\n/**\n * 消息生成回调接口\n */\nexport interface MessageGeneratorCallbacks {\n  onShowGenerating?: () => void; // 显示生成提示\n  onHideGenerating?: () => void; // 隐藏生成提示\n  onError?: (error: string) => void; // 错误回调\n  onStreamingUpdate?: (text: string) => void; // 流式更新 maintext 的回调\n  onRefreshStoryIfOpen?: (userMessage: string) => void; // 如果界面已打开则刷新显示（user消息创建后，传入用户消息内容）\n  onRefreshStory?: (options?: string[]) => void; // 刷新游戏显示的回调（assistant消息创建后，传入选项数组）\n  onCreatedMessages?: (ids: { userMessageId: number; assistantMessageId: number }) => void; // user+assistant 创建完成后回传真实楼层 id\n}\n\n/**\n * 重新生成 assistant 消息（不创建 user 楼层）\n * 典型用途：删除当前轮的 assistant 楼层后，基于同一个 user 楼层重新生成 AI 回复。\n */\nexport async function regenerateAssistantMessage(\n  userMessageId: number,\n  callbacks: MessageGeneratorCallbacks = {},\n): Promise<boolean> {\n  try {\n    if (callbacks.onShowGenerating) callbacks.onShowGenerating();\n\n    // 注册流式事件监听器\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          callbacks.onStreamingUpdate?.('');\n          return;\n        }\n        callbacks.onStreamingUpdate?.(cleanedText);\n      };\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('✅ [regen] 已注册流式输出监听器');\n    } else {\n      console.log('ℹ️ [regen] 流式事件不可用，退化为非流式模式');\n    }\n\n    // 检查 generate 可用\n    if (!checkGenerateAvailable()) {\n      throw new Error('generate 函数不可用，请确保酒馆助手已正确加载');\n    }\n\n    // generate（不传 user_input：沿用当前上下文/提示词）\n    const generatePromise = generate({ should_stream: true });\n    const timeoutPromise = new Promise<string>((_, reject) => {\n      setTimeout(() => reject(new Error('generate 调用超时（5分钟）')), 5 * 60 * 1000);\n    });\n    const result = await Promise.race([generatePromise, timeoutPromise]);\n\n    const cleanedResult = removeThinkingTags(result);\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('生成的消息不符合规范');\n      return false;\n    }\n\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n      callbacks.onError?.('无法提取 maintext 或 option');\n      return false;\n    }\n\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) finalMessage += `\\n\\n<sum>${sum}</sum>`;\n    if (updateVariable) finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n\n    // base 优先使用 userMessage.data（因为 regenerate 不会新建 user 楼层）\n    let base: any = null;\n    try {\n      const userMsg = getChatMessages(userMessageId)?.[0];\n      if (userMsg?.data) base = userMsg.data;\n    } catch {\n      // ignore\n    }\n    if (!base) {\n      try {\n        base =\n          getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n          Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        base = { stat_data: {}, display_data: {}, delta_data: {} };\n      }\n    }\n\n    if (!base || typeof base !== 'object') base = { stat_data: {}, display_data: {}, delta_data: {} };\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // MVU 解析\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) finalData = parsed;\n      } catch (e) {\n        console.warn('⚠️ [regen] MVU 解析失败，使用基础数据:', e);\n      }\n    }\n\n    const extractedOptions = extractAllOptions(finalMessage);\n\n    // 只保存 maintext 和 sum\n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave,\n          data: {\n            ...finalData,\n            __options: extractedOptions,\n          },\n        },\n      ],\n      { refresh: 'none' },\n    );\n\n    const assistantMessageId = getLastMessageId();\n    console.log('✅ [regen] assistant 消息已创建，ID:', assistantMessageId);\n\n    // 回传 id（userMessageId 不变）\n    callbacks.onCreatedMessages?.({ userMessageId, assistantMessageId });\n\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n\n    setTimeout(() => {\n      callbacks.onRefreshStory?.(extractedOptions);\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('❌ [regen] 重新生成 assistant 失败:', error);\n    if (callbacks.onHideGenerating) callbacks.onHideGenerating();\n    callbacks.onError?.(error instanceof Error ? error.message : '重新生成失败');\n    return false;\n  }\n}\n\n/**\n * 生成消息\n * @param userInput 用户输入（选项文本或自定义消息）\n * @param callbacks 回调函数\n */\nexport async function generateMessage(userInput: string, callbacks: MessageGeneratorCallbacks = {}): Promise<boolean> {\n  let userMessageId: number | null = null;\n\n  try {\n    // 1. 禁用相关UI（如果需要）\n    // 这里可以添加禁用选项按钮等逻辑\n\n    // 2. 显示\"正在生成\"提示\n    if (callbacks.onShowGenerating) {\n      callbacks.onShowGenerating();\n    }\n\n    // 3. 获取基础 MVU 数据\n    const mvu_data = await getBaseMvuData();\n\n    // 4. 创建 user 消息，直接使用用户输入（提示词已在酒馆界面封装）\n    console.log('📝 [步骤2] 开始创建 user 消息...');\n    console.log('📝 [步骤2] 用户输入:', userInput);\n    console.log('📝 [步骤2] MVU 数据:', mvu_data ? '已获取' : '未获取');\n\n    try {\n      await createChatMessages(\n        [\n          {\n            role: 'user',\n            message: userInput, // ⚠️ 只存储用户的原始输入，不存储完整提示词\n            data: mvu_data, // 传递 MVU 数据，确保变量正确传递到新楼层\n          },\n        ],\n        {\n          refresh: 'none', // 不更新显示，由游戏界面自己读取\n        },\n      );\n      console.log('✅ [步骤2] user 消息已创建');\n\n      // 9. 获取刚创建的 user 消息 ID\n      userMessageId = getLastMessageId();\n      console.log('✅ [步骤2] user 消息已创建，ID:', userMessageId);\n\n      // 立即回传 ID，这样即使后面 AI 生成崩了，前端也知道 User 消息的真实 ID\n      if (callbacks.onCreatedMessages && userMessageId !== null) {\n        try {\n          callbacks.onCreatedMessages({ userMessageId, assistantMessageId: -1 });\n        } catch (e) {\n          console.warn('⚠️ onCreatedMessages (user) 回调执行失败:', e);\n        }\n      }\n\n      // 10. 刷新显示刚发送的用户消息（参考mhjg实现）\n      // 使用轮询方式确保消息已创建\n      const checkAndRefresh = async (retries = 5) => {\n        const checkMessageId = getLastMessageId();\n        if (checkMessageId === userMessageId) {\n          // 验证消息是否存在\n          const messages = getChatMessages(checkMessageId);\n          if (messages && messages.length > 0 && messages[0].role === 'user') {\n            if (callbacks.onRefreshStoryIfOpen) {\n              callbacks.onRefreshStoryIfOpen(messages[0].message);\n              console.log('✅ [步骤2] 已刷新显示用户消息，ID:', userMessageId);\n            }\n            return;\n          }\n        }\n\n        // 如果消息还未创建，重试\n        if (retries > 0) {\n          setTimeout(() => checkAndRefresh(retries - 1), 50);\n        } else if (callbacks.onRefreshStoryIfOpen) {\n          // 即使验证失败，也尝试刷新（使用用户输入）\n          callbacks.onRefreshStoryIfOpen(userInput);\n          console.log('⚠️ [步骤2] 验证消息失败，但仍尝试刷新显示');\n        }\n      };\n\n      setTimeout(() => checkAndRefresh(), 50);\n    } catch (createError) {\n      console.error('❌ [步骤2] createChatMessages 调用失败:', createError);\n      throw new Error(\n        `创建 user 消息失败: ${createError instanceof Error ? createError.message : String(createError)}`,\n      );\n    }\n\n    // 5. 注册流式事件监听器（在调用 generate 之前）\n    let streamingHandler: ((fullText: string) => void) | null = null;\n    if (typeof eventOn !== 'undefined' && iframe_events?.STREAM_TOKEN_RECEIVED_FULLY) {\n      streamingHandler = (fullText: string) => {\n        // 实时剔除 <thinking> 标签（包括未闭合的）\n        const cleanedText = removeThinkingTagsFromStream(fullText);\n\n        // 如果清理后文本为空（说明正在 thinking 标签内），不显示任何内容\n        if (!cleanedText || cleanedText.trim().length === 0) {\n          if (callbacks.onStreamingUpdate) {\n            callbacks.onStreamingUpdate('');\n          }\n          return;\n        }\n\n        // 传递完整的 cleanedText（包含所有标签），用于检测标签开始/结束\n        if (callbacks.onStreamingUpdate) {\n          callbacks.onStreamingUpdate(cleanedText);\n        }\n      };\n\n      eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, streamingHandler);\n      console.log('✅ [步骤3] 已注册流式输出监听器');\n    } else {\n      console.log('ℹ️ [步骤3] 流式事件不可用，退化为非流式模式');\n    }\n\n    // 6. 使用 generate 生成 LLM 回复（支持流式生成）\n    console.log('🚀 [步骤3] 开始调用 generate 生成回复...');\n    console.log('📝 [步骤3] 用户输入:', userInput);\n\n    // 检查 generate 函数是否可用\n    if (!checkGenerateAvailable()) {\n      console.error('❌ [步骤3] generate 函数未定义');\n      console.error('❌ [步骤3] 请检查：');\n      console.error('   1. 酒馆助手是否已正确安装');\n      console.error('   2. 是否在 iframe 环境中运行');\n      console.error('   3. 全局 generate 函数是否可用');\n      throw new Error('generate 函数不可用，请确保酒馆助手已正确加载');\n    }\n\n    let result: string;\n    try {\n      console.log('🚀 [步骤3] 调用 generate，直接使用用户输入（提示词已在酒馆界面封装）...');\n      console.log('🚀 [步骤3] generate 函数类型:', typeof generate);\n\n      // 直接使用用户输入（提示词已在酒馆界面封装）\n      const generatePromise = generate({\n        // user_input: userInput, // 不使用用户输入\n        should_stream: true, // 启用流式生成\n      });\n\n      // 设置超时（5分钟）\n      const timeoutPromise = new Promise<string>((_, reject) => {\n        setTimeout(\n          () => {\n            reject(new Error('generate 调用超时（5分钟）'));\n          },\n          5 * 60 * 1000,\n        );\n      });\n\n      result = await Promise.race([generatePromise, timeoutPromise]);\n\n      console.log('📨 [步骤3] generate 返回结果，长度:', result?.length || 0);\n      if (!result || result.length === 0) {\n        console.warn('⚠️ [步骤3] generate 返回空结果');\n      } else {\n        console.log('📨 [步骤3] generate 返回结果预览:', result.substring(0, 200) + '...');\n      }\n    } catch (generateError) {\n      console.error('❌ [步骤3] generate 调用失败:', generateError);\n      console.error('❌ [步骤3] 错误详情:', {\n        error: generateError,\n        errorType: typeof generateError,\n        errorMessage: generateError instanceof Error ? generateError.message : String(generateError),\n        errorStack: generateError instanceof Error ? generateError.stack : undefined,\n      });\n\n      // 检查是否是超时错误\n      if (generateError instanceof Error && generateError.message.includes('超时')) {\n        throw new Error('generate 调用超时，请检查网络连接或 LLM 服务状态');\n      }\n\n      throw new Error(\n        `generate 调用失败: ${generateError instanceof Error ? generateError.message : String(generateError)}`,\n      );\n    }\n\n    // 7. 移除 <thinking> 标签\n    const cleanedResult = removeThinkingTags(result);\n\n    // 8. 验证返回结果是否符合规范\n    if (!cleanedResult || !validateMessage(cleanedResult)) {\n      console.error('❌ [步骤4] generate 返回的消息不符合规范');\n      // 隐藏生成提示框\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('生成的消息不符合规范');\n      }\n      return false;\n    }\n\n    // 12. 提取最后一次出现的 <maintext>、<option>、<sum> 和 <UpdateVariable>\n    const maintext = extractLastMaintext(cleanedResult);\n    const option = extractLastOption(cleanedResult);\n    const sum = extractLastSum(cleanedResult);\n    const updateVariable = extractLastUpdateVariable(cleanedResult);\n\n    if (!maintext || !option) {\n      console.error('❌ [步骤5] 无法提取 maintext 或 option');\n      // 隐藏生成提示框\n      if (callbacks.onHideGenerating) {\n        callbacks.onHideGenerating();\n      }\n      if (callbacks.onError) {\n        callbacks.onError('无法提取 maintext 或 option');\n      }\n      return false;\n    }\n\n    // 13. 重新组合消息（包含最后一次的 maintext、option、sum（如果有）和 UpdateVariable（如果有））\n    // 用于 MVU 解析（需要完整消息）\n    let finalMessage = `<maintext>${maintext}</maintext>\\n\\n<option>${option}</option>`;\n    if (sum) {\n      finalMessage += `\\n\\n<sum>${sum}</sum>`;\n      console.log('📝 [步骤5] 提取到 <sum> 标签');\n    }\n    if (updateVariable) {\n      finalMessage += `\\n\\n<UpdateVariable>${updateVariable}</UpdateVariable>`;\n      console.log('📝 [步骤5] 提取到 <UpdateVariable> 标签');\n    }\n\n    // 14. 获取基础 MVU 数据（优先从刚创建的 user 消息读取）\n    console.log('📊 [步骤6] 开始获取基础 MVU 数据...');\n    let base: any;\n    if (userMessageId !== null) {\n      const userMessage = getChatMessages(userMessageId)?.[0];\n      if (userMessage?.data) {\n        base = userMessage.data;\n        console.log('✅ [步骤6] 从刚创建的 user 消息读取基础数据');\n      }\n    }\n\n    // 如果 user 消息没有 data，则从最新的 assistant 消息或 MVU 读取\n    if (!base) {\n      console.log('📊 [步骤6] 尝试从最新的 assistant 消息或 MVU 读取...');\n      base =\n        getChatMessages(-1, { role: 'assistant' })?.[0]?.data ??\n        Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      console.log('✅ [步骤6] 从最新的 assistant 消息或 MVU 读取基础数据');\n    }\n\n    // 确保 base 数据结构完整\n    if (!base || typeof base !== 'object') {\n      console.log('⚠️ [步骤6] base 数据无效，使用空对象');\n      base = { stat_data: {}, display_data: {}, delta_data: {} };\n    }\n    if (!base.stat_data) base.stat_data = {};\n    if (!base.display_data) base.display_data = {};\n    if (!base.delta_data) base.delta_data = {};\n\n    // 15. 解析消息中的 MVU 命令（如果 MVU.parseMessage 可用）\n    console.log('🔍 [步骤7] 开始解析消息中的 MVU 命令...');\n    let finalData = base;\n    if (Mvu.parseMessage) {\n      try {\n        const parsed = await Mvu.parseMessage(finalMessage, base);\n        if (parsed) {\n          finalData = parsed;\n          console.log('✅ [步骤7] MVU 解析成功');\n        } else {\n          console.log('ℹ️ [步骤7] MVU 解析返回 undefined，使用基础数据');\n        }\n      } catch (error) {\n        console.warn('⚠️ [步骤7] MVU 解析失败，使用基础数据:', error);\n      }\n    } else {\n      console.log('ℹ️ [步骤7] MVU.parseMessage 不可用，跳过解析');\n    }\n\n    // 16. 提取选项（在 createChatMessages 之前，从 finalMessage 中提取）\n    console.log('📝 [步骤8] 开始提取选项...');\n    const extractedOptions = extractAllOptions(finalMessage);\n    console.log('📝 [步骤8] 已提取选项:', extractedOptions.length, '个');\n\n    // 17. 创建 assistant 消息（只保存 <maintext> 标签里的内容和 <sum> 标签内容）\n    console.log('📝 [步骤9] 开始创建 assistant 消息...');\n    // 从 finalMessage 中提取 maintext 内容（只保留 maintext 标签里的内容）\n    const maintextContent = extractLastMaintext(finalMessage);\n    const sumContent = extractLastSum(finalMessage);\n\n    let messageToSave = maintextContent || finalMessage;\n    if (sumContent) {\n      if (maintextContent) {\n        messageToSave = `${maintextContent}\\n\\n<sum>${sumContent}</sum>`;\n      } else if (!finalMessage.includes(`<sum>${sumContent}</sum>`)) {\n        messageToSave = `${finalMessage}\\n\\n<sum>${sumContent}</sum>`;\n      }\n    }\n\n    if (!maintextContent) {\n      console.warn('⚠️ [步骤9] 无法从 finalMessage 中提取 maintext，使用完整的 finalMessage');\n    } else {\n      console.log('📝 [步骤9] 已提取 maintext 内容，保存 maintext 和 sum 部分');\n    }\n\n    await createChatMessages(\n      [\n        {\n          role: 'assistant',\n          message: messageToSave, // 只保存 maintext 内容\n          data: {\n            ...finalData, // 传入解析后的数据（包含所有变量更新）\n            __options: extractedOptions, // ✅ 存在 data 里\n          },\n        },\n      ],\n      {\n        refresh: 'none', // 更新显示，由游戏界面自己读取\n      },\n    );\n    console.log('✅ [步骤9] assistant 消息已创建，酒馆界面历史已刷新');\n\n    // 18. 获取新创建的消息 ID\n    const assistantMessageId = getLastMessageId();\n    console.log('🆔 [步骤10] 获取新创建的消息 ID:', assistantMessageId);\n\n    // 18.1 回传真实 message_id（便于上层做“重新生成/删除本轮”等操作）\n    if (callbacks.onCreatedMessages && userMessageId !== null) {\n      try {\n        callbacks.onCreatedMessages({ userMessageId, assistantMessageId });\n      } catch (e) {\n        console.warn('⚠️ onCreatedMessages 回调执行失败（忽略）:', e);\n      }\n    }\n\n    // 19. 隐藏生成提示框\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 20. 刷新游戏显示（延迟一下，确保消息已经完全创建并写入历史）\n    // 同时传递提取的选项，前端可以直接使用，无需从消息中提取\n    setTimeout(() => {\n      if (callbacks.onRefreshStory) {\n        callbacks.onRefreshStory(extractedOptions);\n        console.log('✅ [步骤11] 已刷新游戏显示（已传递选项）');\n      }\n    }, 300);\n\n    return true;\n  } catch (error) {\n    console.error('❌ 生成消息失败:', error);\n\n    // 隐藏生成提示框\n    if (callbacks.onHideGenerating) {\n      callbacks.onHideGenerating();\n    }\n\n    // 显示错误信息\n    if (callbacks.onError) {\n      callbacks.onError(error instanceof Error ? error.message : '生成消息失败');\n    }\n\n    return false;\n  }\n}\n","module.exports = _;","import _ from 'lodash';\nimport { GameConfig, GameData } from '../types/types';\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (\n    mvu_data: any,\n    options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' },\n  ) => Promise<void>;\n};\n\n/**\n * 更新 MVU 变量（将表单输入的值写入 MVU 变量系统）\n */\nexport async function updateMvuVariables(config: GameConfig): Promise<void> {\n  try {\n    // 确保 MVU 已初始化\n    await waitGlobalInitialized('Mvu');\n\n    // 获取当前的 MVU 数据\n    // 优先更新 chat 变量表，作为“当前状态”来源。\n    // 同时合并 init(0) / latest message 以补齐缺失字段，避免只写 reserve 导致 system_state 结构残缺。\n    let initData: any = null;\n    let latestData: any = null;\n    let chatData: any = null;\n    try {\n      initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n    } catch {\n      // ignore\n    }\n    try {\n      latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n    } catch {\n      // ignore\n    }\n    chatData = Mvu.getMvuData({ type: 'chat' });\n\n    const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n    const currentStatData = currentMvuData?.stat_data || {};\n\n    // 构建更新后的 stat_data\n    const updatedStatData = _.cloneDeep(currentStatData);\n\n    // 更新 system_state.antimatter.reserve（系统剩余能源）\n    if (config.reserve !== undefined) {\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // 确保 reserve 在 0-100000 范围内\n      const clampedReserve = _.clamp(config.reserve, 0, 100000);\n      updatedStatData.system_state.antimatter.reserve = clampedReserve;\n      console.info(`✅ 更新 system_state.antimatter.reserve: ${clampedReserve}`);\n    }\n\n    // 将更新后的数据写回 MVU\n    const updatedMvuData = {\n      ...currentMvuData,\n      stat_data: updatedStatData,\n    };\n\n    await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n    console.info('✅ MVU 变量已更新');\n  } catch (error) {\n    console.error('❌ 更新 MVU 变量失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 更新游戏数据到酒馆变量系统\n */\nexport async function updateGameData(data: Partial<GameData>): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_data: {\n        ...(currentData.game_data || {}),\n        ...data,\n      },\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('游戏数据已更新');\n  } catch (error) {\n    console.error('更新游戏数据失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 更新游戏配置\n */\nexport async function updateGameConfig(config: GameConfig): Promise<void> {\n  try {\n    const currentData = getVariables({ type: 'message' });\n    const updatedData = {\n      ...currentData,\n      game_config: config,\n    };\n    replaceVariables(updatedData, { type: 'message' });\n    console.info('游戏配置已更新');\n  } catch (error) {\n    console.error('更新游戏配置失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 初始化游戏数据\n */\nexport async function initializeGameData(config: GameConfig): Promise<GameData> {\n  // 先更新 MVU 变量（将表单输入的值写入 MVU）\n  await updateMvuVariables(config);\n\n  // 创建基本的游戏数据结构（保留兼容性）\n  const gameData: GameData = {\n    station_name: '空间站 Alpha', // 不再从表单读取\n    difficulty: 'normal', // 不再从表单读取\n    resources: {\n      energy: 100,\n      supplies: 100,\n      crew: 10,\n    },\n    status: {\n      energy: 87,\n      life_support: 92,\n      system: 78,\n      personnel: '正常',\n      communication: 95,\n      laboratory: 83,\n      storage: 64,\n      computing: 71,\n    },\n    tasks: [],\n    diary: [],\n    messages: [],\n  };\n\n  await updateGameData(gameData);\n  await updateGameConfig(config);\n\n  return gameData;\n}\n","/**\n * 文本解析工具\n * 用于从 LLM 返回的文本中提取格式化的标签内容\n */\n\n/**\n * 移除 <thinking> 标签及其内部所有内容（用于最终结果）\n */\nexport function removeThinkingTags(text: string): string {\n  if (!text) return '';\n\n  // 匹配 <thinking>...</thinking> 标签（包括简单嵌套情况）\n  let result = text;\n  let lastResult = '';\n\n  // 循环处理，直到没有更多的 <thinking> 标签\n  while (result !== lastResult) {\n    lastResult = result;\n    result = result.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n  }\n\n  return result;\n}\n\n/**\n * 从流式文本中移除 <thinking> 内容\n * - 先移除所有完整的 <thinking>...</thinking>\n * - 如果还有未闭合的 <thinking>，则隐藏从最后一个 <thinking> 开始的所有内容\n */\nexport function removeThinkingTagsFromStream(text: string): string {\n  if (!text) return '';\n\n  // 先移除所有完整的 <thinking>...</thinking> 标签对\n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>/gi, '');\n\n  // 检查是否还有未闭合的 <thinking> 标签\n  const lastThinkingStart = cleaned.lastIndexOf('<thinking>');\n\n  // 如果找到了未闭合的 <thinking>，隐藏从它开始的所有内容\n  if (lastThinkingStart !== -1) {\n    cleaned = cleaned.substring(0, lastThinkingStart).trim();\n  }\n\n  return cleaned;\n}\n\n/**\n * 移除 <sum> 标签及其内容\n */\nexport function removeSumTags(text: string): string {\n  if (!text) return '';\n  return text.replace(/<sum>[\\s\\S]*?<\\/sum>/gi, '').trim();\n}\n\n/**\n * 解析 summary 字符串为对象\n * 格式: 时间: ... | 地点: ... | 人物: ... | 事件: ...\n */\nexport function parseSummary(sumText: string): Record<string, string> {\n  if (!sumText) return {};\n\n  const result: Record<string, string> = {};\n  // 使用正则匹配，兼容中英文冒号\n  // 匹配模式: (键名) (中/英冒号) (直到下一个 | 或字符串结束的内容)\n  const parts = sumText.split('|');\n\n  parts.forEach(part => {\n    const match = part.match(/^\\s*(时间|地点|人物|事件|Time|Location|Characters|Event)\\s*[:：]\\s*([\\s\\S]*)$/i);\n    if (match) {\n      const key = match[1].trim();\n      const value = match[2].trim();\n      result[key] = value;\n    }\n  });\n\n  return result;\n}\n\n/**\n * 提取最后一次出现的 <maintext> 标签内容\n */\nexport function extractLastMaintext(text: string): string {\n  const matches = text.match(/<maintext>([\\s\\S]*?)<\\/maintext>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // 获取最后一个匹配\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取最后一次出现的 <continue_choice> 标签内容\n */\nexport function extractContinueChoice(text: string): string {\n  const matches = text.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<continue_choice>([\\s\\S]*?)<\\/continue_choice>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取最后一次出现的 <result> 标签内容\n */\nexport function extractResult(text: string): string {\n  const matches = text.match(/<result>([\\s\\S]*?)<\\/result>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<result>([\\s\\S]*?)<\\/result>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取最后一次出现的 <decision_node> 标签内容\n */\nexport function extractNextChoice(text: string): string {\n  const matches = text.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<decision_node>([\\s\\S]*?)<\\/decision_node>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取最后一次出现的 <option> 标签内容\n */\nexport function extractLastOption(text: string): string {\n  const matches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // 获取最后一个匹配\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<option>([\\s\\S]*?)<\\/option>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取所有 <suboption> 标签内容（新格式）\n * @returns 所有 suboption 文本的数组\n */\nexport function extractAllOptions(text: string): string[] {\n  if (!text) return [];\n\n  // 首先尝试提取 <suboption> 标签（新格式）\n  const suboptionMatches = text.match(/<suboption>([\\s\\S]*?)<\\/suboption>/gi);\n  if (suboptionMatches && suboptionMatches.length > 0) {\n    const options: string[] = [];\n    suboptionMatches.forEach(match => {\n      const contentMatch = match.match(/<suboption>([\\s\\S]*?)<\\/suboption>/i);\n      if (contentMatch && contentMatch[1]) {\n        const content = contentMatch[1].trim();\n        if (content) {\n          options.push(content);\n        }\n      }\n    });\n    if (options.length > 0) {\n      return options;\n    }\n  }\n\n  // 如果没有找到 <suboption>，回退到旧的 <option> 格式（兼容性）\n  const optionMatches = text.match(/<option>([\\s\\S]*?)<\\/option>/gi);\n  if (!optionMatches || optionMatches.length === 0) {\n    return [];\n  }\n\n  // 提取每个 option 的内容（旧格式）\n  const options: string[] = [];\n  optionMatches.forEach(match => {\n    const contentMatch = match.match(/<option>([\\s\\S]*?)<\\/option>/i);\n    if (contentMatch && contentMatch[1]) {\n      const content = contentMatch[1].trim();\n      if (content) {\n        // 尝试按行分割，每行作为一个选项（兼容旧格式）\n        const lines = content\n          .split('\\n')\n          .map(line => line.trim())\n          .filter(line => line);\n        if (lines.length > 1) {\n          // 多行，每行作为一个选项\n          options.push(...lines);\n        } else {\n          // 单行，直接添加\n          options.push(content);\n        }\n      }\n    }\n  });\n\n  return options;\n}\n\n/**\n * 提取最后一次出现的 <sum> 标签内容\n */\nexport function extractLastSum(text: string): string {\n  const matches = text.match(/<sum>([\\s\\S]*?)<\\/sum>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // 获取最后一个匹配\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n  return contentMatch ? contentMatch[1].trim() : '';\n}\n\n/**\n * 提取最后一次出现的 <UpdateVariable> 标签内容\n */\nexport function extractLastUpdateVariable(text: string): string {\n  const matches = text.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/gi);\n  if (!matches || matches.length === 0) {\n    return '';\n  }\n  // 获取最后一个匹配\n  const lastMatch = matches[matches.length - 1];\n  const contentMatch = lastMatch.match(/<UpdateVariable>([\\s\\S]*?)<\\/UpdateVariable>/i);\n  if (!contentMatch) {\n    return '';\n  }\n\n  const content = contentMatch[1].trim();\n\n  // 直接返回原始内容，不进行任何转换\n  // MVU 系统可能直接支持 JSONPatch 格式，转换反而会导致问题\n  console.log('📝 提取到 <UpdateVariable> 原始内容，直接保留，不进行转换');\n  return content;\n}\n\n/**\n * 验证消息是否符合规范（至少包含 maintext 和 option）\n */\nexport function validateMessage(messageContent: string): boolean {\n  if (!messageContent || typeof messageContent !== 'string') {\n    return false;\n  }\n\n  // 移除 thinking 标签后再验证\n  const cleaned = removeThinkingTags(messageContent);\n  const maintext = extractLastMaintext(cleaned);\n  const option = extractLastOption(cleaned);\n\n  if (!maintext || !option) {\n    console.warn('⚠️ 消息缺少 <maintext> 或 <option> 标签');\n    return false;\n  }\n\n  return true;\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","import { GameData, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\ndeclare function getLastMessageId(): number;\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\n/**\n * 从 MVU 变量系统读取游戏数据\n */\nexport async function readGameData(): Promise<any> {\n  try {\n    // 确保 MVU 已初始化\n    if (typeof waitGlobalInitialized !== 'undefined') {\n      await waitGlobalInitialized('Mvu');\n    }\n\n    // 从 MVU 系统读取 stat_data\n    if (typeof Mvu !== 'undefined' && Mvu.getMvuData) {\n      // 合并多个来源：init(0) -> latest message -> chat（chat 优先覆盖），用于补齐缺失字段\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      try {\n        chatData = Mvu.getMvuData({ type: 'chat' });\n      } catch {\n        // ignore\n      }\n\n      const merged = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      return _.get(merged, 'stat_data') || {};\n    }\n\n    // 降级：从酒馆变量系统读取\n    const variables = getVariables({ type: 'message' });\n    const gameData = variables.game_data || variables.stat_data || {};\n    return gameData;\n  } catch (error) {\n    console.warn('读取游戏数据失败:', error);\n    return {};\n  }\n}\n\n/**\n * 检查是否有存档\n * 通过检查 assistant 消息数量来判断：\n * - assistant 消息只有 1 条：新开的档（开场白），返回 false，显示开始界面\n * - assistant 消息 > 1 条：继续游戏，返回 true，直接进入游戏界面\n */\nexport function hasSaveData(): boolean {\n  try {\n    // 检查 assistant 消息数量\n    const lastMessageId = getLastMessageId();\n    if (lastMessageId < 0) {\n      return false; // 没有消息，肯定没有存档\n    }\n\n    // 获取所有 assistant 消息\n    const messages = getChatMessages(`0-${lastMessageId}`, { role: 'assistant' });\n\n    // 只有 1 条 assistant 消息：新开的档（开场白），应该显示开始界面\n    // 多于 1 条 assistant 消息：继续游戏\n    return messages && messages.length > 1;\n  } catch (error) {\n    console.warn('检查存档状态失败:', error);\n    return false;\n  }\n}\n\n/**\n * 读取游戏配置\n */\nexport function readGameConfig(): Partial<GameConfig> {\n  try {\n    const variables = getVariables({ type: 'message' });\n    const config = variables.game_config || {};\n    return config as Partial<GameConfig>;\n  } catch (error) {\n    console.warn('读取游戏配置失败:', error);\n    return {};\n  }\n}\n","import { ComponentCallbacks } from '../types/types';\nimport { hasSaveData } from '../utils/variableReader';\n\n/**\n * 标题页面组件\n */\nexport class SplashScreen {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen splash-screen';\n    div.id = 'splash-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    this.updateContinueButton();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      this.updateContinueButton();\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // 移除全局事件监听器\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n  }\n\n  private updateContinueButton(): void {\n    if (!this.element) return;\n\n    const continueButton = this.element.querySelector('#continue-button') as HTMLElement;\n    if (continueButton) {\n      if (hasSaveData()) {\n        continueButton.style.display = 'flex';\n      } else {\n        continueButton.style.display = 'none';\n      }\n    }\n  }\n\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    const newGameButton = this.element.querySelector('#new-game-button');\n    if (newGameButton) {\n      newGameButton.addEventListener('click', () => {\n        this.callbacks.onNewGame?.();\n      });\n    }\n\n    const continueButton = this.element.querySelector('#continue-button');\n    if (continueButton) {\n      continueButton.addEventListener('click', () => {\n        this.callbacks.onContinue?.();\n      });\n    }\n\n    const fullscreenButton = this.element.querySelector('#fullscreen-button');\n    if (fullscreenButton) {\n      fullscreenButton.addEventListener('click', () => {\n        this.requestFullscreen();\n      });\n    }\n\n    // Enter键支持：全屏\n    this.keyDownHandler = (e: KeyboardEvent) => {\n      if (e.key === 'Enter' && this.element?.classList.contains('active')) {\n        e.preventDefault();\n        this.requestFullscreen();\n      }\n    };\n    document.addEventListener('keydown', this.keyDownHandler);\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch(err => {\n        console.warn('全屏请求失败:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"splash-screen-content\">\n        <div class=\"splash-header\">\n          <div class=\"splash-logo\">\n            <i class=\"fas fa-anchor\"></i>\n          </div>\n          <h1 class=\"splash-title\">锚</h1>\n          <p class=\"splash-subtitle\">ANCHOR</p>\n        </div>\n        <div class=\"splash-actions\">\n          <button type=\"button\" class=\"splash-button primary\" id=\"new-game-button\">\n            <i class=\"fas fa-play\"></i>\n            <span>开始新游戏</span>\n          </button>\n          <button type=\"button\" class=\"splash-button secondary\" id=\"continue-button\" style=\"display: none;\">\n            <i class=\"fas fa-redo\"></i>\n            <span>继续游戏</span>\n          </button>\n          <button type=\"button\" class=\"splash-button icon-only\" id=\"fullscreen-button\" title=\"切换全屏 (Enter)\">\n            <i class=\"fas fa-expand\"></i>\n          </button>\n        </div>\n        <div class=\"splash-footer\">\n          <p class=\"splash-copyright\">© 2026 锚</p>\n          <p class=\"splash-author\">基于Silly Tavern、酒馆助手</p>\n          <p class=\"splash-hint\" style=\"margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-tertiary);\">按 Enter 键全屏</p>\n        </div>\n      </div>\n    `;\n  }\n}\n","import { ComponentCallbacks, GameConfig } from '../types/types';\nimport _ from 'lodash';\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const toastr: any;\ndeclare const Mvu: {\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n  replaceMvuData: (mvu_data: any, options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => Promise<void>;\n};\n\n/**\n * 开局设置页面组件\n */\nexport class NewGameSetup {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n  }\n\n  public createElement(): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'screen setup-screen';\n    div.id = 'setup-screen';\n    div.innerHTML = this.getHTML();\n    this.element = div;\n    this.bindEvents();\n    return div;\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) return;\n\n    // 实时更新 MVU 变量（当用户输入时）\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    if (reserveInput) {\n      reserveInput.addEventListener('input', async () => {\n        const config = this.getConfig();\n        if (config.reserve !== undefined) {\n          await this.updateMvuVariable(config.reserve);\n        }\n      });\n    }\n\n    const confirmButton = this.element.querySelector('#setup-confirm-button');\n    if (confirmButton) {\n      confirmButton.addEventListener('click', () => {\n        const reserveInput = this.element?.querySelector('#energy-reserve') as HTMLInputElement;\n        const inputValue = reserveInput?.value?.trim() || '';\n\n        // 验证输入\n        if (!inputValue) {\n          toastr.error('请输入系统剩余能源', '验证失败');\n          return;\n        }\n\n        // 检查是否为整数（不允许小数点）\n        if (inputValue.includes('.')) {\n          toastr.error('系统剩余能源必须是整数', '验证失败');\n          return;\n        }\n\n        const reserve = parseInt(inputValue, 10);\n        if (isNaN(reserve)) {\n          toastr.error('请输入有效的数字', '验证失败');\n          return;\n        }\n\n        if (!Number.isInteger(reserve)) {\n          toastr.error('系统剩余能源必须是整数', '验证失败');\n          return;\n        }\n\n        if (reserve < 0 || reserve > 100000) {\n          toastr.error('系统剩余能源必须在 0-100000 之间', '验证失败');\n          return;\n        }\n\n        const config: GameConfig = { reserve };\n        this.callbacks.onConfirm?.(config);\n      });\n    }\n\n    const cancelButton = this.element.querySelector('#setup-cancel-button');\n    if (cancelButton) {\n      cancelButton.addEventListener('click', () => {\n        this.callbacks.onCancel?.();\n      });\n    }\n  }\n\n  private async updateMvuVariable(value: number): Promise<void> {\n    try {\n      // 确保 MVU 已初始化\n      if (typeof waitGlobalInitialized !== 'undefined') {\n        await waitGlobalInitialized('Mvu');\n      }\n\n      if (typeof Mvu === 'undefined' || !Mvu.getMvuData || !Mvu.replaceMvuData) {\n        console.warn('⚠️ MVU 不可用，跳过实时更新');\n        return;\n      }\n\n      // 获取当前的 MVU 数据\n      // 合并 init(0) / latest message / chat（chat 优先），避免只写 reserve 导致 system_state 结构残缺\n      let initData: any = null;\n      let latestData: any = null;\n      let chatData: any = null;\n      try {\n        initData = Mvu.getMvuData({ type: 'message', message_id: 0 });\n      } catch {\n        // ignore\n      }\n      try {\n        latestData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n      } catch {\n        // ignore\n      }\n      chatData = Mvu.getMvuData({ type: 'chat' });\n\n      const currentMvuData = _.merge({}, initData ?? {}, latestData ?? {}, chatData ?? {});\n      const currentStatData = currentMvuData?.stat_data || {};\n\n      // 构建更新后的 stat_data\n      const updatedStatData = { ...currentStatData };\n\n      if (!updatedStatData.system_state) {\n        updatedStatData.system_state = {};\n      }\n      if (!updatedStatData.system_state.antimatter) {\n        updatedStatData.system_state.antimatter = {};\n      }\n      // 确保 reserve 在 0-100000 范围内\n      updatedStatData.system_state.antimatter.reserve = Math.max(0, Math.min(100000, value));\n\n      // 将更新后的数据写回 MVU\n      const updatedMvuData = {\n        ...currentMvuData,\n        stat_data: updatedStatData,\n      };\n\n      await Mvu.replaceMvuData(updatedMvuData, { type: 'chat' });\n      console.info(`✅ 实时更新 MVU 变量 reserve: ${value}`);\n    } catch (error) {\n      console.warn(`⚠️ 实时更新 MVU 变量 reserve 失败:`, error);\n    }\n  }\n\n  private getConfig(): GameConfig {\n    if (!this.element) {\n      return {};\n    }\n\n    const reserveInput = this.element.querySelector('#energy-reserve') as HTMLInputElement;\n\n    return {\n      reserve: reserveInput?.value ? parseInt(reserveInput.value, 10) : undefined,\n    };\n  }\n\n  private getHTML(): string {\n    return `\n      <div class=\"setup-screen-content\">\n        <div class=\"setup-header\">\n          <h1 class=\"setup-title\">新游戏设置</h1>\n          <p class=\"setup-subtitle\">配置您的游戏</p>\n        </div>\n        <div class=\"setup-form\">\n          <div class=\"setup-form-group\">\n            <label class=\"setup-label\" for=\"energy-reserve\">系统剩余能源</label>\n            <input\n              type=\"number\"\n              id=\"energy-reserve\"\n              class=\"setup-input\"\n              min=\"0\"\n              max=\"100000\"\n              step=\"1\"\n              placeholder=\"输入系统剩余能源\"\n              required\n            />\n            <small style=\"color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;\">\n              范围：0 - 100000（整数）\n            </small>\n          </div>\n        </div>\n        <div class=\"setup-actions\">\n          <button type=\"button\" class=\"setup-button secondary\" id=\"setup-cancel-button\">\n            <i class=\"fas fa-times\"></i>\n            <span>取消</span>\n          </button>\n          <button type=\"button\" class=\"setup-button primary\" id=\"setup-confirm-button\">\n            <i class=\"fas fa-check\"></i>\n            <span>确认</span>\n          </button>\n        </div>\n      </div>\n    `;\n  }\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = showdown;","const __WEBPACK_NAMESPACE_OBJECT__ = YAML;","import { waitUntil } from 'async-wait-until';\nimport showdown from \"showdown\";\nimport _ from 'lodash';\nimport { parse } from 'yaml';\nimport { ComponentCallbacks, GameData, NetItem } from '../types/types';\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function getWorldbook(worldbook_name: string): Promise<WorldbookEntry[]>;\ndeclare function getVariables(option: { type: 'message'; message_id: number | 'latest' }): Record<string, any>;\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): { stop: () => void };\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  CHAT_CHANGED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function waitGlobalInitialized(name: string): Promise<void>;\ndeclare const Mvu: {\n  events: {\n    VARIABLE_UPDATE_ENDED: 'mag_variable_update_ended';\n  };\n  getMvuData: (options: { type: 'message' | 'chat' | 'character' | 'global'; message_id?: number | 'latest' }) => {\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n  };\n};\n\ntype WorldbookEntry = {\n  uid: number;\n  name: string;\n  enabled: boolean;\n  content: string;\n};\n\ninterface NetCategory {\n  id: string; // 对应 <module>, 如 'Manual'\n  label: string; // 对应 <alias>, 如 '消耗体手册'\n  items: NetItem[];\n}\n\n/**\n * 主游戏界面组件（Dashboard）\n */\nexport class Dashboard {\n  private element: HTMLElement | null = null;\n  private callbacks: ComponentCallbacks;\n  private gameData: Partial<GameData> = {};\n  private keyDownHandler: ((e: KeyboardEvent) => void) | null = null;\n  private mvuUpdateListener: { stop: () => void } | null = null;\n  private statusRetryCount = 0;\n  private statusRetryTimer: number | null = null;\n  private markdownConverter: showdown.Converter;\n\n  // 网模块数据\n  private netCategories: NetCategory[] = [];\n  private netReport: string = '';\n  private expandedSections: Set<string> = new Set();\n  private selectedItem: { categoryId: string; index: number } | null = null;\n\n  constructor(callbacks: ComponentCallbacks) {\n    this.callbacks = callbacks;\n    this.markdownConverter = new showdown.Converter({ tables: true, strikethrough: true, tasklists: true, simpleLineBreaks: true, ghCodeBlocks: true, openLinksInNewWindow: true });\n  }\n\n  public createElement(): HTMLElement {\n    try {\n      const div = document.createElement('div');\n      div.className = 'screen main-screen';\n      div.id = 'main-screen';\n      div.innerHTML = this.getHTML();\n      this.element = div;\n\n      // 绑定事件（在设置 innerHTML 之后）\n      this.bindEvents();\n\n      // 创建后立即渲染默认数据\n      this.refreshData();\n\n      console.log('✅ Dashboard 元素已创建');\n      return div;\n    } catch (error) {\n      console.error('❌ 创建 Dashboard 元素失败:', error);\n      // 创建一个基本的 div 作为降级方案\n      const fallbackDiv = document.createElement('div');\n      fallbackDiv.className = 'screen main-screen';\n      fallbackDiv.id = 'main-screen';\n      fallbackDiv.innerHTML = '<div style=\"padding: 2rem; color: var(--text-primary);\">锚加载中...</div>';\n      this.element = fallbackDiv;\n      return fallbackDiv;\n    }\n  }\n\n  public show(): void {\n    if (this.element) {\n      this.element.classList.add('active');\n      // 显示时刷新数据\n      try {\n        this.refreshData();\n        console.log('✅ Dashboard 数据已刷新');\n      } catch (error) {\n        console.error('❌ Dashboard 刷新数据失败:', error);\n        // 即使刷新失败，也继续显示\n      }\n    } else {\n      console.error('❌ Dashboard element 为 null，无法显示');\n    }\n  }\n\n  public hide(): void {\n    if (this.element) {\n      this.element.classList.remove('active');\n    }\n  }\n\n  public destroy(): void {\n    if (this.element) {\n      $(this.element).off();\n      $(this.element).remove();\n      this.element = null;\n    }\n\n    // 移除全局事件监听器\n    if (this.keyDownHandler) {\n      document.removeEventListener('keydown', this.keyDownHandler);\n      this.keyDownHandler = null;\n    }\n\n    if (this.mvuUpdateListener) {\n      this.mvuUpdateListener.stop();\n      this.mvuUpdateListener = null;\n    }\n\n    if (this.statusRetryTimer !== null) {\n      window.clearTimeout(this.statusRetryTimer);\n      this.statusRetryTimer = null;\n    }\n  }\n\n  public updateGameData(data: Partial<GameData>): void {\n    this.gameData = { ...this.gameData, ...data };\n    this.refreshData();\n  }\n\n  private refreshData(): void {\n    if (!this.element) {\n      console.warn('⚠️ Dashboard element 为 null，无法刷新数据');\n      return;\n    }\n\n    try {\n      // 更新状态卡片（异步，从 MVU 变量读取）\n      this.updateStatusCards().catch(error => {\n        console.warn('⚠️ 更新状态卡片失败（非关键错误）:', error);\n      });\n\n      // 更新任务列表\n      this.updateTasksList();\n\n      // 更新网模块内容\n      this.updateNetContent();\n\n      // 读取并显示 maintext（延迟执行，避免在初始化时出错）\n      setTimeout(() => {\n        try {\n          this.loadMaintextFromChat();\n        } catch (error) {\n          console.warn('⚠️ 加载 maintext 失败（非关键错误）:', error);\n        }\n      }, 100);\n\n      // 异步加载世界书中的“网”数据\n      this.loadNetFromWorldbook().catch(err => console.error('❌ 加载网模块数据失败:', err));\n\n      console.info('✅ 游戏数据已刷新');\n    } catch (error) {\n      console.error('❌ 刷新数据时出错:', error);\n      // 即使出错也继续，避免完全无法显示\n    }\n  }\n\n  private async updateStatusCards(): Promise<void> {\n    if (!this.element) return;\n\n    const statusGrid = this.element.querySelector('#status-grid');\n    if (!statusGrid) return;\n\n    try {\n      // 从 MVU 变量系统读取 system_state 数据\n      // 关键：避免“刚进入界面时 MVU 还未把 stat_data 注入 -> 读不到 -> 落到默认值且不再刷新”\n      await waitGlobalInitialized('Mvu');\n      await waitUntil(() => _.has(getVariables({ type: 'message' }), 'stat_data'), {\n        timeout: 3000,\n        intervalBetweenAttempts: 100,\n      }).catch(() => {\n        // timeout 不算致命：下面会展示“加载中…”，并自动重试\n      });\n\n      // 优先从 chat 变量表读取（作为“当前状态”来源）\n      const chatData = Mvu.getMvuData({ type: 'chat' });\n      const chatSystemState = _.get(chatData, 'stat_data.system_state');\n\n      // 兜底来源：latest message + 0 层（initvar），用于补齐缺失字段\n      let latestSystemState: any = null;\n      let initSystemState: any = null;\n      try {\n        const latest = Mvu.getMvuData({ type: 'message', message_id: 'latest' });\n        latestSystemState = _.get(latest, 'stat_data.system_state');\n      } catch (e) {\n        console.warn('⚠️ 读取 latest message 的 system_state 失败:', e);\n      }\n      try {\n        const initMsg = Mvu.getMvuData({ type: 'message', message_id: 0 });\n        initSystemState = _.get(initMsg, 'stat_data.system_state');\n      } catch (e) {\n        // message 0 可能不存在，忽略\n      }\n\n      // 合并：init -> latest -> chat（chat 优先覆盖）\n      const systemState: any = _.merge({}, initSystemState || {}, latestSystemState || {}, chatSystemState || {});\n\n      const hasSystemStateData =\n        systemState &&\n        (systemState.cycle !== undefined ||\n          systemState.system_pressure !== undefined ||\n          systemState.instability !== undefined ||\n          !!systemState.population ||\n          !!systemState.antimatter);\n\n      // 仍然没有：不要用假默认值覆盖；显示“加载中”并重试\n      if (!hasSystemStateData) {\n        statusGrid.innerHTML = '<div class=\"status-empty\">系统状态加载中…</div>';\n\n        if (this.statusRetryCount < 10) {\n          this.statusRetryCount += 1;\n          if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n          this.statusRetryTimer = window.setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 250);\n        }\n        return;\n      }\n\n      // 读到了就清理重试状态\n      this.statusRetryCount = 0;\n      if (this.statusRetryTimer !== null) {\n        window.clearTimeout(this.statusRetryTimer);\n        this.statusRetryTimer = null;\n      }\n\n      // 根据 initvar 中的变量结构渲染状态卡片\n      const cards: string[] = [];\n\n      // Cycle (时间计数单位)\n      if (systemState.cycle !== undefined) {\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-clock status-card-icon\"></i>\n              <span class=\"status-card-title\">时间周期</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${systemState.cycle}</span>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Antimatter (反物质)\n      if (systemState.antimatter) {\n        const reserve = systemState.antimatter.reserve ?? 0;\n        const leakRisk = systemState.antimatter.leak_risk ?? 0;\n        const reservePercent = Math.round((reserve / 100000) * 100);\n        const riskLevel = leakRisk < 0.3 ? 'low' : leakRisk < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-atom status-card-icon\"></i>\n              <span class=\"status-card-title\">反物质储备</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${reserve.toLocaleString()}</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill\" style=\"width: ${reservePercent}%\"></div>\n                </div>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  泄漏风险: <span class=\"risk-${riskLevel}\">${(leakRisk * 100).toFixed(1)}%</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Population (人口)\n      if (systemState.population) {\n        const pop = systemState.population;\n        const active = pop.active ?? 0;\n        const standby = pop.standby ?? 0;\n        const archived = pop.archived ?? 0;\n        const total = active + standby + archived;\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-users status-card-icon\"></i>\n              <span class=\"status-card-title\">人口统计</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${total}</span>\n                <div class=\"status-detail\" style=\"font-size: 0.65rem; margin-top: 0.3rem; color: var(--text-tertiary);\">\n                  启用: ${active} | 待机: ${standby} | 归档: ${archived}\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // System Pressure (系统压力)\n      if (systemState.system_pressure !== undefined) {\n        const pressure = systemState.system_pressure ?? 0;\n        const pressurePercent = Math.round(pressure * 100);\n        const pressureLevel = pressure < 0.5 ? 'low' : pressure < 0.8 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-tachometer-alt status-card-icon\"></i>\n              <span class=\"status-card-title\">系统压力</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${pressurePercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${pressureLevel}\" style=\"width: ${pressurePercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      // Instability (系统不稳定性)\n      if (systemState.instability !== undefined) {\n        const instability = systemState.instability ?? 0;\n        const instabilityPercent = Math.round(instability * 100);\n        const instabilityLevel = instability < 0.3 ? 'low' : instability < 0.7 ? 'medium' : 'high';\n\n        cards.push(`\n          <div class=\"status-card\">\n            <div class=\"status-card-header\">\n              <i class=\"fas fa-exclamation-triangle status-card-icon\"></i>\n              <span class=\"status-card-title\">系统不稳定性</span>\n            </div>\n            <div class=\"status-card-content\">\n              <div class=\"status-value\">\n                <span class=\"value-number\">${instabilityPercent}%</span>\n                <div class=\"status-bar\">\n                  <div class=\"status-bar-fill status-${instabilityLevel}\" style=\"width: ${instabilityPercent}%\"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n        `);\n      }\n\n      if (cards.length > 0) {\n        statusGrid.innerHTML = cards.join('');\n      } else {\n        statusGrid.innerHTML = '<div class=\"status-empty\">暂无系统状态数据</div>';\n      }\n    } catch (error) {\n      console.error('❌ 更新状态卡片失败:', error);\n      statusGrid.innerHTML = '<div class=\"status-empty\">加载系统状态失败</div>';\n    }\n  }\n\n  private updateTasksList(): void {\n    if (!this.element) return;\n\n    const tasksList = this.element.querySelector('#tasks-list');\n    if (!tasksList) return;\n\n    // 如果gameData.tasks存在且是数组，使用它；否则使用默认任务\n    const tasks =\n      this.gameData.tasks && Array.isArray(this.gameData.tasks) && this.gameData.tasks.length > 0\n        ? this.gameData.tasks\n        : this.getDefaultTasks();\n\n    tasksList.innerHTML = tasks\n      .map(\n        task => `\n      <div class=\"entry-item\">\n        <div class=\"entry-icon\">\n          <i class=\"fas ${this.getTaskIcon(task.status)}\"></i>\n        </div>\n        <div class=\"entry-content\">\n          <div class=\"entry-header\">\n            <span class=\"entry-title\">${this.escapeHtml(task.title)}</span>\n            <span class=\"entry-status ${task.status}\">${this.getStatusText(task.status)}</span>\n          </div>\n          <div class=\"entry-meta\">\n            <span class=\"entry-time\">${task.time}</span>\n            <span class=\"entry-priority priority-${task.priority}\">${this.getPriorityText(task.priority)}</span>\n          </div>\n          <div class=\"entry-description\">${this.escapeHtml(task.description)}</div>\n        </div>\n      </div>\n    `,\n      )\n      .join('');\n  }\n\n  private updateNetContent(): void {\n    if (!this.element) return;\n\n    const netContainer = this.element.querySelector('#module-net .net-body');\n    if (!netContainer) return;\n\n    // 渲染侧边栏动态分类\n    const sidebarHtml = this.netCategories.map(cat => this.renderSidebarSection(cat.id, cat.label, cat.items)).join('');\n\n    // 渲染侧边栏报告模块\n    const reportSidebarHtml = this.renderSidebarSection('report', '消耗体报告', [{ title: '当前报告' }]);\n\n    // 重新生成 HTML\n    netContainer.innerHTML = `\n      <div class=\"net-explorer\">\n        <div class=\"net-sidebar\">\n          ${sidebarHtml}\n          ${reportSidebarHtml}\n        </div>\n        <div class=\"net-viewer\" id=\"net-viewer\">\n          ${this.renderNetViewer()}\n        </div>\n      </div>\n    `;\n\n    // 绑定事件\n    this.bindNetSidebarEvents();\n\n    // 如果选中的是报告，绑定编辑框事件\n    if (this.selectedItem?.categoryId === 'report') {\n      const editor = this.element.querySelector('#net-report-editor') as HTMLTextAreaElement;\n      if (editor) {\n        $(editor).on(\n          'input',\n          _.debounce((e: any) => {\n            this.netReport = e.target.value;\n            this.saveReportToVariables(this.netReport);\n          }, 1000),\n        );\n      }\n    }\n  }\n\n  private renderSidebarSection(id: string, label: string, items: any[]): string {\n    const isExpanded = this.expandedSections.has(id);\n    const icon = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';\n\n    let itemsHtml = '';\n    if (isExpanded) {\n      itemsHtml = `\n        <div class=\"net-sidebar-items\">\n          ${items\n            .map((item, index) => {\n              const isSelected = this.selectedItem?.categoryId === id && this.selectedItem?.index === index;\n              return `\n              <div class=\"net-sidebar-item ${isSelected ? 'active' : ''}\" data-net-section=\"${id}\" data-net-index=\"${index}\">\n                <i class=\"far fa-file-alt\"></i>\n                <span class=\"net-sidebar-item-title\">${this.escapeHtml(item.title)}</span>\n              </div>\n            `;\n            })\n            .join('')}\n        </div>\n      `;\n    }\n\n    return `\n      <div class=\"net-sidebar-section\" data-section-id=\"${id}\">\n        <div class=\"net-sidebar-header\">\n          <i class=\"fas ${icon}\"></i>\n          <span>${label}</span>\n        </div>\n        ${itemsHtml}\n      </div>\n    `;\n  }\n\n  private renderMarkdown(text: string): string {\n    return this.markdownConverter.makeHtml(text);\n  }\n\n  private renderNetViewer(): string {\n    if (!this.selectedItem) {\n      return '<div class=\"net-viewer-empty\">选择一个条目以查看内容</div>';\n    }\n\n    const { categoryId, index } = this.selectedItem;\n\n    if (categoryId === 'report') {\n      return `\n        <div class=\"net-report-container\">\n          <div class=\"net-viewer-header\">\n            <span class=\"net-viewer-title\">消耗体报告</span>\n          </div>\n          <textarea id=\"net-report-editor\" class=\"net-report-editor\" placeholder=\"在此记录你的报告...\">${this.netReport || ''}</textarea>\n        </div>\n      `;\n    }\n\n    const category = this.netCategories.find(c => c.id === categoryId);\n    const item = category?.items[index];\n\n    if (!item) {\n      return '<div class=\"net-viewer-empty\">条目不存在</div>';\n    }\n\n    return `\n      <div class=\"net-item-viewer\">\n        <div class=\"net-viewer-header\">\n          <h2 class=\"net-viewer-title\">${this.escapeHtml(item.title)}</h2>\n          <div class=\"net-viewer-meta\">作者: ${this.escapeHtml(item.author)}</div>\n        </div>\n        <div class=\"net-viewer-content\">${this.renderMarkdown(item.content)}</div>\n      </div>\n    `;\n  }\n\n  private bindNetSidebarEvents(): void {\n    if (!this.element) return;\n\n    // 展开/折叠\n    $(this.element).off('click', '.net-sidebar-header');\n    $(this.element).on('click', '.net-sidebar-header', e => {\n      const sectionId = $(e.currentTarget).closest('.net-sidebar-section').attr('data-section-id');\n      if (sectionId) {\n        if (this.expandedSections.has(sectionId)) {\n          this.expandedSections.delete(sectionId);\n        } else {\n          this.expandedSections.add(sectionId);\n        }\n        this.updateNetContent();\n      }\n    });\n\n    // 选择条目\n    $(this.element).off('click', '.net-sidebar-item');\n    $(this.element).on('click', '.net-sidebar-item', e => {\n      const categoryId = $(e.currentTarget).attr('data-net-section') as string;\n      const index = parseInt($(e.currentTarget).attr('data-net-index') || '0', 10);\n      this.selectedItem = { categoryId, index };\n      this.updateNetContent();\n    });\n  }\n\n  private async loadNetFromWorldbook(): Promise<void> {\n    const WORLDBOOK_NAME = 'anchor';\n    // 匹配格式: net-<module>-<alias>\n    const NET_ENTRY_REGEX = /^net-([^-]+)-(.+)$/;\n\n    try {\n      const worldbook = await getWorldbook(WORLDBOOK_NAME);\n      const newCategories: NetCategory[] = [];\n\n      worldbook.forEach(entry => {\n        const match = entry.name.match(NET_ENTRY_REGEX);\n        if (match && entry.content) {\n          const moduleId = match[1];\n          const alias = match[2];\n\n          try {\n            const items = parse(entry.content) || [];\n            newCategories.push({\n              id: moduleId,\n              label: alias,\n              items: Array.isArray(items) ? items : [items], // 确保是数组\n            });\n\n            // 默认展开并选择第一个加载到的分类的第一个条目（如果尚未选择）\n            if (newCategories.length === 1 && !this.selectedItem) {\n              this.expandedSections.add(moduleId);\n              this.selectedItem = { categoryId: moduleId, index: 0 };\n            }\n          } catch (e) {\n            console.error(`❌ 解析网模块条目 [${entry.name}] YAML 失败:`, e);\n          }\n        }\n      });\n\n      this.netCategories = newCategories;\n\n      // 加载报告（从变量读取）\n      try {\n        const gameVariables = getVariables({ type: 'message', message_id: 'latest' });\n        this.netReport = gameVariables.stat_data?.player_report || '';\n      } catch (e) {\n        console.warn('⚠️ 读取报告变量失败:', e);\n      }\n\n      this.updateNetContent();\n    } catch (error) {\n      console.error('❌ 加载“网”模块动态数据失败:', error);\n    }\n  }\n\n  private async saveReportToVariables(content: string): Promise<void> {\n    try {\n      // 动态导入 variableUpdater\n      const { updateStatDataVariable } = await import('../utils/variableUpdater');\n      await updateStatDataVariable('player_report', content);\n      console.info('✅ 报告已保存到变量');\n    } catch (error) {\n      console.error('❌ 保存报告到变量失败:', error);\n    }\n  }\n\n  private updateChatMessages(): void {\n    // 注意：通讯模块的消息现在由 dashboardLogic.ts 中的 initChatInterface 管理\n    // 这里不再更新，避免冲突\n    // 通讯模块会从 getChatMessages 读取历史消息\n  }\n\n  private getDefaultTasks() {\n    return [\n      {\n        id: '1',\n        title: '维护能源系统',\n        status: 'completed' as const,\n        priority: 'high' as const,\n        time: '01-15 14:30',\n        description: '检查并维护空间站能源系统，确保所有设备正常运行',\n      },\n    ];\n  }\n\n  private getDefaultMessages() {\n    return [\n      { id: '1', role: 'user' as const, content: '你好，我想了解一下空间站的当前状态。', time: '14:32' },\n      {\n        id: '2',\n        role: 'assistant' as const,\n        content:\n          '您好！空间站当前运行状态良好。能源系统：87%，生命维持系统：92%，系统完整性：78%。所有关键指标均在安全范围内。需要我详细说明某个系统的状态吗？',\n        time: '14:32',\n      },\n      { id: '3', role: 'user' as const, content: '能源系统的详细情况如何？', time: '14:33' },\n      {\n        id: '4',\n        role: 'assistant' as const,\n        content:\n          '能源系统当前运行在87%的容量水平。主要能源来源包括太阳能电池板和备用核能发电机。最近一次检查显示所有组件运行正常，预计可以维持当前负载至少30天。建议在下周进行例行维护检查。',\n        time: '14:33',\n      },\n    ];\n  }\n\n  private getTaskIcon(status: string): string {\n    switch (status) {\n      case 'completed':\n        return 'fa-check-circle';\n      case 'in-progress':\n        return 'fa-clock';\n      case 'pending':\n        return 'fa-exclamation-circle';\n      default:\n        return 'fa-circle';\n    }\n  }\n\n  private getStatusText(status: string): string {\n    switch (status) {\n      case 'completed':\n        return '完成';\n      case 'in-progress':\n        return '进行中';\n      case 'pending':\n        return '待处理';\n      default:\n        return status;\n    }\n  }\n\n  private getPriorityText(priority: string): string {\n    switch (priority) {\n      case 'urgent':\n        return '紧急';\n      case 'high':\n        return '高';\n      case 'medium':\n        return '中';\n      case 'low':\n        return '低';\n      default:\n        return priority;\n    }\n  }\n\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * 解析 maintext 的工具函数（兼容旧格式）\n   */\n  private parseMaintext(messageContent: string): string {\n    const maintextMatch = messageContent.match(/<maintext>([\\s\\S]*?)<\\/maintext>/i);\n    if (!maintextMatch) {\n      return '';\n    }\n    return maintextMatch[1].trim();\n  }\n\n  /**\n   * 从外部传入的文本更新 maintext 显示\n   */\n  public updateMaintextDisplay(messageContent: string): void {\n    if (!this.element) return;\n\n    // 动态导入 textParser\n    import('../utils/textParser')\n      .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n        const el = this.element;\n        if (!el) return;\n\n        // 1. 尝试提取结构化标签\n        const continueChoice = extractContinueChoice(messageContent);\n        const result = extractResult(messageContent);\n        const nextChoice = extractNextChoice(messageContent);\n\n        // 2. 获取三个文本框元素\n        const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n        const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n        const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n        if (continueChoice || result || nextChoice) {\n          // 使用结构化标签\n          if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n          if (resultArea) resultArea.textContent = result || '';\n          if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n        } else {\n          // 回退到旧格式：将 maintext 内容显示在 next_choice 区域\n          const maintext = this.parseMaintext(messageContent);\n          if (nextChoiceArea) {\n            nextChoiceArea.textContent = maintext || '';\n          }\n          // 清空其他两个区域\n          if (continueChoiceArea) continueChoiceArea.textContent = '';\n          if (resultArea) resultArea.textContent = '';\n        }\n\n        console.info(`✅ 已从传入文本刷新 maintext`);\n      })\n      .catch(error => {\n        console.error('❌ 刷新 maintext 失败:', error);\n      });\n  }\n\n  /**\n   * 从最新楼层读取 maintext 并显示在三个文本框中\n   * 优先使用结构化标签（continue_choice, result, decision_node），如果没有则回退到旧格式\n   */\n  public loadMaintextFromChat(): void {\n    if (!this.element) return;\n\n    try {\n      // 检查 getChatMessages 是否可用\n      if (typeof getChatMessages === 'undefined') {\n        console.warn('⚠️ getChatMessages 不可用');\n        return;\n      }\n\n      // 1. 先尝试获取最新的 assistant 消息\n      let messages: Array<{ message: string; message_id: number; role: string }> = [];\n      try {\n        messages = getChatMessages(-1, { role: 'assistant' });\n      } catch (error) {\n        console.warn('⚠️ 获取 assistant 消息失败:', error);\n      }\n\n      let lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n\n      // 2. 如果没有 assistant 消息，获取最新消息（不限制 role）\n      if (!lastMessage) {\n        try {\n          messages = getChatMessages(-1);\n          lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n        } catch (error) {\n          console.warn('⚠️ 获取最新消息失败:', error);\n        }\n      }\n\n      if (!lastMessage) {\n        return;\n      }\n\n      // 4. 解析消息内容\n      const messageContent = lastMessage.message || '';\n\n      // 动态导入 textParser\n      import('../utils/textParser')\n        .then(({ extractContinueChoice, extractResult, extractNextChoice }) => {\n          const el = this.element;\n          if (!el) return;\n\n          // 5. 尝试提取结构化标签\n          const continueChoice = extractContinueChoice(messageContent);\n          const result = extractResult(messageContent);\n          const nextChoice = extractNextChoice(messageContent);\n\n          // 6. 获取三个文本框元素\n          const continueChoiceArea = el.querySelector('#maintext-continue-choice') as HTMLElement;\n          const resultArea = el.querySelector('#maintext-result') as HTMLElement;\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n\n          if (continueChoice || result || nextChoice) {\n            // 使用结构化标签\n            if (continueChoiceArea) continueChoiceArea.textContent = continueChoice || '';\n            if (resultArea) resultArea.textContent = result || '';\n            if (nextChoiceArea) nextChoiceArea.textContent = nextChoice || '';\n          } else {\n            // 回退到旧格式：将 maintext 内容显示在 next_choice 区域\n            const maintext = this.parseMaintext(messageContent);\n            if (nextChoiceArea && maintext) {\n              nextChoiceArea.textContent = maintext;\n            }\n            // 清空其他两个区域\n            if (continueChoiceArea) continueChoiceArea.textContent = '';\n            if (resultArea) resultArea.textContent = '';\n          }\n\n          console.info(`✅ 已加载 maintext (message_id: ${lastMessage.message_id})`);\n        })\n        .catch(error => {\n          console.error('❌ 导入 textParser 失败:', error);\n          const el = this.element;\n          if (!el) return;\n          // 降级处理：使用旧格式\n          const maintext = this.parseMaintext(messageContent);\n          const nextChoiceArea = el.querySelector('#maintext-next-choice') as HTMLElement;\n          if (nextChoiceArea && maintext) {\n            nextChoiceArea.textContent = maintext;\n          }\n        });\n    } catch (error) {\n      console.error('❌ 加载聊天消息失败:', error);\n    }\n  }\n\n  /**\n   * 监听消息变化事件，自动更新显示\n   */\n  private setupMessageListener(): void {\n    try {\n      if (typeof eventOn === 'undefined' || typeof tavern_events === 'undefined') {\n        console.warn('⚠️ 事件监听 API 不可用');\n        return;\n      }\n\n      const handleMessageReceived = () => {\n        // 延迟一点确保消息已写入\n        setTimeout(() => {\n          try {\n            this.loadMaintextFromChat();\n            // 兜底：消息变化时也刷新状态栏（防止 MVU 事件在某些链路不触发）\n            this.updateStatusCards().catch(() => {});\n          } catch (error) {\n            console.error('❌ 处理消息接收事件失败:', error);\n          }\n        }, 150);\n      };\n\n      // 监听 MESSAGE_RECEIVED 和 CHAT_CHANGED 事件\n      if (tavern_events.MESSAGE_RECEIVED) {\n        eventOn(tavern_events.MESSAGE_RECEIVED, handleMessageReceived);\n      }\n      if (tavern_events.CHAT_CHANGED) {\n        eventOn(tavern_events.CHAT_CHANGED, handleMessageReceived);\n      }\n      if (tavern_events.MESSAGE_UPDATED) {\n        eventOn(tavern_events.MESSAGE_UPDATED, handleMessageReceived);\n      }\n\n      // 监听自定义事件 refresh-maintext（用于在对话完成后手动触发更新）\n      if (this.element) {\n        this.element.addEventListener('refresh-maintext', (e: any) => {\n          // 如果事件携带了最新的消息内容，直接使用它更新，避免从 chat 重新加载的延迟和不确定性\n          const latestMessage = e.detail?.message;\n          if (latestMessage) {\n            this.updateMaintextDisplay(latestMessage);\n          } else {\n            // 否则回退到从聊天记录加载\n            setTimeout(() => {\n              this.loadMaintextFromChat();\n            }, 100);\n          }\n        });\n        this.element.addEventListener('refresh-status', () => {\n          setTimeout(() => {\n            this.updateStatusCards().catch(() => {});\n          }, 50);\n        });\n      }\n\n      console.info('✅ 已设置消息监听器');\n    } catch (error) {\n      console.error('❌ 设置消息监听器失败:', error);\n    }\n  }\n\n  private bindEvents(): void {\n    if (!this.element) {\n      console.warn('⚠️ Dashboard element 为 null，无法绑定事件');\n      return;\n    }\n\n    try {\n      // 全屏按钮\n      const fullscreenButton = this.element.querySelector('#dashboard-fullscreen-button');\n      if (fullscreenButton) {\n        fullscreenButton.addEventListener('click', () => {\n          this.toggleFullscreen();\n        });\n      } else {\n        console.warn('⚠️ 未找到全屏按钮元素');\n      }\n\n      // Enter 键全屏支持\n      this.setupEnterKeyFullscreen();\n\n      // 导航切换事件将在 app.ts 中处理\n\n      // 设置消息监听器（需要检查 API 是否可用，延迟执行避免初始化时出错）\n      setTimeout(() => {\n        try {\n          if (typeof eventOn !== 'undefined' && typeof tavern_events !== 'undefined') {\n            this.setupMessageListener();\n          } else {\n            console.warn('⚠️ 事件监听 API 不可用，跳过消息监听器设置');\n          }\n        } catch (error) {\n          console.warn('⚠️ 设置消息监听器失败（非关键错误）:', error);\n        }\n      }, 200);\n\n      // 监听 MVU 变量更新结束 -> 刷新状态卡片\n      setTimeout(async () => {\n        try {\n          await waitGlobalInitialized('Mvu');\n          if (this.mvuUpdateListener) return;\n          if (typeof Mvu === 'undefined' || !Mvu.events?.VARIABLE_UPDATE_ENDED) return;\n\n          this.mvuUpdateListener = eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, () => {\n            if (this.statusRetryTimer !== null) window.clearTimeout(this.statusRetryTimer);\n            this.statusRetryTimer = window.setTimeout(() => {\n              this.updateStatusCards().catch(() => {});\n            }, 50);\n          });\n        } catch (e) {\n          console.warn('⚠️ MVU 事件监听安装失败:', e);\n        }\n      }, 250);\n    } catch (error) {\n      console.error('❌ bindEvents 失败:', error);\n      // 即使绑定失败，也继续，避免完全无法使用\n    }\n  }\n\n  private getHTML(): string {\n    return `\n      <!-- 顶部导航栏 -->\n      <header class=\"main-header\">\n        <div class=\"header-content\">\n          <div class=\"logo-section\">\n            <i class=\"fas fa-anchor logo-icon\"></i>\n            <h1 class=\"logo-text\">锚</h1>\n          </div>\n          <!-- 模块切换导航 -->\n          <nav class=\"top-nav-menu\">\n            <button type=\"button\" class=\"nav-item active\" data-module=\"status\" id=\"nav-status\" title=\"舰体状态 (1)\">\n              <span class=\"nav-shortcut\">1</span>\n              <i class=\"fas fa-chart-line nav-icon\"></i>\n              <span class=\"nav-text\">舰体状态</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"tasks\" id=\"nav-tasks\" title=\"任务模块 (2)\">\n              <span class=\"nav-shortcut\">2</span>\n              <i class=\"fas fa-tasks nav-icon\"></i>\n              <span class=\"nav-text\">任务模块</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"net\" id=\"nav-net\" title=\"网 (3)\">\n              <span class=\"nav-shortcut\">3</span>\n              <i class=\"fas fa-network-wired nav-icon\"></i>\n              <span class=\"nav-text\">网</span>\n            </button>\n            <button type=\"button\" class=\"nav-item\" data-module=\"communication\" id=\"nav-communication\" title=\"通讯模块 (4)\">\n              <span class=\"nav-shortcut\">4</span>\n              <i class=\"fas fa-comments nav-icon\"></i>\n              <span class=\"nav-text\">通讯模块</span>\n            </button>\n          </nav>\n          <div class=\"header-actions\">\n            <button type=\"button\" class=\"fullscreen-button\" id=\"dashboard-fullscreen-button\" title=\"全屏 (Enter)\">\n              <i class=\"fas fa-expand\"></i>\n            </button>\n            <div class=\"header-status\">\n              <div class=\"status-indicator online\">\n                <span class=\"status-dot\"></span>\n                <span class=\"status-text\">系统在线</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <!-- 主内容区域 -->\n      <main class=\"main-content\">\n        <!-- 内容面板 -->\n        <section class=\"content-panel\">\n          <!-- 空间站状态模块（默认显示） -->\n          <div class=\"module-container active\" id=\"module-status\">\n            <div class=\"module-body\">\n              <!-- 主文本框区域 -->\n              <div class=\"maintext-container\">\n                <div class=\"maintext-header\">\n                  <h3 class=\"maintext-title\">\n                    <i class=\"fas fa-scroll\"></i>\n                    当前剧情\n                  </h3>\n                </div>\n                <div class=\"maintext-areas\">\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-history\" title=\"事件延续\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-continue-choice\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-microchip\" title=\"系统记录\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-result\"></div>\n                  </div>\n                  <div class=\"maintext-section\">\n                    <div class=\"maintext-section-header\">\n                      <span class=\"maintext-section-title\"><i class=\"fas fa-bolt\" title=\"新的事件\"></i></span>\n                    </div>\n                    <div class=\"maintext-section-area\" id=\"maintext-next-choice\"></div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"status-grid\" id=\"status-grid\"></div>\n            </div>\n          </div>\n\n          <!-- 任务模块 -->\n          <div class=\"module-container\" id=\"module-tasks\">\n            <div class=\"module-body\">\n              <div class=\"entry-list\" id=\"tasks-list\"></div>\n            </div>\n          </div>\n\n          <!-- 网模块 -->\n          <div class=\"module-container\" id=\"module-net\">\n            <div class=\"module-body net-body\">\n              <!-- 内容由 updateNetContent 填充 -->\n            </div>\n          </div>\n\n          <!-- 通讯模块 -->\n          <div class=\"module-container\" id=\"module-communication\">\n            <div class=\"module-body communication-body\">\n              <div class=\"chat-messages\" id=\"chat-messages\"></div>\n              <div class=\"chat-input-container\">\n                <div class=\"chat-input-wrapper\">\n                  <button type=\"button\" id=\"chat-show-options-btn\" class=\"chat-show-options-btn\" title=\"显示选项\">\n                    <i class=\"fas fa-list\"></i>\n                  </button>\n                  <button\n                    type=\"button\"\n                    id=\"chat-regenerate-btn\"\n                    class=\"chat-regenerate-btn\"\n                    title=\"重新生成当前轮（会删除本轮 user/assistant 消息）\"\n                  >\n                    <i class=\"fas fa-rotate-right\"></i>\n                  </button>\n                  <textarea id=\"chat-input\" class=\"chat-input\" placeholder=\"输入消息...\" rows=\"1\"></textarea>\n                  <button type=\"button\" id=\"chat-send-btn\" class=\"chat-send-btn\">\n                    <i class=\"fas fa-paper-plane\"></i>\n                  </button>\n                </div>\n              </div>\n              <!-- Option 选项浮层容器 -->\n              <div class=\"chat-options-overlay\" id=\"chat-options-overlay\">\n                <div class=\"chat-options-container\" id=\"chat-options-container\">\n                  <div class=\"chat-options-header\">\n                    <span class=\"chat-options-title\">可用选项</span>\n                    <button type=\"button\" class=\"chat-options-close\" id=\"chat-options-close\" title=\"关闭\">\n                      <i class=\"fas fa-times\"></i>\n                    </button>\n                  </div>\n                </div>\n                <div class=\"chat-options-list\" id=\"chat-options-list\"></div>\n              </div>\n            </div>\n          </div>\n        </section>\n      </main>\n\n      <!-- 模态框容器 -->\n      <div class=\"modal-overlay\" id=\"modal-overlay\">\n        <div class=\"modal-container\" id=\"modal-container\">\n          <div class=\"modal-header\">\n            <h3 class=\"modal-title\" id=\"modal-title\">标题</h3>\n            <button class=\"modal-close\" id=\"modal-close\">\n              <i class=\"fas fa-times\"></i>\n            </button>\n          </div>\n          <div class=\"modal-body\" id=\"modal-body\"></div>\n        </div>\n      </div>\n\n    `;\n  }\n\n  private setupEnterKeyFullscreen(): void {\n    try {\n      // 移除旧的事件监听器（如果存在）\n      if (this.keyDownHandler) {\n        document.removeEventListener('keydown', this.keyDownHandler);\n        this.keyDownHandler = null;\n      }\n\n      // 创建新的事件监听器\n      this.keyDownHandler = (e: KeyboardEvent) => {\n        try {\n          // 只在 Dashboard 显示时响应\n          if (!this.element?.classList.contains('active')) {\n            return;\n          }\n\n          // 如果输入框聚焦，不处理 Enter 键和 Esc 键\n          const activeElement = document.activeElement;\n          if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {\n            return;\n          }\n\n          // Enter 键触发全屏\n          if (e.key === 'Enter') {\n            e.preventDefault();\n            this.toggleFullscreen();\n          }\n        } catch (error) {\n          console.error('❌ 键盘事件处理失败:', error);\n        }\n      };\n\n      document.addEventListener('keydown', this.keyDownHandler);\n      console.log('✅ Enter 键全屏支持已设置');\n    } catch (error) {\n      console.error('❌ 设置键盘事件支持失败:', error);\n    }\n  }\n\n  private requestFullscreen(): void {\n    try {\n      const element = document.documentElement;\n      if (element.requestFullscreen) {\n        element.requestFullscreen().catch(err => {\n          console.warn('全屏请求失败:', err);\n        });\n      } else if ((element as any).webkitRequestFullscreen) {\n        (element as any).webkitRequestFullscreen();\n      } else if ((element as any).mozRequestFullScreen) {\n        (element as any).mozRequestFullScreen();\n      } else if ((element as any).msRequestFullscreen) {\n        (element as any).msRequestFullscreen();\n      }\n    } catch (error) {\n      console.error('❌ 请求全屏失败:', error);\n    }\n  }\n\n  private exitFullscreen(): void {\n    try {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    } catch (error) {\n      console.error('❌ 退出全屏失败:', error);\n    }\n  }\n\n  private toggleFullscreen(): void {\n    try {\n      if (!document.fullscreenElement) {\n        this.requestFullscreen();\n      } else {\n        this.exitFullscreen();\n      }\n    } catch (error) {\n      console.error('❌ 切换全屏失败:', error);\n    }\n  }\n}\n","import { PageState } from '../types/types';\nimport { SplashScreen } from '../components/SplashScreen';\nimport { NewGameSetup } from '../components/NewGameSetup';\nimport { Dashboard } from '../components/Dashboard';\nimport { ComponentCallbacks } from '../types/types';\nimport { initializeNewGame, continueGame } from './gameInitializer';\nimport { hasSaveData } from './variableReader';\n\n/**\n * 页面流程管理器\n */\nexport class PageManager {\n  private currentPage: PageState = 'splash';\n  private splashScreen: SplashScreen;\n  private setupScreen: NewGameSetup;\n  private dashboard: Dashboard;\n  private appContainer: HTMLElement;\n\n  constructor(appContainer: HTMLElement) {\n    this.appContainer = appContainer;\n\n    const callbacks: ComponentCallbacks = {\n      onStart: () => this.goToSplash(),\n      onNewGame: () => this.goToSetup(),\n      onContinue: () => this.goToGame(),\n      onConfirm: (config) => this.handleConfirm(config),\n      onCancel: () => this.goToSplash(),\n      onFullscreenToggle: () => this.toggleFullscreen(),\n    };\n\n    this.splashScreen = new SplashScreen(callbacks);\n    this.setupScreen = new NewGameSetup(callbacks);\n    this.dashboard = new Dashboard(callbacks);\n  }\n\n  public initialize(): void {\n    // 创建所有组件\n    this.appContainer.appendChild(this.splashScreen.createElement());\n    this.appContainer.appendChild(this.setupScreen.createElement());\n    this.appContainer.appendChild(this.dashboard.createElement());\n\n    // 检查是否有存档，如果有则直接进入游戏，否则显示开始屏幕\n    const hasSave = hasSaveData();\n    if (hasSave) {\n      // 有存档，直接进入游戏\n      this.goToGame();\n    } else {\n      // 没有存档，显示开始屏幕\n      this.showPage('splash');\n    }\n  }\n\n  private showPage(page: PageState): void {\n    console.log(`🔄 开始切换页面: ${page}`);\n\n    // 隐藏所有页面\n    try {\n      this.splashScreen.hide();\n      this.setupScreen.hide();\n      this.dashboard.hide();\n    } catch (error) {\n      console.warn('⚠️ 隐藏页面时出错:', error);\n    }\n\n    // 显示目标页面\n    try {\n      switch (page) {\n        case 'splash':\n          this.splashScreen.show();\n          // 进入标题页面时请求全屏\n          this.requestFullscreen();\n          break;\n        case 'setup':\n          this.setupScreen.show();\n          break;\n        case 'game':\n          this.dashboard.show();\n          // 确保 Dashboard 已正确显示\n          setTimeout(() => {\n            const dashboardElement = document.getElementById('main-screen');\n            if (dashboardElement && dashboardElement.classList.contains('active')) {\n              console.log('✅ Dashboard 已正确显示');\n            } else {\n              console.error('❌ Dashboard 显示异常，element:', dashboardElement);\n            }\n          }, 100);\n          break;\n      }\n    } catch (error) {\n      console.error(`❌ 显示页面 ${page} 失败:`, error);\n      throw error;\n    }\n\n    this.currentPage = page;\n    console.info(`✅ 成功切换到页面: ${page}`);\n  }\n\n  private goToSplash(): void {\n    this.showPage('splash');\n  }\n\n  private goToSetup(): void {\n    this.showPage('setup');\n  }\n\n  private async goToGame(): Promise<void> {\n    try {\n      console.log('🔄 开始加载游戏...');\n      const gameData = await continueGame();\n      console.log('✅ 游戏数据加载完成:', gameData);\n\n      // 更新游戏数据\n      this.dashboard.updateGameData(gameData);\n\n      // 显示游戏页面\n      this.showPage('game');\n\n      console.log('✅ 已切换到游戏页面');\n    } catch (error) {\n      console.error('❌ 加载游戏失败:', error);\n      console.error('❌ 错误详情:', {\n        error: error,\n        errorMessage: error instanceof Error ? error.message : String(error),\n        errorStack: error instanceof Error ? error.stack : undefined,\n      });\n\n      // 即使加载失败，也尝试显示游戏页面（使用空数据）\n      try {\n        this.dashboard.updateGameData({});\n        this.showPage('game');\n        console.warn('⚠️ 使用空数据继续显示游戏页面');\n      } catch (fallbackError) {\n        console.error('❌ 显示游戏页面也失败:', fallbackError);\n        toastr.error('加载游戏失败', '错误');\n      }\n    }\n  }\n\n  private async handleConfirm(config: any): Promise<void> {\n    try {\n      // initializeNewGame 内部已经会调用 createOpeningStoryMessage\n      const gameData = await initializeNewGame(config);\n      this.dashboard.updateGameData(gameData);\n      this.showPage('game');\n      toastr.success('游戏已初始化', '成功');\n    } catch (error) {\n      console.error('初始化游戏失败:', error);\n      toastr.error('初始化游戏失败', '错误');\n    }\n  }\n\n  private requestFullscreen(): void {\n    const element = document.documentElement;\n    if (element.requestFullscreen) {\n      element.requestFullscreen().catch((err) => {\n        console.warn('全屏请求失败:', err);\n      });\n    } else if ((element as any).webkitRequestFullscreen) {\n      (element as any).webkitRequestFullscreen();\n    } else if ((element as any).mozRequestFullScreen) {\n      (element as any).mozRequestFullScreen();\n    } else if ((element as any).msRequestFullscreen) {\n      (element as any).msRequestFullscreen();\n    }\n  }\n\n  private toggleFullscreen(): void {\n    if (!document.fullscreenElement) {\n      this.requestFullscreen();\n    } else {\n      if (document.exitFullscreen) {\n        document.exitFullscreen();\n      } else if ((document as any).webkitExitFullscreen) {\n        (document as any).webkitExitFullscreen();\n      } else if ((document as any).mozCancelFullScreen) {\n        (document as any).mozCancelFullScreen();\n      } else if ((document as any).msExitFullscreen) {\n        (document as any).msExitFullscreen();\n      }\n    }\n  }\n\n  public getDashboard(): Dashboard {\n    return this.dashboard;\n  }\n}\n","import { GameConfig, GameData } from '../types/types';\nimport { initializeGameData } from './variableUpdater';\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function getVariables(options: { type: 'message' | 'chat' | 'character' | 'global' }): Record<string, any>;\n\n/**\n * 初始化新游戏\n * 不再创建开场白，开场白由用户自定义（第一条assistant消息）\n */\nexport async function initializeNewGame(config: GameConfig): Promise<GameData> {\n  console.info('初始化新游戏...', config);\n\n  const gameData = await initializeGameData(config);\n\n  console.info('新游戏初始化完成（开场白由用户自定义）');\n  return gameData;\n}\n\n/**\n * 继续游戏\n */\nexport async function continueGame(): Promise<Partial<GameData>> {\n  console.info('继续游戏...');\n\n  const variables = getVariables({ type: 'message' });\n  const gameData = variables.game_data || variables.stat_data || {};\n\n  console.info('游戏数据已加载');\n  return gameData as Partial<GameData>;\n}\n","// 锚 - Dashboard 逻辑\n// 包含导航、模态框、动画、状态卡片交互、聊天界面等功能\n\n// 全局函数声明（由酒馆助手提供）\ndeclare function getChatMessages(\n  range: string | number,\n  options?: { role?: 'all' | 'system' | 'assistant' | 'user' },\n): Array<{ message: string; message_id: number; role: string; data?: Record<string, any> }>;\n\ndeclare function deleteChatMessages(message_ids: number[], options?: { refresh?: 'none' | 'all' }): Promise<void>;\n\ndeclare function getLastMessageId(): number;\n\ndeclare function eventOn(event: string, callback: (...args: any[]) => void): void;\n\ndeclare const tavern_events: {\n  MESSAGE_RECEIVED?: string;\n  MESSAGE_UPDATED?: string;\n};\n\ndeclare const errorCatched: (fn: () => void) => () => void;\n\n// ========== 导航功能 ==========\nexport function initNavigation() {\n  const navItems = document.querySelectorAll('.nav-item');\n  const modules = document.querySelectorAll('.module-container');\n\n  // 切换模块的函数\n  function switchModule(moduleId: string) {\n    if (!moduleId) return;\n\n    // 移除所有 active 类\n    navItems.forEach(nav => nav.classList.remove('active'));\n    modules.forEach(module => module.classList.remove('active'));\n\n    // 添加 active 类\n    const targetNavItem = document.querySelector(`.nav-item[data-module=\"${moduleId}\"]`);\n    const targetModule = document.getElementById(`module-${moduleId}`);\n\n    if (targetNavItem) {\n      targetNavItem.classList.add('active');\n    }\n    if (targetModule) {\n      targetModule.classList.add('active');\n    }\n  }\n\n  // 点击切换\n  navItems.forEach(item => {\n    item.addEventListener('click', () => {\n      const moduleId = item.getAttribute('data-module');\n      if (moduleId) {\n        switchModule(moduleId);\n      }\n    });\n  });\n\n  // 键盘快捷键切换（1, 2, 3, 4）\n  const moduleMap: Record<string, string> = {\n    '1': 'status',\n    '2': 'tasks',\n    '3': 'net',\n    '4': 'communication',\n  };\n\n  document.addEventListener('keydown', e => {\n    // 只在主游戏界面激活时响应，且不在输入框中\n    const mainScreen = document.getElementById('main-screen');\n    if (!mainScreen || !mainScreen.classList.contains('active')) {\n      return;\n    }\n\n    // 如果焦点在输入框或其他可输入元素上，不响应\n    const activeElement = document.activeElement;\n    if (\n      activeElement &&\n      (activeElement.tagName === 'INPUT' ||\n        activeElement.tagName === 'TEXTAREA' ||\n        (activeElement instanceof HTMLElement && activeElement.isContentEditable))\n    ) {\n      return;\n    }\n\n    // 检查是否按下数字键 1-4\n    if (e.key >= '1' && e.key <= '4') {\n      const moduleId = moduleMap[e.key];\n      if (moduleId) {\n        e.preventDefault();\n        switchModule(moduleId);\n        console.log(`⌨️ 快捷键切换模块: ${moduleId} (${e.key})`);\n      }\n    }\n  });\n}\n\n// ========== 模态框功能 ==========\nexport function initModals() {\n  const modalOverlay = document.getElementById('modal-overlay');\n  const modalClose = document.getElementById('modal-close');\n\n  if (!modalOverlay || !modalClose) return;\n\n  modalClose.addEventListener('click', () => {\n    modalOverlay.classList.remove('active');\n  });\n\n  modalOverlay.addEventListener('click', e => {\n    if (e.target === modalOverlay) {\n      modalOverlay.classList.remove('active');\n    }\n  });\n}\n\n// ========== 动画功能 ==========\nexport function initAnimations() {\n  // 基础动画已通过 CSS 实现\n  // 这里可以添加 JS 动画逻辑（如果需要）\n}\n\n// ========== 状态卡片交互 ==========\nexport function initStatusCardInteractions() {\n  const statusCards = document.querySelectorAll('.status-card');\n  statusCards.forEach(card => {\n    card.addEventListener('click', () => {\n      // 状态卡片点击交互（如果需要）\n      console.log('状态卡片被点击');\n    });\n  });\n}\n\n// ========== 聊天界面功能 ==========\n\n/**\n * 一轮对话的数据结构\n */\ninterface ConversationRound {\n  assistantMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  userMessage: {\n    message_id: number;\n    message: string;\n  } | null;\n  summary?: string; // 存储 <sum> 内容\n  pending?: boolean; // 标记为待处理的轮次（用户已发送，AI未回复）\n  pendingUserMessage?: string; // 待处理的用户消息内容\n}\n\n/**\n * 初始化对话界面（支持左右滑动和流式渲染）\n */\nexport function initChatInterface() {\n  const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;\n  const chatSendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;\n  const chatRegenerateBtn = document.getElementById('chat-regenerate-btn') as HTMLButtonElement;\n  const chatMessages = document.getElementById('chat-messages') as HTMLElement;\n\n  if (!chatInput || !chatSendBtn || !chatMessages) {\n    return;\n  }\n\n  // 对话轮次数组\n  let rounds: ConversationRound[] = [];\n  let currentRoundIndex = -1; // 当前显示的轮次索引\n\n  // 正在生成/转正的轮次索引（与 currentRoundIndex 解耦：用户可能在生成过程中浏览历史轮次）\n  let activePendingRoundIndex: number | null = null;\n\n  function findLastPendingRoundIndex(): number | null {\n    for (let i = rounds.length - 1; i >= 0; i--) {\n      const r = rounds[i];\n      if (r && r.pending) return i;\n    }\n    return null;\n  }\n\n  function getPendingRoundIndexSafe(): number | null {\n    if (\n      activePendingRoundIndex !== null &&\n      activePendingRoundIndex >= 0 &&\n      activePendingRoundIndex < rounds.length &&\n      rounds[activePendingRoundIndex]?.pending\n    ) {\n      return activePendingRoundIndex;\n    }\n    return findLastPendingRoundIndex();\n  }\n\n  // 当前流式输出元素（用于实时渲染）\n  let streamingElement: HTMLElement | null = null;\n\n  // 保存最后一次流式文本（raw，包含标签）\n  let lastStreamedRawMessage: string = '';\n\n  // 是否正在生成消息\n  let isGenerating = false;\n\n  // 是否正在发送消息（防止重复发送）\n  let isSending = false;\n\n  // 保存最新提取的选项（从 messageGenerator 传递，避免从消息中提取）\n  let latestOptions: string[] = [];\n\n  // 记录最近一次生成创建的真实 message_id（用于把 rounds 的临时 id 覆盖为真实 id）\n  let lastCreatedIds: { userMessageId: number; assistantMessageId: number } | null = null;\n\n  // 确保 generateMessage 已加载\n  let generateMessagePromise: Promise<any> | null = null;\n\n  // 确保 regenerateAssistantMessage 已加载\n  let regenerateAssistantMessagePromise: Promise<any> | null = null;\n\n  function ensureRegenerateAssistantLoaded(): Promise<any> {\n    if (!regenerateAssistantMessagePromise) {\n      regenerateAssistantMessagePromise = import('./utils/messageGenerator').then(\n        module => module.regenerateAssistantMessage,\n      );\n    }\n    return regenerateAssistantMessagePromise;\n  }\n\n  // 预加载消息生成服务\n  function ensureMessageGeneratorLoaded(): Promise<any> {\n    if (!generateMessagePromise) {\n      generateMessagePromise = import('./utils/messageGenerator').then(module => module.generateMessage);\n    }\n    return generateMessagePromise;\n  }\n\n  // 自动调整输入框高度\n  function adjustInputHeight() {\n    chatInput.style.height = 'auto';\n    const maxHeight = 80;\n    const newHeight = Math.min(chatInput.scrollHeight, maxHeight);\n    chatInput.style.height = `${newHeight}px`;\n  }\n\n  chatInput.addEventListener('input', adjustInputHeight);\n\n  // HTML转义\n  function escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // 将消息分组为轮次\n  // 规则（修正版，符合真实时间线）：\n  // 1. 第一条 assistant 消息（开场白）作为孤立消息，只有 assistantMessage，没有 userMessage\n  // 2. 每一条 user 消息都会开启一轮\n  // 3. 紧随其后的 assistant 消息补全该轮\n  function groupMessagesIntoRounds(\n    allMessages: Array<{\n      message: string;\n      message_id: number;\n      role: string;\n    }>,\n  ): ConversationRound[] {\n    const rounds: ConversationRound[] = [];\n\n    // 当前正在等待 assistant 补全的轮次\n    let pendingRound: ConversationRound | null = null;\n\n    // 按消息真实出现顺序遍历（时间线）\n    allMessages.forEach(msg => {\n      // 处理 user 消息：永远开启新一轮\n      if (msg.role === 'user') {\n        const round: ConversationRound = {\n          userMessage: {\n            message_id: msg.message_id,\n            message: msg.message,\n          },\n          assistantMessage: null,\n        };\n\n        rounds.push(round);\n        pendingRound = round;\n        return;\n      }\n\n      // 处理 assistant 消息\n      if (msg.role === 'assistant') {\n        // 尝试提取 sum\n        let sum = '';\n        const sumMatch = msg.message.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        // 如果存在等待补全的轮次，则补全它\n        if (pendingRound && !pendingRound.assistantMessage) {\n          pendingRound.assistantMessage = {\n            message_id: msg.message_id,\n            message: msg.message,\n          };\n          if (sum) pendingRound.summary = sum;\n          pendingRound = null;\n        } else {\n          // 否则视为开场白 / 孤立 assistant 消息\n          rounds.push({\n            userMessage: null,\n            assistantMessage: {\n              message_id: msg.message_id,\n              message: msg.message,\n            },\n            summary: sum || undefined,\n          });\n        }\n      }\n    });\n\n    return rounds;\n  }\n\n  // 显示指定轮次的对话\n  async function displayRound(roundIndex: number) {\n    // 如果正在生成，不清除流式元素\n    if (!isGenerating) {\n      chatMessages.innerHTML = '';\n      streamingElement = null;\n    } else {\n      // 正在生成时，只清除非流式的消息（保留流式元素）\n      const existingMessages = Array.from(chatMessages.children).filter(child => child !== streamingElement);\n      existingMessages.forEach(msg => msg.remove());\n    }\n\n    // 如果索引超出范围，显示空轮次（用于显示用户消息等待AI回复）\n    if (roundIndex < 0 || roundIndex >= rounds.length) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const round = rounds[roundIndex];\n\n    // 先显示 user 消息（如果有）- 确保在上方\n    if (round.userMessage) {\n      renderUserMessage(round.userMessage.message);\n    } else if (round.pendingUserMessage) {\n      // 显示待处理的用户消息\n      renderUserMessage(round.pendingUserMessage);\n    }\n\n    // 再显示 assistant 消息（如果有）- 确保在下方\n    if (round.assistantMessage) {\n      await renderAssistantMessage(\n        round.assistantMessage.message,\n        round.assistantMessage.message,\n        round.summary, // 传入总结\n      );\n    } else if (round.pending && isGenerating) {\n      // 如果是待处理的轮次且正在生成，确保流式元素在用户消息下方\n      if (!streamingElement) {\n        showGenerating();\n      }\n      // 如果流式元素已存在但不在正确位置，移动到用户消息下方\n      if (streamingElement && streamingElement.parentNode === chatMessages) {\n        // 确保流式元素在最后（用户消息之后）\n        chatMessages.appendChild(streamingElement);\n      }\n    }\n\n    updateRegenerateButtonState();\n  }\n\n  function updateRegenerateButtonState() {\n    if (!chatRegenerateBtn) return;\n\n    if (isGenerating || isSending) {\n      chatRegenerateBtn.disabled = true;\n      return;\n    }\n\n    const round = rounds[currentRoundIndex];\n    const hasUserMessage = !!round && !!round.userMessage && typeof round.userMessage.message_id === 'number';\n    const isNotPending = !!round && !round.pending;\n\n    // 只要有用户消息且不在生成状态，就允许重新生成（即使 assistantMessage 为空）\n    chatRegenerateBtn.disabled = !(hasUserMessage && isNotPending);\n  }\n\n  // 渲染 assistant 消息（只解析存在的标签）\n  async function renderAssistantMessage(content: string, rawMessage: string, summaryText?: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-assistant';\n\n    try {\n      const { extractContinueChoice, extractResult, extractNextChoice, removeSumTags } =\n        await import('./utils/textParser');\n\n      // 从 rawMessage 中提取 maintext，然后从 maintext 中提取三栏标签\n      const { extractLastMaintext } = await import('./utils/textParser');\n      const maintext = extractLastMaintext(rawMessage);\n\n      // 如果 maintext 存在，从 maintext 中提取；否则从整个消息中提取\n      const searchText = maintext || rawMessage;\n\n      const continueChoice = extractContinueChoice(searchText);\n      const result = extractResult(searchText);\n      const nextChoice = extractNextChoice(searchText);\n\n      // 构建三栏内容，只显示存在的标签\n      const columns: Array<{ header: string; content: string; key: string; icon: string }> = [];\n\n      if (continueChoice) {\n        columns.push({\n          header: '事件延续',\n          content: continueChoice,\n          key: 'continue',\n          icon: '<i class=\"fas fa-history\" title=\"事件延续\"></i>',\n        });\n      }\n      if (result) {\n        columns.push({\n          header: '后果总结',\n          content: result,\n          key: 'result',\n          icon: '<i class=\"fas fa-microchip\" title=\"后果总结\"></i>',\n        });\n      }\n      if (nextChoice) {\n        columns.push({\n          header: '新剧情',\n          content: nextChoice,\n          key: 'next',\n          icon: '<i class=\"fas fa-bolt\" title=\"新剧情\"></i>',\n        });\n      }\n\n      if (columns.length > 0) {\n        // 显示三栏（可能只有1-3栏）\n        const columnsHtml = columns\n          .map(\n            col => `\n          <div class=\"message-column\">\n            <div class=\"message-column-header\">${col.icon}</div>\n            <div class=\"message-column-content\">${escapeHtml(col.content)}</div>\n          </div>\n        `,\n          )\n          .join('');\n\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\">\n              ${columnsHtml}\n            </div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      } else {\n        // 没有结构化标签，显示单栏（移除 <sum> 标签）\n        const displayContent = removeSumTags(content);\n        messageItem.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n            <div class=\"message-time\"></div>\n          </div>\n        `;\n      }\n\n      // 如果有总结，渲染总结卡片到同一个 messageItem 中\n      if (summaryText) {\n        const summaryCard = await createSummaryCardElement(summaryText);\n        if (summaryCard) {\n          messageItem.appendChild(summaryCard);\n        }\n      }\n    } catch (error) {\n      console.error('❌ 解析结构化标签失败，使用单栏显示:', error);\n      const { removeSumTags } = await import('./utils/textParser');\n      const displayContent = removeSumTags(content);\n      messageItem.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n          <div class=\"message-time\"></div>\n        </div>\n      `;\n    }\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // 渲染 user 消息\n  function renderUserMessage(content: string) {\n    const messageItem = document.createElement('div');\n    messageItem.className = 'message-item message-user';\n\n    // 用户消息显示单栏\n    messageItem.innerHTML = `\n      <div class=\"message-bubble\">\n        <div class=\"message-content\">${escapeHtml(content)}</div>\n        <div class=\"message-time\"></div>\n      </div>\n    `;\n\n    chatMessages.appendChild(messageItem);\n  }\n\n  // 创建 summary 卡片元素\n  async function createSummaryCardElement(sumText: string): Promise<HTMLElement | null> {\n    if (!sumText) return null;\n\n    try {\n      const { parseSummary } = await import('./utils/textParser');\n      const sumObj = parseSummary(sumText);\n\n      if (Object.keys(sumObj).length === 0) return null;\n\n      const summaryCard = document.createElement('div');\n      summaryCard.className = 'summary-card';\n\n      // 预定义的标签和图标\n      const labelIcons: Record<string, string> = {\n        时间: 'fa-clock',\n        Time: 'fa-clock',\n        地点: 'fa-location-dot',\n        Location: 'fa-location-dot',\n        人物: 'fa-users',\n        Characters: 'fa-users',\n        事件: 'fa-star',\n        Event: 'fa-star',\n      };\n\n      let innerHTML = '<div class=\"summary-content\">';\n      for (const [key, value] of Object.entries(sumObj)) {\n        const icon = labelIcons[key] || 'fa-info-circle';\n        innerHTML += `\n          <div class=\"summary-item\">\n            <span class=\"summary-label\"><i class=\"fas ${icon}\"></i> ${escapeHtml(key)}</span>\n            <span class=\"summary-value\">${escapeHtml(value)}</span>\n          </div>\n        `;\n      }\n      innerHTML += '</div>';\n\n      summaryCard.innerHTML = innerHTML;\n      return summaryCard;\n    } catch (error) {\n      console.error('❌ 创建 summary 卡片失败:', error);\n      return null;\n    }\n  }\n\n  // 加载对话历史并分组\n  async function loadChatHistory() {\n    try {\n      const lastMessageId = getLastMessageId();\n\n      const allMessages = lastMessageId >= 0 ? getChatMessages(`0-${lastMessageId}`) : [];\n      const newRounds = groupMessagesIntoRounds(allMessages);\n\n      rounds = newRounds;\n\n      // 显示最后一轮\n      if (rounds.length > 0) {\n        currentRoundIndex = rounds.length - 1;\n        if (!isGenerating) {\n          await displayRound(currentRoundIndex);\n        }\n      }\n\n      console.log('✅ 已加载聊天历史，共', rounds.length, '轮对话，当前显示第', currentRoundIndex + 1, '轮');\n    } catch (error) {\n      console.error('加载聊天历史失败:', error);\n    }\n  }\n\n  // 刷新显示（当模块被激活时调用）\n  async function refreshDisplay() {\n    await loadChatHistory();\n  }\n\n  // 监听键盘事件（左箭头和右箭头）\n  function setupKeyboardNavigation() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const keyHandler = (e: KeyboardEvent) => {\n      // 只在通讯模块激活且不在输入框中时响应\n      if (!communicationModule.classList.contains('active')) return;\n      if (document.activeElement === chatInput) return;\n\n      if (e.key === 'ArrowLeft') {\n        e.preventDefault();\n        goToPreviousRound();\n      } else if (e.key === 'ArrowRight') {\n        e.preventDefault();\n        goToNextRound();\n      } else if (e.key === 'o' || e.key === 'O') {\n        // O 键打开选项界面\n        e.preventDefault();\n        const showOptionsBtn = document.getElementById('chat-show-options-btn') as HTMLButtonElement;\n        if (showOptionsBtn) {\n          showOptionsBtn.click();\n        }\n      }\n    };\n\n    document.addEventListener('keydown', keyHandler);\n  }\n\n  // 发送消息\n  async function sendMessage() {\n    // 防止重复发送\n    if (isSending) {\n      console.warn('⚠️ 正在发送消息，请勿重复点击');\n      return;\n    }\n\n    const message = chatInput.value.trim();\n    if (!message) {\n      return;\n    }\n\n    // 设置发送标志\n    isSending = true;\n\n    chatInput.value = '';\n    adjustInputHeight();\n\n    // 禁用发送按钮和输入框\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n\n    // 设置生成标志（在创建用户消息之前）\n    isGenerating = true;\n    updateRegenerateButtonState();\n\n    // 注意：不在 sendMessage 中直接渲染用户消息\n    // 用户消息会在 generateMessage 创建后，通过 loadChatHistory 重新加载时显示\n\n    try {\n      const generateMessage = await ensureMessageGeneratorLoaded();\n      console.log('🚀 开始生成消息，用户输入:', message);\n\n      const success = await generateMessage(message, {\n        onShowGenerating: () => {\n          // 显示生成提示（如果还没有流式元素）\n          if (!streamingElement) {\n            showGenerating();\n          }\n        },\n        onHideGenerating: () => {\n          // 生成结束时不要把流式 DOM 删掉，否则用户会看到“先消失再出现”的闪屏。\n          // 最终的“转正”为正式消息在 onRefreshStory -> finalizeStreamingAsAssistant 中完成。\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('❌ 生成消息失败:', error);\n          hideGenerating();\n          isGenerating = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          isSending = false;\n\n          // 即使失败，也将当前轮次从 pending 转为正式（这样重新生成按钮就会亮起）\n          const idx = getPendingRoundIndexSafe();\n          const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n          if (r && r.pending) {\n            r.pending = false;\n            if (lastCreatedIds) {\n              r.userMessage = {\n                message_id: lastCreatedIds.userMessageId,\n                message: r.pendingUserMessage || '',\n              };\n            }\n            delete r.pendingUserMessage;\n          }\n          updateRegenerateButtonState(); // 刷新按钮状态\n        },\n        onStreamingUpdate: (text: string) => {\n          // 传递完整的文本（包含标签），用于检测标签开始/结束\n          updateStreamingMessage(text);\n\n          // 实时向 Dashboard 推送最新文本，实现同步更新\n          const dashboardElement = document.getElementById('main-screen');\n          dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext', { detail: { message: text } }));\n        },\n        onRefreshStoryIfOpen: (userMessage: string) => {\n          // user 消息创建后，立即创建一个pending轮次并显示\n          console.log('📝 user 消息已创建，立即显示:', userMessage);\n\n          // 设置生成标志\n          isGenerating = true;\n\n          // 创建一个pending轮次\n          const pendingRound: ConversationRound = {\n            assistantMessage: null,\n            userMessage: null,\n            pending: true,\n            pendingUserMessage: userMessage,\n          };\n\n          // 将pending轮次添加到rounds数组\n          rounds.push(pendingRound);\n          currentRoundIndex = rounds.length - 1;\n          activePendingRoundIndex = currentRoundIndex;\n\n          // 立即显示这个轮次\n          displayRound(currentRoundIndex);\n        },\n        onRefreshStory: async (options?: string[]) => {\n          // assistant 消息创建后，转为最终消息\n          console.log('📝 assistant 消息已创建，转为最终消息');\n\n          if (options && options.length > 0) {\n            latestOptions = options;\n          } else {\n            latestOptions = [];\n          }\n\n          // ✅ 核心：直接 finalize，不重载历史\n          // 将最后的流式 raw 文本传入 finalize（如果为空也传 ''，以保证 finalize 能处理）\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // 用真实 message_id 覆盖临时 id（确保后续可精准删除/重新生成）\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.userMessage) r.userMessage.message_id = lastCreatedIds.userMessageId;\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          // 🔕 不要再调用 loadChatHistory()\n\n          // 其他模块更新可以保留\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(\n                new CustomEvent('refresh-maintext', { detail: { message: lastStreamedRawMessage } }),\n              );\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          lastCreatedIds = ids;\n        },\n      });\n\n      if (success) {\n        console.log('✅ 消息生成成功');\n        // 注意：不要在这里启用按钮，按钮应该在 onRefreshStory 中启用\n        // 因为此时 AI 可能还在流式输出\n      }\n    } catch (error) {\n      console.error('❌ 发送消息异常:', error);\n      hideGenerating();\n      isGenerating = false;\n      // 发生错误时，立即启用按钮和输入框\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      isSending = false;\n      updateRegenerateButtonState();\n    }\n    // 注意：移除了 finally 块，因为按钮应该在 onRefreshStory 中启用\n    // 这样可以确保在 AI 完全生成完成后才启用按钮\n  }\n\n  // 重新生成当前轮：只删除 assistant 消息，然后触发 generate 再创建新的 assistant 消息\n  async function regenerateCurrentRound() {\n    if (!chatRegenerateBtn) return;\n    if (isGenerating || isSending) return;\n\n    const round = rounds[currentRoundIndex];\n    if (!round?.userMessage) {\n      updateRegenerateButtonState();\n      return;\n    }\n\n    const userMessageId = round.userMessage.message_id;\n    const assistantMessageId = round.assistantMessage?.message_id;\n\n    if (typeof userMessageId !== 'number' || !Number.isFinite(userMessageId)) return;\n\n    // UI 锁定\n    isSending = true;\n    isGenerating = true;\n    lastStreamedRawMessage = '';\n    chatSendBtn.disabled = true;\n    chatInput.disabled = true;\n    chatRegenerateBtn.disabled = true;\n\n    // 当前轮进入 pending：保留 userMessage，仅清空 assistantMessage\n    round.assistantMessage = null;\n    round.pending = true;\n    activePendingRoundIndex = currentRoundIndex;\n    await displayRound(currentRoundIndex);\n\n    try {\n      if (typeof assistantMessageId === 'number' && Number.isFinite(assistantMessageId)) {\n        await deleteChatMessages([assistantMessageId], { refresh: 'none' });\n        console.log('🗑️ 已删除当前轮 assistant 消息，准备重新生成:', assistantMessageId);\n\n        // 立即触发一次主文本刷新，清空“当前剧情”显示\n        const dashboardElement = document.getElementById('main-screen');\n        dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext'));\n      } else {\n        console.log('ℹ️ 当前轮无 assistant 消息，直接开始生成');\n      }\n\n      const regenerateAssistantMessage = await ensureRegenerateAssistantLoaded();\n\n      await regenerateAssistantMessage(userMessageId, {\n        onShowGenerating: () => {\n          if (!streamingElement) showGenerating();\n        },\n        onHideGenerating: () => {\n          if (streamingElement) {\n            const timeEl = streamingElement.querySelector('.message-time') as HTMLElement | null;\n            if (timeEl) timeEl.textContent = '';\n          }\n        },\n        onError: (error: string) => {\n          console.error('❌ 重新生成失败:', error);\n          hideGenerating();\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          round.pending = false;\n          updateRegenerateButtonState();\n          // 兜底：重新加载历史（确保与酒馆真实历史一致）\n          loadChatHistory();\n        },\n        onStreamingUpdate: (text: string) => {\n          updateStreamingMessage(text);\n\n          // 实时向 Dashboard 推送最新文本，实现同步更新\n          const dashboardElement = document.getElementById('main-screen');\n          dashboardElement?.dispatchEvent(new CustomEvent('refresh-maintext', { detail: { message: text } }));\n        },\n        onRefreshStory: async (options?: string[]) => {\n          console.log('📝 assistant 消息已重新生成，转为最终消息');\n\n          latestOptions = options && options.length > 0 ? options : [];\n\n          await finalizeStreamingAsAssistant(lastStreamedRawMessage || '');\n\n          // 重新生成只会创建新的 assistant 消息，回调里会给出新的 assistantMessageId\n          if (lastCreatedIds) {\n            const idx = getPendingRoundIndexSafe();\n            const r = typeof idx === 'number' ? rounds[idx] : rounds[currentRoundIndex];\n            if (r?.assistantMessage) r.assistantMessage.message_id = lastCreatedIds.assistantMessageId;\n          }\n\n          // 清除 pending\n          round.pending = false;\n\n          isGenerating = false;\n          isSending = false;\n          chatSendBtn.disabled = false;\n          chatInput.disabled = false;\n          updateRegenerateButtonState();\n\n          setTimeout(() => {\n            try {\n              const dashboardElement = document.getElementById('main-screen');\n              dashboardElement?.dispatchEvent(\n                new CustomEvent('refresh-maintext', { detail: { message: lastStreamedRawMessage } }),\n              );\n              dashboardElement?.dispatchEvent(new CustomEvent('refresh-status'));\n            } catch (err) {\n              console.debug('refresh-maintext dispatch failed:', err);\n            }\n          }, 200);\n        },\n        onCreatedMessages: (ids: { userMessageId: number; assistantMessageId: number }) => {\n          // regenerate 只创建 assistant，但我们保持同一个 userMessageId\n          lastCreatedIds = ids;\n        },\n      });\n    } catch (e) {\n      console.error('❌ 重新生成异常:', e);\n      hideGenerating();\n      round.pending = false;\n      isGenerating = false;\n      isSending = false;\n      chatSendBtn.disabled = false;\n      chatInput.disabled = false;\n      updateRegenerateButtonState();\n      loadChatHistory();\n    }\n  }\n\n  // 显示生成提示\n  function showGenerating() {\n    if (!streamingElement) {\n      streamingElement = document.createElement('div');\n      streamingElement.className = 'message-item message-assistant message-streaming';\n      streamingElement.innerHTML = `\n        <div class=\"message-bubble\">\n          <div class=\"message-content message-content-three-columns\"></div>\n        </div>\n      `;\n      chatMessages.appendChild(streamingElement);\n    }\n  }\n\n  // 隐藏生成提示\n  function hideGenerating() {\n    if (streamingElement) {\n      streamingElement.remove();\n      streamingElement = null;\n    }\n  }\n\n  // 提交流式为正式消息（避免全量重渲染）\n  async function finalizeStreamingAsAssistant(finalText: string) {\n    // 即使 streamingElement 不存在，也应该把 rounds 补全（防止 race）\n    // 先把流式 DOM 更新为最终内容（如果存在）\n    if (streamingElement) {\n      try {\n        // 如果有三栏容器，就用现有解析函数把 finalText 填进去\n        let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) {\n          // 如果没有三栏容器，尝试创建一个容器以便 updateColumnsFromStream 使用\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content message-content-three-columns\"></div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n          columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        }\n\n        // 使用已有的解析逻辑把 finalText 渲染到栏目里（保证最终视图完整）\n        await updateColumnsFromStream(finalText, columnsContainer);\n      } catch (err) {\n        // 解析失败时回退为单栏文本（移除 <sum> 标签）\n        console.error('❌ finalize 更新流式 DOM 失败，回退为单栏:', err);\n        const { removeSumTags } = await import('./utils/textParser');\n        const displayContent = removeSumTags(finalText);\n        if (streamingElement) {\n          streamingElement.innerHTML = `\n            <div class=\"message-bubble\">\n              <div class=\"message-content\">${escapeHtml(displayContent)}</div>\n              <div class=\"message-time\"></div>\n            </div>\n          `;\n        }\n      }\n\n      // 移除流式样式（变为正式消息）\n      streamingElement.classList.remove('message-streaming');\n      const timeEl = streamingElement.querySelector('.message-time');\n      if (timeEl) timeEl.textContent = '';\n    }\n\n    // 关键：立即把 rounds 补全为正式消息，使用 finalText（不依赖后端）\n    // 注意：用户可能在生成过程中浏览历史轮次，因此不能依赖 currentRoundIndex\n    const pendingIdx = getPendingRoundIndexSafe();\n    if (typeof pendingIdx === 'number' && pendingIdx >= 0 && pendingIdx < rounds.length) {\n      const targetRound = rounds[pendingIdx];\n      if (targetRound && targetRound.pending) {\n        // 尝试提取 sum\n        let sum = '';\n        const sumMatch = finalText.match(/<sum>([\\s\\S]*?)<\\/sum>/i);\n        if (sumMatch) {\n          sum = sumMatch[1].trim();\n        }\n\n        // 如果 pending，则直接用 finalText 填充 assistantMessage\n        targetRound.assistantMessage = {\n          // 临时 id，后面可以异步用真实 id 覆盖\n          message_id: Date.now(),\n          message: finalText || (streamingElement ? streamingElement.textContent || '' : ''),\n        };\n\n        if (sum) targetRound.summary = sum;\n\n        // 如果有 pendingUserMessage -> 将其转为 userMessage（临时 id）\n        if (targetRound.pendingUserMessage) {\n          targetRound.userMessage = {\n            message_id: Date.now() - 1,\n            message: targetRound.pendingUserMessage,\n          };\n        }\n\n        targetRound.pending = false;\n        delete targetRound.pendingUserMessage;\n\n        // 如果有 sum，立即在流式元素中添加 summary 卡片\n        if (sum && streamingElement) {\n          const summaryCard = await createSummaryCardElement(sum);\n          if (summaryCard) {\n            streamingElement.appendChild(summaryCard);\n          }\n        }\n      }\n    } else {\n      console.warn('⚠️ finalize: 未找到 pending 轮次，可能是状态竞争或已被刷新重建');\n    }\n\n    // ✅ 不要在生成结束后再 displayRound() 全量重建 DOM\n    // 这会导致 chatMessages 清空/重建，肉眼表现为“刷新闪一下”，并且容易引入位置/滚动等新问题。\n    // 这里仅把流式元素“转正”为最终消息，并更新 rounds 数据即可。\n    streamingElement = null;\n    activePendingRoundIndex = null;\n  }\n\n  // 更新流式消息（实时渲染，检测标签开始/结束）\n  async function updateStreamingMessage(text: string) {\n    // 保存最新流式文本，供 finalize 使用（避免依赖后端立即持久化）\n    lastStreamedRawMessage = text;\n\n    if (!streamingElement) {\n      // 如果还没有流式元素，创建一个\n      showGenerating();\n    }\n\n    if (!streamingElement) return;\n\n    try {\n      // 获取或创建栏目容器\n      let columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n      if (!columnsContainer) {\n        streamingElement.innerHTML = `\n          <div class=\"message-bubble\">\n            <div class=\"message-content message-content-three-columns\"></div>\n            <div class=\"message-time\">生成中</div>\n          </div>\n        `;\n        columnsContainer = streamingElement.querySelector('.message-content-three-columns') as HTMLElement;\n        if (!columnsContainer) return;\n      }\n\n      await updateColumnsFromStream(text, columnsContainer);\n    } catch (error) {\n      console.error('❌ 更新流式消息失败:', error);\n    }\n  }\n\n  // 从流式文本更新栏目（检测标签开始/结束，动态创建栏目）\n  async function updateColumnsFromStream(text: string, container: HTMLElement) {\n    // 定义栏目配置\n    const columnConfigs = [\n      {\n        tag: 'continue_choice',\n        header: '<i class=\"fas fa-history\" title=\"事件延续\"></i>',\n        key: 'continue',\n      },\n      {\n        tag: 'result',\n        header: '<i class=\"fas fa-microchip\" title=\"后果总结\"></i>',\n        key: 'result',\n      },\n      {\n        tag: 'decision_node',\n        header: '<i class=\"fas fa-bolt\" title=\"新剧情\"></i>',\n        key: 'next',\n      },\n    ];\n\n    // 检测每个标签的开始和结束，提取内容\n    for (const config of columnConfigs) {\n      const startTag = `<${config.tag}>`;\n      const endTag = `</${config.tag}>`;\n\n      // 获取或创建栏目元素（先检查是否已存在）\n      let columnElement = container.querySelector(`[data-column-key=\"${config.key}\"]`) as HTMLElement;\n\n      // 检查该栏目是否已经闭合（如果已存在且已闭合，不再更新）\n      if (columnElement) {\n        const isClosed = columnElement.hasAttribute('data-closed');\n        if (isClosed) {\n          // 栏目已闭合，不再更新\n          continue;\n        }\n      }\n\n      // 检测是否已经开始（有开始标签）\n      const startIndex = text.indexOf(startTag);\n      if (startIndex === -1) {\n        // 还没有开始标签，跳过这个栏目\n        continue;\n      }\n\n      // 提取开始标签之后的内容\n      const contentStart = startIndex + startTag.length;\n      const endIndex = text.indexOf(endTag, contentStart);\n\n      let content = '';\n\n      if (endIndex !== -1) {\n        // 有结束标签，提取完整内容，并标记为已闭合\n        content = text.substring(contentStart, endIndex);\n\n        // 如果栏目元素不存在，创建它\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n\n        // 标记为已闭合，之后不再更新\n        columnElement.setAttribute('data-closed', 'true');\n      } else {\n        // 还没有结束标签，提取到目前为止的内容\n        content = text.substring(contentStart);\n\n        // 如果栏目元素不存在，创建它\n        if (!columnElement) {\n          columnElement = document.createElement('div');\n          columnElement.className = 'message-column';\n          columnElement.setAttribute('data-column-key', config.key);\n          const headerElement = document.createElement('div');\n          headerElement.className = 'message-column-header';\n          headerElement.innerHTML = config.header;\n          const contentElement = document.createElement('div');\n          contentElement.className = 'message-column-content';\n          columnElement.appendChild(headerElement);\n          columnElement.appendChild(contentElement);\n          container.appendChild(columnElement);\n        }\n      }\n\n      // 更新栏目内容（只更新文本内容，不替换整个 HTML，保持滚动位置）\n      const contentElement = columnElement.querySelector('.message-column-content') as HTMLElement;\n      if (contentElement) {\n        // 保存滚动状态\n        const oldScrollTop = contentElement.scrollTop;\n        const oldScrollHeight = contentElement.scrollHeight;\n        const wasAtBottom = oldScrollTop + contentElement.clientHeight >= oldScrollHeight - 10;\n\n        // 更新内容\n        contentElement.textContent = content;\n\n        // 恢复滚动位置\n        if (wasAtBottom) {\n          // 如果之前在底部，滚动到底部\n          contentElement.scrollTop = contentElement.scrollHeight;\n        } else {\n          // 否则保持相对位置（尽量保持原有位置）\n          const newScrollHeight = contentElement.scrollHeight;\n          if (newScrollHeight > oldScrollHeight) {\n            // 内容增加了，保持相对位置\n            contentElement.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);\n          } else {\n            // 内容减少了或不变，保持原位置\n            contentElement.scrollTop = oldScrollTop;\n          }\n        }\n      }\n    }\n  }\n\n  // 上一轮\n  function goToPreviousRound() {\n    if (currentRoundIndex > 0) {\n      currentRoundIndex--;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // 下一轮\n  function goToNextRound() {\n    if (currentRoundIndex < rounds.length - 1) {\n      currentRoundIndex++;\n      displayRound(currentRoundIndex);\n    }\n  }\n\n  // ========== Option 选项功能 ==========\n  const optionsOverlay = document.getElementById('chat-options-overlay');\n  const optionsContainer = document.getElementById('chat-options-container');\n  const optionsList = document.getElementById('chat-options-list');\n  const showOptionsBtn = document.getElementById('chat-show-options-btn');\n  const closeOptionsBtn = document.getElementById('chat-options-close');\n\n  // 从最新消息提取选项数据\n  async function getOptionsFromLatestMessage(): Promise<string[]> {\n    try {\n      // 优先使用保存的选项（从 messageGenerator 传递）\n      if (latestOptions.length > 0) {\n        console.log('✅ 使用保存的选项（从 messageGenerator 传递）');\n        return latestOptions;\n      }\n\n      // 次优先：从 assistant 消息的 data 中读取（持久化选项）\n      const messages = getChatMessages(-1, { role: 'assistant' });\n      const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;\n      if (!lastMessage) {\n        return [];\n      }\n\n      if (lastMessage.data?.__options && lastMessage.data.__options.length > 0) {\n        console.log('✅ 从 assistant.data 读取选项（持久化）');\n        return lastMessage.data.__options;\n      }\n\n      // 降级：从消息中提取（如果以上方案均不可用）\n      const { extractAllOptions } = await import('./utils/textParser');\n      const messageContent = lastMessage.message || '';\n      const options = extractAllOptions(messageContent);\n      if (options.length > 0) {\n        console.log('✅ 从消息中提取选项（降级方案）');\n      }\n      return options;\n    } catch (error) {\n      console.error('❌ 获取选项失败:', error);\n      return [];\n    }\n  }\n\n  // 显示选项浮层\n  async function showOptionsOverlay() {\n    if (!optionsOverlay || !optionsContainer || !optionsList) {\n      return;\n    }\n\n    const options = await getOptionsFromLatestMessage();\n\n    if (options.length === 0) {\n      // 如果option为空，显示提示\n      showNoOptionsMessage();\n      return;\n    }\n\n    // 清空之前的选项\n    optionsList.innerHTML = '';\n\n    // 重置状态\n    optionsList.classList.remove('collapse');\n\n    // 设置选项列表为全屏定位容器\n    optionsList.style.position = 'absolute';\n    optionsList.style.top = '0';\n    optionsList.style.left = '0';\n    optionsList.style.right = '0';\n    optionsList.style.bottom = '0';\n    optionsList.style.width = '100%';\n    optionsList.style.height = '100%';\n    // 需要让 list 能 hover（用于 hover 聚焦/模糊效果的 CSS 回退方案）；\n    // 同时通过 click handler 支持“点空白处关闭”，避免 list 吃掉 overlay 的点击。\n    optionsList.style.pointerEvents = 'auto';\n\n    // 获取 overlay 的尺寸，用于计算随机位置\n    if (!optionsOverlay) return;\n\n    // 存储已使用的位置，避免重叠\n    const usedPositions: Array<{ x: number; y: number }> = [];\n    const minDistance = 150; // 最小间距（像素）\n\n    // 生成随机位置，确保不重叠且不靠边缘\n    function generateRandomPosition(): { x: number; y: number } {\n      const maxAttempts = 50;\n      let attempts = 0;\n      const margin = 0.15; // 边缘边距（15%）\n\n      while (attempts < maxAttempts) {\n        // 随机位置，但留出边缘空间\n        const x = margin + Math.random() * (1 - 2 * margin);\n        const y = margin + Math.random() * (1 - 2 * margin);\n\n        // 检查是否与已有位置太近\n        const tooClose = usedPositions.some(pos => {\n          const overlayWidth = optionsOverlay!.clientWidth;\n          const overlayHeight = optionsOverlay!.clientHeight;\n          const dx = (x - pos.x) * overlayWidth;\n          const dy = (y - pos.y) * overlayHeight;\n          const distance = Math.sqrt(dx * dx + dy * dy);\n          return distance < minDistance;\n        });\n\n        if (!tooClose) {\n          usedPositions.push({ x, y });\n          return { x, y };\n        }\n\n        attempts++;\n      }\n\n      // 如果无法找到不重叠的位置，使用随机位置（但仍有边距）\n      const x = margin + Math.random() * (1 - 2 * margin);\n      const y = margin + Math.random() * (1 - 2 * margin);\n      usedPositions.push({ x, y });\n      return { x, y };\n    }\n\n    // 渲染每个选项为圆形气泡，随机位置\n    options.forEach((optionText, index) => {\n      // 可以同时浮现多个选项（可选功能）\n      const delay = index * 80; // 减少延迟，让选项更快浮现\n\n      setTimeout(() => {\n        // STEP 1: 创建容器 + 气泡结构\n        const chatOption = document.createElement('div');\n        chatOption.className = 'chat-option';\n\n        const optionButton = document.createElement('button');\n        optionButton.type = 'button';\n        optionButton.className = 'chat-option-button';\n\n        const optionTextSpan = document.createElement('span');\n        optionTextSpan.className = 'chat-option-text';\n        optionTextSpan.textContent = optionText;\n        optionButton.title = optionText;\n\n        optionButton.appendChild(optionTextSpan);\n        chatOption.appendChild(optionButton);\n\n        // 生成随机位置\n        const position = generateRandomPosition();\n        const rotate = (Math.random() - 0.5) * 30; // -15 到 15 度随机旋转\n\n        chatOption.style.setProperty('--rot', `${rotate}deg`);\n        chatOption.style.left = `${position.x * 100}%`;\n        chatOption.style.top = `${position.y * 100}%`;\n        chatOption.style.position = 'absolute';\n        chatOption.style.pointerEvents = 'auto'; // 气泡本身可点击\n\n        // 思维权重（越靠前越\"清晰\"）\n        const weight = options.length - index;\n        // 降低基础不透明度差异，确保在模糊时依然可见\n        optionButton.style.opacity = `${0.85 + weight * 0.03}`;\n        // 移除初始模糊，确保所有选项基础清晰度\n        optionButton.style.filter = 'none';\n\n        // 点击：思维坍缩\n        optionButton.addEventListener('click', () => {\n          optionButton.classList.add('selected');\n          chatOption.classList.add('selected-parent');\n          optionsList.classList.add('collapse');\n\n          setTimeout(() => {\n            chatInput.value = optionText;\n            adjustInputHeight();\n            sendMessage();\n            hideOptionsOverlay();\n          }, 220);\n        });\n\n        optionsList.appendChild(chatOption);\n\n        // 触发\"念头成形\"动画\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            chatOption.classList.add('show');\n          });\n        });\n      }, delay);\n    });\n\n    optionsOverlay.classList.add('active');\n    console.log(`✅ 已显示 ${options.length} 个选项`);\n  }\n\n  // 显示无选项提示\n  function showNoOptionsMessage() {\n    const messageDiv = document.createElement('div');\n    messageDiv.className = 'chat-no-options-message';\n    messageDiv.innerHTML = `\n      <div class=\"chat-no-options-content\">\n        <div class=\"chat-no-options-text\">做决定吧 qwq</div>\n        <button type=\"button\" class=\"chat-no-options-close\" title=\"关闭\">×</button>\n      </div>\n    `;\n\n    const closeBtn = messageDiv.querySelector('.chat-no-options-close');\n    if (closeBtn) {\n      closeBtn.addEventListener('click', () => {\n        hideOptionsOverlay();\n      });\n    }\n\n    // 添加到选项列表容器中\n    if (optionsList) {\n      optionsList.innerHTML = '';\n      // 重置样式，确保无选项消息正常显示\n      optionsList.style.position = 'absolute';\n      optionsList.style.top = '50%';\n      optionsList.style.left = '50%';\n      optionsList.style.transform = 'translate(-50%, -50%)';\n      optionsList.style.width = 'auto';\n      optionsList.style.height = 'auto';\n      optionsList.style.pointerEvents = 'auto';\n      optionsList.classList.remove('collapse');\n      optionsList.appendChild(messageDiv);\n    }\n\n    // 显示浮层\n    if (optionsOverlay) {\n      optionsOverlay.classList.add('active');\n    }\n  }\n\n  // 隐藏选项浮层\n  function hideOptionsOverlay() {\n    if (optionsOverlay) {\n      optionsOverlay.classList.remove('active');\n    }\n    // 重置 collapse 状态，以便下次打开时能正常显示\n    if (optionsList) {\n      optionsList.classList.remove('collapse');\n    }\n  }\n\n  // 绑定选项相关事件\n  if (showOptionsBtn) {\n    showOptionsBtn.addEventListener('click', showOptionsOverlay);\n  }\n\n  if (closeOptionsBtn) {\n    closeOptionsBtn.addEventListener('click', hideOptionsOverlay);\n  }\n\n  if (optionsOverlay) {\n    optionsOverlay.addEventListener('click', e => {\n      // 允许点击空白处关闭：\n      // - target 是 overlay（真正背景）\n      // - 或 target 是 list 本身（list 覆盖全屏时）\n      if (e.target === optionsOverlay || e.target === optionsList) {\n        hideOptionsOverlay();\n      }\n    });\n  }\n\n  // 绑定发送按钮事件\n  chatSendBtn.addEventListener('click', sendMessage);\n\n  // 绑定重新生成按钮事件\n  if (chatRegenerateBtn) {\n    chatRegenerateBtn.addEventListener('click', regenerateCurrentRound);\n  }\n\n  // 绑定 Enter 键发送（Shift+Enter 换行）\n  chatInput.addEventListener('keydown', e => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n\n  // 设置键盘导航\n  setupKeyboardNavigation();\n\n  // 设置模块切换监听\n  function setupModuleSwitchListener() {\n    const communicationModule = document.getElementById('module-communication');\n    if (!communicationModule) return;\n\n    const observer = new MutationObserver(() => {\n      if (communicationModule.classList.contains('active')) {\n        console.log('📡 通讯模块已激活，刷新显示');\n        refreshDisplay();\n      }\n    });\n\n    observer.observe(communicationModule, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // 初始化时加载历史消息\n  loadChatHistory();\n\n  // 设置模块切换监听\n  setupModuleSwitchListener();\n}\n","// 锚 - 主逻辑\nimport { PageManager } from './utils/pageManager';\nimport { initNavigation, initModals, initAnimations, initStatusCardInteractions, initChatInterface } from './dashboardLogic';\n\nlet pageManager: PageManager | null = null;\n\n/**\n * 初始化应用\n */\nfunction initApp() {\n  const appContainer = document.getElementById('app');\n  if (!appContainer) {\n    console.error('未找到 #app 容器');\n    return;\n  }\n\n  // 初始化页面管理器\n  pageManager = new PageManager(appContainer);\n  pageManager.initialize();\n\n  // 监听页面切换，当进入游戏页面时初始化功能\n  const mainScreen = document.getElementById('main-screen');\n  if (mainScreen) {\n    const observer = new MutationObserver(() => {\n      if (mainScreen.classList.contains('active')) {\n        // 延迟初始化，确保DOM已完全渲染\n        setTimeout(() => {\n          initDashboardFeatures();\n        }, 100);\n      }\n    });\n\n    observer.observe(mainScreen, {\n      attributes: true,\n      attributeFilter: ['class'],\n    });\n  }\n\n  // 监听酒馆消息更新事件\n  eventOn(tavern_events.MESSAGE_UPDATED, () => {\n    if (pageManager) {\n      const dashboard = pageManager.getDashboard();\n      // 刷新游戏数据\n      // 这里可以从变量系统读取最新数据并更新\n      console.info('消息已更新，刷新游戏数据');\n    }\n  });\n}\n\n/**\n * 初始化主游戏界面功能\n */\nfunction initDashboardFeatures() {\n  // 检查是否已经初始化过\n  if (document.querySelector('.nav-item[data-module=\"status\"]')?.hasAttribute('data-initialized')) {\n    return;\n  }\n\n  initNavigation();\n  initModals();\n  initAnimations();\n  initStatusCardInteractions();\n  initChatInterface();\n\n  // 标记已初始化\n  document.querySelectorAll('.nav-item').forEach(item => {\n    item.setAttribute('data-initialized', 'true');\n  });\n\n  console.info('主游戏界面功能已初始化');\n}\n\n// 使用 jQuery 在加载时执行初始化（符合项目规范）\n$(() => {\n  errorCatched(initApp)();\n});\n\n// 在界面卸载时执行清理\n$(window).on('pagehide', () => {\n  console.info('锚界面已卸载');\n  if (pageManager) {\n    // 可以在这里清理资源\n  }\n});\n","// 导入样式\nimport './styles.css';\n\n// 初始化函数\nfunction init() {\n  // 添加 FontAwesome CSS\n  if (!document.querySelector('link[href*=\"font-awesome\"]')) {\n    const link = document.createElement('link');\n    link.rel = 'stylesheet';\n    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';\n    document.head.appendChild(link);\n  }\n\n  // 添加 meta 标签\n  if (!document.querySelector('meta[charset]')) {\n    const charset = document.createElement('meta');\n    charset.setAttribute('charset', 'UTF-8');\n    document.head.appendChild(charset);\n  }\n\n  if (!document.querySelector('meta[name=\"viewport\"]')) {\n    const viewport = document.createElement('meta');\n    viewport.setAttribute('name', 'viewport');\n    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');\n    document.head.appendChild(viewport);\n  }\n\n  // 设置标题\n  document.title = '锚';\n\n  // 添加描述\n  if (!document.querySelector('meta[name=\"description\"]')) {\n    const description = document.createElement('meta');\n    description.setAttribute('name', 'description');\n    description.setAttribute('content', '锚 - 舰体生存经营游戏 - 管理任务、记录日志、处理通讯、监控舰体状态');\n    document.head.appendChild(description);\n  }\n}\n\n// 使用 jQuery 在加载时执行初始化（符合项目规范）\n$(() => {\n  init();\n  console.info('锚界面已加载');\n});\n\n// 在界面卸载时执行清理\n$(window).on('pagehide', () => {\n  console.info('锚界面已卸载');\n});\n\n// 导入应用逻辑\nimport './app';\n"],"names":["checkGenerateAvailable","generate","window","async","regenerateAssistantMessage","userMessageId","callbacks","onShowGenerating","streamingHandler","eventOn","iframe_events","STREAM_TOKEN_RECEIVED_FULLY","fullText","cleanedText","trim","length","onStreamingUpdate","console","log","Error","generatePromise","should_stream","timeoutPromise","Promise","_","reject","setTimeout","result","race","cleanedResult","onHideGenerating","onError","maintext","extractLastMaintext","option","sum","updateVariable","finalMessage","base","userMsg","getChatMessages","data","role","Mvu","getMvuData","type","message_id","stat_data","display_data","delta_data","finalData","parseMessage","parsed","e","warn","extractedOptions","extractAllOptions","maintextContent","sumContent","messageToSave","includes","createChatMessages","message","__options","refresh","assistantMessageId","getLastMessageId","onCreatedMessages","onRefreshStory","error","generateMessage","userInput","mvu_data","waitGlobalInitialized","initData","latestData","chatData","getBaseMvuData","checkAndRefresh","retries","checkMessageId","messages","onRefreshStoryIfOpen","createError","String","substring","generateError","errorType","errorMessage","errorStack","stack","undefined","userMessage","module","exports","initializeGameData","config","currentMvuData","currentStatData","updatedStatData","reserve","system_state","antimatter","clampedReserve","info","updatedMvuData","replaceMvuData","updateMvuVariables","gameData","station_name","difficulty","resources","energy","supplies","crew","status","life_support","system","personnel","communication","laboratory","storage","computing","tasks","diary","currentData","getVariables","updatedData","game_data","replaceVariables","updateGameData","game_config","updateGameConfig","removeThinkingTags","text","lastResult","replace","removeThinkingTagsFromStream","cleaned","lastThinkingStart","lastIndexOf","removeSumTags","parseSummary","sumText","split","forEach","part","match","key","value","matches","contentMatch","extractContinueChoice","extractResult","extractNextChoice","extractLastOption","suboptionMatches","options","content","push","optionMatches","lines","map","line","filter","extractLastSum","extractLastUpdateVariable","validateMessage","messageContent","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","hasSaveData","lastMessageId","SplashScreen","element","constructor","this","createElement","div","document","className","id","innerHTML","getHTML","bindEvents","updateContinueButton","show","classList","add","hide","remove","destroy","$","off","keyDownHandler","removeEventListener","continueButton","querySelector","style","display","newGameButton","addEventListener","onNewGame","onContinue","fullscreenButton","requestFullscreen","contains","preventDefault","documentElement","catch","err","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","NewGameSetup","reserveInput","getConfig","updateMvuVariable","confirmButton","inputValue","toastr","parseInt","isNaN","Number","isInteger","onConfirm","cancelButton","onCancel","Math","max","min","showdown","YAML","Dashboard","mvuUpdateListener","statusRetryCount","statusRetryTimer","markdownConverter","netCategories","netReport","expandedSections","Set","selectedItem","tables","strikethrough","tasklists","simpleLineBreaks","ghCodeBlocks","openLinksInNewWindow","refreshData","fallbackDiv","stop","clearTimeout","updateStatusCards","updateTasksList","updateNetContent","loadMaintextFromChat","loadNetFromWorldbook","statusGrid","timeout","intervalBetweenAttempts","chatSystemState","latestSystemState","initSystemState","latest","initMsg","systemState","cycle","system_pressure","instability","population","cards","leakRisk","leak_risk","reservePercent","round","riskLevel","toLocaleString","toFixed","pop","active","standby","archived","total","pressure","pressurePercent","pressureLevel","instabilityPercent","instabilityLevel","join","tasksList","Array","isArray","getDefaultTasks","task","getTaskIcon","escapeHtml","title","getStatusText","time","priority","getPriorityText","description","netContainer","sidebarHtml","cat","renderSidebarSection","label","items","reportSidebarHtml","renderNetViewer","bindNetSidebarEvents","categoryId","editor","on","target","saveReportToVariables","isExpanded","has","icon","itemsHtml","item","index","renderMarkdown","makeHtml","category","find","c","author","sectionId","currentTarget","closest","attr","delete","NET_ENTRY_REGEX","worldbook","getWorldbook","newCategories","entry","name","alias","parse","gameVariables","player_report","updateStatDataVariable","updateChatMessages","getDefaultMessages","textContent","parseMaintext","maintextMatch","updateMaintextDisplay","then","el","continueChoice","nextChoice","continueChoiceArea","resultArea","nextChoiceArea","lastMessage","setupMessageListener","tavern_events","handleMessageReceived","MESSAGE_RECEIVED","CHAT_CHANGED","MESSAGE_UPDATED","latestMessage","detail","toggleFullscreen","setupEnterKeyFullscreen","events","VARIABLE_UPDATE_ENDED","activeElement","tagName","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","fullscreenElement","PageManager","currentPage","splashScreen","setupScreen","dashboard","appContainer","onStart","goToSplash","goToSetup","goToGame","handleConfirm","onFullscreenToggle","initialize","appendChild","showPage","page","dashboardElement","getElementById","variables","continueGame","fallbackError","initializeNewGame","success","getDashboard","initChatInterface","chatInput","chatSendBtn","chatRegenerateBtn","chatMessages","rounds","currentRoundIndex","activePendingRoundIndex","getPendingRoundIndexSafe","pending","i","r","findLastPendingRoundIndex","streamingElement","lastStreamedRawMessage","isGenerating","isSending","latestOptions","lastCreatedIds","generateMessagePromise","regenerateAssistantMessagePromise","adjustInputHeight","height","newHeight","scrollHeight","displayRound","roundIndex","from","children","child","msg","updateRegenerateButtonState","renderUserMessage","pendingUserMessage","assistantMessage","rawMessage","summaryText","messageItem","searchText","columns","header","columnsHtml","col","displayContent","summaryCard","createSummaryCardElement","renderAssistantMessage","summary","showGenerating","parentNode","disabled","hasUserMessage","isNotPending","sumObj","keys","labelIcons","Time","Location","Characters","Event","entries","loadChatHistory","newRounds","allMessages","pendingRound","sumMatch","groupMessagesIntoRounds","sendMessage","timeEl","hideGenerating","idx","updateStreamingMessage","dispatchEvent","CustomEvent","finalizeStreamingAsAssistant","debug","ids","finalText","columnsContainer","updateColumnsFromStream","pendingIdx","targetRound","Date","now","container","columnConfigs","tag","startTag","endTag","columnElement","hasAttribute","startIndex","indexOf","contentStart","endIndex","setAttribute","headerElement","contentElement","oldScrollTop","scrollTop","oldScrollHeight","wasAtBottom","clientHeight","newScrollHeight","optionsOverlay","optionsContainer","optionsList","showOptionsBtn","closeOptionsBtn","hideOptionsOverlay","getOptionsFromLatestMessage","messageDiv","closeBtn","position","top","left","transform","width","pointerEvents","showNoOptionsMessage","right","bottom","usedPositions","optionText","chatOption","optionButton","optionTextSpan","attempts","margin","x","random","y","some","pos","overlayWidth","clientWidth","overlayHeight","dx","dy","sqrt","generateRandomPosition","rotate","setProperty","weight","opacity","requestAnimationFrame","isFinite","deleteChatMessages","shiftKey","communicationModule","click","setupKeyboardNavigation","MutationObserver","refreshDisplay","observe","attributes","attributeFilter","setupModuleSwitchListener","pageManager","initApp","mainScreen","navItems","querySelectorAll","modules","switchModule","nav","targetNavItem","targetModule","getAttribute","moduleMap","HTMLElement","isContentEditable","initNavigation","modalOverlay","modalClose","initModals","card","initDashboardFeatures","errorCatched","link","rel","href","head","charset","viewport","init"],"ignoreList":[],"sourceRoot":""}